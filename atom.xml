<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>MrBird</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://mrbird.cc/"/>
  <updated>2019-11-23T06:13:43.424Z</updated>
  <id>http://mrbird.cc/</id>
  
  <author>
    <name>MrBird</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>CI/CDå®è·µç¬”è®°</title>
    <link href="http://mrbird.cc/CI-CD-Practice-Note.html"/>
    <id>http://mrbird.cc/CI-CD-Practice-Note.html</id>
    <published>2019-11-18T05:52:58.000Z</published>
    <updated>2019-11-23T06:13:43.424Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --><p>CICDï¼ˆ<strong>C</strong>ontinuous <strong>I</strong>ntegration/<strong>C</strong>ontinuous <strong>D</strong>eploymentï¼‰ï¼ŒæŒç»­é›†æˆæŒç»­éƒ¨ç½²çš„æ„æ€ã€‚å®ŒæˆCICDå®è·µéœ€è¦Kubernetesé›†ç¾¤ï¼ŒHarborï¼ŒGitLabå’ŒJenkinsç­‰è½¯ä»¶é…åˆå®Œæˆï¼Œåœ¨å‰é¢å‡ ç¯‡åšå®¢ä¸­ï¼Œæˆ‘å·²ç»æ­å»ºå¥½äº†Kubernetesé›†ç¾¤ï¼Œå¹¶ä¸”åœ¨masterèŠ‚ç‚¹ï¼ˆ192.168.33.11,CentOSï¼‰ä¸Šå®‰è£…å¥½äº†Harborã€GitLabå’ŒJenkinsï¼Œæœ‰éœ€è¦å¯ä»¥å‚è€ƒä¸‹ã€‚<a id="more"></a></p><h2 id="å®è·µå‡†å¤‡"><a href="#å®è·µå‡†å¤‡" class="headerlink" title="å®è·µå‡†å¤‡"></a>å®è·µå‡†å¤‡</h2><h3 id="CICDæµç¨‹å›¾"><a href="#CICDæµç¨‹å›¾" class="headerlink" title="CICDæµç¨‹å›¾"></a>CICDæµç¨‹å›¾</h3><p>CICDçš„å¤§è‡´æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20191118145712.png" alt="QQæˆªå›¾20191118145712.png"></p><ol><li><p>å¼€å‘è€…å°†æœ€æ–°ä»£ç æäº¤åˆ°GitLabä»“åº“ï¼›</p></li><li><p>GitLab WebHookè§¦å‘Jenkinsæ„å»ºæµæ°´çº¿ï¼š</p><p>2.1 æ‹‰å–æœ€æ–°ä»£ç ï¼›</p><p>2.2 Mavenæ‰“åŒ…ï¼Œæ‰“åŒ…è¿‡ç¨‹ä¸­ä¼šå…ˆè¿›è¡Œå•å…ƒæµ‹è¯•ï¼›</p><p>2.3 å•å…ƒæµ‹è¯•é€šè¿‡ï¼Œæ„å»ºDockeré•œåƒï¼›</p><p>2.4 å°†æœ€æ–°é•œåƒæ¨é€åˆ°Harborï¼›</p><p>2.5 æ›´æ–°Kubernetesç›¸å…³é…ç½®é•œåƒç‰ˆæœ¬ã€‚</p></li><li><p>Kubernetesæ„ŸçŸ¥åˆ°é•œåƒæ›´æ–°ï¼Œä»Harboræ‹‰å–æœ€æ–°é•œåƒï¼Œæ»šåŠ¨å‡çº§ï¼›</p></li><li><p>å¼€å‘è€…çœ‹åˆ°æœ€æ–°çš„ä»£ç æ•ˆæœã€‚</p></li></ol><h3 id="é¡¹ç›®å‡†å¤‡"><a href="#é¡¹ç›®å‡†å¤‡" class="headerlink" title="é¡¹ç›®å‡†å¤‡"></a>é¡¹ç›®å‡†å¤‡</h3><p>è¿™é‡Œæˆ‘ä»¬åœ¨Windowsä¸Šä½¿ç”¨IDEAã€Spring Bootæ„å»ºä¸€ä¸ªç®€å•çš„Java Webé¡¹ç›®ï¼Œé¡¹ç›®åä¸ºdemoï¼Œé¡¹ç›®pomå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cc.mrbird<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>demo<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>åœ¨Bootå…¥å£ç±»ä¸­æ·»åŠ ä¸€ä¸ªç®€å•çš„Controlleræ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(DemoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello world"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢æ–¹æ³•æä¾›äº†ä¸€ä¸ª<code>/hello</code>æ¥å£ï¼Œç®€å•è¿”å›<code>hello world</code>ä¿¡æ¯ã€‚</p><p>æ¥ç€ç¼–å†™ä¸€ä¸ªç®€å•çš„å•å…ƒæµ‹è¯•ï¼š</p><p><img src="img/QQæˆªå›¾20191118151519.png" alt="QQæˆªå›¾20191118151519.png"></p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@AutoConfigureMockMvc</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MockMvc mockMvc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">testIndex</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        mockMvc.perform(MockMvcRequestBuilders.get(<span class="string">"/hello"</span>))</span><br><span class="line">                .andExpect(MockMvcResultMatchers.content().string(<span class="string">"hello world"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æœ€ååœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªDockerfileï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FROM openjdk:8u212-jre</span><br><span class="line">MAINTAINER MrBird 852252810@qq.com</span><br><span class="line"></span><br><span class="line">COPY target/demo-0.0.1-SNAPSHOT.jar /demo-0.0.1-SNAPSHOT.jar</span><br><span class="line">ENTRYPOINT [&quot;java&quot;, &quot;-jar&quot;, &quot;/demo-0.0.1-SNAPSHOT.jar&quot;]</span><br></pre></td></tr></table></figure><p></p><p>è‡³æ­¤ç®€å•çš„Java Webé¡¹ç›®å°±å‡†å¤‡å¥½äº†ã€‚</p><h3 id="GitLabå‡†å¤‡"><a href="#GitLabå‡†å¤‡" class="headerlink" title="GitLabå‡†å¤‡"></a>GitLabå‡†å¤‡</h3><p>æ³¨å†Œä¸€ä¸ªæ–°çš„GitLabè´¦å·ï¼Œæ¯”å¦‚mrbirdï¼Œç„¶ååœ¨GitLabæ–°å»ºä¸€ä¸ªé¡¹ç›®ï¼Œåç§°ä¸ºDemoï¼š</p><p><img src="img/QQæˆªå›¾20191118153441.png" alt="QQæˆªå›¾20191118153441.png"></p><p>å› ä¸ºæˆ‘ä»¬åç»­éœ€è¦åœ¨Windowsä¸‹å°†é¡¹ç›®æäº¤åˆ°GitLabï¼Œå¹¶åœ¨192.168.33.11ä¸Šæ‹‰å–è¯¥é¡¹ç›®ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨Windowså’Œ192.168.33.11æœåŠ¡å™¨ä¸Šç”ŸæˆSSH Keyï¼Œå¹¶æ·»åŠ åˆ°GitLabä¸­ã€‚</p><p>åœ¨WindowsåŠ192.168.33.11è™šæ‹Ÿæœºé€šè¿‡ä¸‹é¢çš„å‘½ä»¤ç”ŸæˆSSH Keyï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -C <span class="string">"852252810@qq.com"</span></span><br><span class="line"></span><br><span class="line">cat ~/.ssh/id_rsa.pub</span><br></pre></td></tr></table></figure><p></p><p>å°†SSH Keyæ·»åŠ åˆ°GitLabï¼š</p><p><img src="img/QQæˆªå›¾20191118153948.png" alt="QQæˆªå›¾20191118153948.png"></p><p>è¿™æ ·æˆ‘ä»¬åç»­çš„pushå’Œpullæ“ä½œå°±ä¸éœ€è¦è¾“å…¥ç”¨æˆ·åäº†ã€‚</p><p>æ¥ç€æˆ‘ä»¬å°†ä¸Šé¢åˆ›å»ºçš„Demoé¡¹ç›®æ¨é€åˆ°GitLabä¸­ï¼ˆåœ¨IDEAçš„Terminalçª—å£ä¸­æ“ä½œï¼Œä¸ªäººä¹ æƒ¯ç”¨å‘½ä»¤è¡Œï¼‰ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># é…ç½®Git</span><br><span class="line">git config --global user.name &quot;mrbird&quot;</span><br><span class="line">git config --global user.email &quot;852252810@qq.com&quot;</span><br><span class="line"></span><br><span class="line"># åˆå§‹åŒ–Gitä»“åº“</span><br><span class="line">git init</span><br><span class="line"></span><br><span class="line"># commit</span><br><span class="line">git commit -am init</span><br><span class="line"></span><br><span class="line"># æ·»åŠ è¿œç¨‹ä»“åº“</span><br><span class="line">git remote add origin ssh://git@gitlab.mrbird.cc:2223/mrbird/demo.git</span><br><span class="line"></span><br><span class="line"># æ¨é€åˆ°è¿œç¨‹ä»“åº“</span><br><span class="line">git push origin master</span><br></pre></td></tr></table></figure><p></p><p>æ¨é€æˆåŠŸåï¼Œå›åˆ°GitLabé¡µé¢å¯ä»¥çœ‹åˆ°é¡¹ç›®å·²ç»æ¨é€OKäº†ï¼š</p><p><img src="img/QQæˆªå›¾20191120162821.png" alt="QQæˆªå›¾20191118154957.png"></p><h3 id="Kuberneteséƒ¨ç½²SpringBooté¡¹ç›®"><a href="#Kuberneteséƒ¨ç½²SpringBooté¡¹ç›®" class="headerlink" title="Kuberneteséƒ¨ç½²SpringBooté¡¹ç›®"></a>Kuberneteséƒ¨ç½²SpringBooté¡¹ç›®</h3><p>åœ¨192.168.33.11æœåŠ¡å™¨ä¸Šå°†åˆšåˆšçš„é¡¹ç›®ä»GitLabä¸­å…‹éš†ä¸‹æ¥:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone ssh://git@gitlab.mrbird.cc:2223/mrbird/demo.git</span><br></pre></td></tr></table></figure><p>å› ä¸ºæ‰“åŒ…éœ€è¦Mavenç¯å¢ƒï¼Œæ‰€ä»¥æ¥ç€é…ç½®Mavenï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># ä¸‹è½½Mavenå®‰è£…åŒ…</span><br><span class="line">wget http://mirrors.tuna.tsinghua.edu.cn/apache/maven/maven-3/3.6.2/binaries/apache-maven-3.6.2-bin.tar.gz</span><br><span class="line"></span><br><span class="line"># è§£å‹</span><br><span class="line">tar -xzvf apache-maven-3.6.2-bin.tar.gz</span><br><span class="line"></span><br><span class="line"># ä¿®æ”¹ç¯å¢ƒå˜é‡</span><br><span class="line">vim /etc/profile</span><br></pre></td></tr></table></figure><p></p><p>æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">M2_HOME=/home/vagrant/apache-maven-3.6.2</span><br><span class="line">export PATH=$PATH:$JAVA_HOME/bin:$M2_HOME/bin</span><br></pre></td></tr></table></figure><p></p><p>è®©ä¿®æ”¹ç”Ÿæ•ˆï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><p></p><p>éªŒè¯ä¸‹æ˜¯å¦å®‰è£…æˆåŠŸï¼š</p><p><img src="img/QQæˆªå›¾20191118164351.png" alt="QQæˆªå›¾20191118164351.png"></p><p>ç¯å¢ƒå‡†å¤‡å¥½åï¼Œå°†ç›®å½•åˆ‡æ¢åˆ°åˆšåˆš<code>git clone</code>çš„demoç›®å½•ä¸‹ï¼Œæ‰§è¡Œ<code>mvn clean package</code>å‘½ä»¤ï¼Œå®Œæˆåå¯ä»¥çœ‹åˆ°fat jarï¼š</p><p><img src="img/QQæˆªå›¾20191120162943.png" alt="QQæˆªå›¾20191118171428.png"></p><p>æ¥ç€æ‰§è¡Œ<code>docker build -t docker.mrbird.cc/febs/demo .</code>å‘½ä»¤æ„å»ºdockeré•œåƒï¼š</p><p><img src="img/QQæˆªå›¾20191119184432.png" alt="QQæˆªå›¾20191119184432.png"></p><p>æ„å»ºæˆåŠŸåæ‰§è¡Œ<code>docker push docker.mrbird.cc/febs/demo</code>å‘½ä»¤æ¨é€åˆ°Harborï¼š</p><p><img src="img/QQæˆªå›¾20191119184535.png" alt="QQæˆªå›¾20191119184535.png"></p><p>è®¿é—®Harborç®¡ç†é¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°é•œåƒå·²ç»æ¨é€ä¸Šæ¥äº†ï¼š</p><p><img src="img/QQæˆªå›¾20191119184638.png" alt="QQæˆªå›¾20191119184638.png"></p><p>æ¥ç€ç¼–å†™ä¸ªç®€å•çš„Kubernetesé…ç½®æ–‡ä»¶ï¼ˆdemo.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">demo-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">      nodePort:</span> <span class="number">30000</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">demo-app</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">demo-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">demo-app</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">demo-app</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">demo</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">docker.mrbird.cc/febs/demo</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">          resources:</span></span><br><span class="line"><span class="attr">            limits:</span></span><br><span class="line"><span class="attr">              cpu:</span> <span class="number">500</span><span class="string">m</span></span><br><span class="line"><span class="attr">              memory:</span> <span class="number">500</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">            requests:</span></span><br><span class="line"><span class="attr">              cpu:</span> <span class="number">200</span><span class="string">m</span></span><br><span class="line"><span class="attr">              memory:</span> <span class="number">200</span><span class="string">Mi</span></span><br></pre></td></tr></table></figure><p>è¿è¡Œè¯¥é…ç½®:</p><p><img src="img/QQæˆªå›¾20191119191043.png" alt="QQæˆªå›¾20191119191043.png"></p><p>ä½¿ç”¨æµè§ˆå™¨è®¿é—®<a href="http://192.168.33.11:30000/hello" target="_blank" rel="noopener">http://192.168.33.11:30000/hello</a>:</p><p><img src="img/QQæˆªå›¾20191119192134.png" alt="QQæˆªå›¾20191119192134.png"></p><p>è‡³æ­¤Spring Booté¡¹ç›®å·²ç»æˆåŠŸè¿è¡Œåœ¨Kubernetesé›†ç¾¤ä¸­äº†ï¼Œæ¥ä¸‹æ¥å¼€å§‹æ¼”ç¤ºå¦‚ä½•è¿›è¡ŒCICDã€‚</p><h2 id="CICDå®è·µ"><a href="#CICDå®è·µ" class="headerlink" title="CICDå®è·µ"></a>CICDå®è·µ</h2><p>å°±å¦‚ä¸Šé¢CICDæµç¨‹å›¾æ‰€ç¤ºï¼Œç¬¬ä¸€æ­¥å°†æœ¬åœ°å¼€å‘ä»£ç pushåˆ°GitLabå·²ç»å®ç°äº†ï¼Œæ¥ä¸‹æ¥å¼€å§‹é…ç½®GitLab WebHookã€‚</p><h3 id="GitLab-WebHook"><a href="#GitLab-WebHook" class="headerlink" title="GitLab WebHook"></a>GitLab WebHook</h3><p>åœ¨Jenkinsä¸­åˆ›å»ºæµæ°´çº¿å‰ï¼Œå…ˆä¿®æ”¹ä¸¤å¤„Jenkinsé…ç½®ã€‚ç‚¹å‡»Jenkinsç®¡ç†é¡µé¢çš„<strong>ç³»ç»Ÿç®¡ç†</strong>èœå• -&gt; <strong>å…¨å±€å®‰å…¨é…ç½®</strong>ï¼š</p><p><img src="img/QQæˆªå›¾20191120091638.png" alt="QQæˆªå›¾20191120091638.png"></p><p>å…³é—­CSRFä¿æŠ¤å’Œå¼€å¯åŒ¿åç”¨æˆ·å…·æœ‰å¯è¯»æƒé™ã€‚</p><p>ç„¶åç‚¹å‡»<strong>æ–°å»ºä»»åŠ¡</strong>èœå•ï¼Œæ–°å¢ä¸€ä¸ªåç§°ä¸ºdemoçš„æµæ°´çº¿ï¼Œå‹¾é€‰<strong>è§¦å‘è¿œç¨‹æ„å»º</strong>ï¼š</p><p><img src="img/QQæˆªå›¾20191120091910.png" alt="QQæˆªå›¾20191120091910.png"></p><p>ä»¤ç‰Œè®¾ç½®ä¸º666666ï¼Œè§¦å‘åœ°å€ä¸º<code>JENKINS_URL/job/demo/build?token=TOKEN_NAME</code>ï¼Œæˆ‘ä»¬éœ€è¦å°†è¿™ä¸ªåœ°å€é…ç½®ä¸ºGitLabçš„WebHookä¸­ã€‚</p><p>æ‰“å¼€GitLabçš„Demoé¡¹ç›®é¡µé¢ï¼Œç‚¹å‡»å·¦ä¾§çš„è®¾ç½®èœå•ï¼š</p><p><img src="img/QQæˆªå›¾20191120092313.png" alt="QQæˆªå›¾20191120092313.png"></p><p>é€‰æ‹©integrationsï¼š</p><p><img src="img/QQæˆªå›¾20191120092425.png" alt="QQæˆªå›¾20191120092425.png"></p><p>å…¶ä¸­<code>http://192.168.33.11:8081</code>ä¸ºæˆ‘çš„Jenkinsåœ°å€ï¼Œå¯¹åº”JENKINS_URLï¼›666666æ˜¯æˆ‘ä»¬è®¾ç½®çš„ä»¤ç‰Œï¼Œå¯¹åº”TOKEN_NAMEã€‚è§¦å‘äº‹ä»¶é€‰æ‹©push eventå°±è¡Œã€‚</p><p>ä¿å­˜WebHookçš„æ—¶å€™å¦‚æœæç¤º<span style="color:red;font-weight:600">Url is blocked: Requests to the local network are not allowed</span>çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨<a href="mailto:admin@example.com" target="_blank" rel="noopener">admin@example.com</a>è´¦å·ç™»å½•GitLabï¼ˆå¯†ç å°±æ˜¯ä½ ç¬¬ä¸€æ¬¡ç™»å½•ä¿®æ”¹çš„å¯†ç ï¼‰ï¼Œç„¶åç‚¹å‡»<strong>Admin Area</strong>-&gt;<strong>Settings</strong>-&gt;<strong>Network</strong>ï¼š</p><p><img src="img/QQæˆªå›¾20191120093459.png" alt="QQæˆªå›¾20191120093459.png"></p><p>å‹¾é€‰Allow requests to the local network from web hooks and serviceså³å¯ã€‚ä¿å­˜åï¼Œé‡æ–°ä½¿ç”¨mrbirdè´¦å·ç™»å½•é‡æ–°é…ç½®WebHookå³å¯ã€‚</p><p>é…ç½®å¥½åï¼Œæµ‹è¯•ä¸€ä¸‹ï¼š</p><p><img src="img/QQæˆªå›¾20191120094028.png" alt="QQæˆªå›¾20191120094028.png"></p><p>é¡µé¢å¼¹å‡ºå¦‚ä¸‹æç¤ºè¯´æ˜é…ç½®ğŸ†—ï¼š</p><p><img src="img/QQæˆªå›¾20191120094121.png" alt="QQæˆªå›¾20191120094121.png"></p><h3 id="ä»£ç æ‹‰å–"><a href="#ä»£ç æ‹‰å–" class="headerlink" title="ä»£ç æ‹‰å–"></a>ä»£ç æ‹‰å–</h3><p>Mavenæ‰“åŒ…å‰éœ€è¦å…ˆç”¨gitå‘½ä»¤å°†ä»£ç æ‹‰å–ä¸‹æ¥ã€‚ç¼–è¾‘åˆšåˆšåˆ›å»ºçš„æµæ°´çº¿ï¼Œåœ¨Pipeline scriptä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p><p><img src="img/QQæˆªå›¾20191120141218.png" alt="QQæˆªå›¾20191120141218.png"></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!groovy</span></span><br><span class="line">pipeline &#123;</span><br><span class="line">  agent any</span><br><span class="line">  environment &#123;</span><br><span class="line">    REPOSITORY=<span class="string">"ssh://git@gitlab.mrbird.cc:2223/mrbird/demo.git"</span></span><br><span class="line">  &#125;</span><br><span class="line">  stages &#123;</span><br><span class="line">    stage(<span class="string">'æ‹‰å–ä»£ç '</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"ä»GitLabåœ°å€<span class="variable">$&#123;REPOSITORY&#125;</span>æ‹‰å–ä»£ç "</span></span><br><span class="line">        deleteDir()</span><br><span class="line">        git <span class="string">"<span class="variable">$&#123;REPOSITORY&#125;</span>"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>Pipeline scriptçš„åŸºæœ¬æ¨¡æ¿ä¸ºï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!groovy</span></span><br><span class="line">pipeline &#123;</span><br><span class="line">  agent any</span><br><span class="line">  environment &#123;</span><br><span class="line">    // å®šä¹‰å…¨å±€å˜é‡</span><br><span class="line">  &#125;</span><br><span class="line">  stages &#123;</span><br><span class="line">  	// å¯ä»¥å®šä¹‰å¤šä¸ªé˜¶æ®µ</span><br><span class="line">    stage(<span class="string">'é˜¶æ®µåç§°'</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        // å…·ä½“æ­¥éª¤</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å›åˆ°ä¸Šé¢çš„Pipeline scriptä»£ç ï¼Œæˆ‘ä»¬ä¸»è¦åšäº†ä¸‹é¢å‡ ä»¶äº‹ï¼š</p><ol><li><p>åœ¨environmentä¸­å®šä¹‰GitLabé¡¹ç›®ä»“åº“åœ°å€å˜é‡ï¼Œæ–¹ä¾¿ä¸‹é¢ç›´æ¥å¼•ç”¨ï¼›</p></li><li><p>é€šè¿‡<code>echo</code>å‘½ä»¤è¾“å‡ºï¼Œæ–¹ä¾¿åç»­ä»æ—¥å¿—ä¸­è§‚å¯Ÿè·Ÿè¸ªï¼›</p></li><li><p>é€šè¿‡<code>deleteDir()</code>æ¸…ç©ºå·¥ä½œåŒºï¼›</p></li><li><p>é€šè¿‡<code>git &quot;${REPOSITORY}&quot;</code>ä»æŒ‡å®šGitä»“åº“æ‹‰å–ä»£ç ã€‚</p></li></ol><p>å…¶ä¸­ï¼Œä½¿ç”¨environmentä¸­çš„å˜é‡æ—¶å€™ï¼Œä¸€å®šè¦ç”¨<code>&quot;${xx}&quot;</code>çš„æ–¹å¼å¼•ç”¨ï¼›ç¬¬3ç¬¬4æ­¥çš„å‘½ä»¤å¯ä»¥é€šè¿‡æµæ°´çº¿è¯­æ³•æ¥ç”Ÿæˆï¼Œæ¯”å¦‚ç”Ÿæˆæ¸…ç©ºå½“å‰ç›®å½•çš„å‘½ä»¤ï¼š</p><p><img src="img/QQæˆªå›¾20191120141809.png" alt="QQæˆªå›¾20191120141809.png"></p><p>ç”Ÿæˆé€šè¿‡Gitæ‹‰å–ä»£ç çš„å‘½ä»¤ï¼š</p><p><img src="img/QQæˆªå›¾20191120141908.png" alt="QQæˆªå›¾20191120141908.png"></p><p>ä¿®æ”¹å¥½æµæ°´çº¿åï¼Œç‚¹å‡»<strong>ç«‹å³æ„å»º</strong>ï¼Œçœ‹çœ‹æˆ‘ä»¬çš„é…ç½®æ˜¯å¦ğŸ†—ï¼š</p><p><img src="img/20191120142110.png" alt="20191120142110.png"></p><p>ä»æ—¥å¿—æ¥çœ‹ï¼Œä»£ç æ‹‰å–æ˜¯æˆåŠŸçš„ã€‚</p><h3 id="Mavenæ‰“åŒ…å’Œå•å…ƒæµ‹è¯•"><a href="#Mavenæ‰“åŒ…å’Œå•å…ƒæµ‹è¯•" class="headerlink" title="Mavenæ‰“åŒ…å’Œå•å…ƒæµ‹è¯•"></a>Mavenæ‰“åŒ…å’Œå•å…ƒæµ‹è¯•</h3><p>Jenkins é€šè¿‡shellè„šæœ¬è°ƒç”¨mvn å‘½ä»¤çš„æ—¶å€™ï¼Œæ˜¯ä»/usr/bin æ–‡ä»¶å¤¹ä¸­æ‰¾å‘½ä»¤çš„ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦åšä¸ªè½¯é“¾æ¥ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /home/vagrant/apache-maven-3.6.2/bin/mvn /usr/bin/mvn</span><br></pre></td></tr></table></figure><p></p><p>æ›´æ–°æµæ°´çº¿çš„Pipeline scriptï¼Œæ·»åŠ mavenæ‰“åŒ…é˜¶æ®µå‘½ä»¤ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!groovy</span></span><br><span class="line">pipeline &#123;</span><br><span class="line">  agent any</span><br><span class="line">  environment &#123;</span><br><span class="line">    REPOSITORY=<span class="string">"ssh://git@gitlab.mrbird.cc:2223/mrbird/demo.git"</span></span><br><span class="line">  &#125;</span><br><span class="line">  stages &#123;</span><br><span class="line">    stage(<span class="string">'æ‹‰å–ä»£ç '</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"ä»GitLabåœ°å€<span class="variable">$&#123;REPOSITORY&#125;</span>æ‹‰å–ä»£ç "</span></span><br><span class="line">        deleteDir()</span><br><span class="line">        git <span class="string">"<span class="variable">$&#123;REPOSITORY&#125;</span>"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'ä»£ç ç¼–è¯‘åŠå•å…ƒæµ‹è¯•'</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"å¼€å§‹ç¼–è¯‘ä»£ç å’Œå•å…ƒæµ‹è¯•"</span></span><br><span class="line">        sh <span class="string">"mvn -U -am clean package"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>mavenæ‰“åŒ…å‰ä¼šè‡ªåŠ¨è¿è¡Œæˆ‘ä»¬åœ¨é¡¹ç›®é‡Œå†™å¥½çš„å•å…ƒæµ‹è¯•ï¼Œä¿®æ”¹åï¼Œç‚¹å‡»<strong>ç«‹å³æ„å»º</strong>ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼ˆæˆªå–å…³é”®éƒ¨åˆ†ï¼‰ï¼š</p><p><img src="img/QQæˆªå›¾20191121170401.png" alt="QQæˆªå›¾20191120154051.png"></p><p><img src="img/QQæˆªå›¾20191121170425.png" alt="QQæˆªå›¾20191120154144.png"></p><p><img src="img/QQæˆªå›¾20191121170512.png" alt="QQæˆªå›¾20191120154249.png"></p><p>å¯ä»¥çœ‹åˆ°å•å…ƒæµ‹è¯•åŠæ‰“åŒ…æˆåŠŸã€‚</p><h3 id="æ„å»ºé•œåƒåŠæ¨é€"><a href="#æ„å»ºé•œåƒåŠæ¨é€" class="headerlink" title="æ„å»ºé•œåƒåŠæ¨é€"></a>æ„å»ºé•œåƒåŠæ¨é€</h3><p>é•œåƒæ„å»ºå’Œæ¨é€æ¶‰åŠå‘½ä»¤è¾ƒå¤šï¼Œæ‰€ä»¥å¯ä»¥å®šä¹‰ä¸€ä¸ªè„šæœ¬ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim build_push.sh</span><br></pre></td></tr></table></figure><p></p><p>è„šæœ¬å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">MODULE=$1</span><br><span class="line">TIME=`date &quot;+%Y%m%d%H%M&quot;`</span><br><span class="line">GIT_REVISION=`git log -1 --pretty=format:&quot;%h&quot;`</span><br><span class="line">IMAGE_NAME=docker.mrbird.cc/febs/$&#123;MODULE&#125;:$&#123;TIME&#125;_$&#123;GIT_REVISION&#125;</span><br><span class="line"></span><br><span class="line">docker build -t $&#123;IMAGE_NAME&#125; .</span><br><span class="line"></span><br><span class="line">docker push $&#123;IMAGE_NAME&#125;</span><br><span class="line"></span><br><span class="line">echo &quot;$&#123;IMAGE_NAME&#125;&quot; &gt; image_name</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢è„šæœ¬å®šä¹‰äº†ä¸‰ä¸ªå˜é‡ï¼š</p><ol><li><p>MODULEï¼Œæ¨¡å—åç§°ï¼Œç”±è„šæœ¬æ‰§è¡Œçš„æ—¶å€™ä¼ å…¥ï¼›</p></li><li><p>TIMEï¼Œæ—¶é—´å­—ç¬¦ä¸²ï¼›</p></li><li><p>GIT_REVISIONï¼Œgit æäº¤å†å²å“ˆå¸Œç çš„å‰7ä½ï¼›</p></li><li><p>IMAGE_NAMEï¼Œé•œåƒåç§°ã€‚</p></li></ol><p>è„šæœ¬åšçš„äº‹æƒ…å¾ˆç®€å•ï¼Œæ ¹æ®å½“å‰ç›®å½•çš„Dockerfileæ„å»ºDockeré•œåƒï¼Œç„¶åå°†é•œåƒæ¨é€åˆ°Harborä»“åº“ï¼Œæ¨é€åï¼Œå°†é•œåƒåç§°å†™åˆ°å½“å‰ç›®å½•ä¸‹çš„image_nameæ–‡ä»¶ä¸­ï¼ˆä¾›åç»­ä½¿ç”¨ï¼‰ã€‚</p><p>ç»™è„šæœ¬æ·»åŠ å¯æ‰§è¡Œæƒé™ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x build_push.sh</span><br></pre></td></tr></table></figure><p></p><p>ä¿®æ”¹Pipeline scriptï¼Œæ–°å¢æ„å»ºé•œåƒåŠæ¨é€é˜¶æ®µå‘½ä»¤ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#!groovy</span><br><span class="line">pipeline &#123;</span><br><span class="line">  agent any</span><br><span class="line">  environment &#123;</span><br><span class="line">    REPOSITORY=&quot;ssh://git@gitlab.mrbird.cc:2223/mrbird/demo.git&quot;</span><br><span class="line">    SCRIPT_PATH=&quot;/home/vagrant/bash&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  stages &#123;</span><br><span class="line">    stage(&apos;æ‹‰å–ä»£ç &apos;) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        echo &quot;ä»GitLabåœ°å€$&#123;REPOSITORY&#125;æ‹‰å–ä»£ç &quot;</span><br><span class="line">        deleteDir()</span><br><span class="line">        git &quot;$&#123;REPOSITORY&#125;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(&apos;ä»£ç ç¼–è¯‘åŠå•å…ƒæµ‹è¯•&apos;) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        echo &quot;å¼€å§‹ç¼–è¯‘ä»£ç å’Œå•å…ƒæµ‹è¯•&quot;</span><br><span class="line">        sh &quot;mvn -U -am clean package&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(&apos;Dockeré•œåƒæ„å»ºåŠæ¨é€&apos;) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        echo &quot;å¼€å§‹æ„å»ºDockeré•œåƒå¹¶æ¨é€åˆ°Harbor&quot;</span><br><span class="line">        sh &quot;$&#123;SCRIPT_PATH&#125;/build_push.sh demo&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å…¶ä¸­<code>SCRIPT_PATH</code>æ˜¯ä¸Šé¢å®šä¹‰çš„è„šæœ¬çš„è·¯å¾„ã€‚</p><p>ä¿®æ”¹å¥½Pipeline scriptï¼Œé‡æ–°ç‚¹å‡»<strong>ç«‹å³æ„å»º</strong>ï¼Œæˆªå–å’Œè¿™éƒ¨åˆ†ç›¸å…³çš„æ—¥å¿—ï¼š</p><p><img src="img/20191121184651.png" alt="20191121184651.png"></p><p>æŸ¥çœ‹é•œåƒåˆ—è¡¨ï¼š</p><p><img src="img/QQæˆªå›¾20191121184855.png" alt="QQæˆªå›¾20191121184855.png"></p><p><img src="img/QQæˆªå›¾20191121184943.png" alt="QQæˆªå›¾20191121184943.png"></p><h3 id="Kubernetes-Deploymentå‡çº§"><a href="#Kubernetes-Deploymentå‡çº§" class="headerlink" title="Kubernetes Deploymentå‡çº§"></a>Kubernetes Deploymentå‡çº§</h3><p>åœ¨<code>/home/vagrant/bash</code>ç›®å½•ä¸‹æ–°å»ºdeploy.shè„šæœ¬ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">IMAGE=`cat image_name`</span><br><span class="line"></span><br><span class="line">kubectl set image deployment/demo-deployment demo=$&#123;IMAGE&#125;</span><br></pre></td></tr></table></figure><p></p><p>è„šæœ¬å†…å®¹å¾ˆç®€å•ï¼Œå°±æ˜¯é€šè¿‡kubectlå‘½ä»¤å‡çº§ç›¸å…³Podçš„é•œåƒï¼Œé•œåƒåç§°ä»image_nameæ–‡ä»¶ä¸­è¯»å–ã€‚</p><p>ä¿®æ”¹Pipeline scriptï¼Œæ·»åŠ Kubernetes Deploymentå‡çº§é˜¶æ®µå‘½ä»¤ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!groovy</span></span><br><span class="line">pipeline &#123;</span><br><span class="line">  agent any</span><br><span class="line">  environment &#123;</span><br><span class="line">    REPOSITORY=<span class="string">"ssh://git@gitlab.mrbird.cc:2223/mrbird/demo.git"</span></span><br><span class="line">    SCRIPT_PATH=<span class="string">"/home/vagrant/bash"</span></span><br><span class="line">  &#125;</span><br><span class="line">  stages &#123;</span><br><span class="line">    stage(<span class="string">'æ‹‰å–ä»£ç '</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"ä»GitLabåœ°å€<span class="variable">$&#123;REPOSITORY&#125;</span>æ‹‰å–ä»£ç "</span></span><br><span class="line">        deleteDir()</span><br><span class="line">        git <span class="string">"<span class="variable">$&#123;REPOSITORY&#125;</span>"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'ä»£ç ç¼–è¯‘åŠå•å…ƒæµ‹è¯•'</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"å¼€å§‹ç¼–è¯‘ä»£ç å’Œå•å…ƒæµ‹è¯•"</span></span><br><span class="line">        sh <span class="string">"mvn -U -am clean package"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Dockeré•œåƒæ„å»ºåŠæ¨é€'</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"å¼€å§‹æ„å»ºDockeré•œåƒå¹¶æ¨é€åˆ°Harbor"</span></span><br><span class="line">        sh <span class="string">"<span class="variable">$&#123;SCRIPT_PATH&#125;</span>/build_push.sh demo"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'æ›´æ–°Kubernetes Deployment'</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"å¼€å§‹æ›´æ–°Kubernetes Deployment"</span></span><br><span class="line">        sh <span class="string">"<span class="variable">$&#123;SCRIPT_PATH&#125;</span>/deploy.sh"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¿®æ”¹åï¼Œç‚¹å‡»<strong>ç«‹å³æ„å»º</strong>ï¼š</p><p><img src="img/QQæˆªå›¾20191121192052.png" alt="QQæˆªå›¾20191121192052.png"></p><p>è‡³æ­¤æˆ‘ä»¬æ•´æ¡CICDæµç¨‹å°±å·²ç»éƒ½é€šäº†ï¼Œä¸‹é¢æµ‹è¯•ä¸‹CICDã€‚</p><h2 id="æ•ˆæœæµ‹è¯•"><a href="#æ•ˆæœæµ‹è¯•" class="headerlink" title="æ•ˆæœæµ‹è¯•"></a>æ•ˆæœæµ‹è¯•</h2><p>å¦‚ä¸Šé¢æ‰€ç¤ºï¼Œæˆ‘ä»¬è®¿é—®<a href="http://192.168.33.11:30000/hello" target="_blank" rel="noopener">http://192.168.33.11:30000/hello</a>ï¼Œé¡µé¢è¿”å›hello worldï¼Œæˆ‘ä»¬åœ¨IDEAä¸­ä¿®æ”¹Controlleræ–¹æ³•ï¼š</p><p><img src="img/QQæˆªå›¾20191121190234.png" alt="QQæˆªå›¾20191121190234.png"></p><p>åŒæ—¶ä¿®æ”¹å•å…ƒæµ‹è¯•æ–¹æ³•ï¼š</p><p><img src="img/QQæˆªå›¾20191121190318.png" alt="QQæˆªå›¾20191121190318.png"></p><p>ä¿®æ”¹ååœ¨IDEAçš„å‘½ä»¤çª—å£è¾“å…¥ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git commit -am update</span><br><span class="line"></span><br><span class="line">git push origin master</span><br></pre></td></tr></table></figure><p></p><p>å°†æœ€æ–°çš„ä»£ç æäº¤åˆ°GitLabåï¼Œè¿‡ä¸€å°ä¼šåˆ·æ–°<a href="http://192.168.33.11:30000/hello" target="_blank" rel="noopener">http://192.168.33.11:30000/hello</a>ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä¿®æ”¹çš„å†…å®¹å·²ç»ç”Ÿæ•ˆäº†ï¼š</p><p><img src="img/QQæˆªå›¾20191121191654.png" alt="QQæˆªå›¾20191121191654.png"></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;CICDï¼ˆ&lt;strong&gt;C&lt;/strong&gt;ontinuous &lt;strong&gt;I&lt;/strong&gt;ntegration/&lt;strong&gt;C&lt;/strong&gt;ontinuous &lt;strong&gt;D&lt;/strong&gt;eploymentï¼‰ï¼ŒæŒç»­é›†æˆæŒç»­éƒ¨ç½²çš„æ„æ€ã€‚å®ŒæˆCICDå®è·µéœ€è¦Kubernetesé›†ç¾¤ï¼ŒHarborï¼ŒGitLabå’ŒJenkinsç­‰è½¯ä»¶é…åˆå®Œæˆï¼Œåœ¨å‰é¢å‡ ç¯‡åšå®¢ä¸­ï¼Œæˆ‘å·²ç»æ­å»ºå¥½äº†Kubernetesé›†ç¾¤ï¼Œå¹¶ä¸”åœ¨masterèŠ‚ç‚¹ï¼ˆ192.168.33.11,CentOSï¼‰ä¸Šå®‰è£…å¥½äº†Harborã€GitLabå’ŒJenkinsï¼Œæœ‰éœ€è¦å¯ä»¥å‚è€ƒä¸‹ã€‚
    
    </summary>
    
    
      <category term="GitLab" scheme="http://mrbird.cc/tags/GitLab/"/>
    
      <category term="CI/CD" scheme="http://mrbird.cc/tags/CI-CD/"/>
    
      <category term="DevOps" scheme="http://mrbird.cc/tags/DevOps/"/>
    
      <category term="Harbor" scheme="http://mrbird.cc/tags/Harbor/"/>
    
      <category term="Kubernetes" scheme="http://mrbird.cc/tags/Kubernetes/"/>
    
      <category term="Jenkins" scheme="http://mrbird.cc/tags/Jenkins/"/>
    
  </entry>
  
  <entry>
    <title>GitLab &amp; Jenkinså®‰è£…å°è®°</title>
    <link href="http://mrbird.cc/GitLab-Jenkins-Install-Note.html"/>
    <id>http://mrbird.cc/GitLab-Jenkins-Install-Note.html</id>
    <published>2019-11-15T02:07:01.000Z</published>
    <updated>2019-11-23T06:13:43.425Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --><p>åœ¨CentOSä¸‹å®‰è£…GitLabå’ŒJenkinsã€‚<a id="more"></a></p><h2 id="å®‰è£…GitLab"><a href="#å®‰è£…GitLab" class="headerlink" title="å®‰è£…GitLab"></a>å®‰è£…GitLab</h2><p>ä¼ ç»Ÿæ–¹å¼å®‰è£…GitLabæ¯”è¾ƒéº»çƒ¦ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨Dockerå®‰è£…GitLabï¼Œæ‹‰å–å®˜æ–¹é•œåƒï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull gitlab/gitlab-ce:latest</span><br></pre></td></tr></table></figure><p></p><p>é•œåƒæœ‰ç‚¹å¤§ï¼Œè€å¿ƒç­‰å¾…ã€‚æ‹‰å–å¥½åï¼Œç¼–å†™ä¸€ä¸ªå¯åŠ¨è„šæœ¬ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; run_gitlab.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">docker stop gitlab</span><br><span class="line">docker rm gitlab</span><br><span class="line">docker run -d \</span><br><span class="line">    --hostname gitlab.mrbird.cc \</span><br><span class="line">    -p 8443:443 -p 8080:80 -p 2223:22 \</span><br><span class="line">    --name gitlab \</span><br><span class="line">    -v /gitlab/config:/etc/gitlab \</span><br><span class="line">    -v /gitlab/logs:/var/log/gitlab \</span><br><span class="line">    -v /gitlab/data:/var/opt/gitlab \</span><br><span class="line">    gitlab/gitlab-ce:latest</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p></p><p><code>--hostname gitlab.mrbird.cc</code>ç»‘å®šåŸŸåï¼Œç«¯å£æ˜ å°„äº†ä¸‹ï¼Œé˜²æ­¢å’Œå®¿ä¸»æœºå†²çªã€‚</p><p>æ‰§è¡Œ<code>chmod u+x run_gitlab.sh</code>æ·»åŠ å¯æ‰§è¡Œæƒé™ï¼Œç„¶åè¿è¡Œ<code>sh run_gitlab.sh</code>å¯åŠ¨GitLabã€‚</p><p>æ‰§è¡Œå¯åŠ¨è„šæœ¬åï¼Œä½¿ç”¨<code>docker logs -f gitlab</code>æŸ¥çœ‹å¯åŠ¨æ—¥å¿—ï¼Œç¬¬ä¸€æ¬¡å¯åŠ¨æ¯”è¾ƒæ…¢ï¼Œå½“æ—¥å¿—å®šæ—¶è¾“å‡º<code>/metrics</code>å†…å®¹æ—¶è¯´æ˜GitLabå·²å¯åŠ¨å®Œæ¯•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">==&gt; /var/log/gitlab/gitlab-rails/sidekiq_exporter.log &lt;==</span><br><span class="line">[2019-11-03T03:35:18.170+0000] 127.0.0.1 - - [03/Nov/2019:03:35:18 UTC] &quot;GET /metrics HTTP/1.1&quot; 200 6162 &quot;-&quot; &quot;Prometheus/2.12.0&quot;</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨åï¼Œä¿®æ”¹gitlab.rbæ–‡ä»¶ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /gitlab/config/gitlab.rb</span><br></pre></td></tr></table></figure><p></p><p>å¼€å¯è¿™æ®µé…ç½®ï¼Œå¹¶ä¸”ç«¯å£å·æ”¹ä¸ºä¸Šé¢æŒ‡å®šçš„2223ï¼š</p><p><img src="img/QQæˆªå›¾20191116202324.png" alt="QQæˆªå›¾20191116202324.png"></p><p>ç„¶åæ‰§è¡Œ<code>sh run_gitlab.sh</code>é‡å¯å³å¯ã€‚</p><p>é‡å¯åï¼Œåœ¨è™šæ‹Ÿæœºå’Œwindowsé‡Œæ·»åŠ hostsè§£æï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.33.11 gitlab.mrbird.cc</span><br></pre></td></tr></table></figure><p></p><p>ä½¿ç”¨æµè§ˆå™¨è®¿é—®<a href="http://gitlab.mrbird.cc:8080/" target="_blank" rel="noopener">http://gitlab.mrbird.cc:8080/</a>ï¼š</p><p><img src="img/QQæˆªå›¾20191116202636.png" alt="QQæˆªå›¾20191116202636.png"></p><p>GitLabè¿˜æ˜¯æ¯”è¾ƒå å†…å­˜çš„ï¼Œåœ¨å®‰è£…GitLabå‰è¯·ç¡®ä¿å†…å­˜å¤Ÿç”¨ğŸŒšï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker stats gitlab</span><br><span class="line"></span><br><span class="line">CONTAINER ID        NAME                CPU %               MEM USAGE / LIMIT     MEM %               NET I/O             BLOCK I/O           PIDS</span><br><span class="line">d8edbda28f9f        gitlab              6.80%               1.944GiB / 3.701GiB   52.54%              130kB / 2.29MB      118MB / 2.52MB      281</span><br></pre></td></tr></table></figure><p></p><h2 id="å®‰è£…Jenkins"><a href="#å®‰è£…Jenkins" class="headerlink" title="å®‰è£…Jenkins"></a>å®‰è£…Jenkins</h2><p>Jenkinsçš„è¯ï¼Œæ¨èç”¨ä¼ ç»Ÿæ–¹å¼å®‰è£…ï¼Œè¿™æ ·å®¿ä¸»æœºä¸Šå®‰è£…çš„mavenã€dockerã€kubectlç­‰å‘½ä»¤å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚</p><p>åœ¨å®‰è£…Jenkinsä¹‹å‰ï¼Œéœ€è¦æœ‰Javaï¼ˆæˆ‘å®‰è£…çš„æ˜¯1.8ç‰ˆæœ¬ï¼‰ç¯å¢ƒï¼Œåœ¨CentOS7ä¸Šå®‰è£…JDKçš„è¿‡ç¨‹å°±ä¸æ¼”ç¤ºäº†ï¼Œä¹‹å‰åœ¨<a href="https://mrbird.cc/FEBS-Vue-Document.html">https://mrbird.cc/FEBS-Vue-Document.html</a>ä¸­ä¹Ÿæœ‰ä»‹ç»è¿‡ã€‚å®‰è£…å¥½JDKåï¼Œä¸‹è½½Jenkins waråŒ…ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://mirrors.jenkins.io/war-stable/latest/jenkins.war</span><br></pre></td></tr></table></figure><p></p><p>ç¼–å†™ä¸€ä¸ªå¯åŠ¨è„šæœ¬run_jenkins.shï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim run_jenkins.sh</span><br></pre></td></tr></table></figure><p></p><p>å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">nohup java -jar jenkins.war --httpPort=8081 &amp;</span><br></pre></td></tr></table></figure><p></p><p>æˆæƒï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod u+x run_jenkins.sh</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨Jenkinsï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh run_jenkins.sh</span><br></pre></td></tr></table></figure><p></p><p>å½“å¯åŠ¨æ—¥å¿—è¾“å‡ºå¦‚ä¸‹å†…å®¹æ—¶ï¼Œè¯´æ˜jenkinså·²æˆåŠŸå¯åŠ¨ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">*************************************************************</span><br><span class="line">*************************************************************</span><br><span class="line">*************************************************************</span><br><span class="line"></span><br><span class="line">Jenkins initial setup is required. An admin user has been created and a password generated.</span><br><span class="line">Please use the following password to proceed to installation:</span><br><span class="line"></span><br><span class="line">6ddc10e56b574f27a360986f84da19fc</span><br><span class="line"></span><br><span class="line">This may also be found at: /root/.jenkins/secrets/initialAdminPassword</span><br><span class="line"></span><br><span class="line">*************************************************************</span><br><span class="line">*************************************************************</span><br><span class="line">*************************************************************</span><br></pre></td></tr></table></figure><p></p><p>å…¶ä¸­<code>6ddc10e56b574f27a360986f84da19fc</code>ä¸ºJenkinsçš„å¯†ç ï¼Œè¯¥å¯†ç ä¹Ÿå¯ä»¥åœ¨/root/.jenkins/secrets/initialAdminPasswordæ–‡ä»¶æ‰¾åˆ°ã€‚</p><p>ä½¿ç”¨æµè§ˆå™¨è®¿é—®<a href="http://192.168.33.11:8081/" target="_blank" rel="noopener">http://192.168.33.11:8081/</a>ï¼š</p><p><img src="img/QQæˆªå›¾20191121085911.png" alt="QQæˆªå›¾20191115145623.png"></p><p>è¾“å…¥ä¸Šé¢çš„å¯†ç ï¼Œè¿›å…¥ï¼š</p><p><img src="img/QQæˆªå›¾20191115145856.png" alt="QQæˆªå›¾20191115145856.png"></p><p>ç‚¹å‡»â€œé€‰æ‹©æ’ä»¶å®‰è£…â€ï¼Œç„¶å<strong>Pipelines and Continuous Delivery</strong>ä¸€æ ä¸­çš„æ‰€æœ‰æ’ä»¶éƒ½å‹¾é€‰ä¸Šï¼š</p><p><img src="img/QQæˆªå›¾20191115150023.png" alt="QQæˆªå›¾20191115150023.png"></p><p>ç„¶åç‚¹å‡»å®‰è£…å³å¯ï¼Œå®‰è£…ç»“æŸåï¼Œæ¥ç€åˆ›å»ºç”¨æˆ·ï¼š</p><p><img src="img/QQæˆªå›¾20191115155632.png" alt="QQæˆªå›¾20191115155632.png"></p><p>ç‚¹å‡»é‡å¯ï¼š</p><p><img src="img/QQæˆªå›¾20191115160201.png" alt="QQæˆªå›¾20191115160201.png"></p><p>ç”¨åˆšåˆšåˆ›å»ºçš„ç”¨æˆ·ç™»å½•å³å¯ï¼š</p><p><img src="img/QQæˆªå›¾20191115160710.png" alt="QQæˆªå›¾20191115160710.png"></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;åœ¨CentOSä¸‹å®‰è£…GitLabå’ŒJenkinsã€‚
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>æ­å»ºDockeré•œåƒä»“åº“Harbor</title>
    <link href="http://mrbird.cc/Harbor.html"/>
    <id>http://mrbird.cc/Harbor.html</id>
    <published>2019-11-14T02:15:50.000Z</published>
    <updated>2019-11-16T10:13:18.196Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --><p>Harboræ˜¯ä¸€æ¬¾å¼€æºçš„Dockeré•œåƒå­˜å‚¨ä»“åº“ï¼Œå…¶æ‰©å±•äº†Docker Distributionï¼Œåœ¨æ­¤åŸºç¡€ä¸Šæ·»åŠ äº†æˆ‘ä»¬å¸¸ç”¨çš„åŠŸèƒ½ï¼Œæ¯”å¦‚å®‰å…¨è®¤è¯ï¼ŒRBACç”¨æˆ·æƒé™ç®¡ç†ï¼Œå¯è§†åŒ–é¡µé¢æ“ä½œç­‰åŠŸèƒ½ã€‚Harborè¿˜æ”¯æŒå¤šä¸ªHarborä»“åº“é—´çš„ç›¸äº’æ‹·è´ï¼Œä»¥å®ç°Dockeré•œåƒä»“åº“çš„é«˜å¯ç”¨ã€‚è¿™èŠ‚æˆ‘ä»¬åœ¨CentOSè™šæ‹Ÿæœºï¼ˆ192.168.33.11ï¼‰ä¸Šæ­å»ºä¸ªå•æœºç‰ˆçš„Harborä½“éªŒä¸€ä¸‹ã€‚<a id="more"></a></p><h2 id="å®‰è£…Harbor"><a href="#å®‰è£…Harbor" class="headerlink" title="å®‰è£…Harbor"></a>å®‰è£…Harbor</h2><p>åœ¨Harborçš„GitHubä»“åº“ï¼š<a href="https://github.com/goharbor/harbor/releases" target="_blank" rel="noopener">https://github.com/goharbor/harbor/releases</a>ä¸‹è½½ç¦»çº¿ç‰ˆæœ¬ï¼ˆofflineï¼‰ï¼Œæˆ‘é€‰æ‹©çš„ç‰ˆæœ¬æ˜¯1.8.4ï¼š</p><p><img src="img/QQæˆªå›¾20191114145009.png" alt="QQæˆªå›¾20191114145009.png"></p><p>ä¸‹è½½åï¼Œå°†å‹ç¼©åŒ…harbor-offline-installer-v1.8.4.tgzä¸Šä¼ åˆ°192.168.33.11æœåŠ¡å™¨ä¸Šï¼š</p><p><img src="img/QQæˆªå›¾20191114164739.png" alt="QQæˆªå›¾20191114164739.png"></p><p>è§£å‹å‹ç¼©åŒ…ï¼š</p><p><img src="img/QQæˆªå›¾20191114164856.png" alt="QQæˆªå›¾20191114150144.png"></p><p>ä¿®æ”¹Harboré…ç½®æ–‡ä»¶ï¼š</p><p><img src="img/QQæˆªå›¾20191114164934.png" alt="QQæˆªå›¾20191114150253.png"></p><p>å°†hostnameä¿®æ”¹ä¸ºå®¿ä¸»æœºIPå³å¯ï¼š</p><p><img src="img/QQæˆªå›¾20191114165021.png" alt="QQæˆªå›¾20191114150354.png"></p><p>ç„¶åæ‰§è¡Œå½“å‰ç›®å½•ä¸‹çš„install.shè„šæœ¬è¿›è¡Œå®‰è£…ã€‚</p><p>å®‰è£…è¿‡ç¨‹ä¸­å‡ºç°å¦‚ä¸‹é”™è¯¯ï¼š</p><p><img src="img/QQæˆªå›¾20191114150640.png" alt="QQæˆªå›¾20191114150640.png"></p><p>æ ¹æ®<a href="https://docs.docker.com/compose/install/" target="_blank" rel="noopener">https://docs.docker.com/compose/install/</a>å®‰è£…docker composeåé‡æ–°æ‰§è¡Œinstall.shè„šæœ¬ã€‚</p><p>å‡ºç°å¦‚ä¸‹ä¿¡æ¯æ—¶ï¼Œå®‰è£…æˆåŠŸ:</p><p><img src="img/QQæˆªå›¾20191114165532.png" alt="QQæˆªå›¾20191114151457.png"></p><p>ä½¿ç”¨æµè§ˆå™¨è®¿é—®<a href="http://192.168.33.11/" target="_blank" rel="noopener">http://192.168.33.11/</a>åœ°å€ï¼Œå¯ä»¥çœ‹åˆ°Harborçš„ç®¡ç†ç•Œé¢ï¼š</p><p><img src="img/QQæˆªå›¾20191114165616.png" alt="QQæˆªå›¾20191114151916.png"></p><p>é»˜è®¤çš„ç”¨æˆ·åå¯†ç ä¸ºï¼šadminï¼ŒHarbor12345ï¼Œç™»å½•åï¼š</p><p><img src="img/QQæˆªå›¾20191114165700.png" alt="QQæˆªå›¾20191114152147.png"></p><p>ä¸ºäº†åç»­æ¨é€é•œåƒæ–¹ä¾¿ï¼Œæˆ‘ä»¬éœ€è¦ç»™192.168.33.11é…ç½®åŸŸåï¼Œæ·»åŠ hostsè§£æï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.33.11 docker.mrbird.cc</span><br></pre></td></tr></table></figure><p></p><h2 id="åˆ›å»ºç”¨æˆ·å’Œé¡¹ç›®"><a href="#åˆ›å»ºç”¨æˆ·å’Œé¡¹ç›®" class="headerlink" title="åˆ›å»ºç”¨æˆ·å’Œé¡¹ç›®"></a>åˆ›å»ºç”¨æˆ·å’Œé¡¹ç›®</h2><p>åœ¨<a href="http://192.168.33.11/" target="_blank" rel="noopener">http://192.168.33.11/</a>Harborç®¡ç†ç•Œé¢ä¸‹æ–°å¢ä¸€ä¸ªç”¨æˆ·ï¼š</p><p><img src="img/QQæˆªå›¾20191114165828.png" alt="QQæˆªå›¾20191114154608.png"></p><p><img src="img/QQæˆªå›¾20191114165905.png" alt="QQæˆªå›¾20191114154646.png"></p><p>ç„¶åæ–°å¢ä¸€ä¸ªé¡¹ç›®ï¼š</p><p><img src="img/QQæˆªå›¾20191114165952.png" alt="QQæˆªå›¾20191114154755.png"></p><p><img src="img/QQæˆªå›¾20191114170013.png" alt="QQæˆªå›¾20191114154830.png"></p><p>åœ¨è¯¥é¡¹ç›®ä¸‹æ·»åŠ åˆšåˆšåˆ›å»ºçš„mrbirdç”¨æˆ·ï¼š</p><p><img src="img/QQæˆªå›¾20191114170054.png" alt="QQæˆªå›¾20191114155249.png"></p><p><img src="img/QQæˆªå›¾20191114170137.png" alt="QQæˆªå›¾20191114155318.png"></p><p>æ¥ç€åœ¨192.168.33.11ä¸Šè¿›è¡Œç™»å½•:</p><p><img src="img/QQæˆªå›¾20191114170510.png" alt="QQæˆªå›¾20191114170510.png"></p><p>ç”¨æˆ·åå’Œå¯†ç å°±æ˜¯åˆšåˆšåœ¨æ§åˆ¶å°åˆ›å»ºçš„mrbirdç”¨æˆ·å’Œå¯†ç ã€‚ä½†æ˜¯ç™»å½•å¤±è´¥äº†ï¼Œè¦ç™»å½•åˆ°http dockerä»“åº“ï¼Œéœ€è¦æ·»åŠ ä¸€äº›é…ç½®ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/docker/daemon.json</span><br></pre></td></tr></table></figure><p></p><p>æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><p><img src="img/QQæˆªå›¾20191114170718.png" alt="QQæˆªå›¾20191114170718.png"></p><p>é‡å¯dockerï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service docker restart</span><br></pre></td></tr></table></figure><p></p><p>ç„¶åé‡æ–°ç™»å½•å³å¯ï¼š</p><p><img src="img/QQæˆªå›¾20191114171254.png" alt="QQæˆªå›¾20191114171254.png"></p><h2 id="æµ‹è¯•é•œåƒæ¨æ‹‰"><a href="#æµ‹è¯•é•œåƒæ¨æ‹‰" class="headerlink" title="æµ‹è¯•é•œåƒæ¨æ‹‰"></a>æµ‹è¯•é•œåƒæ¨æ‹‰</h2><p>æ‹‰å–nginx:1.17.5é•œåƒï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull nginx:1.17.5</span><br></pre></td></tr></table></figure><p></p><p>æ‰“æ ‡ç­¾:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker tag nginx:1.17.5 docker.mrbird.cc/febs/nginx:1.17.5</span><br></pre></td></tr></table></figure><p></p><p>æ ‡ç­¾æ ¼å¼ä¸º[dockerä»“åº“åŸŸå]:[é¡¹ç›®åç§°]:[é•œåƒ]ã€‚</p><p>å°†docker.mrbird.cc/febs/nginx:1.17.5æ¨é€åˆ°Harborï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push docker.mrbird.cc/febs/nginx</span><br></pre></td></tr></table></figure><p></p><p>å›åˆ°Harboræ§åˆ¶å°ï¼Œå¯ä»¥çœ‹åˆ°åœ¨febsé¡¹ç›®ä¸‹å·²ç»å­˜åœ¨ä¸€ä¸ªnginxé•œåƒï¼š</p><p><img src="img/QQæˆªå›¾20191114171855.png" alt="QQæˆªå›¾20191114171855.png"></p><p>åœ¨192.168.33.12æœåŠ¡å™¨ä¸Šæ·»åŠ docker.mrbird.ccçš„è§£æï¼Œç„¶åæ‹‰å–åˆšåˆšçš„é•œåƒï¼Œçœ‹çœ‹æ˜¯å¦æˆåŠŸï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker.mrbird.cc/febs/nginx:1.17.5</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20191114172154.png" alt="QQæˆªå›¾20191114172154.png"></p><p>æ‹‰å–æˆåŠŸã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;Harboræ˜¯ä¸€æ¬¾å¼€æºçš„Dockeré•œåƒå­˜å‚¨ä»“åº“ï¼Œå…¶æ‰©å±•äº†Docker Distributionï¼Œåœ¨æ­¤åŸºç¡€ä¸Šæ·»åŠ äº†æˆ‘ä»¬å¸¸ç”¨çš„åŠŸèƒ½ï¼Œæ¯”å¦‚å®‰å…¨è®¤è¯ï¼ŒRBACç”¨æˆ·æƒé™ç®¡ç†ï¼Œå¯è§†åŒ–é¡µé¢æ“ä½œç­‰åŠŸèƒ½ã€‚Harborè¿˜æ”¯æŒå¤šä¸ªHarborä»“åº“é—´çš„ç›¸äº’æ‹·è´ï¼Œä»¥å®ç°Dockeré•œåƒä»“åº“çš„é«˜å¯ç”¨ã€‚è¿™èŠ‚æˆ‘ä»¬åœ¨CentOSè™šæ‹Ÿæœºï¼ˆ192.168.33.11ï¼‰ä¸Šæ­å»ºä¸ªå•æœºç‰ˆçš„Harborä½“éªŒä¸€ä¸‹ã€‚
    
    </summary>
    
    
      <category term="Harbor" scheme="http://mrbird.cc/tags/Harbor/"/>
    
      <category term="Docker" scheme="http://mrbird.cc/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetesèµ„æºç®¡ç†</title>
    <link href="http://mrbird.cc/Kubernetes-Resource-Management.html"/>
    <id>http://mrbird.cc/Kubernetes-Resource-Management.html</id>
    <published>2019-11-09T04:52:56.000Z</published>
    <updated>2019-11-16T10:13:18.198Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --><p>é€šè¿‡å‰é¢çš„å­¦ä¹ æˆ‘ä»¬çŸ¥é“ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡requestså’Œlimitsç»™PodæŒ‡å®šèµ„æºé…ç½®ï¼Œä½†å¦‚æœæ¯ä¸ªPodéƒ½è¦æŒ‡å®šçš„è¯ç•¥æ˜¾ç¹çï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨LimitRangeæŒ‡å®šä¸€ä¸ªå…¨å±€çš„é»˜è®¤é…ç½®ï¼›æ­¤å¤–é€šè¿‡ResourceQuotaå¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰èµ„æºé…é¢ï¼Œè¿™ä¸ªèµ„æºé…é¢å¯ä»¥ä¸ºæ¯ä¸ªå‘½åç©ºé—´éƒ½æä¾›ä¸€ä¸ªæ€»ä½“çš„èµ„æºä½¿ç”¨çš„é™åˆ¶ï¼šå®ƒå¯ä»¥é™åˆ¶å‘½åç©ºé—´ä¸­æŸç§ç±»å‹çš„å¯¹è±¡çš„æ€»æ•°ç›®ä¸Šé™ï¼Œä¹Ÿå¯ä»¥è®¾ç½®å‘½åç©ºé—´ä¸­Podå¯ä»¥ä½¿ç”¨çš„è®¡ç®—èµ„æºçš„æ€»ä¸Šé™ã€‚</p><a id="more"></a><h2 id="LimitRange"><a href="#LimitRange" class="headerlink" title="LimitRange"></a>LimitRange</h2><p>åœ¨ä½¿ç”¨LimitRangeä¹‹å‰å…ˆåˆ›å»ºä¸€ä¸ªå‘½åç©ºé—´ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: test-resource</span><br></pre></td></tr></table></figure><p></p><p>ç„¶åå®šä¹‰LimitRangeé…ç½®ï¼ˆlimit-range.ymlï¼‰:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">limit-range-example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  limits:</span></span><br><span class="line"><span class="attr">    - max:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">2</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">      min:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">200</span><span class="string">m</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">6</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">      maxLimitRequestRatio:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">    - default:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">300</span><span class="string">m</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">200</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">      defaultRequest:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">200</span><span class="string">m</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">100</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">      max:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">      min:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">100</span><span class="string">m</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">3</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">      maxLimitRequestRatio:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">        memory:</span> <span class="number">4</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">Container</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥LimitRangeï¼š</p><p><img src="img/QQæˆªå›¾20191112092850.png" alt="QQæˆªå›¾20191112092850.png"></p><p>å¯ä»¥çœ‹åˆ°é…ç½®å·²ç»ç”Ÿæ•ˆäº†ã€‚ä¸‹é¢ä»‹ç»ä¸‹è¿™äº›é…ç½®çš„å«ä¹‰ï¼š</p><p>ä¸Šé¢é…ç½®åˆ†ä¸ºPodå’ŒContaineré…ç½®ï¼ŒContainerèµ„æºé…ç½®å¯¹åº”æ¯ä¸ªDockerå®¹å™¨çš„èµ„æºé…ç½®ï¼ŒPodèµ„æºé…ç½®å¯¹åº”ä¸€ä¸ªPodä¸­æ‰€æœ‰å®¹å™¨èµ„æºçš„æ€»å’Œã€‚å…¶ä¸­Podå’ŒContaineréƒ½å¯ä»¥æŒ‡å®š<code>min</code>ï¼Œ<code>max</code>å’Œ<code>maxLimitRequestRatio</code>ï¼š</p><ol><li><p><code>min</code>ï¼šæŒ‡å®šèµ„æºçš„ä¸‹é™ï¼Œå³æœ€ä½èµ„æºé…ç½®ä¸èƒ½ä½äºè¿™ä¸ªå€¼ï¼›</p></li><li><p><code>max</code>ï¼šæŒ‡å®šèµ„æºçš„ä¸Šé™ï¼Œå³æœ€é«˜èµ„æºä½¿ç”¨ä¸èƒ½é«˜äºè¿™ä¸ªå€¼ï¼›</p></li><li><p><code>maxLimitRequestRatio</code>ï¼šè¯¥å€¼ç”¨äºæŒ‡å®šrequestså’Œlimitså€¼æ¯”ä¾‹çš„ä¸Šé™ã€‚</p></li></ol><p>ç›¸è¾ƒäºPodï¼ŒContainerè¿˜å¯ä»¥æŒ‡å®š<code>defaultRequest</code>å’Œ<code>default</code>ï¼ˆå®é™…ä¸Šå°±æ˜¯<code>defaultLimit</code>ï¼Œä¸æ‡‚ä¸ºä»€ä¹ˆKubernetesä¸ç”¨è¿™ä¸ªåç§°ğŸ˜µï¼‰ï¼š</p><ol><li><p><code>defaultRequest</code>ï¼šå…¨å±€å®¹å™¨çš„é»˜è®¤<code>requests</code>å€¼ï¼›</p></li><li><p><code>default</code>ï¼šå…¨å±€å®¹å™¨çš„é»˜è®¤<code>limits</code>å€¼ã€‚</p></li></ol><p>ä¸‹é¢æˆ‘ä»¬ä¸¾å‡ ä¸ªä¾‹å­ï¼Œçœ‹çœ‹æˆ‘ä»¬åˆ›å»ºçš„LimitRangeæ˜¯å¦ç”Ÿæ•ˆã€‚</p><p>å®šä¹‰ä¸€ä¸ªPodé…ç½®æ–‡ä»¶ï¼ˆtest-default.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test-default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥Podï¼š</p><p><img src="img/QQæˆªå›¾20191112094923.png" alt="QQæˆªå›¾20191112094923.png"></p><p><img src="img/QQæˆªå›¾20191112094959.png" alt="QQæˆªå›¾20191112094959.png"></p><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åœ¨test-default.ymlä¸­å¹¶æ²¡æœ‰å®šä¹‰requestså’Œlimitsé…ç½®ï¼Œä½†æ˜¯é€šè¿‡Podå®ä¾‹çš„yamlå¯ä»¥çœ‹åˆ°å®ƒå·²ç»æŒ‡å®šäº†è¿™ä¸¤ä¸ªå€¼ï¼Œè€Œè¿™äº›æ­£æ˜¯ä¸Šé¢æˆ‘ä»¬åœ¨LimitRangeä¸­å®šä¹‰çš„é»˜è®¤å€¼ã€‚</p><p>æ¥ç€å®šä¹‰ä¸€ä¸ªæ–°çš„Podé…ç½®ï¼ˆtest-max.ymlï¼‰:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test-max</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      resources:</span></span><br><span class="line"><span class="attr">        limits:</span></span><br><span class="line"><span class="attr">          cpu:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">          memory:</span> <span class="number">500</span><span class="string">Mi</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥Podï¼š</p><p><img src="img/QQæˆªå›¾20191112095603.png" alt="QQæˆªå›¾20191112095603.png"></p><p>å¯ä»¥çœ‹åˆ°åœ¨åˆ›å»ºçš„æ—¶å€™å°±æŠ¥é”™äº†ï¼Œå› ä¸ºä¸Šé¢çš„cpué…ç½®å³è¶…è¿‡äº†LimtRangeä¸­å®šä¹‰çš„Containerçš„cpuæœ€é«˜é…ç½®ï¼Œä¹Ÿè¶…è¿‡äº†Podçš„cpuçš„æœ€é«˜é…ç½®ã€‚</p><p>å†åˆ›å»ºä¸€ä¸ªPodé…ç½®ï¼ˆtest-ratio.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test-ratio</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      resources:</span></span><br><span class="line"><span class="attr">        limits:</span></span><br><span class="line"><span class="attr">          cpu:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">          memory:</span> <span class="number">500</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">        requests:</span></span><br><span class="line"><span class="attr">          cpu:</span> <span class="number">300</span><span class="string">m</span></span><br><span class="line"><span class="attr">          memory:</span> <span class="number">50</span><span class="string">Mi</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥Podï¼š</p><p><img src="img/QQæˆªå›¾20191112100308.png" alt="QQæˆªå›¾20191112100308.png"></p><p>å¯ä»¥çœ‹åˆ°ä¹ŸæŠ¥é”™äº†ï¼Œå› ä¸ºrequestså’Œlimitsçš„æ¯”ä¾‹ä¸ç¬¦åˆLimitRangeçš„maxLimitRequestRatioé…ç½®ã€‚</p><p>LimitRangeçš„æµ‹è¯•å…ˆåˆ°è¿™é‡Œå§ï¼Œé€šè¿‡ä¸Šé¢ä¸‰ä¸ªä¾‹å­å¤§ä½“ä¹Ÿèƒ½æ„Ÿå—åˆ°LimitRangeçš„ä½œç”¨äº†ã€‚</p><h2 id="ResourceQuota"><a href="#ResourceQuota" class="headerlink" title="ResourceQuota"></a>ResourceQuota</h2><p>ResourceQuotaç”¨äºç®¡ç†èµ„æºé…é¢ï¼Œè¿™ä¸ªèµ„æºé…é¢å¯ä»¥ä¸ºæ¯ä¸ªå‘½åç©ºé—´éƒ½æä¾›ä¸€ä¸ªæ€»ä½“çš„èµ„æºä½¿ç”¨çš„é™åˆ¶ã€‚èµ„æºé…é¢ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªç±»å‹ï¼š</p><h3 id="è®¡ç®—èµ„æºé…é¢"><a href="#è®¡ç®—èµ„æºé…é¢" class="headerlink" title="è®¡ç®—èµ„æºé…é¢"></a>è®¡ç®—èµ„æºé…é¢</h3><table align="center"><thead><tr><th scope="col">èµ„æºåç§°</th><th scope="col">è¯´æ˜</th></tr></thead><tbody><tr><td>Cpu</td><td>æ‰€æœ‰éç»ˆæ­¢çŠ¶æ€çš„Podï¼ŒCPU Requestsçš„æ€»å’Œä¸èƒ½è¶…è¿‡è¯¥å€¼</td></tr><tr><td>limits.cpu</td><td>æ‰€æœ‰éç»ˆæ­¢çŠ¶æ€çš„Podï¼Œ CPU Limitsçš„æ€»å’Œä¸èƒ½è¶…è¿‡è¯¥å€¼</td></tr><tr><td>limits.memory</td><td>æ‰€æœ‰éç»ˆæ­¢çŠ¶æ€çš„Podï¼Œå†…å­˜ Limitsçš„æ€»å’Œä¸èƒ½è¶…è¿‡è¯¥å€¼</td></tr><tr><td>Memory</td><td>æ‰€æœ‰éç»ˆæ­¢çŠ¶æ€çš„Podï¼Œ å†…å­˜ Requestsçš„æ€»å’Œä¸èƒ½è¶…è¿‡è¯¥å€¼</td></tr><tr><td>requests.cpu</td><td>æ‰€æœ‰éç»ˆæ­¢çŠ¶æ€çš„Podï¼ŒCPU Requestsçš„æ€»å’Œä¸èƒ½è¶…è¿‡è¯¥å€¼</td></tr><tr><td>requests.memory</td><td>æ‰€æœ‰éç»ˆæ­¢çŠ¶æ€çš„Podï¼Œ å†…å­˜Requestsçš„æ€»å’Œä¸èƒ½è¶…è¿‡è¯¥å€¼</td></tr></tbody></table><h3 id="å­˜å‚¨èµ„æºé…é¢"><a href="#å­˜å‚¨èµ„æºé…é¢" class="headerlink" title="å­˜å‚¨èµ„æºé…é¢"></a>å­˜å‚¨èµ„æºé…é¢</h3><table><thead><tr><th scope="col">èµ„æºåç§°</th><th scope="col">è¯´æ˜</th></tr></thead><tbody><tr><td>requests.storage</td><td>æ‰€æœ‰PVCï¼Œå­˜å‚¨è¯·æ±‚æ€»é‡ä¸èƒ½è¶…è¿‡æ­¤å€¼</td></tr><tr><td>PersistentVolumeclaims</td><td>åœ¨è¯¥å‘½åç©ºé—´ä¸­èƒ½å­˜åœ¨çš„æŒä¹…å·çš„æ€»æ•°ä¸Šé™</td></tr><tr><td>.storageclass.storage.k8s.io/requests.storage</td><td>å’Œè¯¥å­˜å‚¨ç±»å…³è”çš„æ‰€æœ‰PVCï¼Œå­˜å‚¨è¯·æ±‚æ€»å’Œä¸èƒ½è¶…è¿‡æ­¤å€¼</td></tr><tr><td>.storageclass.storage.k8s.io/persistentvolumeclaims</td><td>å’Œè¯¥å­˜å‚¨ç±»å…³è”çš„æ‰€æœ‰PVCçš„æ€»å’Œ</td></tr></tbody></table><h3 id="å¯¹è±¡æ•°é‡é…é¢"><a href="#å¯¹è±¡æ•°é‡é…é¢" class="headerlink" title="å¯¹è±¡æ•°é‡é…é¢"></a>å¯¹è±¡æ•°é‡é…é¢</h3><table><thead><tr><th scope="col">èµ„æºåç§°</th><th scope="col">è¯´æ˜</th></tr></thead><tbody><tr><td>Configmaps</td><td>åœ¨è¯¥å‘½åç©ºé—´ä¸­èƒ½å­˜åœ¨çš„ConfigMapçš„æ€»æ•°ä¸Šé™</td></tr><tr><td><p>Pods</p></td><td><p>åœ¨è¯¥å‘½åç©ºé—´ä¸­èƒ½å­˜åœ¨çš„éç»ˆæ­¢çŠ¶æ€Podçš„æ€»æ•°ä¸Šé™ï¼ŒPodç»ˆæ­¢çŠ¶æ€ç­‰ä»·äºPodçš„</p><p>status.phase in(Failed, Succeeded) = true</p></td></tr><tr><td>Replicationcontrollers</td><td>åœ¨è¯¥å‘½åç©ºé—´ä¸­èƒ½å­˜åœ¨çš„RCçš„æ€»æ•°ä¸Šé™</td></tr><tr><td>Resourcequtas</td><td>åœ¨è¯¥å‘½åç©ºé—´ä¸­èƒ½å­˜åœ¨çš„èµ„æºé…é¢é¡¹çš„æ€»æ•°ä¸Šé™</td></tr><tr><td>Services</td><td>åœ¨è¯¥å‘½åç©ºé—´ä¸­èƒ½å­˜åœ¨çš„Serviceçš„æ€»æ•°ä¸Šé™</td></tr><tr><td>service.loadbalancers</td><td>åœ¨è¯¥å‘½åç©ºé—´ä¸­èƒ½å­˜åœ¨çš„è´Ÿè½½å‡è¡¡çš„æ€»æ•°ä¸Šé™</td></tr><tr><td>services.nodeports</td><td>åœ¨è¯¥å‘½åç©ºé—´ä¸­èƒ½å­˜åœ¨çš„NodePortçš„æ€»æ•°ä¸Šé™</td></tr><tr><td>Secrets</td><td>åœ¨è¯¥å‘½åç©ºé—´ä¸­èƒ½å­˜åœ¨çš„Secretçš„æ€»æ•°ä¸Šé™</td></tr></tbody></table><h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>åœ¨æµ‹è¯•ResourceQuotaä¹‹å‰æˆ‘ä»¬ä¹Ÿå…ˆåˆ›å»ºä¸€ä¸ªå‘½åç©ºé—´ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">quota-ns</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºä¸ªç®€å•çš„ResourceQuotaé…ç½®ï¼ˆtest-quota.ymlï¼‰ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ResourceQuota</span><br><span class="line">metadata:</span><br><span class="line">  name: test-quota</span><br><span class="line">spec:</span><br><span class="line">  hard:</span><br><span class="line">    pods: &quot;4&quot;</span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥ResourceQuotaï¼š</p><p><img src="img/QQæˆªå›¾20191112104240.png" alt="QQæˆªå›¾20191112104240.png"></p><p>æ¥ç€å®šä¹‰ä¸€ä¸ªRCé…ç½®ï¼ˆnginx-rc.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-rc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥RC:</p><p><img src="img/QQæˆªå›¾20191112104507.png" alt="QQæˆªå›¾20191112104507.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œå·²ç»æœ‰3ä¸ªPodå®ä¾‹äº†ï¼Œå¦‚æœå°†Podæ•°é‡æ‰©å¤§åˆ°5ï¼Œçœ‹çœ‹ä¼šæ€æ ·ï¼š</p><p><img src="img/QQæˆªå›¾20191112104655.png" alt="QQæˆªå›¾20191112104655.png"></p><p>æœ€ç»ˆä¹Ÿåªä¼šæœ‰4ä¸ªPodå®ä¾‹ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ä¸Šé¢ResourceQuotaä¸­æŒ‡å®šçš„æœ€å¤§Podæ•°é‡ä¸º4ã€‚</p><blockquote><p>ã€ŠKubernetesæƒå¨æŒ‡å—(ç¬¬4ç‰ˆ)ã€‹è¯»ä¹¦ç¬”è®°</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;é€šè¿‡å‰é¢çš„å­¦ä¹ æˆ‘ä»¬çŸ¥é“ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡requestså’Œlimitsç»™PodæŒ‡å®šèµ„æºé…ç½®ï¼Œä½†å¦‚æœæ¯ä¸ªPodéƒ½è¦æŒ‡å®šçš„è¯ç•¥æ˜¾ç¹çï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨LimitRangeæŒ‡å®šä¸€ä¸ªå…¨å±€çš„é»˜è®¤é…ç½®ï¼›æ­¤å¤–é€šè¿‡ResourceQuotaå¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰èµ„æºé…é¢ï¼Œè¿™ä¸ªèµ„æºé…é¢å¯ä»¥ä¸ºæ¯ä¸ªå‘½åç©ºé—´éƒ½æä¾›ä¸€ä¸ªæ€»ä½“çš„èµ„æºä½¿ç”¨çš„é™åˆ¶ï¼šå®ƒå¯ä»¥é™åˆ¶å‘½åç©ºé—´ä¸­æŸç§ç±»å‹çš„å¯¹è±¡çš„æ€»æ•°ç›®ä¸Šé™ï¼Œä¹Ÿå¯ä»¥è®¾ç½®å‘½åç©ºé—´ä¸­Podå¯ä»¥ä½¿ç”¨çš„è®¡ç®—èµ„æºçš„æ€»ä¸Šé™ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Kubernetes" scheme="http://mrbird.cc/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes Namespace&amp;Context</title>
    <link href="http://mrbird.cc/Kubernetes-Namespaces-Context.html"/>
    <id>http://mrbird.cc/Kubernetes-Namespaces-Context.html</id>
    <published>2019-11-08T04:53:11.000Z</published>
    <updated>2019-11-09T08:39:58.274Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --><p>åœ¨ä¸€ä¸ªç»„ç»‡å†…éƒ¨ï¼Œä¸åŒçš„å·¥ä½œç»„å¯ä»¥åœ¨åŒä¸€ä¸ªKubernetesé›†ç¾¤ä¸­å·¥ä½œï¼ŒKubernetesé€šè¿‡å‘½åç©ºé—´å’ŒContextçš„è®¾ç½®å¯¹ä¸åŒçš„å·¥ä½œç»„è¿›è¡ŒåŒºåˆ†ï¼Œä½¿å¾—å®ƒä»¬æ—¢å¯ä»¥å…±äº«åŒä¸€ä¸ªKubernetesé›†ç¾¤çš„æœåŠ¡ï¼Œä¹Ÿèƒ½å¤Ÿäº’ä¸å¹²æ‰°ã€‚</p><a id="more"></a><h2 id="Namespaceçš„åˆ›å»º"><a href="#Namespaceçš„åˆ›å»º" class="headerlink" title="Namespaceçš„åˆ›å»º"></a>Namespaceçš„åˆ›å»º</h2><p>Kubernetesé›†ç¾¤ä¼šå¸®æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåç§°ä¸ºdefaultçš„å‘½åç©ºé—´ï¼š</p><p><img src="img/QQæˆªå›¾20191109160144.png" alt="QQæˆªå›¾20191109160144.png"></p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„podã€rcã€serviceç­‰Kubernetesèµ„æºéƒ½æ˜¯ä½¿ç”¨è¿™ä¸ªå‘½åç©ºé—´ï¼Œæ­¤å¤–æˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ›å»ºè‡ªå·±çš„å‘½åç©ºé—´ã€‚</p><p>å®šä¹‰ä¸€ä¸ªå‘½åç©ºé—´é…ç½®dev-namesapce.ymlï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">dev</span> <span class="comment"># devå‘½åç©ºé—´</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥å‘½åç©ºé—´ï¼š</p><p><img src="img/QQæˆªå›¾20191109160534.png" alt="QQæˆªå›¾20191109160534.png"></p><h2 id="ä½¿ç”¨Namespace"><a href="#ä½¿ç”¨Namespace" class="headerlink" title="ä½¿ç”¨Namespace"></a>ä½¿ç”¨Namespace</h2><p>ä½¿ç”¨å‘½åç©ºé—´åªéœ€è¦åœ¨åˆ›å»ºKubernetesèµ„æºå¯¹è±¡çš„æ—¶å€™æŒ‡å®šå³å¯ï¼Œæ¯”å¦‚åˆ›å»ºä¸€ä¸ªtomcat-rc.ymlï¼Œå¹¶æŒ‡å®šå‘½åç©ºé—´ä¸ºdevï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tomcat-rc</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">dev</span> <span class="comment"># æŒ‡å®šå‘½åç©ºé—´</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">              hostPort:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥rcï¼š</p><p><img src="img/20191109161045.png" alt="20191109161045.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œdefalutå‘½åç©ºé—´ä¸‹å¹¶æ²¡æœ‰ä»»ä½•podï¼Œè€Œdevå‘½åç©ºé—´ä¸‹åˆ™æœ‰ä¸¤ä¸ªtomcat podå®ä¾‹ã€‚</p><div class="note danger"><p>å‘½åç©ºé—´åªæ˜¯åç§°ä¸Šçš„éš”ç¦»ï¼Œä¸åŒå‘½åç©ºé—´ä¸‹çš„podï¼Œserviceç­‰è¿˜æ˜¯å¯ä»¥ç›¸äº’è®¿é—®çš„ã€‚</p></div><h2 id="Contextçš„åˆ›å»ºå’Œä½¿ç”¨"><a href="#Contextçš„åˆ›å»ºå’Œä½¿ç”¨" class="headerlink" title="Contextçš„åˆ›å»ºå’Œä½¿ç”¨"></a>Contextçš„åˆ›å»ºå’Œä½¿ç”¨</h2><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ›å»ºContextï¼ˆä¸Šä¸‹æ–‡ï¼‰ï¼ŒæŒ‡å®šä½¿ç”¨çš„å‘½åç©ºé—´ï¼Œç„¶åä½¿ç”¨è¯¥Contextï¼Œæ¥å®Œæˆé»˜è®¤çš„å‘½åç©ºé—´åˆ‡æ¢ã€‚</p><p>åœ¨åˆ›å»ºContextå‰ï¼Œæˆ‘ä»¬æŸ¥çœ‹ä¸‹Kubernetesé»˜è®¤çš„é…ç½®ï¼š</p><p><img src="img/QQæˆªå›¾20191109162819.png" alt="QQæˆªå›¾20191109162819.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œå½“å‰é»˜è®¤çš„Contextåç§°ä¸ºkubernetes-admin@kubernetesï¼Œç”±æ­¤å¯ä»¥æ¨æ–­ï¼Œå®ƒå’Œdefalutè¿™ä¸ªå‘½åç©ºé—´æŒ‚é’©ã€‚</p><p>åˆ›å»ºä¸€ä¸ªæ–°çš„Contextï¼Œåç§°ä¸ºctx-devï¼Œå‘½åç©ºé—´ä½¿ç”¨ä¸Šé¢åˆ›å»ºçš„devï¼š</p><p><img src="img/QQæˆªå›¾20191109162659.png" alt="QQæˆªå›¾20191109162659.png"></p><p>å…¶ä¸­<code>/root/.kube/config</code>ä¸ºKubernetesé…ç½®ã€‚</p><p>åˆ›å»ºæˆåŠŸåï¼Œæˆ‘ä»¬ä½¿ç”¨ctx-devè¿™ä¸ªContextï¼š</p><p><img src="img/QQæˆªå›¾20191109163224.png" alt="QQæˆªå›¾20191109163224.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œç°åœ¨ä¸éœ€è¦æŒ‡å®š<code>-n dev</code>å°±å¯ä»¥è·å–åˆ°devå‘½åç©ºé—´ä¸‹çš„podäº†ï¼Œä¹Ÿè¯å®äº†Contextçš„åˆ‡æ¢æ˜¯æˆåŠŸçš„ã€‚</p><p>å¦‚æœæƒ³è¦æ¢å¤é»˜è®¤çš„Contextï¼Œå°†ContextæŒ‡å®šä¸ºkubernetes-admin@kubernetesï¼š</p><p><img src="img/QQæˆªå›¾20191109163514.png" alt="QQæˆªå›¾20191109163514.png"></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;åœ¨ä¸€ä¸ªç»„ç»‡å†…éƒ¨ï¼Œä¸åŒçš„å·¥ä½œç»„å¯ä»¥åœ¨åŒä¸€ä¸ªKubernetesé›†ç¾¤ä¸­å·¥ä½œï¼ŒKubernetesé€šè¿‡å‘½åç©ºé—´å’ŒContextçš„è®¾ç½®å¯¹ä¸åŒçš„å·¥ä½œç»„è¿›è¡ŒåŒºåˆ†ï¼Œä½¿å¾—å®ƒä»¬æ—¢å¯ä»¥å…±äº«åŒä¸€ä¸ªKubernetesé›†ç¾¤çš„æœåŠ¡ï¼Œä¹Ÿèƒ½å¤Ÿäº’ä¸å¹²æ‰°ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Kubernetes" scheme="http://mrbird.cc/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes ServiceåŸºç¡€</title>
    <link href="http://mrbird.cc/Kubernetes-Service-Basic.html"/>
    <id>http://mrbird.cc/Kubernetes-Service-Basic.html</id>
    <published>2019-11-07T06:30:59.000Z</published>
    <updated>2019-11-09T03:19:50.431Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --><p>Kuberneteså¯ä»¥ä¸ºä¸€ç»„å…·æœ‰ç›¸åŒåŠŸèƒ½çš„Podæä¾›ä¸€ä¸ªç»Ÿä¸€çš„å…¥å£åœ°å€ï¼Œå¹¶ä¸”å°†è¯·æ±‚å‡è¡¡çš„è½¬å‘åˆ°å„ä¸ªå¯¹åº”çš„Podä¸Šã€‚æœ¬èŠ‚ä¸»è¦è®°å½•Serviceçš„ä¸€äº›åŸºæœ¬ç”¨æ³•ã€‚</p><a id="more"></a><h2 id="åŸºæœ¬ç”¨æ³•"><a href="#åŸºæœ¬ç”¨æ³•" class="headerlink" title="åŸºæœ¬ç”¨æ³•"></a>åŸºæœ¬ç”¨æ³•</h2><p>åˆ›å»ºä¸€ä¸ªTomcat RCï¼ˆtomcat-rc.ymlï¼‰:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tomcat-rc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥RCï¼š</p><p><img src="img/QQæˆªå›¾20191109095409.png" alt="QQæˆªå›¾20191109095409.png"></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡Node IP + Container Portåœ¨Kubernetesé›†ç¾¤ä¸­è®¿é—®Tomcatï¼š</p><p><img src="img/QQæˆªå›¾20191109095554.png" alt="QQæˆªå›¾20191109095554.png"></p><p>ç”±äºPodæ˜¯Kubernetesé›†ç¾¤èŒƒå›´å†…çš„è™šæ‹Ÿæ¦‚å¿µï¼Œé›†ç¾¤å¤–çš„å®¢æˆ·ç«¯æ— æ³•é€šè¿‡Podçš„IPå’Œç«¯å£è®¿é—®ï¼Œæˆ‘ä»¬å¯ä»¥å°†Podçš„ç«¯å£å·æ˜ å°„åˆ°å®¿ä¸»æœºï¼Œä»¥ä½¿å®¢æˆ·ç«¯åº”ç”¨èƒ½å¤Ÿé€šè¿‡ç‰©ç†æœºè®¿é—®å®¹å™¨åº”ç”¨ï¼Œä¿®æ”¹åˆšåˆšçš„tomcat-rc.ymlï¼Œæ·»åŠ hostPortï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tomcat-rc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">              hostPort:</span> <span class="number">8081</span> <span class="comment"># æ–°å¢</span></span><br></pre></td></tr></table></figure><p>æ›´æ–°è¯¥RCï¼š</p><p><img src="img/QQæˆªå›¾20191109100036.png" alt="QQæˆªå›¾20191109100036.png"></p><p>å¯ä»¥çœ‹åˆ°tomcat podè¢«åˆ†é…åˆ°äº†node1å’Œnode2ä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨å®¿ä¸»æœºå¤–ä½¿ç”¨<a href=""></a>æˆ–è€…<a href=""></a>è®¿é—®tomcatï¼š</p><p><img src="img/QQæˆªå›¾20191109100307.png" alt="QQæˆªå›¾20191109100307.png"></p><p>ä½†æ˜¯æˆ‘ä»¬çŸ¥é“ï¼ŒPodçš„IPåœ°å€æ˜¯ä¸å¯é çš„ï¼Œä¾‹å¦‚å½“Podæ‰€åœ¨çš„Nodeå‘ç”Ÿæ•…éšœæ—¶ï¼ŒPodå°†è¢«Kubernetesé‡æ–°è°ƒåº¦åˆ°å¦ä¸€ä¸ªNodeï¼ŒPodçš„IPåœ°å€å°†å‘ç”Ÿå˜åŒ–ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªtomcat podçš„ç»Ÿä¸€è®¿é—®å…¥å£ï¼Œè¿™å°±æ˜¯Serviceçš„ä½œç”¨ã€‚</p><p>åˆ›å»ºServiceæœ‰ä¸¤ç§æ–¹å¼ï¼š</p><p><strong>1.kubectl exposeå‘½ä»¤æ¥åˆ›å»ºService</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl expose rc tomcat-rc</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20191109100642.png" alt="QQæˆªå›¾20191109100642.png"></p><p>ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡Serviceçš„clusterIP + Portæ¥è®¿é—®äº†ï¼š</p><p><img src="img/QQæˆªå›¾20191109100757.png" alt="QQæˆªå›¾20191109100757.png"></p><p>Serviceåœ°å€10.1.187.222:8080å‡è¡¡çš„è´Ÿè½½åˆ°äº†ä¸¤ä¸ªtomcat podä¸Šï¼ˆ10.244.1.19:8080å’Œ10.244.4.13:8080ï¼‰</p><p><strong>2.é€šè¿‡é…ç½®æ–‡ä»¶åˆ›å»º</strong></p><p>å®šä¹‰ä¸€ä¸ªtomcat-service.ymlï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tomcat-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">8081</span> <span class="comment"># serviceç«¯å£</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">8080</span> <span class="comment"># ç›®æ ‡ç«¯å£</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">tomcat</span> <span class="comment"># é€‰æ‹©å™¨ï¼Œé€‰æ‹©name=tomcatçš„pod</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥Serviceï¼š</p><p><img src="img/QQæˆªå›¾20191109101415.png" alt="QQæˆªå›¾20191109101415.png"></p><p>åŒæ ·ï¼ŒServiceé»˜è®¤æ˜¯ä¸èƒ½å¤–éƒ¨è®¿é—®çš„ï¼Œå¦‚æœæƒ³è®©å¤–éƒ¨èƒ½å¤Ÿè®¿é—®åˆ°tomcat serviceï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦å°†Serviceçš„ç«¯å£æ˜ å°„åˆ°ç‰©ç†æœºï¼Œä¿®æ”¹ä¸Šé¢çš„tomcat-service.ymlï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tomcat-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span> <span class="comment"># æ–°å¢</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">8081</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">      nodePort:</span> <span class="number">30000</span> <span class="comment"># æ–°å¢</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">tomcat</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢é…ç½®é€šè¿‡è®¾ç½®nodePortï¼ˆèŒƒå›´30000-32767ï¼‰æ˜ å°„åˆ°ç‰©ç†æœºï¼ŒåŒæ—¶è®¾ç½®Serviceçš„ç±»å‹ä¸ºNodePortï¼Œåˆ›å»ºè¯¥Serviceï¼š</p><p><img src="img/QQæˆªå›¾20191109102138.png" alt="QQæˆªå›¾20191109102138.png"></p><p>ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å®¿ä¸»æœºçš„IP+30000è®¿é—®tomcatäº†ï¼š</p><p><img src="img/QQæˆªå›¾20191109102418.png" alt="QQæˆªå›¾20191109102418.png"></p><h2 id="è´Ÿè½½å‡è¡¡ç­–ç•¥"><a href="#è´Ÿè½½å‡è¡¡ç­–ç•¥" class="headerlink" title="è´Ÿè½½å‡è¡¡ç­–ç•¥"></a>è´Ÿè½½å‡è¡¡ç­–ç•¥</h2><p>Kubernetes Serviceæä¾›äº†ä¸¤ç§è´Ÿè½½åˆ†å‘ç­–ç•¥ï¼šRoundRobinå’ŒSessionAffinityï¼š</p><ol><li>RoundRobinï¼šè½®è¯¢æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ï¼Œå³è½®è¯¢å°†è¯·æ±‚è½¬å‘åˆ°åç«¯çš„å„ä¸ªPodä¸Šã€‚</li><li>SessionAffinityï¼šåŸºäºå®¢æˆ·ç«¯IPåœ°å€è¿›è¡Œä¼šè¯ä¿æŒçš„æ¨¡å¼ï¼Œå³ç¬¬1æ¬¡å°†æŸä¸ªå®¢æˆ·ç«¯å‘èµ·çš„è¯·æ±‚è½¬å‘åˆ°åç«¯çš„æŸä¸ªPodä¸Šï¼Œä¹‹åä»ç›¸åŒçš„å®¢æˆ·ç«¯å‘èµ·çš„è¯·æ±‚éƒ½å°†è¢«è½¬å‘åˆ°åç«¯ç›¸åŒçš„Podä¸Šã€‚å¯ä»¥é€šè¿‡è®¾ç½®service.spec.sessionAffinity=ClientIPæ¥å¯ç”¨SessionAffinityç­–ç•¥ï¼š<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tomcat-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  sessionAffinity:</span> <span class="string">ClientIP</span> <span class="comment"># é‡‡ç”¨SessionAffinityç­–ç•¥</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">8081</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">      nodePort:</span> <span class="number">30000</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">tomcat</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="Headless-Service"><a href="#Headless-Service" class="headerlink" title="Headless Service"></a>Headless Service</h2><p>Headless Serviceä¸æä¾›ClusterIPï¼Œä»…é€šè¿‡Label Selectorå°†åç«¯çš„Podåˆ—è¡¨è¿”å›ç»™è°ƒç”¨çš„å®¢æˆ·ç«¯ã€‚</p><p>åˆ›å»ºtomcat-headless-service.ymlï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tomcat-headless-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">  clusterIP:</span> <span class="string">None</span> <span class="comment"># è®¾ç½®clusterIPä¸ºNoneï¼Œè¡¨ç¤ºheadless service</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">tomcat</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥headless serviceï¼š</p><p><img src="img/QQæˆªå›¾20191109111632.png" alt="QQæˆªå›¾20191109111632.png"></p><p><img src="img/QQæˆªå›¾20191109111800.png" alt="QQæˆªå›¾20191109111800.png"></p><blockquote><p>ã€ŠKubernetesæƒå¨æŒ‡å—(ç¬¬4ç‰ˆ)ã€‹è¯»ä¹¦ç¬”è®°</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;Kuberneteså¯ä»¥ä¸ºä¸€ç»„å…·æœ‰ç›¸åŒåŠŸèƒ½çš„Podæä¾›ä¸€ä¸ªç»Ÿä¸€çš„å…¥å£åœ°å€ï¼Œå¹¶ä¸”å°†è¯·æ±‚å‡è¡¡çš„è½¬å‘åˆ°å„ä¸ªå¯¹åº”çš„Podä¸Šã€‚æœ¬èŠ‚ä¸»è¦è®°å½•Serviceçš„ä¸€äº›åŸºæœ¬ç”¨æ³•ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Kubernetes" scheme="http://mrbird.cc/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes Podæ‰©å®¹ä¸ç¼©å®¹</title>
    <link href="http://mrbird.cc/Kubernetes-Pod-Expansion-Contraction.html"/>
    <id>http://mrbird.cc/Kubernetes-Pod-Expansion-Contraction.html</id>
    <published>2019-11-07T06:19:48.000Z</published>
    <updated>2019-11-08T12:38:39.455Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --><p>é’ˆå¯¹ä¸åŒæ—¶æœŸæµé‡çš„å¤§å°æˆ‘ä»¬å¯ä»¥ç»™Podæ‰©ç¼©å®¹ï¼ŒKubernetesæ”¯æŒé€šè¿‡kubectlå‘½ä»¤æ‰‹åŠ¨æ‰©ç¼©å®¹ï¼Œä¹Ÿæ”¯æŒé€šè¿‡HPAè‡ªåŠ¨æ¨ªå‘æ‰©ç¼©å®¹ã€‚<a id="more"></a></p><h2 id="æ‰‹åŠ¨æ‰©ç¼©å®¹"><a href="#æ‰‹åŠ¨æ‰©ç¼©å®¹" class="headerlink" title="æ‰‹åŠ¨æ‰©ç¼©å®¹"></a>æ‰‹åŠ¨æ‰©ç¼©å®¹</h2><p>ç°æœ‰å¦‚ä¸‹deploymenté…ç½®ï¼ˆnginx-deployment.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          image:</span> <span class="attr">nginx:1.7.9</span></span><br><span class="line"><span class="attr">          imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥Deploymentï¼š</p><p><img src="img/QQæˆªå›¾20191108094938.png" alt="QQæˆªå›¾20191108094938.png"></p><p>æœ‰3ä¸ªnginxå®ä¾‹ï¼Œç°åœ¨ç”¨ä¸‹é¢è¿™æ¡å‘½ä»¤å°†nginxå®ä¾‹æ‰©å……åˆ°5ä¸ªï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale deployment nginx-deployment --replicas 5</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20191108100513.png" alt="QQæˆªå›¾20191108100513.png"></p><p>ç¼©å®¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale deployment nginx-deployment --replicas 1</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20191108100834.png" alt="QQæˆªå›¾20191108100834.png"></p><h2 id="HPA"><a href="#HPA" class="headerlink" title="HPA"></a>HPA</h2><p>HPAèƒ½å¤Ÿæ ¹æ®ç‰¹å®šæŒ‡æ ‡å®Œæˆç›®æ ‡Podçš„è‡ªåŠ¨æ‰©ç¼©å®¹ã€‚åˆ›å»ºä¸€ä¸ªä¸ä¸Šé¢nginx-deploymentç›¸å¯¹åº”çš„HPAï¼ˆnginx-deployment-hpa.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-deployment-hpa-v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  maxReplicas:</span> <span class="number">6</span></span><br><span class="line"><span class="attr">  minReplicas:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  scaleTargetRef:</span></span><br><span class="line"><span class="attr">    apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">  targetCPUUtilizationPercentage:</span> <span class="number">50</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸»è¦å‚æ•°å¦‚ä¸‹ï¼š</p><ol><li><p>scaleTargetRefï¼šç›®æ ‡ä½œç”¨å¯¹è±¡ï¼Œå¯ä»¥æ˜¯Deploymentã€ReplicationControlleræˆ–ReplicaSetã€‚</p></li><li><p>targetCPUUtilizationPercentageï¼šæœŸæœ›æ¯ä¸ªPodçš„CPUä½¿ç”¨ç‡éƒ½ä¸º50%ï¼Œè¯¥ä½¿ç”¨ç‡åŸºäºPodè®¾ç½®çš„CPU Requestå€¼è¿›è¡Œè®¡ç®—ï¼Œä¾‹å¦‚è¯¥å€¼ä¸º200mï¼Œé‚£ä¹ˆç³»ç»Ÿå°†ç»´æŒPodçš„å®é™…CPUä½¿ç”¨å€¼ä¸º100mã€‚</p></li><li><p>minReplicaså’ŒmaxReplicasï¼šPodå‰¯æœ¬æ•°é‡çš„æœ€å°å€¼å’Œæœ€å¤§å€¼ï¼Œç³»ç»Ÿå°†åœ¨è¿™ä¸ªèŒƒå›´å†…è¿›è¡Œè‡ªåŠ¨æ‰©ç¼©å®¹æ“ä½œï¼Œå¹¶ç»´æŒæ¯ä¸ªPodçš„CPUä½¿ç”¨ç‡ä¸º50%ã€‚</p></li></ol><div class="note info"><p>ä½¿ç”¨HPAï¼Œéœ€è¦é¢„å…ˆå®‰è£…Metrics Serverï¼Œç”¨äºé‡‡é›†Podçš„CPUä½¿ç”¨ç‡ã€‚</p></div><blockquote><p>ã€ŠKubernetesæƒå¨æŒ‡å—(ç¬¬4ç‰ˆ)ã€‹è¯»ä¹¦ç¬”è®°</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;é’ˆå¯¹ä¸åŒæ—¶æœŸæµé‡çš„å¤§å°æˆ‘ä»¬å¯ä»¥ç»™Podæ‰©ç¼©å®¹ï¼ŒKubernetesæ”¯æŒé€šè¿‡kubectlå‘½ä»¤æ‰‹åŠ¨æ‰©ç¼©å®¹ï¼Œä¹Ÿæ”¯æŒé€šè¿‡HPAè‡ªåŠ¨æ¨ªå‘æ‰©ç¼©å®¹ã€‚
    
    </summary>
    
    
      <category term="Kubernetes" scheme="http://mrbird.cc/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes Podå‡çº§ä¸å›æ»š</title>
    <link href="http://mrbird.cc/Kubernetes-Pod-Upgrade-And-Rollback.html"/>
    <id>http://mrbird.cc/Kubernetes-Pod-Upgrade-And-Rollback.html</id>
    <published>2019-11-05T10:59:27.000Z</published>
    <updated>2019-11-08T09:57:27.638Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --><p>å½“é›†ç¾¤ä¸­çš„æŸä¸ªæœåŠ¡éœ€è¦å‡çº§æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åœæ­¢ç›®å‰ä¸è¯¥æœåŠ¡ç›¸å…³çš„æ‰€æœ‰Podï¼Œç„¶åä¸‹è½½æ–°ç‰ˆæœ¬é•œåƒå¹¶åˆ›å»ºæ–°çš„Podã€‚å¦‚æœé›†ç¾¤è§„æ¨¡æ¯”è¾ƒå¤§ï¼Œåˆ™è¿™ä¸ªå·¥ä½œå˜æˆäº†ä¸€ä¸ªæŒ‘æˆ˜ï¼Œè€Œä¸”å…ˆå…¨éƒ¨åœæ­¢ç„¶åé€æ­¥å‡çº§çš„æ–¹å¼ä¼šå¯¼è‡´è¾ƒé•¿æ—¶é—´çš„æœåŠ¡ä¸å¯ç”¨ã€‚Kubernetesæä¾›äº†æ»šåŠ¨å‡çº§åŠŸèƒ½æ¥è§£å†³ä¸Šè¿°é—®é¢˜ã€‚å¦‚æœåœ¨æ›´æ–°è¿‡ç¨‹ä¸­å‘ç”Ÿäº†é”™è¯¯ï¼Œåˆ™è¿˜å¯ä»¥é€šè¿‡å›æ»šæ“ä½œæ¢å¤Podçš„ç‰ˆæœ¬ã€‚<a id="more"></a></p><h2 id="Deploymentå‡çº§"><a href="#Deploymentå‡çº§" class="headerlink" title="Deploymentå‡çº§"></a>Deploymentå‡çº§</h2><p>ç°æœ‰å¦‚ä¸‹deploymentå®šä¹‰ï¼ˆnginx-deployment.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          image:</span> <span class="attr">nginx:1.7.9</span></span><br><span class="line"><span class="attr">          imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥deploymentï¼š</p><p><img src="img/QQæˆªå›¾20191106094755.png" alt="QQæˆªå›¾20191106094755.png"></p><p>é€šè¿‡kubectlå‘½ä»¤å°†nginxçš„ç‰ˆæœ¬æ›´æ–°åˆ°1.9.1ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">set</span> image deployment/nginx-deployment nginx=nginx:1.9.1</span><br></pre></td></tr></table></figure><p></p><p>æŸ¥çœ‹æ»šåŠ¨å‡çº§çš„è¿‡ç¨‹ï¼š</p><p><img src="img/QQæˆªå›¾20191106095447.png" alt="QQæˆªå›¾20191106095447.png"></p><p>æŸ¥çœ‹Podï¼Œä¼šå‘ç°åç§°å·²ç»æ”¹å˜äº†ï¼š</p><p><img src="img/QQæˆªå›¾20191106095549.png" alt="QQæˆªå›¾20191106095549.png"></p><p>ä¸Šè¿°æ»šåŠ¨å‡çº§çš„è¿‡ç¨‹å¯ä»¥ç”¨ä¸‹å›¾è¡¨ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20191106101327.png" alt="QQæˆªå›¾20191106101327.png"></p><p>æŸ¥çœ‹Deployment nginx-deploymentçš„è¯¦ç»†äº‹ä»¶ä¿¡æ¯å¯ä»¥è¯æ˜è¿™ä¸€ç‚¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe deployments/nginx-deployment</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20191106100133.png" alt="QQæˆªå›¾20191106100133.png"></p><p>æŸ¥çœ‹rsï¼š</p><p><img src="img/QQæˆªå›¾20191106102115.png" alt="QQæˆªå›¾20191106102115.png"></p><p>é»˜è®¤çš„å‡çº§ç­–ç•¥ä¸ºRollingUpdateï¼ˆæ»šåŠ¨æ›´æ–°ï¼‰ï¼ŒKubernetesè¿˜æ”¯æŒRecreateï¼ˆé‡å»ºï¼‰ç­–ç•¥ï¼š</p><ol><li><p>Recreateï¼šå…ˆæ€æ‰æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„Podï¼Œç„¶ååˆ›å»ºæ–°çš„Podã€‚</p></li><li><p>RollingUpdateï¼šä»¥æ»šåŠ¨æ›´æ–°çš„æ–¹å¼æ¥é€ä¸ªæ›´æ–°Podã€‚åŒæ—¶ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®spec.strategy.rollingUpdateä¸‹çš„ä¸¤ä¸ªå‚æ•°ï¼ˆmaxUnavailableå’ŒmaxSurgeï¼‰æ¥æ§åˆ¶æ»šåŠ¨æ›´æ–°çš„è¿‡ç¨‹ã€‚</p></li></ol><p>RollingUpdateçš„ä¸¤ä¸ªå‚æ•°å«ä¹‰å¦‚ä¸‹ï¼š</p><ol><li><p>maxUnavailableï¼šç”¨äºæŒ‡å®šDeploymentåœ¨æ›´æ–°è¿‡ç¨‹ä¸­ä¸å¯ç”¨çŠ¶æ€çš„Podæ•°é‡çš„ä¸Šé™ã€‚è¯¥maxUnavailableçš„æ•°å€¼å¯ä»¥æ˜¯ç»å¯¹å€¼ï¼ˆä¾‹å¦‚1ï¼‰æˆ–PodæœŸæœ›çš„å‰¯æœ¬æ•°çš„ç™¾åˆ†æ¯”ï¼ˆä¾‹å¦‚10%ï¼‰ã€‚</p></li><li><p>maxSurgeï¼šç”¨äºæŒ‡å®šåœ¨Deploymentæ›´æ–°Podçš„è¿‡ç¨‹ä¸­Podæ€»æ•°è¶…è¿‡PodæœŸæœ›å‰¯æœ¬æ•°éƒ¨åˆ†çš„æœ€å¤§å€¼ã€‚è¯¥maxSurgeçš„æ•°å€¼å¯ä»¥æ˜¯ç»å¯¹å€¼ï¼ˆä¾‹å¦‚5ï¼‰æˆ–PodæœŸæœ›å‰¯æœ¬æ•°çš„ç™¾åˆ†æ¯”ï¼ˆä¾‹å¦‚10%ï¼‰ã€‚</p></li></ol><div class="note info"><p>æ­¤å¤–ï¼Œé™¤äº†ä½¿ç”¨kubectlå‘½ä»¤å‡çº§å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡ä¿®æ”¹deployment.ymlçš„æ–¹å¼æ¥å®Œæˆã€‚</p></div><h2 id="Deploymentå›æ»š"><a href="#Deploymentå›æ»š" class="headerlink" title="Deploymentå›æ»š"></a>Deploymentå›æ»š</h2><p>å¦‚æœå‡çº§åæ•ˆæœä¸æ»¡æ„çš„è¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†Deploymentå›æ»šåˆ°å‡çº§ä¹‹å‰ï¼Œä½¿ç”¨ä¸‹é¢è¿™æ¡å‘½ä»¤æŸ¥çœ‹æ»šåŠ¨å‡çº§çš„å†å²ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout history deployment/nginx-deployment</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20191106103606.png" alt="QQæˆªå›¾20191106103606.png"></p><p>REVISIONä¸ºå‡çº§çš„å†å²ç‰ˆæœ¬ï¼Œæˆ‘ä»¬åªå®Œæˆäº†nginxä»1.7.9å‡çº§åˆ°1.9.1çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥REVISION 1è¡¨ç¤ºnginxä¸º1.7.9çš„ç‰ˆæœ¬ï¼ŒREVISION 2è¡¨ç¤ºnginxä¸º1.9.1çš„ç‰ˆæœ¬ã€‚å› ä¸ºæˆ‘ä»¬åœ¨åˆ›å»ºdeploymentçš„æ—¶å€™æ²¡æœ‰åŠ ä¸Š<code>--record=true</code>å‚æ•°ï¼Œæ‰€ä»¥CHANGE-CACSEåˆ—æ˜¯ç©ºçš„ã€‚</p><p>éœ€è¦æŸ¥çœ‹ç‰¹å®šç‰ˆæœ¬çš„è¯¦ç»†ä¿¡æ¯ï¼Œåˆ™å¯ä»¥åŠ ä¸Šâ€“revision=<n>å‚æ•°ï¼š</n></p><p><img src="img/QQæˆªå›¾20191106104520.png" alt="QQæˆªå›¾20191106104520.png"></p><p>è¦å°†nginxå›é€€åˆ°1.7.9ç‰ˆæœ¬ï¼Œæˆ‘ä»¬å¯ä»¥å°†REVISIONæŒ‡å®šä¸º1ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout undo deployment/nginx-deployment --to-revision=1</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20191106105253.png" alt="QQæˆªå›¾20191106105253.png"></p><p><img src="img/QQæˆªå›¾20191106105638.png" alt="QQæˆªå›¾20191106105638.png"></p><h2 id="æš‚åœä¸æ¢å¤"><a href="#æš‚åœä¸æ¢å¤" class="headerlink" title="æš‚åœä¸æ¢å¤"></a>æš‚åœä¸æ¢å¤</h2><p>å› ä¸ºDeploymenté…ç½®ä¸€æ—¦ä¿®æ”¹å°±ä¼šè§¦å‘å‡çº§æ“ä½œï¼Œæ‰€ä»¥å½“ä¿®æ”¹çš„åœ°æ–¹è¾ƒå¤šçš„æ—¶å€™å°±ä¼šé¢‘ç¹è§¦å‘å‡çº§ã€‚æˆ‘ä»¬å¯ä»¥å…ˆæš‚åœå‡çº§æ“ä½œï¼Œå½“æ‰€æœ‰é…ç½®éƒ½ä¿®æ”¹å¥½åå†æ¢å¤å‡çº§ã€‚</p><p>æš‚åœï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout pause deployment/nginx-deployment</span><br></pre></td></tr></table></figure><p></p><p>æš‚åœåï¼Œå¯¹nginx-deploymentçš„ä¿®æ”¹ä¸ä¼šè§¦å‘å‡çº§ã€‚ä¿®æ”¹å¥½åï¼Œæ¢å¤å‡çº§ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout resume deployment/nginx-deployment</span><br></pre></td></tr></table></figure><p></p><h2 id="å…¶ä»–Podç®¡ç†å¯¹è±¡å‡çº§ç­–ç•¥"><a href="#å…¶ä»–Podç®¡ç†å¯¹è±¡å‡çº§ç­–ç•¥" class="headerlink" title="å…¶ä»–Podç®¡ç†å¯¹è±¡å‡çº§ç­–ç•¥"></a>å…¶ä»–Podç®¡ç†å¯¹è±¡å‡çº§ç­–ç•¥</h2><h3 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h3><p>DaemonSetçš„å‡çº§ç­–ç•¥åŒ…æ‹¬ä¸¤ç§ï¼šOnDeleteå’ŒRollingUpdateï¼š</p><ol><li><p>OnDeleteï¼ˆé»˜è®¤ï¼‰ï¼šåœ¨åˆ›å»ºå¥½æ–°çš„DaemonSeté…ç½®ä¹‹åï¼Œæ–°çš„Podå¹¶ä¸ä¼šè¢«è‡ªåŠ¨åˆ›å»ºï¼Œç›´åˆ°ç”¨æˆ·æ‰‹åŠ¨åˆ é™¤æ—§ç‰ˆæœ¬çš„Podï¼Œæ‰è§¦å‘æ–°å»ºæ“ä½œã€‚</p></li><li><p>RollingUpdateï¼šå’Œå‰é¢ä»‹ç»çš„ä¸€è‡´ï¼Œä¸è¿‡ä¸æ”¯æŒrolloutï¼Œåªèƒ½é€šè¿‡å°†é…ç½®æ”¹å›å»æ¥å®ç°ã€‚</p></li></ol><h3 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a>StatefulSet</h3><p>æ”¯æŒRecreateã€OnDeleteå’ŒRollingUpdateã€‚</p><blockquote><p>ã€ŠKubernetesæƒå¨æŒ‡å—(ç¬¬4ç‰ˆ)ã€‹è¯»ä¹¦ç¬”è®°</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;å½“é›†ç¾¤ä¸­çš„æŸä¸ªæœåŠ¡éœ€è¦å‡çº§æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åœæ­¢ç›®å‰ä¸è¯¥æœåŠ¡ç›¸å…³çš„æ‰€æœ‰Podï¼Œç„¶åä¸‹è½½æ–°ç‰ˆæœ¬é•œåƒå¹¶åˆ›å»ºæ–°çš„Podã€‚å¦‚æœé›†ç¾¤è§„æ¨¡æ¯”è¾ƒå¤§ï¼Œåˆ™è¿™ä¸ªå·¥ä½œå˜æˆäº†ä¸€ä¸ªæŒ‘æˆ˜ï¼Œè€Œä¸”å…ˆå…¨éƒ¨åœæ­¢ç„¶åé€æ­¥å‡çº§çš„æ–¹å¼ä¼šå¯¼è‡´è¾ƒé•¿æ—¶é—´çš„æœåŠ¡ä¸å¯ç”¨ã€‚Kubernetesæä¾›äº†æ»šåŠ¨å‡çº§åŠŸèƒ½æ¥è§£å†³ä¸Šè¿°é—®é¢˜ã€‚å¦‚æœåœ¨æ›´æ–°è¿‡ç¨‹ä¸­å‘ç”Ÿäº†é”™è¯¯ï¼Œåˆ™è¿˜å¯ä»¥é€šè¿‡å›æ»šæ“ä½œæ¢å¤Podçš„ç‰ˆæœ¬ã€‚
    
    </summary>
    
    
      <category term="Kubernetes" scheme="http://mrbird.cc/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes Podç®¡ç†å¯¹è±¡ä¸è°ƒåº¦ç­–ç•¥</title>
    <link href="http://mrbird.cc/Kubernetes-Pod-Mananger.html"/>
    <id>http://mrbird.cc/Kubernetes-Pod-Mananger.html</id>
    <published>2019-11-04T01:14:06.000Z</published>
    <updated>2019-11-08T09:57:27.638Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --><p>åœ¨å‰é¢çš„å­¦ä¹ ä¸­æˆ‘ä»¬äº†è§£åˆ°ï¼Œåœ¨Kubernetesä¸­ï¼ŒPodç®¡ç†å¯¹è±¡ä¸»è¦æœ‰RC(RS)ã€Deploymentã€StatefulSetã€DaemonSetå’ŒJobï¼ˆCronJobï¼‰ç­‰ã€‚å…¶ä¸­RC(RS)å’ŒDeploymentçš„ç”¨æ³•å·²ç»å¤§è‡´äº†è§£ï¼Œè¿™é‡Œä¸»è¦è®°å½•ä¸‹StatefulSetã€DaemonSetå’ŒJobï¼ˆCronJobï¼‰çš„ç”¨æ³•ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒPodç®¡ç†å¯¹è±¡åœ¨åˆ›å»ºPodçš„æ—¶å€™æ˜¯æ ¹æ®ç³»ç»Ÿè‡ªåŠ¨è°ƒåº¦ç®—æ³•æ¥å®Œæˆéƒ¨ç½²çš„ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®è°ƒåº¦ç­–ç•¥æ¥å®ç°Podçš„ç²¾å‡†è°ƒåº¦ã€‚</p><a id="more"></a><h2 id="Podè°ƒåº¦ç­–ç•¥"><a href="#Podè°ƒåº¦ç­–ç•¥" class="headerlink" title="Podè°ƒåº¦ç­–ç•¥"></a>Podè°ƒåº¦ç­–ç•¥</h2><h3 id="NodeSelector"><a href="#NodeSelector" class="headerlink" title="NodeSelector"></a>NodeSelector</h3><p>æˆ‘ä»¬å¯ä»¥è¯¥æŸä¸ªèŠ‚ç‚¹Nodeè®¾ç½®æ ‡ç­¾ï¼Œç„¶åé€šè¿‡NodeSelectorè®©Podè°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ä¸Šã€‚</p><p>å‰é¢æ­å»ºçš„Kubernetesé›†ç¾¤æœ‰ä¸¤ä¸ªworkerèŠ‚ç‚¹node1å’Œnode2ï¼Œæˆ‘ä»¬ç»™node2æ‰“ä¸ªæ ‡ç­¾ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label nodes node2 tier=frontend</span><br></pre></td></tr></table></figure><p></p><p>æ¥ç€å®šä¹‰ä¸€ä¸ªRCé…ç½®ï¼ˆnode-select-pod.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test-rc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      nodeSelector:</span></span><br><span class="line"><span class="attr">        tier:</span> <span class="string">frontend</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥RCï¼Œè§‚å¯ŸPodæœ€ç»ˆè°ƒåº¦çš„èŠ‚ç‚¹ï¼š</p><p><img src="img/QQæˆªå›¾20191105202135.png" alt="å›¾ç‰‡"></p><p>å¯ä»¥çœ‹åˆ°nginx podå·²ç»æˆåŠŸè°ƒåº¦åˆ°äº†node2èŠ‚ç‚¹ä¸Šã€‚</p><p>Kubernetesä¼šç»™æ¯ä¸ªnodeè´´ä¸Šä¸€äº›é»˜è®¤çš„æ ‡ç­¾ï¼Œé€šè¿‡<code>kubectl get node node1 -o yaml</code>å¯ä»¥çœ‹åˆ°è¿™äº›é»˜è®¤çš„æ ‡ç­¾ï¼š</p><p><img src="img/QQæˆªå›¾20191105152923.png" alt="QQæˆªå›¾20191105152923.png"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">beta.kubernetes.io/arch: amd64</span><br><span class="line">beta.kubernetes.io/os: linux</span><br><span class="line">kubernetes.io/arch: amd64</span><br><span class="line">kubernetes.io/hostname: node1</span><br><span class="line">kubernetes.io/os: linux</span><br></pre></td></tr></table></figure><p>è¿™äº›é»˜è®¤çš„æ ‡ç­¾åœ¨ä¸‹é¢è¿™äº›è°ƒåº¦ç­–ç•¥ä¸­ä¹Ÿæ˜¯è›®å¸¸ç”¨çš„ã€‚</p><h3 id="NodeAffinity"><a href="#NodeAffinity" class="headerlink" title="NodeAffinity"></a>NodeAffinity</h3><p>Affinity[É™ËˆfÉªnÉ™ti]ï¼šäº²å’ŒåŠ›ï¼Œå–œå¥½ã€‚NodeAffinityä¸ºNodeäº²å’ŒåŠ›è°ƒåº¦ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªè§„åˆ™ï¼ˆåç§°æœ‰ç‚¹é•¿ï¼Œå¿«18cmäº†å§ï¼‰:</p><ol><li><p>RequiredDuringSchedulingIgnoredDuringExecutionï¼šå¿…é¡»æ»¡è¶³æŒ‡å®šçš„è§„åˆ™æ‰å¯ä»¥è°ƒåº¦Podï¼Œç¡¬è§„åˆ™ã€‚</p></li><li><p>PreferredDuringSchedulingIgnoredDuringExecutionï¼šè½¯è§„åˆ™ï¼Œæœ€å¥½æ»¡è¶³æ‰€åˆ—å‡ºçš„æ¡ä»¶æ‰è°ƒåº¦Podã€‚</p></li></ol><p>IgnoredDuringExecutionçš„æ„æ€æ˜¯ï¼Œå¦‚æœä¸€ä¸ªPodå·²ç»è°ƒåº¦åˆ°æŸä¸ªèŠ‚ç‚¹ä¸Šäº†ï¼Œç„¶åè¿™ä¸ªèŠ‚ç‚¹çš„æ ‡ç­¾å‘ç”Ÿäº†æ”¹å˜ï¼Œé‚£ä¹ˆä¸å½±å“å·²ç»è°ƒåº¦å¥½çš„Podï¼Œignoreã€‚</p><p>å®šä¹‰ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼ˆnode-affinity.ymlï¼‰ï¼Œç”¨äºæ¼”ç¤ºNodeAffinityï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test-rc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      affinity:</span></span><br><span class="line"><span class="attr">        nodeAffinity:</span></span><br><span class="line"><span class="attr">          requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line"><span class="attr">            nodeSelectorTerms:</span></span><br><span class="line"><span class="attr">              - matchExpressions:</span></span><br><span class="line"><span class="attr">                  - key:</span> <span class="string">beta.kubernetes.io/arch</span></span><br><span class="line"><span class="attr">                    operator:</span> <span class="string">In</span></span><br><span class="line"><span class="attr">                    values:</span></span><br><span class="line"><span class="bullet">                      -</span> <span class="string">amd64</span></span><br><span class="line"><span class="attr">          preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line"><span class="attr">            - weight:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">              preference:</span></span><br><span class="line"><span class="attr">                matchExpressions:</span></span><br><span class="line"><span class="attr">                  - key:</span> <span class="string">disk-type</span></span><br><span class="line"><span class="attr">                    operator:</span> <span class="string">In</span></span><br><span class="line"><span class="attr">                    values:</span></span><br><span class="line"><span class="bullet">                      -</span> <span class="string">ssd</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢é…ç½®ä½¿å¾—RCåœ¨è°ƒåº¦nginx podçš„æ—¶å€™éœ€è¦æ»¡è¶³ï¼šèŠ‚ç‚¹å…·æœ‰beta.kubernetes.io/arch=amd64æ ‡ç­¾ï¼Œå¦‚æœå…·æœ‰disk-type=ssdæ ‡ç­¾å°±æ›´å¥½äº†ï¼Œæ¢å¥è¯è¯´å°±æ˜¯å¸Œæœ›nginx podè°ƒåº¦åœ¨cpuæ¶æ„ä¸ºamdï¼Œç£ç›˜ä¸ºssdçš„èŠ‚ç‚¹ä¸Šã€‚</p><p>ä¸Šé¢é…ç½®ä¸­ï¼Œæ“ä½œç¬¦<code>operator</code>é™¤äº†å¯ä»¥ä½¿ç”¨Inå¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨NotInã€Existsã€DoesNotExistã€Gtã€Ltã€‚</p><p>NodeAffinityè§„åˆ™è®¾ç½®éœ€è¦æ³¨æ„çš„å‡ ä¸ªç‚¹ï¼š</p><ol><li><p>å¦‚æœnodeAffinityæŒ‡å®šäº†å¤šä¸ªnodeSelectorTermsï¼Œé‚£ä¹ˆå…¶ä¸­ä¸€ä¸ªèƒ½å¤ŸåŒ¹é…æˆåŠŸå³å¯ï¼›</p></li><li><p>å¦‚æœåœ¨nodeSelectorTermsä¸­æœ‰å¤šä¸ªmatchExpressionsï¼Œåˆ™ä¸€ä¸ªèŠ‚ç‚¹å¿…é¡»æ»¡è¶³æ‰€æœ‰matchExpressionsæ‰èƒ½è¿è¡Œè¯¥Podã€‚</p></li></ol><p>è¿è¡Œä¸Šé¢è¿™ä¸ªé…ç½®ï¼š</p><p><img src="img/QQæˆªå›¾20191105202725.png" alt="QQæˆªå›¾20191105202725.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œå› ä¸ºnode1å’Œnode2éƒ½å…·æœ‰beta.kubernetes.io/arch=amd64æ ‡ç­¾ï¼Œè€Œæ²¡æœ‰disk-type=ssdæ ‡ç­¾ï¼Œæ‰€ä»¥nginx podæœ‰å¯èƒ½è¢«è°ƒåº¦åˆ°node1ä¹Ÿæœ‰å¯èƒ½è¢«è°ƒåº¦åˆ°node2ã€‚</p><p>æˆ‘ä»¬ç»™node1æ·»åŠ disk-type=ssdæ ‡ç­¾ï¼Œé‡æ–°è¿è¡Œä¸Šé¢çš„é…ç½®æ–‡ä»¶ï¼š</p><p><img src="img/QQæˆªå›¾20191105203033.png" alt="QQæˆªå›¾20191105203033.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œnginx podè¢«è°ƒåº¦åˆ°äº†node1ä¸Šã€‚</p><h3 id="PodAffinity"><a href="#PodAffinity" class="headerlink" title="PodAffinity"></a>PodAffinity</h3><p>PodAffinityæŒ‡çš„æ˜¯Podäº²å’ŒåŠ›è°ƒåº¦è‚¡åˆ™ï¼Œæ¯”å¦‚æŸäº›èŠ‚ç‚¹å·²ç»å­˜åœ¨ä¸€äº›Podäº†ï¼Œæ–°çš„Podåœ¨è°ƒåº¦çš„æ—¶å€™å¸Œæœ›å’ŒæŒ‡å®šPodåœ¨ä¸€å°èŠ‚ç‚¹ä¸Šï¼Œäº¦æˆ–æœ‰æ„é¿å¼€å’ŒæŒ‡å®šPodåœ¨ä¸€å°èŠ‚ç‚¹ä¸Šï¼Œè¿™æ—¶å€™å°±å¯ä»¥ç”¨PodAffinityå®ç°ã€‚</p><p>NodeAffinityè§„åˆ™è®¾ç½®ä¹Ÿæ˜¯é€šè¿‡<code>requiredDuringSchedulingIgnoredDuringExecution</code>å’Œ<code>PreferredDuringSchedulingIgnoredDuringExecution</code>å®ç°çš„ã€‚æ­¤å¤–ï¼ŒNodeAffinityè¿˜éœ€è¦è®¾ç½®topologyï¼ˆæ‹“æ‰‘è§„åˆ™ï¼‰ï¼Œæ„ä¸ºè¡¨è¾¾èŠ‚ç‚¹æ‰€å±çš„topologyèŒƒå›´ï¼š</p><ol><li><p>kubernetes.io/hostnameï¼ˆèŠ‚ç‚¹æ‰€å¤„çš„æœåŠ¡å™¨ï¼‰</p></li><li><p>failure-domain.beta.kubernetes.io/zoneï¼ˆèŠ‚ç‚¹æ‰€å¤„çš„æœåŠ¡å™¨äº‘ç›˜åˆ†åŒºï¼‰</p></li><li><p>failure-domain.beta.kubernetes.io/regionï¼ˆèŠ‚ç‚¹æ‰€å¤„çš„æœåŠ¡å™¨äº‘ç›˜æ‰€åœ¨çš„åœ°åŒºï¼‰</p></li></ol><p>è¦æ¼”ç¤ºPodAffinityçš„ä½¿ç”¨ï¼Œéœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªå‚ç…§Podï¼Œåˆ›å»ºä¸€ä¸ªå‚ç…§Podçš„é…ç½®æ–‡ä»¶ï¼ˆflag-pod.ymlï¼‰:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">flag-pod</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">flag-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">flag-nginx</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure><p></p><p>è¿™ä¸ªPodå…·æœ‰<code>tier=frontend</code>å’Œ<code>app=flag-nginx</code>æ ‡ç­¾ã€‚</p><p>åˆ›å»ºè¿™ä¸ªå‚ç…§Podï¼š</p><p><img src="img/QQæˆªå›¾20191105203331.png" alt="QQæˆªå›¾20191105203331.png"></p><p>å‚ç…§podè¿è¡Œåœ¨äº†node1èŠ‚ç‚¹ä¸Šã€‚</p><p>åˆ›å»ºå¥½åï¼Œæ¥ç€å®šä¹‰ä¸€ä¸ªæ–°çš„é…ç½®ç±»ï¼ˆpod-affinity.ymlï¼‰ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-affinity</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    - name: nginx</span><br><span class="line">      image: nginx</span><br><span class="line">      ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">  affinity:</span><br><span class="line">    podAffinity:</span><br><span class="line">      requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">        - labelSelector:</span><br><span class="line">            matchExpressions:</span><br><span class="line">              - key: tier</span><br><span class="line">                operator: In</span><br><span class="line">                values:</span><br><span class="line">                  - frontend</span><br><span class="line">          topologyKey: kubernetes.io/hostname</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šè¿°é…ç½®è¦æ±‚ï¼Œnginx podéœ€è¦å’Œæ ‡ç­¾åŒ…å«tier=frontendçš„Podåˆ†é…åœ¨åŒä¸€ä¸ªNodeä¸Šï¼ˆtopologyKey: kubernetes.io/hostnameï¼‰ï¼Œåˆ›å»ºè¯¥Podï¼Œè§‚å¯Ÿå®ƒè¢«è°ƒåº¦åˆ°å“ªä¸ªèŠ‚ç‚¹ä¸Šäº†ï¼š</p><p><img src="img/QQæˆªå›¾20191105203532.png" alt="QQæˆªå›¾20191105203532.png"></p><p>podAntiAffinityå’ŒpodAffinityåˆšå¥½ç›¸åï¼Œä¸¾ä¸ªä¾‹å­ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„é…ç½®ç±»ï¼ˆpod-affinity-two.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pod-affinity-two</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">  affinity:</span></span><br><span class="line"><span class="attr">    podAntiAffinity:</span></span><br><span class="line"><span class="attr">      requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line"><span class="attr">        - labelSelector:</span></span><br><span class="line"><span class="attr">            matchExpressions:</span></span><br><span class="line"><span class="attr">              - key:</span> <span class="string">app</span></span><br><span class="line"><span class="attr">                operator:</span> <span class="string">In</span></span><br><span class="line"><span class="attr">                values:</span></span><br><span class="line"><span class="bullet">                  -</span> <span class="string">flag-nginx</span></span><br><span class="line"><span class="attr">          topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢é…ç½®å¸Œæœ›nginx podä¸å’Œapp=flag-nginxçš„Podåœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ã€‚</p><p>åˆ›å»ºè¯¥Podï¼Œè§‚å¯Ÿå®ƒè¢«è°ƒåº¦åˆ°å“ªä¸ªèŠ‚ç‚¹ä¸Šäº†ï¼š</p><p><img src="img/QQæˆªå›¾20191105203938.png" alt="QQæˆªå›¾20191105203938.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œå®ƒå’Œflag-nginxå¤„äºä¸åŒçš„èŠ‚ç‚¹ï¼Œä½äºnode2ã€‚</p><h3 id="Taints-amp-Tolerations"><a href="#Taints-amp-Tolerations" class="headerlink" title="Taints &amp; Tolerations"></a>Taints &amp; Tolerations</h3><p>Taintsç”¨äºç»™èŠ‚ç‚¹æ·»åŠ æ±¡ç‚¹ï¼Œè€ŒTolerationsç”¨äºå®šä¹‰Podå¯¹èŠ‚ç‚¹æ±¡ç‚¹çš„å®¹å¿åº¦ã€‚åœ¨Nodeä¸Šè®¾ç½®ä¸€ä¸ªæˆ–å¤šä¸ªTaintä¹‹åï¼Œé™¤éPodæ˜ç¡®å£°æ˜èƒ½å¤Ÿå®¹å¿è¿™äº›æ±¡ç‚¹ï¼Œå¦åˆ™æ— æ³•åœ¨è¿™äº›Nodeä¸Šè¿è¡Œã€‚Tolerationæ˜¯Podçš„å±æ€§ï¼Œè®©Podèƒ½å¤Ÿï¼ˆæ³¨æ„ï¼Œåªæ˜¯èƒ½å¤Ÿï¼Œè€Œéå¿…é¡»ï¼‰è¿è¡Œåœ¨æ ‡æ³¨äº†Taintçš„Nodeä¸Šã€‚</p><p>ç»™èŠ‚ç‚¹è®¾ç½®æ±¡ç‚¹çš„è¯­æ³•ä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes [nodeName] key=value:rule</span><br></pre></td></tr></table></figure><p></p><p>å…¶ä¸­ruleçš„å–å€¼æœ‰ï¼š</p><ol><li><p>NoScheudleï¼šä¸è°ƒåº¦ï¼›</p></li><li><p>PreferNoScheduleï¼šæœ€å¥½ä¸è¦è°ƒåº¦ï¼›</p></li><li><p>NoExecuteï¼šä¸è¿è¡Œï¼›</p></li><li><p>PreferNoExecuteï¼šæœ€å¥½ä¸è¿è¡Œã€‚</p></li></ol><p>NoScheduleå’ŒNoExecuteåŒºåˆ«ï¼š</p><ul><li>NoScheduleä¸è°ƒåº¦ï¼Œå¦‚æœæ˜¯åœ¨è°ƒåº¦åè®¾ç½®çš„æ±¡ç‚¹ï¼Œå¹¶ä¸”Podæ²¡æœ‰å®¹å¿è¯¥æ±¡ç‚¹ï¼Œä¹Ÿèƒ½ç»§ç»­æ‰§è¡Œ</li><li>NoExecuteä¸æ‰§è¡Œï¼Œå¦‚æœæ˜¯åœ¨è°ƒåº¦åè®¾ç½®çš„æ±¡ç‚¹ï¼Œå¹¶ä¸”Podæ²¡æœ‰å®¹å¿è¯¥æ±¡ç‚¹ï¼Œåˆ™ä¼šè¢«é©±é€ã€‚å¯ä»¥è®¾ç½®é©±é€æ—¶é—´<code>tolerationSeconds: xx</code>ã€‚</li></ul><p>æˆ‘ä»¬ç»™node1èŠ‚ç‚¹è®¾ç½®ä¸€ä¸ªæ±¡ç‚¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes node1 aa=bb:NoSchedule</span><br></pre></td></tr></table></figure><p></p><p>ç„¶åæ–°å»ºä¸€ä¸ªPodé…ç½®ç±»ï¼ˆpod-taint-test.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pod-taint</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">  tolerations:</span></span><br><span class="line"><span class="attr">    - key:</span> <span class="string">"aa"</span></span><br><span class="line"><span class="attr">      operator:</span> <span class="string">"Equal"</span></span><br><span class="line"><span class="attr">      value:</span> <span class="string">"bb"</span></span><br><span class="line"><span class="attr">      effect:</span> <span class="string">"NoSchedule"</span></span><br></pre></td></tr></table></figure><p></p><p>Podçš„Tolerationå£°æ˜ä¸­çš„keyå’Œeffectéœ€è¦ä¸Taintçš„è®¾ç½®ä¿æŒä¸€è‡´ï¼Œå¹¶ä¸”æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ä¹‹ä¸€ï¼š</p><ol><li><p>operatorçš„å€¼æ˜¯Existsï¼ˆæ— é¡»æŒ‡å®švalueï¼‰ï¼Œå¦‚ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">......</span></span><br><span class="line"><span class="attr">  tolerations:</span></span><br><span class="line"><span class="attr">    - key:</span> <span class="string">"aa"</span></span><br><span class="line"><span class="attr">      operator:</span> <span class="string">"Exists"</span></span><br><span class="line"><span class="attr">      effect:</span> <span class="string">"NoSchedule"</span></span><br></pre></td></tr></table></figure></li><li><p>operatorçš„å€¼æ˜¯Equalå¹¶ä¸”valueç›¸ç­‰ã€‚å¦‚æœä¸æŒ‡å®šoperatorï¼Œåˆ™é»˜è®¤å€¼ä¸ºEqualã€‚</p></li></ol><p>å¦å¤–ï¼Œæœ‰å¦‚ä¸‹ä¸¤ä¸ªç‰¹ä¾‹ï¼š</p><ol><li>ç©ºçš„keyé…åˆExistsæ“ä½œç¬¦èƒ½å¤ŸåŒ¹é…æ‰€æœ‰çš„é”®å’Œå€¼ï¼›</li><li>ç©ºçš„effectåŒ¹é…æ‰€æœ‰çš„effectã€‚</li></ol><p>å›åˆ°pod-taint-test.ymlï¼Œè¯¥é…ç½®æ–‡ä»¶å®šä¹‰nginx podå¯ä»¥å®¹å¿<code>aa=bb:NoSchedule</code>è¿™ä¸ªæ±¡ç‚¹ï¼Œæ‰€ä»¥å®ƒæœ‰å¯èƒ½ä¼šè¢«è°ƒåº¦åˆ°node1ä¸Šã€‚åˆ›å»ºè¯¥Podï¼Œè§‚å¯Ÿï¼š</p><p><img src="img/QQæˆªå›¾20191105204219.png" alt="QQæˆªå›¾20191105204219.png"></p><p>è¿™æ—¶å€™åœ¨nginx podæ‰€è¿è¡Œçš„èŠ‚ç‚¹node1ä¸Šæ–°å¢ä¸€ä¸ªæ±¡ç‚¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes node1 cc=dd:NoExecute</span><br></pre></td></tr></table></figure><p></p><p>è§‚å¯Ÿnginx podæƒ…å†µï¼š</p><p><img src="img/QQæˆªå›¾20191105204303.png" alt="QQæˆªå›¾20191105204303.png"></p><p>å¯ä»¥çœ‹åˆ°å®ƒè¢«é©±é€äº†ï¼Œå·²ç»æ²¡æœ‰æ­£åœ¨è¿è¡Œçš„podäº†ã€‚</p><h3 id="Pod-Priority-Preemption"><a href="#Pod-Priority-Preemption" class="headerlink" title="Pod Priority Preemption"></a>Pod Priority Preemption</h3><p>æˆ‘ä»¬å¯ä»¥ç»™PodæŒ‡å®šä¼˜å…ˆçº§ï¼Œä¼˜å…ˆçº§å¯ä»¥é€šè¿‡PriorityClasså¯¹è±¡åˆ›å»ºï¼Œæ¯”å¦‚åˆ›å»ºä¸€ä¸ªä¼˜å…ˆçº§ä¸º10000çš„PriorityClassï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">scheduling.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PriorityClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">hign-priority</span></span><br><span class="line"><span class="attr">value:</span> <span class="number">10000</span></span><br><span class="line"><span class="attr">globalDefault:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">"10000ä¼˜å…ˆçº§"</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸Šè¿°æ–‡ä»¶å®šä¹‰äº†ä¸€ä¸ªåä¸ºhigh-priorityçš„ä¼˜å…ˆçº§ç±»åˆ«ï¼Œä¼˜å…ˆçº§ä¸º10000ï¼Œæ•°å­—è¶Šå¤§ï¼Œä¼˜å…ˆè¶Šé«˜ã€‚è¶…è¿‡ä¸€äº¿çš„æ•°å­—è¢«ç³»ç»Ÿä¿ç•™ï¼Œç”¨äºæŒ‡æ´¾ç»™ç³»ç»Ÿç»„ä»¶ã€‚</p><p>ä¼˜å…ˆçº§åˆ›å»ºåï¼Œå¯ä»¥åœ¨Podå®šä¹‰ä¸­å¼•ç”¨è¯¥ä¼˜å…ˆçº§ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">  priorityClassName:</span> <span class="string">hign-priority</span></span><br></pre></td></tr></table></figure><p></p><h2 id="Podç®¡ç†å¯¹è±¡"><a href="#Podç®¡ç†å¯¹è±¡" class="headerlink" title="Podç®¡ç†å¯¹è±¡"></a>Podç®¡ç†å¯¹è±¡</h2><h3 id="Job"><a href="#Job" class="headerlink" title="Job"></a>Job</h3><p>Jobæ˜¯ä¸€ç§ç‰¹æ®Šçš„Podç®¡ç†å¯¹è±¡ï¼Œæ˜¯ä¸€ç§ä¸€æ¬¡æ€§Podè¿è¡Œä»»åŠ¡ï¼Œä»»åŠ¡ç»“æŸåï¼ŒPodçš„ç”Ÿå‘½å‘¨æœŸä¹Ÿå°±ç»“æŸäº†ã€‚</p><p>å®šä¹‰ä¸€ä¸ªJobé…ç½®ç±»ï¼ˆjob.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">job-ex</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">job</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">          command:</span> <span class="string">["echo",</span> <span class="string">"hello job"</span><span class="string">]</span></span><br><span class="line"><span class="attr">      restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure><p></p><p>Jobçš„é‡å¯ç­–ç•¥<code>restartPolicy</code>åªæ”¯æŒNeverå’ŒOnFailureã€‚</p><p>åˆ›å»ºè¿™ä¸ªJobï¼š</p><p><img src="img/QQæˆªå›¾20191105140915.png" alt="QQæˆªå›¾20191105140915.png"></p><p>æŸ¥çœ‹JobçŠ¶æ€ï¼š</p><p><img src="img/QQæˆªå›¾20191105141330.png" alt="QQæˆªå›¾20191105141330.png"></p><p>COMPLETIONS 1/1è¡¨ç¤ºæ€»å…±éœ€è¦æ‰§è¡Œ1ä¸ªä»»åŠ¡ï¼Œå…±æ‰§è¡Œå®Œ1ä¸ªä»»åŠ¡ã€‚</p><p>æŸ¥çœ‹å¯¹åº”Podçš„çŠ¶æ€ï¼š</p><p><img src="img/QQæˆªå›¾20191105141452.png" alt="QQæˆªå›¾20191105141452.png"></p><p>çŠ¶æ€ä¸ºCompletedã€‚</p><p>æŸ¥çœ‹Jobæ—¥å¿—ï¼š</p><p><img src="img/QQæˆªå›¾20191105141618.png" alt="QQæˆªå›¾20191105141618.png"></p><p>Jobè¿˜å¯ä»¥è®¾ç½®å¹¶å‘æ•°é‡å’Œæ€»Jobæ•°ï¼Œä¿®æ”¹ä¸Šé¢çš„job.ymlï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">job-ex</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  parallelism:</span> <span class="number">2</span> <span class="comment"># å¹¶å‘æ•°2</span></span><br><span class="line"><span class="attr">  completions:</span> <span class="number">6</span> <span class="comment"># æ€»çš„Jobæ•°é‡</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">job</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">          command:</span> <span class="string">["echo",</span> <span class="string">"hello job"</span><span class="string">]</span></span><br><span class="line"><span class="attr">      restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure><p></p><p>è¿è¡Œè¯¥Jobï¼š <img src="img/QQæˆªå›¾20191105142838.png" alt="QQæˆªå›¾20191105142838.png"></p><p>æŸ¥çœ‹Podï¼š</p><p><img src="img/QQæˆªå›¾20191105142918.png" alt="QQæˆªå›¾20191105142918.png"></p><h3 id="CronJob"><a href="#CronJob" class="headerlink" title="CronJob"></a>CronJob</h3><p>CronJobé¡¾åæ€ä¹‰å°±æ˜¯æ”¯æŒCronè¡¨è¾¾å¼çš„Jobï¼Œä¸è¿‡Kubernetesçš„Cronè¡¨è¾¾å¼å’Œä¼ ç»Ÿçš„Cronè¡¨è¾¾å¼ä¸å¤ªä¸€æ ·ï¼Œä¸æ”¯æŒåˆ°ç§’çº§ã€‚å…·ä½“è§„åˆ™å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Minutes Hours DayofMonth Month DayofWeek Year</span><br></pre></td></tr></table></figure><p></p><ol><li><p>Minutesï¼šå¯å‡ºç°<code>,</code> <code>-</code> <code>*</code> <code>/</code> è¿™4ä¸ªå­—ç¬¦ï¼Œæœ‰æ•ˆèŒƒå›´ä¸º0ï½59çš„æ•´æ•°ã€‚</p></li><li><p>Hoursï¼šå¯å‡ºç°<code>,</code> <code>-</code> <code>*</code> <code>/</code>è¿™4ä¸ªå­—ç¬¦ï¼Œ æœ‰æ•ˆèŒƒå›´ä¸º0ï½23çš„æ•´æ•°ã€‚</p></li><li><p>DayofMonthï¼šå¯å‡ºç°<code>,</code> <code>-</code> <code>*</code> <code>/</code> <code>?</code> <code>L</code> <code>W</code> <code>C</code> è¿™8ä¸ªå­—ç¬¦ï¼Œæœ‰æ•ˆèŒƒå›´ä¸º0ï½31çš„æ•´æ•°ã€‚</p></li><li><p>Monthï¼šå¯å‡ºç°<code>,</code> <code>-</code> <code>*</code> <code>/</code>è¿™4ä¸ªå­—ç¬¦ï¼Œæœ‰æ•ˆèŒƒå›´ä¸º1ï½12çš„æ•´æ•°æˆ–JANï½DECã€‚</p></li><li><p>DayofWeekï¼šå¯å‡ºç°<code>,</code> <code>-</code> <code>*</code> <code>/</code> <code>?</code> <code>L</code> <code>C</code> <code>ï¼ƒ</code>è¿™8ä¸ªå­—ç¬¦ï¼Œæœ‰æ•ˆèŒƒå›´ä¸º1ï½7çš„æ•´æ•°æˆ–SUNï½SATã€‚1è¡¨ç¤ºæ˜ŸæœŸå¤©ï¼Œ2è¡¨ç¤ºæ˜ŸæœŸä¸€ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p></li></ol><p>ä¸Šé¢ç‰¹æ®Šå­—ç¬¦çš„å«ä¹‰å¦‚ä¸‹ï¼š</p><ol><li><p><code>*</code>ï¼šè¡¨ç¤ºåŒ¹é…è¯¥åŸŸçš„ä»»æ„å€¼ï¼Œå‡å¦‚åœ¨MinutesåŸŸä½¿ç”¨<code>*</code>ï¼Œåˆ™è¡¨ç¤ºæ¯åˆ†é’Ÿéƒ½ä¼šè§¦å‘äº‹ä»¶ã€‚</p></li><li><p><code>/</code>ï¼šè¡¨ç¤ºä»èµ·å§‹æ—¶é—´å¼€å§‹è§¦å‘ï¼Œç„¶åæ¯éš”å›ºå®šæ—¶é—´è§¦å‘ä¸€æ¬¡ï¼Œä¾‹å¦‚åœ¨MinutesåŸŸè®¾ç½®ä¸º5/20ï¼Œåˆ™æ„å‘³ç€ç¬¬1æ¬¡è§¦å‘åœ¨ç¬¬5minæ—¶ï¼Œæ¥ä¸‹æ¥æ¯20minè§¦å‘ä¸€æ¬¡ï¼Œå°†åœ¨ç¬¬25minã€ç¬¬45minç­‰æ—¶åˆ»åˆ†åˆ«è§¦å‘ã€‚</p></li></ol><p>å®šä¹‰ä¸€ä¸ªCronJobçš„é…ç½®ç±»ï¼ˆcron-job.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cron-job-ex</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  schedule:</span> <span class="string">"*/1 * * * *"</span></span><br><span class="line"><span class="attr">  jobTemplate:</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      template:</span></span><br><span class="line"><span class="attr">        spec:</span></span><br><span class="line"><span class="attr">          containers:</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">hello</span></span><br><span class="line"><span class="attr">              image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">              command:</span> <span class="string">["sh",</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"date;echo hello cronJob"</span><span class="string">]</span></span><br><span class="line"><span class="attr">          restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢çš„å®šæ—¶ä»»åŠ¡æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ã€‚</p><p>åˆ›å»ºè¯¥CronJobï¼š</p><p><img src="img/QQæˆªå›¾20191105144308.png" alt="QQæˆªå›¾20191105144308.png"></p><p>è¿‡ä¸ªä¸¤ä¸‰åˆ†é’ŸæŸ¥çœ‹è¿è¡Œæƒ…å†µï¼š</p><p><img src="img/QQæˆªå›¾20191105145147.png" alt="QQæˆªå›¾20191105145147.png"></p><h3 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h3><p>DaemonSeté€‚ç”¨äºåœ¨æ¯ä¸ªNodeéƒ½éœ€è¦è¿è¡Œä¸€ä¸ªPodçš„æ—¶å€™ä½¿ç”¨ï¼Œæ¯”å¦‚ï¼šæ¯ä¸€ä¸ªNodeä¸Šè¿è¡Œä¸€ä¸ªæ—¥å¿—é‡‡é›†ã€æ€§èƒ½ç›‘æ§çš„Podã€‚</p><p>æ¯”å¦‚æˆ‘ä»¬ç°åœ¨éœ€è¦åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½éƒ¨ç½²ä¸€ä¸ªnode-exporteræ¥é‡‡é›†èŠ‚ç‚¹ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡DaemonSetæ¥å®ç°ã€‚</p><p>å®šä¹‰ä¸€ä¸ªDaemonSeté…ç½®æ–‡ä»¶ï¼ˆdaemonset.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">node-exporter-d</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">node-exporter</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">node-exporter</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">node-exporter</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">prom/node-exporter</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">9100</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥DaemonSetä¹‹å‰å…ˆåˆ é™¤ä¸Šé¢åœ¨node1èŠ‚ç‚¹ä¸Šåˆ›å»ºçš„æ±¡ç‚¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes node1 aa:NoSchedule-</span><br><span class="line">kubectl taint nodes node1 cc:NoExecute-</span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥DaemonSetï¼Œç„¶åè§‚å¯ŸPodä¿¡æ¯ï¼Œçœ‹æ˜¯å¦æ¯ä¸ªèŠ‚ç‚¹éƒ½éƒ¨ç½²äº†ä¸€ä¸ªå®ä¾‹ï¼š</p><p><img src="img/QQæˆªå›¾20191105205401.png" alt="QQæˆªå›¾20191105205401.png"></p><h3 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a>StatefulSet</h3><p>ç³»ç»Ÿå­¦ä¹ PV/PVCåå†æ·±å…¥ã€‚</p><blockquote><p>ã€ŠKubernetesæƒå¨æŒ‡å—(ç¬¬4ç‰ˆ)ã€‹è¯»ä¹¦ç¬”è®°</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;åœ¨å‰é¢çš„å­¦ä¹ ä¸­æˆ‘ä»¬äº†è§£åˆ°ï¼Œåœ¨Kubernetesä¸­ï¼ŒPodç®¡ç†å¯¹è±¡ä¸»è¦æœ‰RC(RS)ã€Deploymentã€StatefulSetã€DaemonSetå’ŒJobï¼ˆCronJobï¼‰ç­‰ã€‚å…¶ä¸­RC(RS)å’ŒDeploymentçš„ç”¨æ³•å·²ç»å¤§è‡´äº†è§£ï¼Œè¿™é‡Œä¸»è¦è®°å½•ä¸‹StatefulSetã€DaemonSetå’ŒJobï¼ˆCronJobï¼‰çš„ç”¨æ³•ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒPodç®¡ç†å¯¹è±¡åœ¨åˆ›å»ºPodçš„æ—¶å€™æ˜¯æ ¹æ®ç³»ç»Ÿè‡ªåŠ¨è°ƒåº¦ç®—æ³•æ¥å®Œæˆéƒ¨ç½²çš„ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®è°ƒåº¦ç­–ç•¥æ¥å®ç°Podçš„ç²¾å‡†è°ƒåº¦ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Kubernetes" scheme="http://mrbird.cc/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes PodåŸºç¡€</title>
    <link href="http://mrbird.cc/Kubernetes-Pod-Basic.html"/>
    <id>http://mrbird.cc/Kubernetes-Pod-Basic.html</id>
    <published>2019-11-03T02:50:14.000Z</published>
    <updated>2019-11-03T09:32:24.908Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --><p>Podæ˜¯Kubernetesçš„æœ€å°è°ƒåº¦å•ä½ï¼ŒåŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨ï¼ˆæ¯”å¦‚Dockerå®¹å™¨ï¼‰ï¼Œå®¹å™¨é—´å…±äº«ç½‘ç»œå’Œå­˜å‚¨ã€‚è¿™èŠ‚ä¸»è¦è®°å½•ä»€ä¹ˆæ˜¯é™æ€Podï¼ŒPodå®¹å™¨å¦‚ä½•å…±äº«å­˜å‚¨ï¼Œå¦‚ä½•ä½¿ç”¨ConfigMapç®¡ç†Podé…ç½®ï¼Œå¦‚ä½•ä½¿ç”¨Downward APIè·å–Podä¿¡æ¯ç­‰ã€‚<a id="more"></a></p><h2 id="é™æ€Pod"><a href="#é™æ€Pod" class="headerlink" title="é™æ€Pod"></a>é™æ€Pod</h2><p>é™æ€Podæ˜¯ç”±kubeletåˆ›å»ºå¹¶ç®¡ç†çš„ç‰¹æ®Šçš„Podï¼Œæ— æ³•å’ŒPodç®¡ç†å¯¹è±¡å…³è”ï¼Œå¹¶ä¸”ä¸èƒ½é€šè¿‡API Serverå…³è”ã€‚åˆ›å»ºé™æ€Podæœ‰é…ç½®æ–‡ä»¶æ–¹å¼å’ŒHTTPæ–¹å¼ï¼š</p><h3 id="é…ç½®æ–‡ä»¶æ–¹å¼"><a href="#é…ç½®æ–‡ä»¶æ–¹å¼" class="headerlink" title="é…ç½®æ–‡ä»¶æ–¹å¼"></a>é…ç½®æ–‡ä»¶æ–¹å¼</h3><p>åœ¨æ­å»ºKubernetesé›†ç¾¤çš„æ—¶å€™ï¼Œä»å¯åŠ¨MasterèŠ‚ç‚¹çš„æ—¥å¿—å¯ä»¥çœ‹å‡ºï¼Œé™æ€Podçš„ç›®å½•ä½äº<code>/etc/kubernetes/manifests</code>ï¼š</p><p>åœ¨è¯¥ç›®å½•ä¸‹åˆ›å»ºé™æ€Podæ–‡ä»¶ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/kubernetes/manifests</span><br><span class="line">vim static-pod.yaml</span><br></pre></td></tr></table></figure><p></p><p>å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">static-pod</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">static-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">static-nginx</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p></p><p>è¿‡äº†ä¸€ä¼šæŸ¥çœ‹Podï¼š</p><p><img src="img/QQæˆªå›¾20191103124437.png" alt="QQæˆªå›¾20191103124437.png"></p><p>äºé™æ€Podæ— æ³•é€šè¿‡API Serverç›´æ¥ç®¡ç†ï¼Œæ‰€ä»¥åœ¨Masterä¸Šå°è¯•åˆ é™¤è¿™ä¸ªPodæ—¶ï¼Œä¼šä½¿å…¶å˜æˆPendingçŠ¶æ€ï¼Œä¸”ä¸ä¼šè¢«åˆ é™¤ã€‚</p><p><img src="img/QQæˆªå›¾20191103124756.png" alt="QQæˆªå›¾20191103124756.png"></p><p>åˆ é™¤è¯¥Podçš„æ“ä½œåªèƒ½æ˜¯åˆ°å…¶æ‰€åœ¨Nodeä¸Šå°†å…¶å®šä¹‰æ–‡ä»¶static-pod.yamlä»/etc/kubernetes/manifestsç›®å½•ä¸‹åˆ é™¤ï¼š</p><p><img src="img/QQæˆªå›¾20191103124916.png" alt="QQæˆªå›¾20191103124916.png"></p><h3 id="HTTPæ–¹å¼"><a href="#HTTPæ–¹å¼" class="headerlink" title="HTTPæ–¹å¼"></a>HTTPæ–¹å¼</h3><p>è¿‡è®¾ç½®kubeletçš„å¯åŠ¨å‚æ•°<code>--manifest-url</code>ï¼Œkubeletå°†ä¼šå®šæœŸä»è¯¥URLåœ°å€ä¸‹è½½Podçš„å®šä¹‰æ–‡ä»¶ï¼Œå¹¶ä»¥.yamlæˆ–.jsonæ–‡ä»¶çš„æ ¼å¼è¿›è¡Œè§£æï¼Œç„¶ååˆ›å»ºPodã€‚</p><h2 id="Podå®¹å™¨å…±äº«Volume"><a href="#Podå®¹å™¨å…±äº«Volume" class="headerlink" title="Podå®¹å™¨å…±äº«Volume"></a>Podå®¹å™¨å…±äº«Volume</h2><p>åŒä¸€ä¸ªPodçš„å¤šä¸ªå®¹å™¨é—´å¯ä»¥å…±äº«Podçº§åˆ«çš„Volumeï¼Œä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim pod-volume.yml</span><br></pre></td></tr></table></figure><p></p><p>å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pod-volume</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">      imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">      volumeMounts:</span></span><br><span class="line"><span class="attr">        - mountPath:</span> <span class="string">/usr/local/tomcat/logs</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">logs</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">["sh",</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"tail -f /logs/catalina*.log"</span><span class="string">]</span></span><br><span class="line"><span class="attr">      volumeMounts:</span></span><br><span class="line"><span class="attr">        - mountPath:</span> <span class="string">/logs</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">logs</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">logs</span></span><br><span class="line"><span class="attr">      emptyDir:</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢Podå®šä¹‰ä¸­ï¼Œåˆ›å»ºäº†ä¸€ä¸ªPodçº§åˆ«çš„Volumeï¼Œåç§°ä¸ºlogsï¼Œç±»å‹ä¸ºemptyDirã€‚è¿™ä¸ªVolumeåŒæ—¶æŒ‚è½½åˆ°äº†tomcatçš„/usr/local/tomcat/logsç›®å½•ä¸‹ï¼Œä¹ŸæŒ‚è½½åˆ°äº†busyboxçš„/logsç›®å½•ä¸‹ã€‚</p><p>åˆ›å»ºè¯¥Podï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f pod-volume.yml</span><br></pre></td></tr></table></figure><p></p><div class="note info"><p>è¿™é‡Œçš„tomcaté•œåƒæ¯”è¾ƒå¤§ï¼Œå¤§æ¦‚æœ‰500MBå·¦å³ï¼Œæ‰€ä»¥åœ¨åˆ›å»ºä¹‹å‰ï¼Œæœ€å¥½åœ¨Kubernetesé›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹ä¸­é…ç½®Dockeré•œåƒåŠ é€Ÿåœ°å€ã€‚</p></div><p>å½“pod-volumeçŠ¶æ€ä¸ºreadyåï¼ŒæŸ¥çœ‹busyboxçš„æ—¥å¿—ï¼š</p><p><img src="img/QQæˆªå›¾20191103143252.png" alt="QQæˆªå›¾20191103143252.png"></p><p>è¯¥æ—¥å¿—ä¸ºtomcatçš„å¯åŠ¨æ—¥å¿—ï¼Œè¯´æ˜ä¸Šé¢æŒ‚è½½çš„Volumeç”Ÿæ•ˆäº†ï¼Œå¯ä»¥é€šè¿‡æŸ¥çœ‹tomcat<code>/usr/local/tomcat/logs</code>ç›®å½•ä¸‹å’Œbusybox<code>/logs</code>ç›®å½•ä¸‹çš„å†…å®¹æ¥è¯æ˜è¿™ä¸€ç‚¹ï¼š</p><p><img src="img/QQæˆªå›¾20191103143458.png" alt="QQæˆªå›¾20191103143458.png"></p><h2 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h2><p>ConfigMapä»¥ä¸€ä¸ªæˆ–å¤šä¸ªkey:valueçš„å½¢å¼ä¿å­˜åœ¨Kubernetesç³»ç»Ÿä¸­ä¾›åº”ç”¨ä½¿ç”¨ï¼Œæ—¢å¯ä»¥ç”¨äºè¡¨ç¤ºä¸€ä¸ªå˜é‡çš„å€¼ï¼ˆä¾‹å¦‚version=v1ï¼‰ï¼Œä¹Ÿå¯ä»¥ç”¨äºè¡¨ç¤ºä¸€ä¸ªå®Œæ•´é…ç½®æ–‡ä»¶çš„å†…å®¹ï¼ˆä¾‹å¦‚<code>server.xml=&lt;?xml...&gt;...</code>ï¼‰ã€‚</p><h3 id="åˆ›å»ºConfigMap"><a href="#åˆ›å»ºConfigMap" class="headerlink" title="åˆ›å»ºConfigMap"></a>åˆ›å»ºConfigMap</h3><p>åˆ›å»ºConfigMapä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><p><strong>1.é€šè¿‡ymlæ–‡ä»¶åˆ›å»º</strong></p><p>åˆ›å»º<code>simple-cm.yml</code>æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">simple-cm</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  version:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">  release:</span> <span class="string">stable</span></span><br></pre></td></tr></table></figure><p></p><p>è¯¥ConfigMapä»…åŒ…å«ä¸¤ä¸ªç®€å•çš„å€¼versionå’Œreleasesã€‚</p><p>åˆ›å»ºè¯¥ConfigMapï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f simple-cm.yml</span><br></pre></td></tr></table></figure><p></p><p>æŸ¥çœ‹è¯¥ConfigMapï¼š</p><p><img src="img/QQæˆªå›¾20191103145002.png" alt="QQæˆªå›¾20191103145002.png"></p><p>åœ¨å®šä¹‰ConfigMapçš„æ—¶å€™ï¼Œvalueé™¤äº†å¯ä»¥ä½¿ç”¨ç®€å•çš„å€¼å¤–ï¼Œè¿˜å¯ä»¥æ˜¯æ•´ä¸ªé…ç½®æ–‡ä»¶çš„å†…å®¹ã€‚</p><p>åˆ›å»º<code>file-cm.yml</code>ï¼Œå†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">file-cm</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  serverXml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="string">    &lt;Server port="8005" shutdown="SHUTDOWN"&gt;</span></span><br><span class="line"><span class="string">      &lt;Listener className="org.apache.catalina.startup.VersionLoggerListener"/&gt;</span></span><br><span class="line"><span class="string">      &lt;Listener SSLEngine="on" className="org.apache.catalina.core.AprLifecycleListener"/&gt;</span></span><br><span class="line"><span class="string">      &lt;!-- Prevent memory leaks due to use of particular java/javax APIs--&gt;</span></span><br><span class="line"><span class="string">      &lt;Listener className="org.apache.catalina.core.JreMemoryLeakPreventionListener"/&gt;</span></span><br><span class="line"><span class="string">      &lt;Listener className="org.apache.catalina.mbeans.GlobalResourcesLifecycleListener"/&gt;</span></span><br><span class="line"><span class="string">      &lt;Listener className="org.apache.catalina.core.ThreadLocalLeakPreventionListener"/&gt;</span></span><br><span class="line"><span class="string">      &lt;GlobalNamingResources&gt;</span></span><br><span class="line"><span class="string">        &lt;Resource auth="Container" description="User database that can be updated and saved" factory="org.apache.catalina.users.MemoryUserDatabaseFactory" name="UserDatabase" pathname="conf/tomcat-users.xml" type="org.apache.catalina.UserDatabase"/&gt;</span></span><br><span class="line"><span class="string">      &lt;/GlobalNamingResources&gt;</span></span><br><span class="line"><span class="string">      &lt;Service name="Catalina"&gt;</span></span><br><span class="line"><span class="string">        &lt;Connector connectionTimeout="20000" port="8080" protocol="HTTP/1.1" redirectPort="8443"/&gt;</span></span><br><span class="line"><span class="string">        &lt;Connector port="8009" protocol="AJP/1.3" redirectPort="8443"/&gt;</span></span><br><span class="line"><span class="string">        &lt;Engine defaultHost="localhost" name="Catalina"&gt;</span></span><br><span class="line"><span class="string">          &lt;Realm className="org.apache.catalina.realm.LockOutRealm"&gt;</span></span><br><span class="line"><span class="string">            &lt;Realm className="org.apache.catalina.realm.UserDatabaseRealm" resourceName="UserDatabase"/&gt;</span></span><br><span class="line"><span class="string">          &lt;/Realm&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">          &lt;Host appBase="webapps" autoDeploy="true" name="localhost" unpackWARs="true"&gt;</span></span><br><span class="line"><span class="string">            &lt;Valve className="org.apache.catalina.valves.AccessLogValve" directory="logs" pattern="%h %l %u %t &amp;quot;%r&amp;quot; %s %b" prefix="localhost_access_log" suffix=".txt"/&gt;</span></span><br><span class="line"><span class="string">          &lt;Context docBase="D:\Code\apache-tomcat-8.5.32\webapps\tj_certification" path="/tj_certification" reloadable="true" source="org.eclipse.jst.jee.server:tj_certification"/&gt;&lt;/Host&gt;</span></span><br><span class="line"><span class="string">        &lt;/Engine&gt;</span></span><br><span class="line"><span class="string">      &lt;/Service&gt;</span></span><br><span class="line"><span class="string">    &lt;/Server&gt;</span></span><br><span class="line"><span class="string"></span><span class="attr">  serverProperties:</span> <span class="string">"1catalina.org.apache.juli.AsyncFileHandler.level = FINE</span></span><br><span class="line"><span class="string">                     1catalina.org.apache.juli.AsyncFileHandler.directory = $&#123;catalina.base&#125;/logs</span></span><br><span class="line"><span class="string">                     1catalina.org.apache.juli.AsyncFileHandler.prefix = catalina.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                     2localhost.org.apache.juli.AsyncFileHandler.level = FINE</span></span><br><span class="line"><span class="string">                     2localhost.org.apache.juli.AsyncFileHandler.directory = $&#123;catalina.base&#125;/logs</span></span><br><span class="line"><span class="string">                     2localhost.org.apache.juli.AsyncFileHandler.prefix = localhost.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                     3manager.org.apache.juli.AsyncFileHandler.level = FINE</span></span><br><span class="line"><span class="string">                     3manager.org.apache.juli.AsyncFileHandler.directory = $&#123;catalina.base&#125;/logs</span></span><br><span class="line"><span class="string">                     3manager.org.apache.juli.AsyncFileHandler.prefix = manager.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                     4host-manager.org.apache.juli.AsyncFileHandler.level = FINE</span></span><br><span class="line"><span class="string">                     4host-manager.org.apache.juli.AsyncFileHandler.directory = $&#123;catalina.base&#125;/logs</span></span><br><span class="line"><span class="string">                     4host-manager.org.apache.juli.AsyncFileHandler.prefix = host-manager.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                     java.util.logging.ConsoleHandler.level = FINE</span></span><br><span class="line"><span class="string">                     java.util.logging.ConsoleHandler.formatter = org.apache.juli.OneLineFormatter</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                     org.apache.catalina.core.ContainerBase.[Catalina].[localhost].level = INFO</span></span><br><span class="line"><span class="string">                     org.apache.catalina.core.ContainerBase.[Catalina].[localhost].handlers = 2localhost.org.apache.juli.AsyncFileHandler</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                     org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/manager].level = INFO</span></span><br><span class="line"><span class="string">                     org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/manager].handlers = 3manager.org.apache.juli.AsyncFileHandler</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                     org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/host-manager].level = INFO</span></span><br><span class="line"><span class="string">                     org.apache.catalina.core.ContainerBase.[Catalina].[localhost].[/host-manager].handlers = 4host-manager.org.apache.juli.AsyncFileHandler"</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥ConfigMapï¼š</p><p><img src="img/QQæˆªå›¾20191103150049.png" alt="QQæˆªå›¾20191103150049.png"></p><p><strong>2.ç›´æ¥é€šè¿‡Kubectlå‘½ä»¤åˆ›å»º</strong></p><p>é€šè¿‡kubectlå‘½ä»¤åˆ›å»ºConfigMapä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç§ç”¨æ³•ï¼š</p><ol><li><p>é€šè¿‡â€“from-fileå‚æ•°ä»æ–‡ä»¶ä¸­è¿›è¡Œåˆ›å»ºï¼Œå¯ä»¥æŒ‡å®škeyçš„åç§°ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸€ä¸ªå‘½ä»¤è¡Œä¸­åˆ›å»ºåŒ…å«å¤šä¸ªkeyçš„ConfigMapï¼Œè¯­æ³•ä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl cerate configmap [NAME] --from-file=[key=]source --from-file=[key=]source</span><br></pre></td></tr></table></figure></li><li><p>é€šè¿‡â€“from-fileå‚æ•°ä»ç›®å½•ä¸­è¿›è¡Œåˆ›å»ºï¼Œè¯¥ç›®å½•ä¸‹çš„æ¯ä¸ªé…ç½®æ–‡ä»¶åéƒ½è¢«è®¾ç½®ä¸ºkeyï¼Œæ–‡ä»¶çš„å†…å®¹è¢«è®¾ç½®ä¸ºvalueï¼Œè¯­æ³•ä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl cerate configmap [NAME] --from-file=config-file-dir</span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨â€“from-literalæ—¶ä¼šä»æ–‡æœ¬ä¸­è¿›è¡Œåˆ›å»ºï¼Œç›´æ¥å°†æŒ‡å®šçš„key#=value#åˆ›å»ºä¸ºConfigMapçš„å†…å®¹ï¼Œè¯­æ³•ä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl cerate configmap [NAME] --from-literal=key1=value1 --from-literal=key2=value2</span><br></pre></td></tr></table></figure></li></ol><p>æ¯”å¦‚ä½¿ç”¨kubectlå‘½ä»¤åˆ›å»ºä¸€ä¸ªå’Œsimple-cmæ•ˆæœä¸€æ ·çš„ConfigMapï¼š</p><p><img src="img/QQæˆªå›¾20191103150859.png" alt="QQæˆªå›¾20191103150859.png"></p><p>ä½¿ç”¨kubectlå‘½ä»¤åˆ›å»ºä¸€ä¸ªå’Œfile-cmæ•ˆæœä¸€æ ·çš„ConfigMapï¼š</p><p>é¦–å…ˆåœ¨å½“å‰ç›®å½•ä¸‹å‡†å¤‡å¥½ä¸¤ä¸ªé…ç½®æ–‡ä»¶server.xmlå’Œserver.propertiesï¼š</p><p><img src="img/QQæˆªå›¾20191103151524.png" alt="QQæˆªå›¾20191103151524.png"></p><p>ç„¶åä½¿ç”¨kubectlå‘½ä»¤åˆ›å»ºï¼š</p><p><img src="img/QQæˆªå›¾20191103151751.png" alt="QQæˆªå›¾20191103151751.png"></p><h3 id="Podå®¹å™¨ä½¿ç”¨ConfigMap"><a href="#Podå®¹å™¨ä½¿ç”¨ConfigMap" class="headerlink" title="Podå®¹å™¨ä½¿ç”¨ConfigMap"></a>Podå®¹å™¨ä½¿ç”¨ConfigMap</h3><p>Podçš„å®¹å™¨è¦ä½¿ç”¨ConfigMapä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ol><li>é€šè¿‡ç¯å¢ƒå˜é‡è·å–ConfigMapä¸­çš„å†…å®¹;</li><li>é€šè¿‡VolumeæŒ‚è½½çš„æ–¹å¼å°†ConfigMapä¸­çš„å†…å®¹æŒ‚è½½ä¸ºå®¹å™¨å†…éƒ¨çš„æ–‡ä»¶æˆ–ç›®å½•ã€‚</li></ol><p><strong>é€šè¿‡ç¯å¢ƒå˜é‡çš„æ–¹å¼</strong></p><p>åˆ›å»ºä¸€ä¸ªPodé…ç½®ï¼ˆsimple-cm-pod.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">simple-cm-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">["sh",</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"env | grep ENV"</span><span class="string">]</span> <span class="comment"># æ‰“å°åç§°åŒ…å«ENVçš„ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="attr">      env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">ENVVERSION</span>     <span class="comment"># å®šä¹‰ç¯å¢ƒå˜é‡åç§°</span></span><br><span class="line"><span class="attr">          valueFrom:</span>           <span class="comment"># å€¼æ¥è‡ª...</span></span><br><span class="line"><span class="attr">            configMapKeyRef:</span>   <span class="comment"># ConfigMapé”®çš„å¼•ç”¨</span></span><br><span class="line"><span class="attr">              key:</span> <span class="string">version</span>     <span class="comment"># ConfigMapçš„key</span></span><br><span class="line"><span class="attr">              name:</span> <span class="string">simple-cm</span>  <span class="comment"># ConfigMapçš„åç§°</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">ENVRELEASE</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            configMapKeyRef:</span></span><br><span class="line"><span class="attr">              key:</span> <span class="string">release</span></span><br><span class="line"><span class="attr">              name:</span> <span class="string">simple-cm</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥Podï¼Œå¹¶æŸ¥çœ‹æ—¥å¿—ï¼š</p><p><img src="img/QQæˆªå›¾20191103153532.png" alt="QQæˆªå›¾20191103153532.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œå€¼å·²ç»æˆåŠŸä»ConfigMapé‡Œå»åˆ°äº†ã€‚</p><p>å¦‚æœè¦å¼•ç”¨æŸä¸ªConfigMapçš„æ‰€æœ‰å†…å®¹ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢è¿™ç§æ–¹å¼ã€‚å®šä¹‰ä¸€ä¸ªPodé…ç½®ï¼ˆsimple-cm-pod-all.uymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">simple-cm-pod-all</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">["sh",</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"env"</span><span class="string">]</span></span><br><span class="line"><span class="attr">      envFrom:</span></span><br><span class="line"><span class="attr">        - configMapRef:</span></span><br><span class="line"><span class="attr">            name:</span> <span class="string">simple-cm</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥Podï¼Œå¹¶æŸ¥çœ‹æ—¥å¿—ï¼š</p><p><img src="img/QQæˆªå›¾20191103154213.png" alt="QQæˆªå›¾20191103154213.png"></p><p><strong>é€šè¿‡VolumeæŒ‚è½½çš„æ–¹å¼</strong></p><p>åˆ›å»ºä¸€ä¸ªPodé…ç½®ï¼ˆfile-cm-pod.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">file-cm-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">      volumeMounts:</span></span><br><span class="line"><span class="attr">        - mountPath:</span> <span class="string">/configs</span> <span class="comment"># å®¹å™¨æŒ‚è½½ç›®å½•ä¸º/configs</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">config-vm</span> <span class="comment"># å¼•ç”¨ä¸‹é¢å®šä¹‰çš„è¿™ä¸ªVolume</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">config-vm</span>   <span class="comment"># volumeåç§°ä¸ºconfig-vm</span></span><br><span class="line"><span class="attr">      configMap:</span>        <span class="comment"># é€šè¿‡ConfigMapè·å–</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">file-cm</span>   <span class="comment"># å¼•ç”¨åç§°ä¸ºfile-cmçš„ConfigMap</span></span><br><span class="line"><span class="attr">        items:</span></span><br><span class="line"><span class="attr">          - key:</span> <span class="string">serverXml</span> <span class="comment"># ConfigMapé‡Œé…ç½®çš„key</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">server.xml</span> <span class="comment"># å€¼ä½¿ç”¨server.xmlæ–‡ä»¶è¿›è¡ŒæŒ‚è½½</span></span><br><span class="line"><span class="attr">          - key:</span> <span class="string">serverProperties</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">server.properties</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥Podï¼Œå¹¶è¿›å…¥åˆ°å®¹å™¨å†…éƒ¨è§‚å¯Ÿ/configsç›®å½•ä¸‹æ–‡ä»¶å†…å®¹ï¼š</p><p><img src="img/QQæˆªå›¾20191103155731.png" alt="QQæˆªå›¾20191103155731.png"></p><p>å¯ä»¥çœ‹åˆ°åç§°ä¸ºfile-cmçš„ConfigMapå†…å®¹å·²ç»æˆåŠŸæŒ‚è½½åˆ°äº†tomcatå®¹å™¨å†…éƒ¨ã€‚</p><p>å¦‚æœåœ¨å¼•ç”¨ConfigMapæ—¶ä¸æŒ‡å®šitemsï¼Œåˆ™ä½¿ç”¨volumeMountæ–¹å¼åœ¨å®¹å™¨å†…çš„ç›®å½•ä¸‹ä¸ºæ¯ä¸ªiteméƒ½ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶åä¸ºkeyçš„æ–‡ä»¶ã€‚</p><div class="note danger"><p>åœ¨Podå¯¹ConfigMapè¿›è¡ŒæŒ‚è½½ï¼ˆvolumeMountï¼‰æ“ä½œæ—¶ï¼Œåœ¨å®¹å™¨å†…éƒ¨åªèƒ½æŒ‚è½½ä¸ºâ€œç›®å½•â€ï¼Œæ— æ³•æŒ‚è½½ä¸ºâ€œæ–‡ä»¶â€ã€‚åœ¨æŒ‚è½½åˆ°å®¹å™¨å†…éƒ¨åï¼Œåœ¨ç›®å½•ä¸‹å°†åŒ…å«ConfigMapå®šä¹‰çš„æ¯ä¸ªitemï¼Œå¦‚æœåœ¨è¯¥ç›®å½•ä¸‹åŸæ¥è¿˜æœ‰å…¶ä»–æ–‡ä»¶ï¼Œåˆ™å®¹å™¨å†…çš„è¯¥ç›®å½•å°†è¢«æŒ‚è½½çš„ConfigMap<strong>è¦†ç›–</strong>ã€‚</p></div><h2 id="Downward-API"><a href="#Downward-API" class="headerlink" title="Downward API"></a>Downward API</h2><p>Downward APIç”¨äºå°†Podç›¸å…³ä¿¡æ¯æ³¨å…¥åˆ°å®¹å™¨å†…éƒ¨ï¼Œä¸»è¦æœ‰<strong>ç¯å¢ƒå˜é‡</strong>å’Œ<strong>VolumeæŒ‚è½½</strong>ä¸¤ç§æ–¹å¼ã€‚</p><p><strong>ç¯å¢ƒå˜é‡</strong></p><p>åˆ›å»ºä¸€ä¸ªPodé…ç½®ï¼ˆdapi-pod.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">dapi-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">["sh",</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"env | grep MY_POD"</span><span class="string">]</span></span><br><span class="line"><span class="attr">      env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MY_POD_NAME</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">metadata.name</span> <span class="comment"># é€šè¿‡downward apiè·å–å½“å‰podåç§°</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MY_POD_NAMESPACE</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">metadata.namespace</span>  <span class="comment"># é€šè¿‡downward apiè·å–å½“å‰pod namespace</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MY_POD_IP</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">status.podIP</span>  <span class="comment"># é€šè¿‡downward apiè·å–å½“å‰pod IP</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥Podï¼Œå¹¶æŸ¥çœ‹æ—¥å¿—ï¼š</p><p><img src="img/QQæˆªå›¾20191103162045.png" alt="QQæˆªå›¾20191103162045.png"></p><p>é€šè¿‡ç¯å¢ƒå˜é‡çš„æ–¹å¼è¿˜å¯ä»¥å°†å®¹å™¨çš„requestså’Œlimitsä¿¡æ¯æ³¨å…¥åˆ°å®¹å™¨çš„ç¯å¢ƒå˜é‡ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªPodé…ç½®ï¼ˆdapi-pod-container-vars.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">dapi-pod-container-vars</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">["sh",</span> <span class="string">"-c"</span><span class="string">]</span></span><br><span class="line"><span class="attr">      args:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">while</span> <span class="literal">true</span><span class="string">;do</span></span><br><span class="line">            <span class="string">echo</span> <span class="bullet">-en</span> <span class="string">'\n'</span><span class="string">;</span></span><br><span class="line">            <span class="string">printenv</span> <span class="string">MY_CPU_REQUEST</span> <span class="string">MY_CPU_LIMIT;</span></span><br><span class="line">            <span class="string">printenv</span> <span class="string">MY_MEM_REQUEST</span> <span class="string">MY_MEM_LIMIT;</span></span><br><span class="line">            <span class="string">sleep</span> <span class="number">3600</span><span class="string">;</span></span><br><span class="line">          <span class="string">done;</span></span><br><span class="line"><span class="attr">      resources:</span></span><br><span class="line"><span class="attr">        requests:</span></span><br><span class="line"><span class="attr">          memory:</span> <span class="string">"32Mi"</span></span><br><span class="line"><span class="attr">          cpu:</span> <span class="string">"125m"</span></span><br><span class="line"><span class="attr">        limits:</span></span><br><span class="line"><span class="attr">          memory:</span> <span class="string">"64Mi"</span></span><br><span class="line"><span class="attr">          cpu:</span> <span class="string">"250m"</span></span><br><span class="line"><span class="attr">      env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MY_CPU_REQUEST</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            resourceFieldRef:</span></span><br><span class="line"><span class="attr">              resource:</span> <span class="string">requests.cpu</span></span><br><span class="line"><span class="attr">              containerName:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MY_CPU_LIMIT</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            resourceFieldRef:</span></span><br><span class="line"><span class="attr">              resource:</span> <span class="string">limits.cpu</span></span><br><span class="line"><span class="attr">              containerName:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MY_MEM_REQUEST</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            resourceFieldRef:</span></span><br><span class="line"><span class="attr">              resource:</span> <span class="string">request.memory</span></span><br><span class="line"><span class="attr">              containerName:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MY_MEM_LIMIT</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            resourceFieldRef:</span></span><br><span class="line"><span class="attr">              resource:</span> <span class="string">limits.memory</span></span><br><span class="line"><span class="attr">              containerName:</span> <span class="string">busybox</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥Podå¹¶è§‚å¯Ÿæ—¥å¿—ï¼š</p><p><img src="img/QQæˆªå›¾20191103163059.png" alt="QQæˆªå›¾20191103163059.png"></p><p><strong>é€šè¿‡VolumeæŒ‚è½½</strong></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡Downward APIå°†Podçš„Labelï¼ŒAnnotationç­‰ä¿¡æ¯æŒ‚è½½åˆ°å®¹å™¨å†…éƒ¨æ–‡ä»¶ä¸­ï¼Œæ–°å»ºä¸€ä¸ªPodé…ç½®ï¼ˆdapi-pod-volumes.ymlï¼‰ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">dapi-pod-volume</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">    release:</span> <span class="string">canary</span></span><br><span class="line"><span class="attr">    environment:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line"><span class="attr">    builder:</span> <span class="string">mrbird</span></span><br><span class="line"><span class="attr">    blog:</span> <span class="attr">https://mrbird.cc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">["sh",</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"sleep 36000"</span><span class="string">]</span></span><br><span class="line"><span class="attr">      volumeMounts:</span></span><br><span class="line"><span class="attr">        - mountPath:</span> <span class="string">/podinfo</span> <span class="comment"># æŒ‚è½½è·¯å¾„</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">pod-info</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">pod-info</span></span><br><span class="line"><span class="attr">      downwardAPI:</span> <span class="comment"># é€šè¿‡downward apiè·å–pod labelså’Œannationsä¿¡æ¯</span></span><br><span class="line"><span class="attr">        items:</span></span><br><span class="line"><span class="attr">          - path:</span> <span class="string">"labels"</span> <span class="comment"># æŒ‚è½½æ–‡ä»¶åç§°</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">metadata.labels</span> <span class="comment"># æŒ‚è½½å†…å®¹</span></span><br><span class="line"><span class="attr">          - path:</span> <span class="string">"annotation"</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">metadata.annotations</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥Podï¼Œå¹¶è¿›å…¥åˆ°å®¹å™¨/podinfoç›®å½•è§‚å¯Ÿç»“æœï¼š</p><p><img src="img/QQæˆªå›¾20191103171025.png" alt="QQæˆªå›¾20191103171025.png"></p><h2 id="Podç”Ÿå‘½å‘¨æœŸ"><a href="#Podç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="Podç”Ÿå‘½å‘¨æœŸ"></a>Podç”Ÿå‘½å‘¨æœŸ</h2><table><thead><tr><th>é˜¶æ®µ</th><th>æè¿°</th></tr></thead><tbody><tr><td><strong>Pending</strong></td><td>Pod å·²è¢« Kubernetes æ¥å—ï¼Œä½†å°šæœªåˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨é•œåƒã€‚è¿™åŒ…æ‹¬è¢«è°ƒåº¦ä¹‹å‰çš„æ—¶é—´ä»¥åŠé€šè¿‡ç½‘ç»œä¸‹è½½é•œåƒæ‰€èŠ±è´¹çš„æ—¶é—´ï¼Œæ‰§è¡Œéœ€è¦ä¸€æ®µæ—¶é—´ã€‚</td></tr><tr><td><strong>Running</strong></td><td>Pod å·²ç»è¢«ç»‘å®šåˆ°äº†ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ‰€æœ‰å®¹å™¨å·²è¢«åˆ›å»ºã€‚è‡³å°‘ä¸€ä¸ªå®¹å™¨æ­£åœ¨è¿è¡Œï¼Œæˆ–è€…æ­£åœ¨å¯åŠ¨æˆ–é‡æ–°å¯åŠ¨ã€‚</td></tr><tr><td><strong>Succeeded</strong></td><td>æ‰€æœ‰å®¹å™¨æˆåŠŸç»ˆæ­¢ï¼Œä¹Ÿä¸ä¼šé‡å¯ã€‚</td></tr><tr><td><strong>Failed</strong></td><td>æ‰€æœ‰å®¹å™¨ç»ˆæ­¢ï¼Œè‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨ä»¥å¤±è´¥æ–¹å¼ç»ˆæ­¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªå®¹å™¨è¦ä¹ˆå·²é 0 çŠ¶æ€é€€å‡ºï¼Œè¦ä¹ˆè¢«ç³»ç»Ÿç»ˆæ­¢ã€‚</td></tr><tr><td><strong>Unknown</strong></td><td>ç”±äºä¸€äº›åŸå› ï¼ŒPod çš„çŠ¶æ€æ— æ³•è·å–ï¼Œé€šå¸¸æ˜¯ä¸ Pod é€šä¿¡æ—¶å‡ºé”™å¯¼è‡´çš„ã€‚</td></tr></tbody></table><p>ä¸‰ç§é‡å¯ç­–ç•¥ï¼š</p><ol><li>Alwaysï¼šå½“å®¹å™¨å¤±æ•ˆæ—¶ï¼Œç”±kubeletè‡ªåŠ¨é‡å¯è¯¥å®¹å™¨ï¼›</li><li>OnFailureï¼šå½“å®¹å™¨ç»ˆæ­¢è¿è¡Œä¸”é€€å‡ºç ä¸ä¸º0æ—¶ï¼Œç”±kubeletè‡ªåŠ¨é‡å¯è¯¥å®¹å™¨ï¼›</li><li>Neverï¼šä¸è®ºå®¹å™¨è¿è¡ŒçŠ¶æ€å¦‚ä½•ï¼Œkubeletéƒ½ä¸ä¼šé‡å¯è¯¥å®¹å™¨ã€‚</li></ol><p>ç»“åˆPodçš„çŠ¶æ€å’Œé‡å¯ç­–ç•¥ï¼Œä»¥ä¸‹ä¸ºä¸€äº›å¸¸è§çš„çŠ¶æ€è½¬æ¢åœºæ™¯ï¼š</p><table align="center" border="1" cellpadding="1" cellspacing="1"><tbody><tr><td colspan="1" rowspan="2" style="text-align:center;width:107px">PodåŒ…å«çš„å®¹å™¨æ•°</td><td colspan="1" rowspan="2" style="text-align:center;width:108px">Podå½“å‰çš„çŠ¶æ€</td><td colspan="1" rowspan="2" style="text-align:center;width:139px">å‘ç”Ÿäº‹ä»¶</td><td colspan="3" rowspan="1" style="text-align:center;width:486px">Podçš„ç»“æœçŠ¶æ€</td></tr><tr><td style="width:137px">RestarPolicy=Always</td><td style="width:162px">RestartPolicy=OnFailure</td><td style="width:180px">RestartPolicy=Never</td></tr><tr><td style="width:107px">åŒ…å«1ä¸ªå®¹å™¨</td><td style="width:108px">Running</td><td style="width:139px">å®¹å™¨æˆåŠŸé€€å‡º</td><td style="width:137px">Running</td><td style="width:162px">Succeeded</td><td style="width:180px">Succeeded</td></tr><tr><td style="width:107px">åŒ…å«1ä¸ªå®¹å™¨</td><td style="width:108px">Running</td><td style="width:139px">å®¹å™¨å¤±è´¥é€€å‡º</td><td style="width:137px">Running</td><td style="width:162px">Running</td><td style="width:180px">Failed</td></tr><tr><td style="width:107px">åŒ…å«ä¸¤ä¸ªå®¹å™¨</td><td style="width:108px">Running</td><td style="width:139px">1ä¸ªå®¹å™¨å¤±è´¥é€€å‡º</td><td style="width:137px">Running</td><td style="width:162px">Running</td><td style="width:180px">Running</td></tr><tr><td style="width:107px">åŒ…å«ä¸¤ä¸ªå®¹å™¨</td><td style="width:108px">Running</td><td style="width:139px">å®¹å™¨è¢«OOMæ€æ‰</td><td style="width:137px">Running</td><td style="width:162px">Running</td><td style="width:180px">Failed</td></tr></tbody></table><blockquote><p>ã€ŠKubernetesæƒå¨æŒ‡å—(ç¬¬4ç‰ˆ)ã€‹è¯»ä¹¦ç¬”è®°</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;Podæ˜¯Kubernetesçš„æœ€å°è°ƒåº¦å•ä½ï¼ŒåŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨ï¼ˆæ¯”å¦‚Dockerå®¹å™¨ï¼‰ï¼Œå®¹å™¨é—´å…±äº«ç½‘ç»œå’Œå­˜å‚¨ã€‚è¿™èŠ‚ä¸»è¦è®°å½•ä»€ä¹ˆæ˜¯é™æ€Podï¼ŒPodå®¹å™¨å¦‚ä½•å…±äº«å­˜å‚¨ï¼Œå¦‚ä½•ä½¿ç”¨ConfigMapç®¡ç†Podé…ç½®ï¼Œå¦‚ä½•ä½¿ç”¨Downward APIè·å–Podä¿¡æ¯ç­‰ã€‚
    
    </summary>
    
    
      <category term="Kubernetes" scheme="http://mrbird.cc/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>KubernetesåŸºç¡€</title>
    <link href="http://mrbird.cc/Kubernetes-Basic.html"/>
    <id>http://mrbird.cc/Kubernetes-Basic.html</id>
    <published>2019-10-30T07:36:15.000Z</published>
    <updated>2019-11-16T10:13:18.197Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --><p>ä¸Šä¸€èŠ‚æˆ‘ä»¬å·²ç»æˆåŠŸæ­å»ºäº†Kubernetesé›†ç¾¤ï¼ŒKubernetesåŒ…å«äº†å¤§é‡çš„æ¦‚å¿µå’Œæœ¯è¯­ï¼Œæ¯”å¦‚Masterã€Nodeã€Podã€Replication Controllerã€Serviceç­‰ç­‰ï¼Œåœ¨æ·±å…¥å­¦ä¹ Kubernetesä¹‹å‰ï¼Œæœ‰å¿…è¦æ‹æ¸…Kubernetesæ¶æ„è®¾è®¡å’Œè¿™äº›æœ¯è¯­çš„å«ä¹‰ã€‚</p><a id="more"></a><h2 id="Kubernetesæ¶æ„"><a href="#Kubernetesæ¶æ„" class="headerlink" title="Kubernetesæ¶æ„"></a>Kubernetesæ¶æ„</h2><p>KubernetesåŸºæœ¬æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20191030093713.png" alt="QQæˆªå›¾20191030093713.png"></p><p>ç”±ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒKubernetesé›†ç¾¤èŠ‚ç‚¹å¯åˆ†ä¸º<strong>Master</strong>å’Œ<strong>Node</strong>ï¼š</p><ul><li>Masterï¼šæŒ‡çš„æ˜¯é›†ç¾¤ä¸­çš„æ§åˆ¶èŠ‚ç‚¹ï¼Œè´Ÿè´£ç®¡ç†å’Œæ§åˆ¶æ•´ä¸ªé›†ç¾¤ã€‚åŸºæœ¬ä¸Šæˆ‘ä»¬å¯¹Kubernetesé›†ç¾¤çš„æ“ä½œéƒ½æ˜¯åœ¨MasterèŠ‚ç‚¹ä¸Šå®Œæˆçš„ï¼›</li><li>Nodeï¼šé™¤äº†Masterå¤–ï¼ŒKubernetesé›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹ç§°ä¸ºNodeã€‚æ¯ä¸ªNodeéƒ½å°†è´Ÿè´£è¿è¡ŒMasteræŒ‡æ´¾çš„Dockerå®¹å™¨ï¼Œå½“æŸä¸ªNodeå®•æœºåï¼Œè¿™äº›å·¥ä½œä¼šè¢«Masterè½¬ç§»åˆ°åˆ«çš„Nodeä¸Šã€‚</li></ul><p>MasterèŠ‚ç‚¹ä¸Šä¸»è¦åŒ…å«äº†ä»¥ä¸‹è¿™äº›å…³æ¥çš„è¿›ç¨‹:</p><ol><li><strong>API Server</strong>ï¼šæä¾›äº†HTTP Restæ¥å£çš„å…³é”®æœåŠ¡è¿›ç¨‹ï¼Œæ˜¯Kubernetesé‡Œæ‰€æœ‰èµ„æºçš„å¢ã€åˆ ã€æ”¹ã€æŸ¥ç­‰æ“ä½œçš„å”¯ä¸€å…¥å£ï¼Œä¹Ÿæ˜¯é›†ç¾¤æ§åˆ¶çš„å…¥å£è¿›ç¨‹ï¼›</li><li><strong>Controller Manager</strong>ï¼šè´Ÿè´£ç»´æŠ¤é›†ç¾¤çš„çŠ¶æ€ï¼Œæ¯”å¦‚æ•…éšœæ£€æµ‹ï¼Œæ‰©ç¼©å®¹ï¼Œæ»šåŠ¨æ›´æ–°ç­‰ç­‰ï¼›</li><li><strong>Scheduler</strong>ï¼šè´Ÿè´£èµ„æºçš„è°ƒåº¦ï¼ŒæŒ‰ç…§é¢„å®šçš„ç­–ç•¥æŠŠpodè°ƒåº¦åˆ°æŒ‡å®šçš„nodeèŠ‚ç‚¹ï¼›</li><li><strong>etcd</strong>ï¼šå­˜å‚¨Kubernetesé›†ç¾¤ä¿¡æ¯ã€‚</li></ol><p>NodeèŠ‚ç‚¹ä¸Šä¸»è¦åŒ…å«äº†ä»¥ä¸‹è¿™äº›å…³æ¥çš„è¿›ç¨‹:</p><ol><li><strong>kubelet</strong>ï¼šè´Ÿè´£Podå¯¹åº”çš„å®¹å™¨çš„åˆ›å»ºã€å¯åœç­‰ä»»åŠ¡ï¼›</li><li><strong>kube-proxy</strong>ï¼šå®ç°Kubernetes Serviceçš„é€šä¿¡ä¸è´Ÿè½½å‡è¡¡æœºåˆ¶çš„é‡è¦ç»„ä»¶ï¼›</li><li><strong>docker</strong>ï¼šDockerå¼•æ“ï¼Œè´Ÿè´£æœ¬æœºçš„å®¹å™¨åˆ›å»ºå’Œç®¡ç†å·¥ä½œï¼›</li><li><strong>pod</strong>ï¼šPodæ˜¯Kubernetesä¸­èƒ½å¤Ÿåˆ›å»ºå’Œéƒ¨ç½²çš„æœ€å°å•å…ƒï¼Œæ˜¯Kubernetesé›†ç¾¤ä¸­çš„ä¸€ä¸ªåº”ç”¨å®ä¾‹ã€‚PodåŒ…å«äº†ä¸€ä¸ªâ€œæ ¹å®¹å™¨â€Pauseå’Œå¤šä¸ªDockerå®¹å™¨ï¼›</li></ol><p>KubernetesèŠ‚ç‚¹é—´çš„ç½‘ç»œé€šä¿¡é€šè¿‡ç½‘ç»œæ’ä»¶å®ç°ï¼Œæ¯”å¦‚Flannelï¼ŒCalicoç­‰ã€‚</p><h2 id="Podç®¡ç†å¯¹è±¡"><a href="#Podç®¡ç†å¯¹è±¡" class="headerlink" title="Podç®¡ç†å¯¹è±¡"></a>Podç®¡ç†å¯¹è±¡</h2><p>Podç®¡ç†å¯¹è±¡æŒ‡çš„æ˜¯Kubernetesä¸­å¯ä»¥ç”¨äºåˆ›å»ºå’Œç®¡ç†Podçš„ç»„ä»¶ï¼Œæ¯”å¦‚RC(RS)ï¼ŒDeploymentï¼ŒStableSetç­‰ç­‰ã€‚åœ¨äº†è§£è¿™äº›ç»„ä»¶å‰ï¼Œå…ˆæ¥çœ‹çœ‹Podçš„ç»„æˆï¼š</p><p><img src="img/QQæˆªå›¾20191030105535.png" alt="QQæˆªå›¾20191030105535.png"></p><p>PodåŒ…å«ä¸€ä¸ª<strong>Pause</strong>å®¹å™¨å’Œå¤šä¸ªDockerå®¹å™¨ï¼ŒPauseå®¹å™¨ç”¨äºç®¡ç†è¿™äº›Dockerå®¹å™¨ã€‚</p><p>Podå¯ä»¥é€šè¿‡yamlæ–‡ä»¶æ¥åˆ›å»ºï¼Œä¸‹é¢ä¸¾ä¸ªç®€å•çš„ä¾‹å­:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span> <span class="comment"># kindä¸ºpodè¡¨æ˜è¿™æ˜¯ä¸€ä¸ªpodå®šä¹‰</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-pod</span> <span class="comment"># podåç§°ä¸ºnginx-pod</span></span><br><span class="line"><span class="attr">  labels:</span> <span class="comment"># å®šä¹‰æ ‡ç­¾ä¿¡æ¯ï¼ˆlabelï¼‰</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nginx</span> </span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nginx</span> <span class="comment"># å®¹å™¨åç§°</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">nginx</span> <span class="comment"># åŸºäºnginxé•œåƒæ„å»º</span></span><br><span class="line"><span class="attr">      imagePullPolicy:</span> <span class="string">IfNotPresent</span> <span class="comment"># é•œåƒæ‹‰å–è§„åˆ™ï¼Œä¸å­˜åœ¨åˆ™è¿œç¨‹æ‹‰å–</span></span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span> <span class="comment"># ç«¯å£</span></span><br></pre></td></tr></table></figure><p></p><p>æ¯ä¸ªPodéƒ½åŒ…å«ä¸€ä¸ªå”¯ä¸€çš„IPåœ°å€ï¼Œç§°ä¸º<strong>Pod IP</strong>ï¼ŒKubernetesé›†ç¾¤å†…çš„ä»»æ„ä¸¤ä¸ªPodä¹‹é—´éƒ½èƒ½æ­£å¸¸é€šä¿¡ã€‚Pod IPåŠ ä¸Šä¸Šé¢å®šä¹‰çš„80ç«¯å£ï¼Œç»„æˆäº†ä¸€ä¸ª<strong>Endpoint</strong>ï¼Œä»£è¡¨æ­¤Podé‡Œçš„ä¸€ä¸ªæœåŠ¡è¿›ç¨‹çš„å¯¹å¤–é€šä¿¡åœ°å€ã€‚Podçš„ç›¸å…³å†…å®¹å­˜å‚¨åœ¨<strong>Volume</strong>ä¸­ï¼ŒPodçš„ç›¸å…³è¿è¡Œè®°å½•å¯ä»¥é€šè¿‡<strong>Event</strong>æŸ¥çœ‹ï¼š</p><p><img src="img/QQæˆªå›¾20191030113626.png" alt="QQæˆªå›¾20191030113626.png"></p><p>åœ¨å®šä¹‰Podçš„æ—¶å€™æˆ‘ä»¬ä¹Ÿå¯ä»¥æŒ‡å®šèµ„æºèµ„æºé™é¢ï¼Œèµ„æºä¸»è¦åŒ…æ‹¬<strong>CPU</strong>å’Œ<strong>Memory</strong>ï¼š</p><ul><li><p>åœ¨Kubernetesä¸­ï¼Œ1mè¡¨ç¤ºåƒåˆ†ä¹‹ä¸€CPUï¼Œå³1000mè¡¨ç¤ºä¸€ä¸ªCPUï¼›</p></li><li><p>å¸¸ç”¨å•ä½æœ‰KiBã€MiBå’ŒGiBç­‰ï¼Œæ˜¯äºŒè¿›åˆ¶è¡¨ç¤ºçš„å­—èŠ‚å•ä½ï¼Œ1 KiBï¼ˆKibiByteï¼‰= 2^10 Bytes = 1024 Bytes = 8192 Bitsã€‚</p></li></ul><p>åœ¨Kubernetesé‡Œï¼Œä¸€ä¸ªè®¡ç®—èµ„æºè¿›è¡Œé…é¢é™å®šæ—¶éœ€è¦è®¾å®šä»¥ä¸‹ä¸¤ä¸ªå‚æ•°ï¼š</p><ol><li><strong>Requests</strong>ï¼šè¯¥èµ„æºçš„æœ€å°ç”³è¯·é‡ï¼Œç³»ç»Ÿå¿…é¡»æ»¡è¶³è¦æ±‚ï¼›</li><li><strong>Limits</strong>ï¼šè¯¥èµ„æºæœ€å¤§å…è®¸ä½¿ç”¨çš„é‡ï¼Œä¸èƒ½è¢«çªç ´ï¼Œå½“å®¹å™¨è¯•å›¾ä½¿ç”¨è¶…è¿‡è¿™ä¸ªé‡çš„èµ„æºæ—¶ï¼Œå¯èƒ½ä¼šè¢«Kubernetesâ€œæ€æ‰â€å¹¶é‡å¯ã€‚</li></ol><p>æ¯”å¦‚ä¿®æ”¹ä¸Šé¢çš„Podé…ç½®æ–‡ä»¶ï¼Œå®šä¹‰èµ„æºé…é¢ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span> </span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-pod</span> </span><br><span class="line"><span class="attr">  labels:</span> </span><br><span class="line"><span class="attr">    name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">nginx</span> </span><br><span class="line"><span class="attr">      imagePullPolicy:</span> <span class="string">IfNotPresent</span> </span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span> </span><br><span class="line"><span class="attr">      resources:</span></span><br><span class="line"><span class="attr">        requests:</span></span><br><span class="line"><span class="attr">          memory:</span> <span class="string">"64Mi"</span> <span class="comment"># è‡³å°‘éœ€è¦64MiBå†…å­˜</span></span><br><span class="line"><span class="attr">          cpu:</span> <span class="string">"200m"</span> <span class="comment"># è‡³å°‘éœ€è¦0.2ä¸ªCPU</span></span><br><span class="line"><span class="attr">        limits:</span></span><br><span class="line"><span class="attr">          memory:</span> <span class="string">"128Mi"</span> <span class="comment"># å†…å­˜æ¶ˆè€—ä¸èƒ½å¤šäº128MiB</span></span><br><span class="line"><span class="attr">          cpu:</span> <span class="string">"500m"</span> <span class="comment"># CPUæ¶ˆè€—ä¸èƒ½å¤šäº0.5</span></span><br></pre></td></tr></table></figure><p></p><p>é™¤äº†ç›´æ¥ä½¿ç”¨Podé…ç½®æ–‡ä»¶æ¥åˆ›å»ºPodå¤–ï¼Œæ›´ä¸ºå¸¸ç”¨çš„æ˜¯ä½¿ç”¨Podç®¡ç†å¯¹è±¡RC(RS)ã€Deploymentç­‰åˆ›å»ºå’Œç®¡ç†Podã€‚</p><h3 id="RC-RS"><a href="#RC-RS" class="headerlink" title="RC(RS)"></a>RC(RS)</h3><p>RCå…¨ç§°Replication Controllerï¼ˆå‰¯æœ¬æ§åˆ¶å™¨ï¼‰,ç”¨äºæ§åˆ¶ä»»æ„æ—¶åˆ»æŒ‡å®šPodçš„æ•°é‡éƒ½ç¬¦åˆé¢„æœŸå€¼ã€‚RCé…ç½®æ–‡ä»¶ä¸€èˆ¬åŒ…å«ä»¥ä¸‹ä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><ol><li>æœŸæœ›çš„Podå‰¯æœ¬æ•°é‡ï¼›</li><li>ç”¨äºç­›é€‰Podçš„Label Selectorï¼›</li><li>åˆ›å»ºPodçš„æ¨¡æ¿ï¼ˆå½“æ•°é‡å°‘äºé¢„æœŸçš„æ—¶å€™ï¼Œç”¨è¿™ä¸ªæ¨¡æ¿åˆ›å»ºPodï¼‰ã€‚</li></ol><p>ä¸¾ä¸ªRC yamlçš„ä¾‹å­ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ReplicationController # è¡¨ç¤ºRC</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-rc # RCæ§åˆ¶å™¨åç§°ä¸ºnginx-rc</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3 # æœŸæœ›Podçš„å‰¯æœ¬æ•°é‡ä¸º3</span><br><span class="line">  selector:</span><br><span class="line">    name: nginx # Labelç­›é€‰å™¨ï¼Œç­›é€‰å‡ºLabelåŒ…å«ï¼ˆname=nginxï¼‰çš„Pod</span><br><span class="line">  template: # Podåˆ›å»ºæ¨¡æ¿ï¼Œæ ¼å¼åŸºæœ¬å’Œæˆ‘ä»¬ä¸Šé¢å®šä¹‰çš„Pod yamlä¸€è‡´</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: nginx</span><br><span class="line">          image: nginx</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 80</span><br></pre></td></tr></table></figure><p></p><p>é€šè¿‡è¿™ä¸ªRCï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ï¼šåœ¨Kubernetesé›†ç¾¤ä¸­ï¼Œä»»æ„æ—¶åˆ»éƒ½å­˜åœ¨3ä¸ªè¿è¡Œç€Nginxå®¹å™¨çš„Podï¼Œå³é€šè¿‡è¿™ä¸ªRCæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªNginxæ•°é‡ä¸º3çš„Nginxé›†ç¾¤ï¼ˆå…¶ä¸­ä¸€ç§å¯èƒ½æ€§ï¼‰ï¼š</p><p><img src="img/QQæˆªå›¾20191030142008.png" alt="QQæˆªå›¾20191030142008.png"></p><p>åœ¨Kubernetesçš„å‘å±•ä¸­ï¼ŒRCå‡çº§ä¸ºäº†Replica Setï¼Œä¿—ç§°RSï¼Œè¯­æ³•å¤§è‡´å’ŒRCä¸€è‡´ã€‚RSå’ŒRCæœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šRSæ‹¥æœ‰æ›´ä¸ºğŸ‚ğŸºçš„Podç­›é€‰å™¨ã€‚æ¯”å¦‚ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">    matchExpressions:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">&#123;key:</span> <span class="string">release,</span> <span class="attr">operator:</span> <span class="string">In,</span> <span class="attr">values:</span> <span class="string">[stable,</span> <span class="string">snapshot]&#125;</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line">    <span class="string">...</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢çš„RSç­›é€‰Podè§„åˆ™ä¸ºï¼šç­›é€‰æ ‡ç­¾åŒ…å«tierä¸ºfrontendï¼Œå¹¶ä¸”releaseçš„å€¼ä¸ºstableæˆ–è€…snapshotçš„Podã€‚</p><p>æ€»ä¹‹ï¼ŒRC(RS)çš„ä½œç”¨ä¸º:</p><ol><li>Podçš„åˆ›å»ºåŠæ•°é‡æ§åˆ¶ï¼›</li><li>é€šè¿‡æ”¹å˜RCé‡Œçš„Podå‰¯æœ¬æ•°é‡ï¼Œå¯ä»¥å®ç°Podçš„æ‰©å®¹æˆ–ç¼©å®¹ï¼›</li><li>é€šè¿‡æ”¹å˜RCé‡ŒPodæ¨¡æ¿ä¸­çš„é•œåƒç‰ˆæœ¬ï¼Œå¯ä»¥å®ç°Podçš„æ»šåŠ¨å‡çº§ã€‚</li></ol><h3 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h3><p>Deploymentå¯ä»¥çœ‹æˆæ˜¯RSçš„å‡çº§ç‰ˆç»„ä»¶ï¼Œå†…éƒ¨ä½¿ç”¨RSç®¡ç†Podï¼Œå’ŒRSç›¸æ¯”æœ€å¤§çš„ä¸åŒåœ¨äºDeploymentå¯ä»¥éšæ—¶æŸ¥çœ‹Podçš„éƒ¨ç½²çŠ¶æ€ã€‚Deploymentçš„yamlé…ç½®å’ŒRSå·®ä¸å¤šï¼Œä¸¾ä¸ªDeployment yamlçš„ä¾‹å­(nginx-deployment.yml):</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deployment</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: nginx</span><br><span class="line">  replicas: 3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: nginx</span><br><span class="line">          image: nginx</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 80</span><br></pre></td></tr></table></figure><p></p><p>é™¤äº†kindï¼Œå…¶ä»–éƒ½å’ŒRSå·®ä¸å¤šã€‚åœ¨Kubernetesé›†ç¾¤ä¸­åˆ›å»ºè¯¥Deploymentï¼š</p><p><img src="img/QQæˆªå›¾20191030152700.png" alt="QQæˆªå›¾20191030152700.png"></p><ul><li>READYï¼šé›†ç¾¤ä¸­å‡†å¤‡å°±ç»ªçš„Podæ•°é‡ï¼›</li><li>UP-TO-DATEï¼šæœ€æ–°ç‰ˆæœ¬çš„Podçš„å‰¯æœ¬æ•°é‡ï¼Œç”¨äºæŒ‡ç¤ºåœ¨æ»šåŠ¨å‡çº§çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰å¤šå°‘ä¸ªPodå‰¯æœ¬å·²ç»æˆåŠŸå‡çº§ï¼›</li><li>AVAILABLEï¼šå½“å‰é›†ç¾¤ä¸­å¯ç”¨çš„Podå‰¯æœ¬æ•°é‡ï¼Œå³é›†ç¾¤ä¸­å½“å‰å­˜æ´»çš„Podæ•°é‡ã€‚</li></ul><p>æŸ¥çœ‹RSå’ŒPodï¼š</p><p><img src="img/QQæˆªå›¾20191030153402.png" alt="QQæˆªå›¾20191030153402.png"></p><p>å¯ä»¥çœ‹åˆ°å®ƒä»¬çš„å…³ç³»ä¸ºdeployment -&gt; rs -&gt; podsï¼š</p><p><img src="img/QQæˆªå›¾20191030154129.png" alt="QQæˆªå›¾20191030154129.png"></p><h3 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a>StatefulSet</h3><p>StatefulSetï¼ˆæœ‰çŠ¶æ€é›†åˆï¼‰å¯ä»¥çœ‹æˆæ˜¯Deploymentçš„ä¸€ä¸ªå˜ç§ï¼Œé€‚åˆç”¨äºæ„å»ºMySQLé›†ç¾¤ã€MongoDBé›†ç¾¤ç­‰æœ‰çŠ¶æ€çš„é›†ç¾¤ï¼Œè¿™äº›é›†ç¾¤æœ‰ä»¥ä¸‹è¿™äº›å…±åŒç‰¹ç‚¹ï¼š</p><ol><li>é›†ç¾¤è§„æ¨¡ç›¸å¯¹å›ºå®šï¼Œä¸èƒ½éšæ„å˜åŠ¨ï¼›</li><li>é›†ç¾¤ä¸­æ¯ä¸ªPodéƒ½æ˜¯æœ‰çŠ¶æ€çš„ï¼Œå³æ•°æ®ä¼šè¢«æŒä¹…åŒ–åˆ°å­˜å‚¨ä¸­ï¼›</li><li>æ¯ä¸ªPodéƒ½æœ‰å›ºå®šçš„IDã€‚</li></ol><p>StatefulSetåˆ›å»ºçš„Podé›†ç¾¤ç¬¦åˆä¸Šé¢çš„éœ€æ±‚ï¼Œå…·æœ‰å¦‚ä¸‹ç‰¹ç‚¹:</p><ol><li>æ¯ä¸ªPodçš„åç§°åœ¨åˆ›å»ºå‰å°±å¯ä»¥ç¡®å®šä¸‹æ¥äº†ã€‚æ¯”å¦‚StatefulSetçš„åç§°ä¸ºmysqlï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªPodå«mysql-0ï¼Œç¬¬äºŒä¸ªå«mysql-1ï¼Œä»¥æ­¤ç±»æ¨ï¼›</li><li>Podçš„å¯åœè¯•æ˜¯æŒ‰ç…§é¡ºåºæ¥çš„ï¼›</li><li>Podé€šè¿‡PVæˆ–è€…PVCæ¥æŒä¹…åŒ–å­˜å‚¨ã€‚</li></ol><p>è¿™é‡Œå°±å…ˆä¸æ·±å…¥ç ”ç©¶StatefulSetäº†ï¼Œåé¢å†æ‰¾æœºä¼šç ”ç©¶ã€‚</p><h3 id="Job"><a href="#Job" class="headerlink" title="Job"></a>Job</h3><p>Jobæ˜¯ä¸€ç§ç‰¹æ®Šçš„Podç®¡ç†å¯¹è±¡ï¼Œæ˜¯ä¸€ç§ä¸€æ¬¡æ€§Podè¿è¡Œä»»åŠ¡ï¼Œä»»åŠ¡ç»“æŸåï¼ŒPodçš„ç”Ÿå‘½å‘¨æœŸä¹Ÿå°±ç»“æŸäº†ã€‚Kubernetesä¸­æ”¯æŒCronè¡¨è¾¾å¼çš„ä»»åŠ¡ç§°ä¸ºCronJobï¼Œåé¢æ¥è§¦åˆ°äº†å†ä»”ç»†ç ”ç©¶ğŸ˜ªã€‚</p><h2 id="Label"><a href="#Label" class="headerlink" title="Label"></a>Label</h2><p>å°±å¦‚ä¸Šé¢æ‰€è¯´ï¼ŒLabelå°±æ˜¯ç”¨äºç»™Podæ‰“æ ‡ç­¾ç”¨çš„ï¼Œä¾›Podç®¡ç†å¯¹è±¡ã€Serviceç­‰ç­›é€‰ä½¿ç”¨ã€‚</p><h2 id="HPA"><a href="#HPA" class="headerlink" title="HPA"></a>HPA</h2><p>é™¤äº†ä½¿ç”¨<code>kubectl scale</code>å‘½ä»¤ä¿®æ”¹Podæ•°é‡å®ç°æ‰©å®¹æˆ–è€…ç¼©å®¹å¤–ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©HPAï¼ˆHorizontal Pod Autoscalingï¼ŒPodæ¨ªå‘è‡ªåŠ¨æ‰©å±•ï¼‰æ¥å®ŒæˆPodçš„è‡ªåŠ¨åŒ–æ‰©ç¼©å®¹ã€‚ä¸¾ä¸ªHPAçš„ä¾‹å­ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-hpa</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  maxReplicas:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">  minReplicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  scaleTargetRef:</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">  targetCPUUtilizationPercentage:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢å®šä¹‰äº†ä¸€ä¸ªåä¸ºnginx-hpaçš„HPAï¼Œç›‘æ§åç§°ä¸ºnginx-deploymentçš„Deploymentä¸­çš„Podï¼Œå½“å…¶<code>targetCPUUtilizationPercentage</code>çš„å€¼å¤§äº80%æ—¶ï¼Œå°†å‘ç”ŸåŠ¨æ€æ‰©å®¹è¡Œä¸ºï¼Œå¹¶ä¸”Podçš„æ•°é‡å¿…é¡»å†3~10ä¹‹é—´ã€‚</p><p><code>targetCPUUtilizationPercentage</code>æŒ‡çš„æ˜¯Podä¸€åˆ†é’Ÿå†…CPUä½¿ç”¨ç‡çš„ç®—æ•°å¹³å‡å€¼ã€‚æ¯”å¦‚Podçš„requests cpuä¸º0.4ï¼Œå½“å‰CPUä½¿ç”¨é‡ä¸º0.3ï¼Œåˆ™CPUä½¿ç”¨ç‡ä¸º75%ã€‚æ‰€ä»¥è¦ä½¿ç”¨HPAçš„åŠŸèƒ½ï¼ŒPodå¿…é¡»æŒ‡å®šäº†requests cpuå€¼ã€‚</p><h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><p>Serviceã€RCå’ŒPodä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20191031100702.png" alt="QQæˆªå›¾20191031100702.png"></p><p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼ŒServiceæ˜¯å¤–ç•Œè®¿é—®Podçš„æ¡¥æ¢ï¼ŒServiceé€šè¿‡Label Selectoræ¥ç­›é€‰å¤„ç¬¦åˆçš„Podï¼Œå°†è¯·æ±‚å‡è¡¡çš„è½¬å‘åˆ°ç›®æ ‡Podä¸Šã€‚å‰é¢ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡Deploymentåˆ›å»ºäº†ä¸‰ä¸ªNginx Podï¼Œä½†ç°åœ¨å¤–ç•Œå¹¶ä¸èƒ½ç›´æ¥è®¿é—®å®ƒä»¬ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªServiceæ¥å®ç°è¿™ä¸ªéœ€æ±‚ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim nginx-service.yml</span><br></pre></td></tr></table></figure><p></p><p>å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      nodePort:</span> <span class="number">30001</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢é…ç½®ä¸­<code>spec.ports</code>å®šä¹‰äº†ä¸‰ä¸ªç«¯å£ï¼Œåœ¨äº†è§£è¿™ä¸‰ä¸ªç«¯å£çš„å«ä¹‰ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸‹ä¸‹é¢è¿™ä¸‰ä¸ªIPçš„å«ä¹‰ï¼š</p><ol><li>Node IPï¼šNodeçš„IPåœ°å€ï¼ŒNodeæ˜¯éƒ¨ç½²åœ¨å®¿ä¸»æœºä¸Šçš„ï¼Œæ‰€ä»¥å®é™…ä¸Šå°±æ˜¯å®¿ä¸»æœºçš„IPåœ°å€ï¼Œä¸ä¼šå‘ç”Ÿæ”¹å˜ï¼›</li><li>Pod IPï¼šPodçš„IPåœ°å€ï¼Œç”±äºåŠ¨æ€æ‰©ç¼©å®¹ã€å®•æœºè½¬ç§»ç­‰åŸå› ï¼Œè¿™ä¸ªIPç»å¸¸ä¼šå‘ç”Ÿæ”¹å˜ï¼›</li><li>Cluster IPï¼šServiceçš„IPåœ°å€ï¼Œåœ¨ä¸€ä¸ªå®Œæ•´çš„Serviceç”Ÿå‘½å‘¨æœŸå†…æ˜¯ä¸ä¼šæ”¹å˜çš„ã€‚</li></ol><p>å…¶ä¸­<code>Pod IP</code>å’Œ<code>Cluster IP</code>æ˜¯å±äºKubernetesé›†ç¾¤èŒƒå›´å†…çš„ï¼Œå¤–ç•Œæ— æ³•ç›´æ¥è®¿é—®ã€‚</p><p>å†å›å¤´çœ‹ä¸Šé¢ä¸‰ä¸ªç«¯å£çš„å«ä¹‰ï¼š</p><ol><li>portï¼šæŒ‡å®šServiceçš„ç«¯å£å·ï¼›</li><li>targetPortï¼šç›®æ ‡Podçš„ç«¯å£ï¼Œæ ¹æ®å‰é¢nginx-deploymentçš„å®šä¹‰ï¼Œè¿™é‡Œåº”è¯¥æŒ‡å®šä¸º80ï¼›</li><li>nodePortï¼šåœ¨Nodeä¸Šå¼€å¯çš„ç›‘å¬ç«¯å£ï¼Œç”¨äºå¤–ç•Œé€šè¿‡<code>Cluster IP:nodePort</code>æ¥è®¿é—®å¯¹åº”çš„Serviceã€‚</li></ol><p>ä½¿ç”¨nodePortæ—¶ï¼Œéœ€è¦å°†Serviceçš„typeæŒ‡å®šä¸ºNodePortï¼Œå¹¶ä¸”nodePortæœ‰èŒƒå›´é™åˆ¶ï¼Œå¿…é¡»åœ¨30000-32767ä¹‹é—´ã€‚</p><p>ä½¿ç”¨<code>kubectl create -f nginx-service.yml</code>åˆ›å»ºè¯¥Serviceï¼š</p><p><img src="img/QQæˆªå›¾20191031104422.png" alt="QQæˆªå›¾20191031104422.png"></p><p>æŸ¥çœ‹Serviceå’Œendpointï¼š</p><p><img src="img/QQæˆªå›¾20191031104556.png" alt="QQæˆªå›¾20191031104556.png"></p><p>ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡<code>node1 Ip:nodePort</code>æ¥è®¿é—®Nginx PodæœåŠ¡äº†ï¼š</p><p><img src="img/QQæˆªå›¾20191031104735.png" alt="QQæˆªå›¾20191031104735.png"></p><h2 id="Volume"><a href="#Volume" class="headerlink" title="Volume"></a>Volume</h2><p>Volumeæ˜¯Podä¸Šèƒ½å¤Ÿè¢«å¤šä¸ªDockerå®¹å™¨è®¿é—®çš„å…±äº«ç›®å½•ï¼ŒVolumeçš„ç”Ÿå‘½å‘¨æœŸå’ŒPodç›¸å…³ï¼Œä¸Dockerå®¹å™¨æ— å…³ã€‚å¯ä»¥åœ¨å®šä¹‰Podçš„æ—¶å€™æŒ‡å®šVolumeï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-pod</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nginx-data</span></span><br><span class="line"><span class="attr">      emptyDir:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">      ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      volumeMounts:</span></span><br><span class="line"><span class="attr">        - mountPath:</span> <span class="string">/etc/nginx</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">nginx-data</span></span><br></pre></td></tr></table></figure><p></p><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½æ˜¯ç°åœ¨Podé‡Œå£°æ˜ä¸€ä¸ªVolumeï¼Œç„¶ååœ¨å®¹å™¨é‡Œå¼•ç”¨è¯¥Volumeï¼Œå¹¶æŒ‚è½½åˆ°å®¹å™¨çš„æŸä¸ªç›®å½•ä¸Šã€‚</p><p>æ¯”è¾ƒå¸¸ç”¨çš„Volumeç±»å‹æœ‰ï¼š</p><ol><li><p>emptyDirï¼šä¸€ä¸ªemptyDir Volumeæ˜¯åœ¨Podåˆ†é…åˆ°Nodeæ—¶åˆ›å»ºçš„ã€‚ä»å®ƒçš„åç§°å°±å¯ä»¥çœ‹å‡ºï¼Œå®ƒçš„åˆå§‹å†…å®¹ä¸ºç©ºï¼Œå¹¶ä¸”æ— é¡»æŒ‡å®šå®¿ä¸»æœºä¸Šå¯¹åº”çš„ç›®å½•æ–‡ä»¶ï¼Œå› ä¸ºè¿™æ˜¯Kubernetesè‡ªåŠ¨åˆ†é…çš„ä¸€ä¸ªç›®å½•ï¼Œå½“Podä»Nodeä¸Šç§»é™¤æ—¶ï¼ŒemptyDirä¸­çš„æ•°æ®ä¹Ÿä¼šè¢«æ°¸ä¹…åˆ é™¤ï¼›</p></li><li><p>hostPathä¸ºåœ¨Podä¸ŠæŒ‚è½½å®¿ä¸»æœºä¸Šçš„æ–‡ä»¶æˆ–ç›®å½•ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">"persistend-storage"</span></span><br><span class="line"><span class="attr">      hostPath:</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">"/data"</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="PV-PVC"><a href="#PV-PVC" class="headerlink" title="PV,PVC"></a>PV,PVC</h2><p>PV(Persistent Volume)æ˜¯Kubernetesé›†ç¾¤ä¸­çš„æŸä¸ªç½‘ç»œå­˜å‚¨å¯¹åº”çš„ä¸€å—å­˜å‚¨ï¼Œä¸å±äºä»»ä½•Nodeï¼Œä½†å¯ä»¥åœ¨æ¯ä¸ªNodeä¸Šè®¿é—®ï¼›PVC(Persistent Volume Claimï¼ŒPVå£°æ˜)ï¼ŒæŸä¸ªPodéœ€è¦ç”¨åˆ°PVå‰ï¼Œå¿…é¡»å…ˆå®šä¹‰PVCã€‚</p><p>å®šä¸€ä¸ªNFSç±»å‹çš„PVï¼Œå£°æ˜éœ€è¦10Giå­˜å‚¨ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pv01</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  capacity:</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">10</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">  nfs:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/somepath</span></span><br><span class="line"><span class="attr">    server:</span> <span class="number">127.17</span><span class="number">.0</span><span class="number">.2</span></span><br></pre></td></tr></table></figure><p></p><p>è¯¥PVå£°æ˜äº†127.17.0.2NFSç³»ç»Ÿä¸‹çš„/somepathç›®å½•ä½œä¸ºç½‘ç»œå­˜å‚¨ï¼Œå†…å­˜ä¸º10Giï¼Œè¯¥PVåç§°ä¸ºpv01ã€‚</p><p>accessModesæœ‰ä»¥ä¸‹ä¸‰ç§æ¨¡å¼ï¼š</p><ol><li>ReadWriteOnceï¼šè¯»å†™æƒé™ï¼Œå¹¶ä¸”åªèƒ½è¢«å•ä¸ªNodeæŒ‚è½½ï¼›</li><li>ReadOnlyManyï¼šåªè¯»æƒé™ï¼Œå…è®¸è¢«å¤šä¸ªNodeæŒ‚è½½ï¼›</li><li>ReadWriteManyï¼šè¯»å†™æƒé™ï¼Œå…è®¸è¢«å¤šä¸ªNodeæŒ‚è½½ã€‚</li></ol><p>æ¥ç€å®šä¹‰ä¸€ä¸ªPVCï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pvclaim</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">8</span><span class="string">Gi</span></span><br></pre></td></tr></table></figure><p></p><p>è¯¥PVCå£°æ˜äº†éœ€è¦8Giå­˜å‚¨ç©ºé—´ï¼Œåˆšåˆšå®šä¹‰çš„PVç¬¦åˆè¿™ä¸ªè¦æ±‚ï¼Œæ‰€ä»¥ä¼šè¢«ç»‘å®šä¸Šã€‚å®šä¹‰äº†PVCåï¼Œå°±å¯ä»¥åœ¨Podé‡Œå¼•ç”¨äº†ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">podpv</span></span><br><span class="line"><span class="attr">      persistentVolumeClaim:</span></span><br><span class="line"><span class="attr">        claimName:</span> <span class="string">pvclaim</span></span><br></pre></td></tr></table></figure><p></p><p>PVå…·æœ‰ä»¥ä¸‹å‡ ç§çŠ¶æ€ï¼š</p><ol><li>Availableï¼šç©ºé—²çŠ¶æ€ï¼›</li><li>Boundï¼šå·²ç»ç»‘å®šåˆ°æŸä¸ªPVCä¸Šï¼›</li><li>Releasedï¼šå¯¹åº”çš„PVCå·²ç»è¢«åˆ é™¤ï¼Œä½†èµ„æºè¿˜æ²¡æœ‰è¢«é›†ç¾¤æ”¶å›ï¼›</li><li>Failedï¼šPVè‡ªåŠ¨å›æ”¶å¤±è´¥ã€‚</li></ol><h2 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h2><p>Namespaceé¡¾åæ€ä¹‰ï¼Œå‘½åç©ºé—´ï¼Œç”¨äºèµ„æºéš”ç¦»ã€‚é»˜è®¤Kubernetesä¼šåˆ›å»ºdefaultå‘½åç©ºé—´ï¼Œå¹¶ä¸”Podï¼ŒRCç­‰éƒ½æ˜¯ç”¨è¯¥å‘½åç©ºé—´ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å®šä¹‰è‡ªå·±çš„å‘½åç©ºé—´ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">febs</span></span><br></pre></td></tr></table></figure><p></p><p>åœ¨åˆ›å»ºPodç­‰èµ„æºçš„æ—¶å€™å°±å¯ä»¥æŒ‡å®šè¯¥å‘½åç©ºé—´äº†ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-pod</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">febs</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><p></p><h2 id="Annotation"><a href="#Annotation" class="headerlink" title="Annotation"></a>Annotation</h2><p>Annotationæ˜¯ç”¨æˆ·ä»»æ„å®šä¹‰çš„é™„åŠ ä¿¡æ¯ï¼Œä¾¿äºå¤–éƒ¨å·¥å…·æŸ¥æ‰¾ï¼Œæ¯”å¦‚ç‰ˆæœ¬ä¿¡æ¯ï¼Œbuildä¿¡æ¯ç­‰ã€‚</p><h2 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h2><p>å­¦è¿‡Dockerçš„éƒ½çŸ¥é“ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æŒ‚è½½ç›®å½•çš„æ–¹å¼å°†å®¿ä¸»æœºä¸­çš„é…ç½®æ–‡ä»¶æ˜ å°„åˆ°Dockerå®¹å™¨å†…ã€‚ä½†è¿™åœ¨é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œè¦æŒ‚è½½çš„é…ç½®æ–‡ä»¶è¿‡å¤šï¼Œä¸ä»…éº»çƒ¦è€Œä¸”å®¹æ˜“å‡ºé”™ï¼ŒKuberneteçš„ConfigMapå°±æ˜¯ç”¨äºè§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚</p><p>ConfigMapå­˜å‚¨äº†å¤§é‡key-valueé…ç½®ï¼Œå­˜å‚¨åœ¨etcdä¸­ï¼Œé€šè¿‡Volumeçš„æ–¹å¼æ˜ å°„åˆ°ç›®æ ‡Podå†…ï¼Œæˆä¸ºä¸€ä»½é…ç½®æ–‡ä»¶ï¼ŒConfigMapå®è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªé…ç½®ä¸­å¿ƒã€‚</p><blockquote><p>ã€ŠKubernetesæƒå¨æŒ‡å—(ç¬¬4ç‰ˆ)ã€‹è¯»ä¹¦ç¬”è®°</p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;ä¸Šä¸€èŠ‚æˆ‘ä»¬å·²ç»æˆåŠŸæ­å»ºäº†Kubernetesé›†ç¾¤ï¼ŒKubernetesåŒ…å«äº†å¤§é‡çš„æ¦‚å¿µå’Œæœ¯è¯­ï¼Œæ¯”å¦‚Masterã€Nodeã€Podã€Replication Controllerã€Serviceç­‰ç­‰ï¼Œåœ¨æ·±å…¥å­¦ä¹ Kubernetesä¹‹å‰ï¼Œæœ‰å¿…è¦æ‹æ¸…Kubernetesæ¶æ„è®¾è®¡å’Œè¿™äº›æœ¯è¯­çš„å«ä¹‰ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Kubernetes" scheme="http://mrbird.cc/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes1.16.2å®‰è£…Dashboard</title>
    <link href="http://mrbird.cc/Kubernetes1-16-2-install-Dashboard.html"/>
    <id>http://mrbird.cc/Kubernetes1-16-2-install-Dashboard.html</id>
    <published>2019-10-29T07:38:24.000Z</published>
    <updated>2019-11-08T12:06:08.417Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --><p>Kubernetes Dashboardæ˜¯Kubernetesæä¾›çš„Webç”¨æˆ·ç•Œé¢ï¼Œé€šè¿‡Dashboardæˆ‘ä»¬å¯ä»¥å°†å®¹å™¨åŒ–çš„åº”ç”¨éƒ¨ç½²åˆ°Kubernetesé›†ç¾¤ä¸­ï¼Œå¯¹å®¹å™¨åŒ–çš„åº”ç”¨è¿›è¡Œæ•…éšœæ’é™¤ä»¥åŠé›†ç¾¤èµ„æºç®¡ç†ï¼›å¯ä»¥é€šè¿‡DashboardæŸ¥çœ‹é›†ç¾¤åº”ç”¨è¯¦æƒ…ï¼Œåˆ›å»ºæˆ–ä¿®æ”¹å•ä¸ªKubernetesèµ„æºï¼ˆä¾‹å¦‚Deploymentsï¼ŒJobsï¼ŒDaemonSetsç­‰ï¼‰ã€‚<a id="more"></a></p><h2 id="å®‰è£…Dashboard"><a href="#å®‰è£…Dashboard" class="headerlink" title="å®‰è£…Dashboard"></a>å®‰è£…Dashboard</h2><p>ä¸ŠèŠ‚æˆ‘ä»¬æ­å»ºçš„Kubernetesé›†ç¾¤ç‰ˆæœ¬ä¸º1.16.2ï¼Œæˆªè‡³ç›®å‰ä¸ºæ­¢ï¼Œä¸è¯¥ç‰ˆæœ¬å¯¹åº”çš„Dashboardç‰ˆæœ¬ä¸ºv2.0.0-beta5ï¼Œå¯ä»¥é€šè¿‡<a href="https://github.com/kubernetes/dashboard/releases" target="_blank" rel="noopener">https://github.com/kubernetes/dashboard/releases</a>æŸ¥çœ‹ï¼š</p><p><img src="img/QQæˆªå›¾20191029210946.png" alt="QQæˆªå›¾20191029210946.png"></p><p>ä¸‹è½½è¯¥ç‰ˆæœ¬çš„Dashboard yamlæ–‡ä»¶ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta5/aio/deploy/recommended.yaml</span><br></pre></td></tr></table></figure><p></p><p>ä¿®æ”¹è¯¥é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim recommended.yaml</span><br></pre></td></tr></table></figure><p></p><p>ä¿®æ”¹çš„å†…å®¹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20191029211413.png" alt="QQæˆªå›¾20191029211413.png"></p><p>æ¥ç€åˆ›å»ºè¯ä¹¦ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mkdir dashboard-certs</span><br><span class="line"></span><br><span class="line">cd dashboard-certs/</span><br><span class="line"></span><br><span class="line">#åˆ›å»ºå‘½åç©ºé—´</span><br><span class="line">kubectl create namespace kubernetes-dashboard</span><br><span class="line"></span><br><span class="line">#åˆ›å»ºkeyæ–‡ä»¶</span><br><span class="line">openssl genrsa -out dashboard.key 2048</span><br><span class="line"></span><br><span class="line">#è¯ä¹¦è¯·æ±‚</span><br><span class="line">openssl req -days 36000 -new -out dashboard.csr -key dashboard.key -subj &apos;/CN=dashboard-cert&apos;</span><br><span class="line"></span><br><span class="line">#è‡ªç­¾è¯ä¹¦</span><br><span class="line">openssl x509 -req -in dashboard.csr -signkey dashboard.key -out dashboard.crt</span><br><span class="line"></span><br><span class="line">#åˆ›å»ºkubernetes-dashboard-certså¯¹è±¡</span><br><span class="line">kubectl create secret generic kubernetes-dashboard-certs --from-file=dashboard.key --from-file=dashboard.crt -n kubernetes-dashboard</span><br></pre></td></tr></table></figure><p></p><p>ç„¶åæ‰§è¡Œ<code>kubectl create -f ../recommended.yaml</code>å‘½ä»¤å®‰è£…Dashboardã€‚</p><p>ä½¿ç”¨<code>kubectl get service -n kubernetes-dashboard -o wide</code>å‘½ä»¤æŸ¥çœ‹æ˜¯å¦éƒ¨ç½²æˆåŠŸï¼š</p><p><img src="img/QQæˆªå›¾20191029211919.png" alt="QQæˆªå›¾20191029211919.png"></p><h2 id="åˆ›å»ºè´¦å·ä¸æˆæƒ"><a href="#åˆ›å»ºè´¦å·ä¸æˆæƒ" class="headerlink" title="åˆ›å»ºè´¦å·ä¸æˆæƒ"></a>åˆ›å»ºè´¦å·ä¸æˆæƒ</h2><p>Dashboardéƒ¨ç½²å¥½åï¼Œæ¥ç€åˆ›å»ºè´¦å·ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim dashboard-admin.yaml</span><br></pre></td></tr></table></figure><p></p><p>å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">dashboard-admin</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kubernetes-dashboard</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºè¯¥è´¦å·ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f dashboard-admin.yaml</span><br></pre></td></tr></table></figure><p></p><p>è´¦å·åˆ›å»ºå¥½åï¼Œæ¥ç€ä¸ºå…¶æˆæƒï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim dashboard-admin-bind-cluster-role.yaml</span><br></pre></td></tr></table></figure><p></p><p>å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">dashboard-admin-bind-cluster-role</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">dashboard-admin</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kubernetes-dashboard</span></span><br></pre></td></tr></table></figure><p></p><p>æˆæƒï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f dashboard-admin-bind-cluster-role.yaml</span><br></pre></td></tr></table></figure><p></p><h2 id="è®¿é—®Dashboard"><a href="#è®¿é—®Dashboard" class="headerlink" title="è®¿é—®Dashboard"></a>è®¿é—®Dashboard</h2><p>ä½¿ç”¨æµè§ˆå™¨è®¿é—®<a href="https://192.168.33.12:30008/#/login" target="_blank" rel="noopener">https://192.168.33.12:30008/#/login</a>ï¼š</p><p><img src="img/QQæˆªå›¾20191029222406.png" alt="QQæˆªå›¾20191029222406.png"></p><p>é€‰æ‹©Tokenï¼ŒTokençš„å€¼å¯ä»¥ç”¨ä¸‹é¢çš„å‘½ä»¤è·å–ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep dashboard-admin | awk &apos;&#123;print $1&#125;&apos;)</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20191029222542.png" alt="QQæˆªå›¾20191029222542.png"></p><p>å¤åˆ¶è¯¥Tokenåˆ°Dashboardï¼š</p><p><img src="img/QQæˆªå›¾20191029222651.png" alt="QQæˆªå›¾20191029222651.png"></p><p>ç‚¹å‡»Sign Inï¼š</p><p><img src="img/QQæˆªå›¾20191029222743.png" alt="QQæˆªå›¾20191029222743.png"></p><h2 id="å®‰è£…Metrics-Service"><a href="#å®‰è£…Metrics-Service" class="headerlink" title="å®‰è£…Metrics Service"></a>å®‰è£…Metrics Service</h2><p>ä¸Šé¢Dashboardçš„CPU Usage (cores)å’ŒMemory Usage (bytes)åˆ—æ˜¯ç©ºçš„ï¼Œè¿™æ˜¯å› ä¸ºKubernetesçš„æ—©æœŸç‰ˆæœ¬ä¾é Heapsteræ¥å®ç°å®Œæ•´çš„æ€§èƒ½æ•°æ®é‡‡é›†å’Œç›‘æ§åŠŸèƒ½ï¼ŒKubernetesä»1.8ç‰ˆæœ¬å¼€å§‹ï¼Œæ€§èƒ½æ•°æ®å¼€å§‹ä»¥Metrics APIçš„æ–¹å¼æä¾›æ ‡å‡†åŒ–æ¥å£ï¼Œå¹¶ä¸”ä»1.10ç‰ˆæœ¬å¼€å§‹å°†Heapsteræ›¿æ¢ä¸ºMetrics Serverã€‚</p><p>é¦–å…ˆåœ¨masterèŠ‚ç‚¹ä¸Šå®‰è£…gitï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install git</span><br></pre></td></tr></table></figure><p></p><p>ç„¶åå…‹éš†Metrics Server GitHubä»“åº“ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/kubernetes-sigs/metrics-server.git</span><br></pre></td></tr></table></figure><p></p><p>ä¿®æ”¹metrics-server-deployment.yamlï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim metrics-server/deploy/1.8+/metrics-server-deployment.yaml</span><br></pre></td></tr></table></figure><p></p><p>ä¿®æ”¹å†…å®¹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20191108195559.png" alt="QQæˆªå›¾20191108195559.png"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        command:</span><br><span class="line">          - /metrics-server</span><br><span class="line">          - --kubelet-preferred-address-types=InternalIP</span><br><span class="line">          - --kubelet-insecure-tls</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>å› ä¸ºé»˜è®¤metrics serviceçš„é•œåƒåœ°å€éœ€è¦ç§‘å­¦ä¸Šç½‘æ‰èƒ½æ‹‰å–ï¼Œæ‰€ä»¥åœ¨åˆ›å»ºä¹‹å‰ï¼Œæˆ‘ä»¬åœ¨node1å’Œnode2èŠ‚ç‚¹å…ˆæ‰§è¡Œä»¥ä¸‹æ“ä½œå‡†å¤‡é•œåƒï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull bluersw/metrics-server-amd64:v0.3.6</span><br><span class="line">docker tag bluersw/metrics-server-amd64:v0.3.6 k8s.gcr.io/metrics-server-amd64:v0.3.6</span><br></pre></td></tr></table></figure><p></p><p>ç„¶åå›åˆ°masterèŠ‚ç‚¹ï¼Œæ‰§è¡Œï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f metrics-server/deploy/1.8+/</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20191108195421.png" alt="QQæˆªå›¾20191108195421.png"></p><p>ç¨ç­‰ç‰‡åˆ»ï¼Œç„¶åæ‰§è¡Œ<code>kubectl top nodes</code>ä¾¿å¯ä»¥çœ‹åˆ°æ¯ä¸ªèŠ‚ç‚¹çš„CPUå’Œå†…å­˜ä½¿ç”¨ç‡äº†ï¼š</p><p><img src="img/QQæˆªå›¾20191108195522.png" alt="QQæˆªå›¾20191108195522.png"></p><p>å›åˆ°Dashboardï¼š</p><p><img src="img/QQæˆªå›¾20191108200314.png" alt="QQæˆªå›¾20191108200314.png"></p><p><img src="img/QQæˆªå›¾2019102ddd9202540.png" alt="QQæˆªå›¾2019102ddd9202540.png"></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;Kubernetes Dashboardæ˜¯Kubernetesæä¾›çš„Webç”¨æˆ·ç•Œé¢ï¼Œé€šè¿‡Dashboardæˆ‘ä»¬å¯ä»¥å°†å®¹å™¨åŒ–çš„åº”ç”¨éƒ¨ç½²åˆ°Kubernetesé›†ç¾¤ä¸­ï¼Œå¯¹å®¹å™¨åŒ–çš„åº”ç”¨è¿›è¡Œæ•…éšœæ’é™¤ä»¥åŠé›†ç¾¤èµ„æºç®¡ç†ï¼›å¯ä»¥é€šè¿‡DashboardæŸ¥çœ‹é›†ç¾¤åº”ç”¨è¯¦æƒ…ï¼Œåˆ›å»ºæˆ–ä¿®æ”¹å•ä¸ªKubernetesèµ„æºï¼ˆä¾‹å¦‚Deploymentsï¼ŒJobsï¼ŒDaemonSetsç­‰ï¼‰ã€‚
    
    </summary>
    
    
      <category term="Kubernetes" scheme="http://mrbird.cc/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubeadmå®‰è£…Kubernetes1.16.2é›†ç¾¤</title>
    <link href="http://mrbird.cc/Kubeadm-install-Kubernetes1-16-2-cluster.html"/>
    <id>http://mrbird.cc/Kubeadm-install-Kubernetes1-16-2-cluster.html</id>
    <published>2019-10-28T12:49:50.000Z</published>
    <updated>2019-11-08T09:57:27.638Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --><p>Kubernetesä»1.4ç‰ˆæœ¬å¼€å§‹åå°±å¼•å…¥äº†kubeadmç”¨äºç®€åŒ–é›†ç¾¤æ­å»ºçš„è¿‡ç¨‹ï¼Œåœ¨Kubernetes 1.13ç‰ˆæœ¬ä¸­ï¼Œkubeadmå·¥å…·è¿›å…¥GAé˜¶æ®µï¼Œå¯ç”¨äºç”Ÿäº§ç¯å¢ƒKubernetesé›†ç¾¤æ­å»ºã€‚æœ¬èŠ‚å°†ä½¿ç”¨Kubeadmæ­å»ºKubernetes1.16.2é›†ç¾¤ï¼Œå®¿ä¸»æœºé‡‡ç”¨3å°Vagrantæ„å»ºçš„Centos7è™šæ‹Ÿæœºï¼Œé…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼ˆKubernetesæ¨èå®¿ä¸»æœºæœ€ä½å†…å­˜ä¸èƒ½ä½äº2Gï¼ŒCPUæ ¸å¿ƒæ•°æœ€ä½ä¸èƒ½ä½äº2ï¼‰ï¼š<a id="more"></a></p><table><thead><tr><th style="text-align:center">æ“ä½œç³»ç»Ÿ</th><th style="text-align:center">IP</th><th style="text-align:center">è§’è‰²</th><th style="text-align:center">CPUæ ¸å¿ƒæ•°</th><th style="text-align:center">å†…å­˜</th><th style="text-align:center">Hostname</th></tr></thead><tbody><tr><td style="text-align:center">centos7</td><td style="text-align:center">192.168.33.11</td><td style="text-align:center">master</td><td style="text-align:center">2</td><td style="text-align:center">4096M</td><td style="text-align:center">master</td></tr><tr><td style="text-align:center">centos7</td><td style="text-align:center">192.168.33.12</td><td style="text-align:center">worker</td><td style="text-align:center">2</td><td style="text-align:center">4096M</td><td style="text-align:center">node1</td></tr><tr><td style="text-align:center">centos7</td><td style="text-align:center">192.168.33.13</td><td style="text-align:center">worker</td><td style="text-align:center">2</td><td style="text-align:center">4096M</td><td style="text-align:center">node2</td></tr></tbody></table><p>åˆ†äº«ä¸‹æˆ‘çš„Vagrantfileé…ç½®ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Vagrant.configure("2")</span> <span class="string">do</span> <span class="string">|config|</span></span><br><span class="line">  <span class="string">config.vm.box</span> <span class="string">=</span> <span class="string">"centos/7"</span></span><br><span class="line">  <span class="string">config.vm.define</span> <span class="string">"one"</span> <span class="string">do</span> <span class="string">|one|</span></span><br><span class="line">  	<span class="string">one.vm.network</span> <span class="string">"private_network"</span><span class="string">,</span> <span class="attr">ip:</span> <span class="string">"192.168.33.11"</span></span><br><span class="line">  	<span class="string">one.vm.hostname</span> <span class="string">=</span> <span class="string">"master"</span></span><br><span class="line">  	<span class="string">one.vm.provider</span> <span class="string">"virtualbox"</span> <span class="string">do</span> <span class="string">|v|</span></span><br><span class="line">	  <span class="string">v.memory</span> <span class="string">=</span> <span class="number">4096</span></span><br><span class="line">	  <span class="string">v.cpus</span> <span class="string">=</span> <span class="number">2</span></span><br><span class="line">	<span class="string">end</span></span><br><span class="line">  <span class="string">end</span></span><br><span class="line"></span><br><span class="line">  <span class="string">config.vm.define</span> <span class="string">"two"</span> <span class="string">do</span> <span class="string">|two|</span></span><br><span class="line">  	<span class="string">two.vm.network</span> <span class="string">"private_network"</span><span class="string">,</span> <span class="attr">ip:</span> <span class="string">"192.168.33.12"</span></span><br><span class="line">  	<span class="string">two.vm.hostname</span> <span class="string">=</span> <span class="string">"node1"</span></span><br><span class="line">  	<span class="string">two.vm.provider</span> <span class="string">"virtualbox"</span> <span class="string">do</span> <span class="string">|v|</span></span><br><span class="line">	  <span class="string">v.memory</span> <span class="string">=</span> <span class="number">4096</span></span><br><span class="line">	  <span class="string">v.cpus</span> <span class="string">=</span> <span class="number">2</span></span><br><span class="line">	<span class="string">end</span></span><br><span class="line">  <span class="string">end</span></span><br><span class="line"></span><br><span class="line">  <span class="string">config.vm.define</span> <span class="string">"three"</span> <span class="string">do</span> <span class="string">|three|</span></span><br><span class="line">  	<span class="string">three.vm.network</span> <span class="string">"private_network"</span><span class="string">,</span> <span class="attr">ip:</span> <span class="string">"192.168.33.13"</span></span><br><span class="line">  	<span class="string">three.vm.hostname</span> <span class="string">=</span> <span class="string">"node2"</span></span><br><span class="line">  	<span class="string">three.vm.provider</span> <span class="string">"virtualbox"</span> <span class="string">do</span> <span class="string">|v|</span></span><br><span class="line">	  <span class="string">v.memory</span> <span class="string">=</span> <span class="number">4096</span></span><br><span class="line">	  <span class="string">v.cpus</span> <span class="string">=</span> <span class="number">2</span></span><br><span class="line">	<span class="string">end</span></span><br><span class="line">  <span class="string">end</span></span><br><span class="line"><span class="string">end</span></span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨åå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/12341234.png" alt="QQæˆªå›¾20191028210242.png"></p><h2 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h2><p><span style="color:red;font-weight:600">ä¸‹é¢è¿™äº›å‡†å¤‡å·¥ä½œåˆ†åˆ«åœ¨3å°æœºå™¨ä¸Šä½¿ç”¨rootè´¦å·æ“ä½œï¼š</span></p><p><strong>1.å®‰è£…å¿…è¦è½¯ä»¶ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y net-tools.x86_64 vim wget</span><br></pre></td></tr></table></figure><p></p><p><strong>2.é…ç½®hostsï¼š</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br></pre></td></tr></table></figure><p></p><p>å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.33.11 master</span><br><span class="line">192.168.33.12 node1</span><br><span class="line">192.168.33.13 node2</span><br></pre></td></tr></table></figure><p></p><p><strong>3.å…³é—­é˜²ç«å¢™ï¼š</strong></p><p>ä¸ºäº†é¿å…kubernetesçš„MasterèŠ‚ç‚¹å’Œå„ä¸ªå·¥ä½œèŠ‚ç‚¹çš„NodeèŠ‚ç‚¹é—´çš„é€šä¿¡å‡ºç°é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å…³é—­æœ¬åœ°æ­å»ºçš„Centosè™šæ‹Ÿæœºçš„é˜²ç«å¢™ã€‚ç”Ÿäº§ç¯å¢ƒæ¨èçš„åšæ³•æ˜¯åœ¨é˜²ç«å¢™ä¸Šé…ç½®å„ä¸ªç»„ä»¶éœ€è¦ç›¸äº’é€šä¿¡çš„ç«¯å£ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable firewalld</span><br><span class="line">systemctl stop firewalld</span><br></pre></td></tr></table></figure><p></p><p><strong>4.ç¦ç”¨SELinuxï¼Œè®©å®¹å™¨å¯ä»¥é¡ºåˆ©åœ°è¯»å–ä¸»æœºæ–‡ä»¶ç³»ç»Ÿï¼š</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i &apos;s/^SELINUX=enforcing$/SELINUX=disabled/&apos; /etc/selinux/config</span><br></pre></td></tr></table></figure><p><strong>5.å®‰è£…18.09ç‰ˆæœ¬çš„dockerï¼š</strong></p><p>å› ä¸ºæœ¬èŠ‚éœ€è¦å®‰è£…çš„kubernetesé›†ç¾¤ç‰ˆæœ¬ä¸º1.16.2ï¼Œè€Œè¯¥ç‰ˆæœ¬çš„kubernetesæœ€é«˜æ”¯æŒçš„dockerç‰ˆæœ¬ä¸º18.09ã€‚å¯ä»¥é€šè¿‡è¯¥åœ°å€æŸ¥çœ‹kuberneteså’Œdockerçš„ç‰ˆæœ¬å¯¹åº”å…³ç³»ï¼š<a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.16.md#downloads-for-v1160" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.16.md#downloads-for-v1160</a>ï¼š</p><p><img src="img/QQæˆªå›¾20191028211129.png" alt="QQæˆªå›¾20191028211129.png"></p><p>å®‰è£…å¿…è¦ä¾èµ–:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils \</span><br><span class="line">  device-mapper-persistent-data \</span><br><span class="line">  lvm2</span><br></pre></td></tr></table></figure><p></p><p>æ·»åŠ dockerç¨³å®šç‰ˆä»“åº“ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><p></p><p>å®‰è£…18.09ç‰ˆæœ¬ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install docker-ce-18.09.0 docker-ce-cli-18.09.0 containerd.io</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨dockerï¼Œå¹¶è®¾ç½®å¼€æœºè‡ªå¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable docker &amp;&amp; systemctl start docker</span><br></pre></td></tr></table></figure><p></p><p>ä¿®æ”¹/etc/docker/daemon.jsonæ–‡ä»¶:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/docker/daemon.json</span><br></pre></td></tr></table></figure><p></p><p>å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>é‡å¯dockerï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure><p></p><p><strong>6.å°†æ¡¥æ¥çš„IPv4æµé‡ä¼ é€’åˆ°iptablesçš„é“¾</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">   net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">   net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl --system</span><br></pre></td></tr></table></figure><p><strong>7.å…³é—­swap</strong></p><p>Swapæ˜¯æ“ä½œç³»ç»Ÿåœ¨å†…å­˜åƒç´§çš„æƒ…å†µç”³è¯·çš„è™šæ‹Ÿå†…å­˜ï¼ŒæŒ‰ç…§Kuberneteså®˜ç½‘çš„è¯´æ³•ï¼ŒSwapä¼šå¯¹Kubernetesçš„æ€§èƒ½é€ æˆå½±å“ï¼Œä¸æ¨èä½¿ç”¨Swapã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a</span><br></pre></td></tr></table></figure><p></p><h2 id="å®‰è£…Master"><a href="#å®‰è£…Master" class="headerlink" title="å®‰è£…Master"></a>å®‰è£…Master</h2><p>å‡†å¤‡å·¥ä½œå®Œæ¯•åï¼Œæ¥ç€å¼€å§‹åœ¨192.168.33.11 Masterè™šæ‹Ÿæœºä¸Šå®‰è£…Kubernetes Masterã€‚</p><p><strong>1.é…ç½®å›½å†…çš„kubernetesæºï¼š</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line"></span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p></p><p><strong>2.å®‰è£…kubeletã€kubeadmå’Œkubectlå·¥å…·ï¼š</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes</span><br></pre></td></tr></table></figure><p></p><p><strong>3.å¯åŠ¨kubeletå¹¶è®¾ç½®å¼€æœºè‡ªå¯ï¼š</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable kubelet &amp;&amp; systemctl start kubelet</span><br></pre></td></tr></table></figure><p></p><p><strong>4.ä½¿ç”¨ä¸‹é¢è¿™æ¡å‘½ä»¤å¯åŠ¨masterï¼š</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --kubernetes-version=v1.16.2 \</span><br><span class="line">--pod-network-cidr=10.244.0.0/16 \</span><br><span class="line">--service-cidr=10.1.0.0/16 \</span><br><span class="line">--apiserver-advertise-address=192.168.33.11 \</span><br><span class="line">--image-repository registry.aliyuncs.com/google_containers</span><br></pre></td></tr></table></figure><p></p><p>é…ç½®å«ä¹‰å¦‚ä¸‹ï¼š</p><ul><li>kubernetes-version: ç”¨äºæŒ‡å®šk8sç‰ˆæœ¬ï¼Œè¿™é‡ŒæŒ‡å®šä¸ºæœ€æ–°çš„1.16.2ç‰ˆæœ¬ï¼›</li><li>apiserver-advertise-addressï¼šç”¨äºæŒ‡å®škube-apiserverç›‘å¬çš„ipåœ°å€ï¼Œå°±æ˜¯masteræœ¬æœºIPåœ°å€ã€‚</li><li>pod-network-cidrï¼šå› ä¸ºåé¢æˆ‘ä»¬é€‰æ‹©flannelä½œä¸ºPodçš„ç½‘ç»œæ’ä»¶ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦æŒ‡å®šPodçš„ç½‘ç»œèŒƒå›´ä¸º10.244.0.0/16</li><li>service-cidrï¼šç”¨äºæŒ‡å®šSVCçš„ç½‘ç»œèŒƒå›´ï¼›</li><li>image-repository: å…¶ä¸­é»˜è®¤çš„é•œåƒä»“åº“k8s.gcr.ioæ²¡æœ‰ç§‘å­¦ä¸Šç½‘çš„è¯æ— æ³•è®¿é—®ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒä¿®æ”¹ä¸ºå›½å†…çš„é˜¿é‡Œé•œåƒä»“åº“registry.aliyuncs.com/google_containers</li></ul><p>å¯åŠ¨æ—¶ï¼Œéœ€è¦æ‹‰å–é•œåƒï¼Œè¿‡ç¨‹æ¯”è¾ƒç¼“æ…¢è€å¿ƒç­‰å¾…å³å¯ã€‚å¦‚æœä½ æƒ³å…ˆæ‹‰å¥½é•œåƒå†å¯åŠ¨ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>kubeadm config images list</code>å‘½ä»¤åˆ—å‡ºéœ€è¦æ‹‰å–çš„é•œåƒã€‚</p><p>å¯åŠ¨æˆåŠŸåï¼Œä½ ä¼šçœ‹åˆ°ç±»ä¼¼å¦‚ä¸‹æç¤º:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p $HOME/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm join 192.168.33.11:6443 --token yf7sct.o63ceq25gxdu71cd \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:bcd15ddd7432d393d3831c75ac7673f582d4e9895ff2c579c3f545d2a5d3026e</span><br></pre></td></tr></table></figure><p></p><p>æ„æ€æ˜¯ï¼Œå¦‚æœä½ æƒ³è¦érootç”¨æˆ·ä¹Ÿèƒ½ä½¿ç”¨kubectlå‘½ä»¤çš„è¯ï¼Œéœ€è¦æ‰§è¡Œä¸‹é¢è¿™äº›æ“ä½œï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure><p></p><p>è€Œå¦‚æœä½ æ˜¯rootç”¨æˆ·çš„è¯ï¼Œç›´æ¥è¿è¡Œä¸‹é¢è¿™æ®µå‘½ä»¤å³å¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export KUBECONFIG=/etc/kubernetes/admin.conf</span><br></pre></td></tr></table></figure><p></p><p>è€Œä¸‹é¢è¿™æ®µåˆ™æ˜¯ç”¨äºå·¥ä½œèŠ‚ç‚¹NodeåŠ å…¥Masteré›†ç¾¤ç”¨çš„ï¼Œåé¢ä¼šä½¿ç”¨åˆ°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.33.11:6443 --token yf7sct.o63ceq25gxdu71cd \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:bcd15ddd7432d393d3831c75ac7673f582d4e9895ff2c579c3f545d2a5d3026e</span><br></pre></td></tr></table></figure><p></p><h2 id="å®‰è£…NodeèŠ‚ç‚¹ï¼ŒåŠ å…¥é›†ç¾¤"><a href="#å®‰è£…NodeèŠ‚ç‚¹ï¼ŒåŠ å…¥é›†ç¾¤" class="headerlink" title="å®‰è£…NodeèŠ‚ç‚¹ï¼ŒåŠ å…¥é›†ç¾¤"></a>å®‰è£…NodeèŠ‚ç‚¹ï¼ŒåŠ å…¥é›†ç¾¤</h2><p>æ¥ç€åœ¨192.168.33.12å’Œ192.168.33.13è™šæ‹Ÿæœºä¸Šæ“ä½œã€‚</p><p>å’Œå®‰è£…Masteræ­¥éª¤ä¸€æ ·ï¼Œå…ˆå®‰è£…å¥½kubeadmç›¸å…³å·¥å…·ï¼Œç„¶åæ‰§è¡Œä¸‹é¢è¿™æ¡å‘½ä»¤å°†NodeåŠ å…¥åˆ°é›†ç¾¤ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.33.11:6443 --token yf7sct.o63ceq25gxdu71cd \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:bcd15ddd7432d393d3831c75ac7673f582d4e9895ff2c579c3f545d2a5d3026e</span><br></pre></td></tr></table></figure><p></p><p>å½“è¾“å‡ºå¦‚ä¸‹å†…å®¹æ˜¯è¯´æ˜åŠ å…¥æˆåŠŸï¼š</p><p><img src="img/QQæˆªå›¾20191028215138.png" alt="QQæˆªå›¾20191028215138.png"></p><h2 id="å®‰è£…ç½‘ç»œæ’ä»¶"><a href="#å®‰è£…ç½‘ç»œæ’ä»¶" class="headerlink" title="å®‰è£…ç½‘ç»œæ’ä»¶"></a>å®‰è£…ç½‘ç»œæ’ä»¶</h2><p>åœ¨Masterä¸Šæ‰§è¡Œkubectl get nodeså‘½ä»¤ï¼Œä¼šå‘ç°Kubernetesæç¤ºMasterä¸ºNotReadyçŠ¶æ€ï¼Œè¿™æ˜¯å› ä¸ºè¿˜æ²¡æœ‰å®‰è£…CNIç½‘ç»œæ’ä»¶ï¼š</p><p><img src="img/QQæˆªå›¾20191028215653.png" alt="QQæˆªå›¾20191028215653.png"></p><p>å¯¹äºCNIç½‘ç»œæ’ä»¶ï¼Œå¯ä»¥æœ‰è®¸å¤šé€‰æ‹©ï¼Œè¯·å‚è€ƒ<a href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/#pod-network" target="_blank" rel="noopener">https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/#pod-network</a>çš„è¯´æ˜ã€‚è¿™é‡Œæˆ‘é€‰æ‹©çš„flannelï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure><p></p><p>ä¿®æ”¹kube-flannel.ymlï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim kube-flannel.yml</span><br></pre></td></tr></table></figure><p></p><p>ä¿®æ”¹çš„åœ°æ–¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">containers:</span><br><span class="line">      - name: kube-flannel</span><br><span class="line">        image: quay.io/coreos/flannel:v0.11.0-amd64</span><br><span class="line">        command:</span><br><span class="line">        - /opt/bin/flanneld</span><br><span class="line">        args:</span><br><span class="line">        - --ip-masq</span><br><span class="line">        - --kube-subnet-mgr</span><br><span class="line">        - --iface=eth1 # æ–°å¢éƒ¨åˆ†</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p></p><p>Vagrant åœ¨å¤šä¸»æœºæ¨¡å¼ä¸‹æœ‰å¤šä¸ªç½‘å¡ï¼Œeth0 ç½‘å¡ç”¨äºnatè½¬å‘è®¿é—®å…¬ç½‘ï¼Œè€Œeth1ç½‘å¡æ‰æ˜¯ä¸»æœºçœŸæ­£çš„IPï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ç›´æ¥éƒ¨ç½²k8s flannel æ’ä»¶ä¼šå¯¼è‡´CoreDNSæ— æ³•å·¥ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ·»åŠ ä¸Šé¢è¿™æ¡é…ç½®å¼ºåˆ¶flannelä½¿ç”¨eth1ã€‚</p><p>å®‰è£…flannelï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f kube-flannel.yml</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºæ—¶ï¼Œè¡¨ç¤ºå®‰è£…æˆåŠŸï¼š</p><p><img src="img/QQæˆªå›¾20191028215831.png" alt="QQæˆªå›¾20191028215831.png"></p><p>ç¨ç­‰ç‰‡åˆ»åï¼Œå†æ¬¡æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€ï¼š</p><p><img src="img/QQæˆªå›¾20191028215910.png" alt="QQæˆªå›¾20191028215910.png"></p><p>å¯ä»¥çœ‹åˆ°æ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯ReadyçŠ¶æ€ã€‚</p><p>æ‰§è¡Œ<code>kubectl get pods --all-namespaces</code>ï¼ŒéªŒè¯Kubernetesé›†ç¾¤çš„ç›¸å…³Podæ˜¯å¦éƒ½æ­£å¸¸åˆ›å»ºå¹¶è¿è¡Œï¼š</p><p><img src="img/QQæˆªå›¾20191028220122.png" alt="QQæˆªå›¾20191028220122.png"></p><p>åˆ°è¿™é‡Œé€šè¿‡Kubeadmå®‰è£…Kubernetes 1.16.2é›†ç¾¤å·²ç»æˆåŠŸäº†ã€‚å¦‚æœå®‰è£…å¤±è´¥ï¼Œåˆ™å¯ä»¥æ‰§è¡Œ<code>kubeadm reset</code>å‘½ä»¤å°†ä¸»æœºæ¢å¤åŸçŠ¶ï¼Œé‡æ–°æ‰§è¡Œ<code>kubeadm init</code>å‘½ä»¤ï¼Œå†æ¬¡è¿›è¡Œå®‰è£…ã€‚</p><h2 id="å°è¯•ç‰›åˆ€"><a href="#å°è¯•ç‰›åˆ€" class="headerlink" title="å°è¯•ç‰›åˆ€"></a>å°è¯•ç‰›åˆ€</h2><p>ä¸ºäº†å¿«é€Ÿåœ°éªŒè¯ä¸€ä¸‹ä¸Šé¢æ­å»ºé›†ç¾¤æ˜¯å¦å¯ç”¨ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªNginx Deploymentï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create deployment nginx --image=nginx</span><br><span class="line"> </span><br><span class="line">kubectl expose deployment nginx --port=80 --type=NodePort</span><br></pre></td></tr></table></figure><p></p><p>ä½¿ç”¨å‘½ä»¤<code>kubectl get pod,svc</code>æŸ¥çœ‹æ˜¯å¦æ­£å¸¸ï¼š</p><p><img src="img/QQæˆªå›¾20191028221659.png" alt="QQæˆªå›¾20191028221659.png"></p><p>ä½¿ç”¨å‘½ä»¤<code>kubectl get pods,svc -o wide</code>æŸ¥çœ‹è¯¥Podå…·ä½“ä½äºå“ªä¸€ä¸ªèŠ‚ç‚¹ï¼š</p><p><img src="img/QQæˆªå›¾20191028221805.png" alt="QQæˆªå›¾20191028221805.png"></p><p>å¯ä»¥çœ‹åˆ°å…¶ä½äºNode2èŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹IPä¸º192.168.33.13ï¼Œç«¯å£ä¸º30935ï¼Œä½¿ç”¨æµè§ˆå™¨è®¿é—®è¯¥åœ°å€ï¼š</p><p><img src="img/QQæˆªå›¾20191028221923.png" alt="QQæˆªå›¾20191028221923.png"></p><p>ä½¿ç”¨<code>kubectl get pods</code>å‘½ä»¤æŸ¥çœ‹Podçš„æƒ…å†µ:</p><p><img src="img/QQæˆªå›¾20191029202111.png" alt="QQæˆªå›¾20191029202111.png"></p><p>ä½¿ç”¨<code>kubectl delete</code>å‘½ä»¤åˆ é™¤è¿™ä¸ªPodçœ‹çœ‹ä¼šæ€æ ·ï¼š</p><p><img src="img/QQæˆªå›¾20191029202330.png" alt="QQæˆªå›¾20191029202330.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œåˆšåˆšçš„åä¸ºxxxçš„Podå¤„äºTerminatingï¼ˆç»“æŸä¸­ï¼‰çš„çŠ¶æ€ï¼Œè€Œå¦ä¸€ä¸ªæ–°çš„åä¸ºxxxçš„Podæ­£å¤„äºContainerCreatingï¼ˆåˆ›å»ºä¸­ï¼‰çŠ¶æ€ï¼Œå› ä¸ºé»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>replicas</code>çš„å€¼ä¸º1ï¼ŒKubernetesé›†ç¾¤ä¼šå§‹ç»ˆä¿æŒNginxçš„å®ä¾‹ä¸º1ã€‚</p><p>è¦åˆ é™¤Nginxå¯ä»¥é€šè¿‡åˆ é™¤deploymentæ¥å®Œæˆï¼Œä½¿ç”¨<code>kubectl get deployments</code>å‘½ä»¤æŸ¥çœ‹å½“å‰çš„deploymentï¼š</p><p><img src="img/QQæˆªå›¾20191029202412.png" alt="QQæˆªå›¾20191029202412.png"></p><p>ä½¿ç”¨å‘½ä»¤<code>kubectl delete deployment nginx</code>ï¼š</p><p><img src="img/QQæˆªå›¾20191029202439.png" alt="QQæˆªå›¾20191029202439.png"></p><p>å®é™…ä¸­æˆ‘ä»¬ä¸€èˆ¬é€šè¿‡ymlæˆ–è€…jsonæ–‡ä»¶æ¥åˆ›å»ºåº”ç”¨ï¼Œä¸‹é¢æˆ‘ä»¬ä½¿ç”¨ymlçš„æ–¹å¼åˆ›å»ºä¸€ä¸ª3å®ä¾‹çš„Nginxé›†ç¾¤ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim nginx-rc.yml</span><br></pre></td></tr></table></figure><p></p><p>å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-rc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim nginx-service.yml</span><br></pre></td></tr></table></figure><p>å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure><p></p><p>æ¥ç€æ‰§è¡Œä¸‹é¢è¿™ä¸¤æ¡å‘½ä»¤å¯åŠ¨Nginxé›†ç¾¤ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f nginx-rc.yml</span><br><span class="line">kubectl create -f nginx-service.yml</span><br></pre></td></tr></table></figure><p></p><p>ä½¿ç”¨<code>kubectl get pods</code>å‘½ä»¤æŸ¥çœ‹Podæƒ…å†µ:</p><p><img src="img/QQæˆªå›¾20191029202540.png" alt="QQæˆªå›¾20191029202540.png"></p><p>ä½¿ç”¨<code>kubectl get services</code>å‘½ä»¤æŸ¥çœ‹Serviceæƒ…å†µï¼š</p><p><img src="img/QQæˆªå›¾20191029202644.png" alt="QQæˆªå›¾20191029202644.png"></p><p>ä½¿ç”¨<code>kubectl describe svc nginx-service</code>å‘½ä»¤æŸ¥çœ‹Nginx Serviceè¯¦æƒ…ï¼š</p><p><img src="img/QQæˆªå›¾20191029202719.png" alt="QQæˆªå›¾20191029202719.png"></p><p>ä½¿ç”¨å‘½ä»¤<code>kubectl get pods,svc -o wide</code>æŸ¥çœ‹Nginx Podå…·ä½“ä½äºå“ªä¸€ä¸ªèŠ‚ç‚¹ï¼š</p><p><img src="img/QQæˆªå›¾20191029202746.png" alt="QQæˆªå›¾20191029202746.png"></p><p>å¯ä»¥çœ‹åˆ°åœ¨node1å’Œnode2èŠ‚ç‚¹ä¸Šéƒ½æœ‰Nginxçš„Podï¼Œä½¿ç”¨æµè§ˆå™¨è®¿é—®<a href="http://192.168.33.12:32631/" target="_blank" rel="noopener">http://192.168.33.12:32631/</a>æˆ–è€…<a href="http://192.168.33.13:32631/" target="_blank" rel="noopener">http://192.168.33.13:32631/</a>ï¼š</p><p><img src="img/QQæˆªå›¾20191029202923.png" alt="QQæˆªå›¾20191029202923.png"></p><p>åˆ é™¤çš„è¯æ‰§è¡Œä¸‹é¢è¿™ä¸¤æ¡å‘½ä»¤å³å¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f nginx-service.yml</span><br><span class="line">kubectl delete -f nginx-rc.yml</span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;Kubernetesä»1.4ç‰ˆæœ¬å¼€å§‹åå°±å¼•å…¥äº†kubeadmç”¨äºç®€åŒ–é›†ç¾¤æ­å»ºçš„è¿‡ç¨‹ï¼Œåœ¨Kubernetes 1.13ç‰ˆæœ¬ä¸­ï¼Œkubeadmå·¥å…·è¿›å…¥GAé˜¶æ®µï¼Œå¯ç”¨äºç”Ÿäº§ç¯å¢ƒKubernetesé›†ç¾¤æ­å»ºã€‚æœ¬èŠ‚å°†ä½¿ç”¨Kubeadmæ­å»ºKubernetes1.16.2é›†ç¾¤ï¼Œå®¿ä¸»æœºé‡‡ç”¨3å°Vagrantæ„å»ºçš„Centos7è™šæ‹Ÿæœºï¼Œé…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼ˆKubernetesæ¨èå®¿ä¸»æœºæœ€ä½å†…å­˜ä¸èƒ½ä½äº2Gï¼ŒCPUæ ¸å¿ƒæ•°æœ€ä½ä¸èƒ½ä½äº2ï¼‰ï¼š
    
    </summary>
    
    
      <category term="Kubernetes" scheme="http://mrbird.cc/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Fork/Joinä½¿ç”¨å­¦ä¹ </title>
    <link href="http://mrbird.cc/JDK7-Fork-Join.html"/>
    <id>http://mrbird.cc/JDK7-Fork-Join.html</id>
    <published>2019-03-21T03:20:14.000Z</published>
    <updated>2019-10-28T12:14:46.235Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --><p>JDK7æä¾›äº†ä¸€ä¸ªå°†ä»»åŠ¡â€œåˆ†è€Œæ²»ä¹‹â€çš„æ¡†æ¶ â€” Fork/Joinã€‚å®ƒæŠŠä¸€ä¸ªå¤§çš„ä»»åŠ¡åˆ†å‰²æˆè¶³å¤Ÿå°çš„å­ä»»åŠ¡ï¼Œå¦‚æœå­ä»»åŠ¡æ¯”è¾ƒå¤§çš„è¯è¿˜è¦å¯¹å­ä»»åŠ¡è¿›è¡Œç»§ç»­åˆ†å‰²ã€‚åˆ†å‰²çš„å­ä»»åŠ¡åˆ†åˆ«æ”¾åˆ°åŒç«¯é˜Ÿåˆ—é‡Œï¼Œç„¶åå¯åŠ¨çº¿ç¨‹åˆ†åˆ«ä»åŒç«¯é˜Ÿåˆ—é‡Œè·å–ä»»åŠ¡æ‰§è¡Œã€‚å­ä»»åŠ¡æ‰§è¡Œå®Œçš„ç»“æœéƒ½æ”¾åœ¨å¦å¤–ä¸€ä¸ªé˜Ÿåˆ—é‡Œï¼Œå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ä»é˜Ÿåˆ—é‡Œå–æ•°æ®ï¼Œç„¶ååˆå¹¶è¿™äº›æ•°æ®ã€‚<a id="more"></a></p><p>Fork/Joinçš„æ€æƒ³å¦‚ä¸‹æ‰€ç¤ºï¼š <img src="img/QQæˆªå›¾20190702172347.png" alt="QQæˆªå›¾20190702172347.png"></p><h2 id="RecursiveTask"><a href="#RecursiveTask" class="headerlink" title="RecursiveTask"></a>RecursiveTask</h2><p><img src="img/QQæˆªå›¾20190703111904.png" alt="QQæˆªå›¾20190703111904.png"></p><p>RecursiveTaské€‚ç”¨äºå°†ä»»åŠ¡åˆ†è€Œæ²»ä¹‹ï¼Œå¹¶ä¸”æœ‰è¿”å›å€¼çš„æƒ…å†µï¼Œä¸¾ä¸ªè®¡ç®—1åˆ°100å’Œçš„ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RecursiveTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å®šä¹‰æœ€å°åŒºé—´ä¸º10</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> MAX_THRESHOLD = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ForkJoinPool forkJoinPool = <span class="keyword">new</span> ForkJoinPool();</span><br><span class="line">        ForkJoinTask&lt;Integer&gt; future = forkJoinPool.submit(<span class="keyword">new</span> CalculateRecursiveTask(<span class="number">1</span>, <span class="number">100</span>));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Integer result = future.get();</span><br><span class="line">            System.out.println(result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CalculateRecursiveTask</span> <span class="keyword">extends</span> <span class="title">RecursiveTask</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">        <span class="comment">// èµ·å§‹</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> start;</span><br><span class="line">        <span class="comment">// ç»“æŸ</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> end;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CalculateRecursiveTask</span><span class="params">(<span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.start = start;</span><br><span class="line">            <span class="keyword">this</span>.end = end;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> Integer <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// å¦‚æœèµ·å§‹å’Œç»“æŸèŒƒå›´å°äºæˆ‘ä»¬å®šä¹‰çš„åŒºé—´èŒƒå›´ï¼Œåˆ™ç›´æ¥è®¡ç®—</span></span><br><span class="line">            <span class="keyword">if</span> ((end - start) &lt;= MAX_THRESHOLD) &#123;</span><br><span class="line">                <span class="keyword">return</span> IntStream.rangeClosed(start, end).sum();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å¦åˆ™ï¼Œå°†èŒƒå›´ä¸€åˆ†ä¸ºäºŒï¼Œåˆ†æˆä¸¤ä¸ªå­ä»»åŠ¡</span></span><br><span class="line">                <span class="keyword">int</span> middle = (start + end) / <span class="number">2</span>;</span><br><span class="line">                CalculateRecursiveTask leftTask = <span class="keyword">new</span> CalculateRecursiveTask(start, middle);</span><br><span class="line">                CalculateRecursiveTask rightTask = <span class="keyword">new</span> CalculateRecursiveTask(middle + <span class="number">1</span>, end);</span><br><span class="line">                <span class="comment">// æ‰§è¡Œå­ä»»åŠ¡</span></span><br><span class="line">                leftTask.fork();</span><br><span class="line">                rightTask.fork();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// æ±‡æ€»å­ä»»åŠ¡</span></span><br><span class="line">                <span class="keyword">return</span> leftTask.join() + rightTask.join();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ForkJoinPoolä½¿ç”¨submitæˆ–invokeæäº¤çš„åŒºåˆ«ï¼šinvokeæ˜¯åŒæ­¥æ‰§è¡Œï¼Œè°ƒç”¨ä¹‹åéœ€è¦ç­‰å¾…ä»»åŠ¡å®Œæˆï¼Œæ‰èƒ½æ‰§è¡Œåé¢çš„ä»£ç ï¼›submitæ˜¯å¼‚æ­¥æ‰§è¡Œï¼Œåªæœ‰åœ¨Futureè°ƒç”¨getçš„æ—¶å€™ä¼šé˜»å¡ã€‚</p><p>å¯åŠ¨ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p><p><img src="img/QQæˆªå›¾20190703112347.png" alt="QQæˆªå›¾20190703112347.png"></p><p>å…¶å®è¿™é‡Œæ‰§è¡Œå­ä»»åŠ¡è°ƒç”¨forkæ–¹æ³•å¹¶ä¸æ˜¯æœ€ä½³çš„é€‰æ‹©ï¼Œæœ€ä½³çš„é€‰æ‹©æ˜¯invokeAllæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰§è¡Œå­ä»»åŠ¡</span></span><br><span class="line"><span class="comment">// leftTask.fork();</span></span><br><span class="line"><span class="comment">// rightTask.fork();</span></span><br><span class="line">invokeAll(leftTask,rightTask);</span><br><span class="line"><span class="comment">// æ±‡æ€»å­ä»»åŠ¡</span></span><br><span class="line"><span class="keyword">return</span> leftTask.join() + rightTask.join();</span><br></pre></td></tr></table></figure><p></p><h2 id="RecursiveAction"><a href="#RecursiveAction" class="headerlink" title="RecursiveAction"></a>RecursiveAction</h2><p><img src="img/QQæˆªå›¾20190703114411.png" alt="QQæˆªå›¾20190703114411.png"></p><p>ä½¿ç”¨æ–¹å¼å’ŒRecursiveTaskç±»ä¼¼ï¼Œåªä¸è¿‡æ²¡æœ‰è¿”å›å€¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RecursiveActionTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å®šä¹‰æœ€å°åŒºé—´ä¸º10</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> MAX_THRESHOLD = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> AtomicInteger SUM = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ForkJoinPool forkJoinPool = <span class="keyword">new</span> ForkJoinPool();</span><br><span class="line">        forkJoinPool.submit(<span class="keyword">new</span> CalculateRecursiveAction(<span class="number">0</span>, <span class="number">100</span>));</span><br><span class="line">        forkJoinPool.awaitTermination(<span class="number">2</span>, TimeUnit.SECONDS);</span><br><span class="line">        System.out.println(SUM);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CalculateRecursiveAction</span> <span class="keyword">extends</span> <span class="title">RecursiveAction</span> </span>&#123;</span><br><span class="line">        <span class="comment">// èµ·å§‹</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> start;</span><br><span class="line">        <span class="comment">// ç»“æŸ</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> end;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">CalculateRecursiveAction</span><span class="params">(<span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.start = start;</span><br><span class="line">            <span class="keyword">this</span>.end = end;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// å¦‚æœèµ·å§‹å’Œç»“æŸèŒƒå›´å°äºæˆ‘ä»¬å®šä¹‰çš„åŒºé—´èŒƒå›´ï¼Œåˆ™ç›´æ¥è®¡ç®—</span></span><br><span class="line">            <span class="keyword">if</span> ((end - start) &lt;= MAX_THRESHOLD) &#123;</span><br><span class="line">                SUM.addAndGet(IntStream.rangeClosed(start, end).sum());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å¦åˆ™ï¼Œå°†èŒƒå›´ä¸€åˆ†ä¸ºäºŒï¼Œåˆ†æˆä¸¤ä¸ªå­ä»»åŠ¡</span></span><br><span class="line">                <span class="keyword">int</span> middle = (end + start) / <span class="number">2</span>;</span><br><span class="line">                CalculateRecursiveAction leftAction = <span class="keyword">new</span> CalculateRecursiveAction(start, middle);</span><br><span class="line">                CalculateRecursiveAction rightAction = <span class="keyword">new</span> CalculateRecursiveAction(middle + <span class="number">1</span>, end);</span><br><span class="line">                <span class="comment">// æ‰§è¡Œå­ä»»åŠ¡</span></span><br><span class="line">                invokeAll(leftAction, rightAction);</span><br><span class="line">                <span class="comment">// æ²¡æœ‰æ±‡æ€»å­ä»»åŠ¡ç»“æœè¿‡ç¨‹ï¼Œå› ä¸ºæ²¡æœ‰è¿”å›å€¼ã€‚</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºç»“æœä¹Ÿæ˜¯5050ã€‚</p><h2 id="ä»€ä¹ˆæ—¶å€™ç”¨"><a href="#ä»€ä¹ˆæ—¶å€™ç”¨" class="headerlink" title="ä»€ä¹ˆæ—¶å€™ç”¨"></a>ä»€ä¹ˆæ—¶å€™ç”¨</h2><p>ä¸Šé¢åªæ˜¯ä¸ºäº†æ¼”ç¤ºFork/Joinçš„ç”¨æ³•ï¼Œå®é™…æ˜¯é‡‡ç”¨è¿™ç§æ–¹å¼è®¡ç®—åè€Œæ›´åŠ è´¹æ—¶ï¼Œå› ä¸ºåˆ‡å‰²ä»»åŠ¡ï¼Œåˆ†é…çº¿ç¨‹éœ€è¦é¢å¤–çš„å¼€é”€ã€‚å…¶å®ä»€ä¹ˆæ—¶å€™ç”¨ä¸å¿…å¤ªçº ç»“ï¼Œä¸€ä¸ªè¶³å¤Ÿå¤§çš„ä»»åŠ¡ï¼Œå¦‚æœé‡‡ç”¨Fork/Joinæ¥å¤„ç†æ¯”ä¼ ç»Ÿå¤„ç†æ–¹å¼å¿«çš„è¯ï¼Œé‚£å°±æ¯«ä¸çŠ¹è±«çš„é€‰æ‹©å®ƒå§ï¼</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.imooc.com/article/24822" target="_blank" rel="noopener">https://www.imooc.com/article/24822</a></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;JDK7æä¾›äº†ä¸€ä¸ªå°†ä»»åŠ¡â€œåˆ†è€Œæ²»ä¹‹â€çš„æ¡†æ¶ â€” Fork/Joinã€‚å®ƒæŠŠä¸€ä¸ªå¤§çš„ä»»åŠ¡åˆ†å‰²æˆè¶³å¤Ÿå°çš„å­ä»»åŠ¡ï¼Œå¦‚æœå­ä»»åŠ¡æ¯”è¾ƒå¤§çš„è¯è¿˜è¦å¯¹å­ä»»åŠ¡è¿›è¡Œç»§ç»­åˆ†å‰²ã€‚åˆ†å‰²çš„å­ä»»åŠ¡åˆ†åˆ«æ”¾åˆ°åŒç«¯é˜Ÿåˆ—é‡Œï¼Œç„¶åå¯åŠ¨çº¿ç¨‹åˆ†åˆ«ä»åŒç«¯é˜Ÿåˆ—é‡Œè·å–ä»»åŠ¡æ‰§è¡Œã€‚å­ä»»åŠ¡æ‰§è¡Œå®Œçš„ç»“æœéƒ½æ”¾åœ¨å¦å¤–ä¸€ä¸ªé˜Ÿåˆ—é‡Œï¼Œå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ä»é˜Ÿåˆ—é‡Œå–æ•°æ®ï¼Œç„¶ååˆå¹¶è¿™äº›æ•°æ®ã€‚
    
    </summary>
    
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥å­¦ä¹ Javaçº¿ç¨‹æ± </title>
    <link href="http://mrbird.cc/Java-Thread-Pool.html"/>
    <id>http://mrbird.cc/Java-Thread-Pool.html</id>
    <published>2019-03-20T12:35:35.000Z</published>
    <updated>2019-10-28T12:14:46.241Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --><p>åœ¨å‰é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬éƒ½æ˜¯é€šè¿‡<code>new Thread</code>æ¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œç”±äºçº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯éƒ½éœ€è¦æ¶ˆè€—ä¸€å®šçš„CPUèµ„æºï¼Œæ‰€ä»¥åœ¨é«˜å¹¶å‘ä¸‹è¿™ç§åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼å°†ä¸¥é‡å½±å“ä»£ç æ‰§è¡Œæ•ˆç‡ã€‚è€Œçº¿ç¨‹æ± çš„ä½œç”¨å°±æ˜¯è®©ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œç»“æŸåä¸é©¬ä¸Šé”€æ¯ï¼Œç»§ç»­æ‰§è¡Œæ–°çš„ä»»åŠ¡ï¼Œè¿™æ ·å°±èŠ‚çœäº†ä¸æ–­åˆ›å»ºçº¿ç¨‹å’Œé”€æ¯çº¿ç¨‹çš„å¼€é”€ã€‚<a id="more"></a></p><h2 id="ThreadPoolExecutor"><a href="#ThreadPoolExecutor" class="headerlink" title="ThreadPoolExecutor"></a>ThreadPoolExecutor</h2><p>åˆ›å»ºJavaçº¿ç¨‹æ± æœ€ä¸ºæ ¸å¿ƒçš„ç±»ä¸º<code>ThreadPoolExecutor</code>ï¼š</p><p><img src="img/QQæˆªå›¾20190630215357.png" alt="QQæˆªå›¾20190630215357.png"></p><p>å®ƒæä¾›äº†å››ç§æ„é€ å‡½æ•°æ¥åˆ›å»ºçº¿ç¨‹æ± ï¼Œå…¶ä¸­æœ€ä¸ºæ ¸å¿ƒçš„æ„é€ å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">int</span> maximumPoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">long</span> keepAliveTime,</span></span></span><br><span class="line"><span class="function"><span class="params">                              TimeUnit unit,</span></span></span><br><span class="line"><span class="function"><span class="params">                              BlockingQueue&lt;Runnable&gt; workQueue,</span></span></span><br><span class="line"><span class="function"><span class="params">                              ThreadFactory threadFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">                              RejectedExecutionHandler handler)</span></span></span><br></pre></td></tr></table></figure><p></p><p>è¿™7ä¸ªå‚æ•°çš„å«ä¹‰å¦‚ä¸‹ï¼š</p><ol><li><p><strong>corePoolSize</strong> çº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹æ•°ã€‚å³çº¿ç¨‹æ± ä¸­ä¿ç•™çš„çº¿ç¨‹ä¸ªæ•°ï¼Œå³ä½¿è¿™äº›çº¿ç¨‹æ˜¯ç©ºé—²çš„ï¼Œä¹Ÿä¸ä¼šè¢«é”€æ¯ï¼Œé™¤éé€šè¿‡ThreadPoolExecutorçš„<code>allowCoreThreadTimeOut(true)</code>æ–¹æ³•å¼€å¯äº†æ ¸å¿ƒçº¿ç¨‹çš„è¶…æ—¶ç­–ç•¥ï¼›</p></li><li><p><strong>maximumPoolSize</strong> çº¿ç¨‹æ± ä¸­å…è®¸çš„æœ€å¤§çº¿ç¨‹ä¸ªæ•°ï¼›</p></li><li><p><strong>keepAliveTime</strong> ç”¨äºè®¾ç½®é‚£äº›è¶…å‡ºæ ¸å¿ƒçº¿ç¨‹æ•°é‡çš„çº¿ç¨‹çš„æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´è¿˜æ²¡æœ‰æ–°ä»»åŠ¡çš„è¯ï¼Œè¶…å‡ºçš„çº¿ç¨‹å°†è¢«é”€æ¯ï¼›</p></li><li><p><strong>unit</strong> è¶…æ—¶æ—¶é—´å•ä½ï¼›</p></li><li><p><strong>workQueue</strong> çº¿ç¨‹é˜Ÿåˆ—ã€‚ç”¨äºä¿å­˜é€šè¿‡executeæ–¹æ³•æäº¤çš„ï¼Œç­‰å¾…è¢«æ‰§è¡Œçš„ä»»åŠ¡ï¼›</p></li><li><p><strong>threadFactory</strong> çº¿ç¨‹åˆ›å»ºå·¥ç¨‹ï¼Œå³æŒ‡å®šæ€æ ·åˆ›å»ºçº¿ç¨‹ï¼›</p></li><li><p><strong>handler</strong> æ‹’ç»ç­–ç•¥ã€‚å³æŒ‡å®šå½“çº¿ç¨‹æäº¤çš„æ•°é‡è¶…å‡ºäº†maximumPoolSizeåï¼Œè¯¥ä½¿ç”¨ä»€ä¹ˆç­–ç•¥å¤„ç†è¶…å‡ºçš„çº¿ç¨‹ã€‚</p></li></ol><p>åœ¨é€šè¿‡è¿™ä¸ªæ„é€ æ–¹æ³•åˆ›å»ºçº¿ç¨‹æ± çš„æ—¶å€™ï¼Œè¿™å‡ ä¸ªå‚æ•°å¿…é¡»æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼Œå¦åˆ™å°†æŠ›å‡º<code>IllegalArgumentException</code>å¼‚å¸¸ï¼š</p><ol><li><p>corePoolSizeä¸èƒ½å°äº0ï¼›</p></li><li><p>keepAliveTimeä¸èƒ½å°äº0ï¼›</p></li><li><p>maximumPoolSize ä¸èƒ½å°äºç­‰äº0ï¼›</p></li><li><p>maximumPoolSizeä¸èƒ½å°äºcorePoolSizeï¼›</p></li></ol><p>æ­¤å¤–ï¼ŒworkQueueã€threadFactoryå’Œhandlerä¸èƒ½ä¸ºnullï¼Œå¦åˆ™å°†æŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚</p><p>ä¸‹é¢ä¸¾äº›ä¾‹å­æ¥æ·±å…¥ç†è§£è¿™å‡ ä¸ªå‚æ•°çš„å«ä¹‰ã€‚</p><p>ä½¿ç”¨ä¸Šé¢çš„æ„é€ æ–¹æ³•åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ThreadPoolExecutor threadPoolExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">                <span class="number">1</span>, <span class="number">2</span>, <span class="number">10</span>,</span><br><span class="line">                TimeUnit.SECONDS,</span><br><span class="line">                <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">1</span>), (ThreadFactory) Thread::<span class="keyword">new</span>,</span><br><span class="line">                <span class="keyword">new</span> ThreadPoolExecutor.AbortPolicy());</span><br><span class="line">System.out.println(<span class="string">"çº¿ç¨‹æ± åˆ›å»ºå®Œæ¯•"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> activeCount = -<span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> queueSize = -<span class="number">1</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (activeCount != threadPoolExecutor.getActiveCount()</span><br><span class="line">            || queueSize != threadPoolExecutor.getQueue().size()) &#123;</span><br><span class="line">        System.out.println(<span class="string">"æ´»è·ƒçº¿ç¨‹ä¸ªæ•° "</span> + threadPoolExecutor.getActiveCount());</span><br><span class="line">        System.out.println(<span class="string">"æ ¸å¿ƒçº¿ç¨‹ä¸ªæ•° "</span> + threadPoolExecutor.getCorePoolSize());</span><br><span class="line">        System.out.println(<span class="string">"é˜Ÿåˆ—çº¿ç¨‹ä¸ªæ•° "</span> + threadPoolExecutor.getQueue().size());</span><br><span class="line">        System.out.println(<span class="string">"æœ€å¤§çº¿ç¨‹æ•° "</span> + threadPoolExecutor.getMaximumPoolSize());</span><br><span class="line">        System.out.println(<span class="string">"------------------------------------"</span>);</span><br><span class="line">        activeCount = threadPoolExecutor.getActiveCount();</span><br><span class="line">        queueSize = threadPoolExecutor.getQueue().size();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢çš„ä»£ç åˆ›å»ºäº†ä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹æ•°é‡ä¸º1ï¼Œå…è®¸æœ€å¤§çº¿ç¨‹æ•°é‡ä¸º2ï¼Œæœ€å¤§æ´»è·ƒæ—¶é—´ä¸º10ç§’ï¼Œçº¿ç¨‹é˜Ÿåˆ—é•¿åº¦ä¸º1çš„çº¿ç¨‹æ± ã€‚</p><p>å‡å¦‚æˆ‘ä»¬é€šè¿‡executeæ–¹æ³•å‘çº¿ç¨‹æ± æäº¤1ä¸ªä»»åŠ¡ï¼Œçœ‹çœ‹ç»“æœå¦‚ä½•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">ThreadPoolExecutor threadPoolExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">                <span class="number">1</span>, <span class="number">2</span>, <span class="number">10</span>,</span><br><span class="line">                TimeUnit.SECONDS,</span><br><span class="line">                <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">1</span>), (ThreadFactory) Thread::<span class="keyword">new</span>,</span><br><span class="line">                <span class="keyword">new</span> ThreadPoolExecutor.AbortPolicy());</span><br><span class="line">System.out.println(<span class="string">"çº¿ç¨‹æ± åˆ›å»ºå®Œæ¯•"</span>);</span><br><span class="line"></span><br><span class="line">threadPoolExecutor.execute(() -&gt; sleep(<span class="number">100</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> activeCount = -<span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> queueSize = -<span class="number">1</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (activeCount != threadPoolExecutor.getActiveCount()</span><br><span class="line">            || queueSize != threadPoolExecutor.getQueue().size()) &#123;</span><br><span class="line">        System.out.println(<span class="string">"æ´»è·ƒçº¿ç¨‹ä¸ªæ•° "</span> + threadPoolExecutor.getActiveCount());</span><br><span class="line">        System.out.println(<span class="string">"æ ¸å¿ƒçº¿ç¨‹ä¸ªæ•° "</span> + threadPoolExecutor.getCorePoolSize());</span><br><span class="line">        System.out.println(<span class="string">"é˜Ÿåˆ—çº¿ç¨‹ä¸ªæ•° "</span> + threadPoolExecutor.getQueue().size());</span><br><span class="line">        System.out.println(<span class="string">"æœ€å¤§çº¿ç¨‹æ•° "</span> + threadPoolExecutor.getMaximumPoolSize());</span><br><span class="line">        System.out.println(<span class="string">"------------------------------------"</span>);</span><br><span class="line">        activeCount = threadPoolExecutor.getActiveCount();</span><br><span class="line">        queueSize = threadPoolExecutor.getQueue().size();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><div class="note info"><p>ThreadPoolExecutorçš„executeå’Œsubmitæ–¹æ³•éƒ½å¯ä»¥å‘çº¿ç¨‹æ± æäº¤ä»»åŠ¡ï¼ŒåŒºåˆ«æ˜¯ï¼Œsubmitæ–¹æ³•èƒ½å¤Ÿè¿”å›æ‰§è¡Œç»“æœï¼Œè¿”å›å€¼ç±»å‹ä¸ºFuture</p></div><p>sleepæ–¹æ³•ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sleep</span><span class="params">(<span class="keyword">long</span> value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">"çº¿ç¨‹æ‰§è¡Œsleepæ–¹æ³•"</span>);</span><br><span class="line">        TimeUnit.SECONDS.sleep(value);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨ç¨‹åºï¼Œæ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š <img src="img/QQæˆªå›¾20190630222238.png" alt="QQæˆªå›¾20190630222238.png"></p><p>çº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹æ•°é‡ä¸º1ï¼Œé€šè¿‡executeæäº¤äº†ä¸€ä¸ªä»»åŠ¡åï¼Œç”±äºæ ¸å¿ƒçº¿ç¨‹æ˜¯ç©ºé—²çš„ï¼Œæ‰€ä»¥ä»»åŠ¡è¢«æ‰§è¡Œäº†ã€‚ç”±äºè¿™ä¸ªä»»åŠ¡çš„é€»è¾‘æ˜¯ä¼‘çœ 100ç§’ï¼Œæ‰€ä»¥åœ¨è¿™100ç§’å†…ï¼Œçº¿ç¨‹æ± çš„æ´»è·ƒçº¿ç¨‹æ•°é‡ä¸º1ã€‚æ­¤å¤–ï¼Œå› ä¸ºæäº¤çš„ä»»åŠ¡è¢«æ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œäº†ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰çº¿ç¨‹éœ€è¦è¢«æ”¾åˆ°çº¿ç¨‹é˜Ÿåˆ—é‡Œç­‰å¾…ï¼Œçº¿ç¨‹é˜Ÿåˆ—é•¿åº¦ä¸º0ã€‚</p><p>å‡å¦‚æˆ‘ä»¬é€šè¿‡executeæ–¹æ³•å‘çº¿ç¨‹æ± æäº¤2ä¸ªä»»åŠ¡ï¼Œçœ‹çœ‹ç»“æœå¦‚ä½•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">threadPoolExecutor.execute(() -&gt; sleep(<span class="number">100</span>));</span><br><span class="line">threadPoolExecutor.execute(() -&gt; sleep(<span class="number">100</span>));</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20190701183457.png" alt="QQæˆªå›¾20190701183457.png"></p><p>çº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹æ•°é‡ä¸º1ï¼Œé€šè¿‡executeæäº¤äº†2ä¸ªä»»åŠ¡åï¼Œä¸€å¼€å§‹æ ¸å¿ƒçº¿ç¨‹æ˜¯ç©ºé—²çš„ï¼ŒThread-0è¢«æ‰§è¡Œã€‚ç”±äºè¿™ä¸ªä»»åŠ¡çš„é€»è¾‘æ˜¯ä¼‘çœ 100ç§’ï¼Œæ‰€ä»¥åœ¨è¿™100ç§’å†…ï¼Œçº¿ç¨‹æ± çš„æ´»è·ƒçº¿ç¨‹æ•°é‡ä¸º1ã€‚å› ä¸ºæ ¸å¿ƒçº¿ç¨‹æ•°é‡ä¸º1ï¼Œæ‰€ä»¥å¦å¤–ä¸€ä¸ªä»»åŠ¡åœ¨è¿™100ç§’å†…ä¸èƒ½è¢«æ‰§è¡Œï¼Œäºæ˜¯è¢«æ”¾åˆ°çº¿ç¨‹é˜Ÿåˆ—é‡Œç­‰å¾…ï¼Œçº¿ç¨‹é˜Ÿåˆ—é•¿åº¦ä¸º1ã€‚</p><p>å‡å¦‚æˆ‘ä»¬é€šè¿‡executeæ–¹æ³•å‘çº¿ç¨‹æ± æäº¤3ä¸ªä»»åŠ¡ï¼Œçœ‹çœ‹ç»“æœå¦‚ä½•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">threadPoolExecutor.execute(() -&gt; sleep(<span class="number">100</span>));</span><br><span class="line">threadPoolExecutor.execute(() -&gt; sleep(<span class="number">100</span>));</span><br><span class="line">threadPoolExecutor.execute(() -&gt; sleep(<span class="number">100</span>));</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20190701184303.png" alt="QQæˆªå›¾20190701184303.png"></p><p>è¿™ä¸‰ä¸ªä»»åŠ¡éƒ½æ˜¯ä¼‘çœ 100ç§’ï¼Œæ‰€ä»¥æ ¸å¿ƒçº¿ç¨‹æ± ä¸­ç¬¬ä¸€ä¸ªä»»åŠ¡æ­£åœ¨è¢«æ‰§è¡Œï¼Œç¬¬äºŒä¸ªä»»åŠ¡è¢«æ”¾å…¥åˆ°äº†çº¿ç¨‹é˜Ÿåˆ—ã€‚è€Œå½“ç¬¬ä¸‰ä¸ªä»»åŠ¡è¢«æäº¤è¿›æ¥æ—¶ï¼Œçº¿ç¨‹é˜Ÿåˆ—æ»¡äº†ï¼ˆæˆ‘ä»¬å®šä¹‰çš„é•¿åº¦ä¸º1ï¼‰ï¼Œç”±äºè¯¥çº¿ç¨‹æ± å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°é‡ä¸º2ï¼Œæ‰€ä»¥çº¿ç¨‹æ± è¿˜å¯ä»¥å†åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œå¦å¤–ä¸€ä¸ªä»»åŠ¡ï¼Œäºæ˜¯ä¹ä¹‹å‰åœ¨çº¿ç¨‹é˜Ÿåˆ—é‡Œçš„çº¿ç¨‹è¢«å–å‡ºæ‰§è¡Œï¼ˆFIFOï¼‰ï¼Œç¬¬ä¸‰ä¸ªä»»åŠ¡è¢«æ”¾å…¥åˆ°äº†çº¿ç¨‹é˜Ÿåˆ—ã€‚</p><p>æ”¹å˜ç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªä»»åŠ¡çš„ç¡çœ æ—¶é—´ï¼Œè§‚å¯Ÿè¾“å‡ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">threadPoolExecutor.execute(() -&gt; sleep(<span class="number">100</span>));</span><br><span class="line">threadPoolExecutor.execute(() -&gt; sleep(<span class="number">5</span>));</span><br><span class="line">threadPoolExecutor.execute(() -&gt; sleep(<span class="number">5</span>));</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20190701185215.png" alt="QQæˆªå›¾20190701185215.png"></p><p>ç¬¬äºŒä¸ªä»»åŠ¡æäº¤5ç§’åï¼Œä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œæ‰€ä»¥çº¿ç¨‹é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡è¢«æ‰§è¡Œï¼Œäºæ˜¯é˜Ÿåˆ—çº¿ç¨‹ä¸ªæ•°ä¸º0ï¼Œæ´»è·ƒçº¿ç¨‹æ•°é‡ä¸º2ï¼ˆç¬¬ä¸€ä¸ªå’Œç¬¬ä¸‰ä¸ªä»»åŠ¡ï¼‰ã€‚å†è¿‡5ç§’åï¼Œç¬¬ä¸‰ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œäºæ˜¯æ´»è·ƒçº¿ç¨‹æ•°é‡ä¸º1ï¼ˆç¬¬ä¸€ä¸ª100ç§’è¿˜æ²¡æ‰§è¡Œå®Œæ¯•ï¼‰ã€‚</p><p>åœ¨ç¬¬ä¸‰ä¸ªä»»åŠ¡ç»“æŸçš„ç¬é—´ï¼Œæˆ‘ä»¬è§‚å¯Ÿçº¿ç¨‹å¿«ç…§:</p><p><img src="img/QQæˆªå›¾20190701185617.png" alt="QQæˆªå›¾20190701185617.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œçº¿ç¨‹æ± ä¸­æœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼ŒThread-0åœ¨æ‰§è¡Œç¬¬ä¸€ä¸ªä»»åŠ¡ï¼ˆä¼‘çœ 100ç§’ï¼Œè¿˜æ²¡ç»“æŸï¼‰ï¼ŒThread-1æ‰§è¡Œå®Œç¬¬ä¸‰ä¸ªä»»åŠ¡åå¹¶æ²¡æœ‰é©¬ä¸Šè¢«é”€æ¯ã€‚è¿‡æ®µæ—¶é—´åï¼ˆ10ç§’é’Ÿåï¼‰å†è§‚å¯Ÿçº¿ç¨‹å¿«ç…§:</p><p><img src="img/QQæˆªå›¾20190701190444.png" alt="QQæˆªå›¾20190701190444.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒThread-1è¿™ä¸ªçº¿ç¨‹è¢«é”€æ¯äº†ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨åˆ›å»ºçº¿ç¨‹æ± çš„æ—¶å€™ï¼ŒæŒ‡å®škeepAliveTime ä¸º10ç§’ï¼Œ10ç§’åï¼Œè¶…å‡ºæ ¸å¿ƒçº¿ç¨‹æ± çº¿ç¨‹å¤–çš„é‚£äº›çº¿ç¨‹å°†è¢«é”€æ¯ã€‚</p><p>å‡å¦‚ä¸€æ¬¡æ€§æäº¤4ä¸ªä»»åŠ¡ï¼Œçœ‹çœ‹ä¼šæ€æ ·ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">threadPoolExecutor.execute(() -&gt; sleep(<span class="number">100</span>));</span><br><span class="line">threadPoolExecutor.execute(() -&gt; sleep(<span class="number">100</span>));</span><br><span class="line">threadPoolExecutor.execute(() -&gt; sleep(<span class="number">100</span>));</span><br><span class="line">threadPoolExecutor.execute(() -&gt; sleep(<span class="number">100</span>));</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20190701190808.png" alt="QQæˆªå›¾20190701190808.png"></p><p>å› ä¸ºæˆ‘ä»¬è®¾ç½®çš„æ‹’ç»ç­–ç•¥ä¸ºAbortPolicyï¼Œæ‰€ä»¥æœ€åæäº¤çš„é‚£ä¸ªä»»åŠ¡ç›´æ¥è¢«æ‹’ç»äº†ã€‚æ›´å¤šæ‹’ç»ç­–ç•¥ä¸‹é¢ä¼šä»‹ç»åˆ°ã€‚</p><h2 id="å…³é—­çº¿ç¨‹æ± "><a href="#å…³é—­çº¿ç¨‹æ± " class="headerlink" title="å…³é—­çº¿ç¨‹æ± "></a>å…³é—­çº¿ç¨‹æ± </h2><p>çº¿ç¨‹æ± åŒ…å«ä»¥ä¸‹å‡ ä¸ªçŠ¶æ€ï¼š</p><p><img src="img/QQæˆªå›¾20190702100110.png" alt="QQæˆªå›¾20190702100110.png"></p><p>å½“çº¿ç¨‹æ± ä¸­æ‰€æœ‰ä»»åŠ¡éƒ½å¤„ç†å®Œæ¯•åï¼Œçº¿ç¨‹å¹¶ä¸ä¼šè‡ªå·±å…³é—­ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨<code>shutdown</code>å’Œ<code>shutdownNow</code>æ–¹æ³•æ¥å…³é—­çº¿ç¨‹æ± ã€‚ä¸¤è€…çš„åŒºåˆ«åœ¨äºï¼š</p><ol><li><p><code>shutdown</code>æ–¹æ³•å°†çº¿ç¨‹æ± ç½®ä¸ºshutdownçŠ¶æ€ï¼Œæ‹’ç»æ–°çš„ä»»åŠ¡æäº¤ï¼Œä½†çº¿ç¨‹æ± å¹¶ä¸ä¼šé©¬ä¸Šå…³é—­ï¼Œè€Œæ˜¯ç­‰å¾…æ‰€æœ‰æ­£åœ¨æŠ˜è¡Œçš„å’Œçº¿ç¨‹é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•åï¼Œçº¿ç¨‹æ± æ‰ä¼šè¢«å…³é—­ã€‚æ‰€ä»¥è¿™ä¸ªæ–¹æ³•æ˜¯å¹³æ»‘çš„å…³é—­çº¿ç¨‹æ± ã€‚</p></li><li><p><code>shutdownNow</code>æ–¹æ³•å°†çº¿ç¨‹æ± ç½®ä¸ºstopçŠ¶æ€ï¼Œæ‹’ç»æ–°çš„ä»»åŠ¡æäº¤ï¼Œä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„é‚£äº›ä»»åŠ¡ï¼Œå¹¶ä¸”æ¸…é™¤çº¿ç¨‹é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡å¹¶è¿”å›ã€‚æ‰€ä»¥è¿™ä¸ªæ–¹æ³•æ˜¯æ¯”è¾ƒâ€œæš´åŠ›â€çš„ã€‚</p></li></ol><p>ä¸¾ä¸¤ä¸ªä¾‹å­è§‚å¯Ÿä¸‹ä¸¤è€…çš„åŒºåˆ«ï¼š</p><p><code>shutdown</code>ä¾‹å­:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    ThreadPoolExecutor threadPoolExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">            <span class="number">2</span>, <span class="number">4</span>, <span class="number">10</span>,</span><br><span class="line">            TimeUnit.SECONDS,</span><br><span class="line">            <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">2</span>), (ThreadFactory) Thread::<span class="keyword">new</span>,</span><br><span class="line">            <span class="keyword">new</span> ThreadPoolExecutor.AbortPolicy());</span><br><span class="line"></span><br><span class="line">    threadPoolExecutor.execute(<span class="keyword">new</span> shortTask());</span><br><span class="line">    threadPoolExecutor.execute(<span class="keyword">new</span> longTask());</span><br><span class="line">    threadPoolExecutor.execute(<span class="keyword">new</span> longTask());</span><br><span class="line">    threadPoolExecutor.execute(<span class="keyword">new</span> shortTask());</span><br><span class="line"></span><br><span class="line">    threadPoolExecutor.shutdown();</span><br><span class="line">    System.out.println(<span class="string">"å·²ç»æ‰§è¡Œäº†çº¿ç¨‹æ± shutdownæ–¹æ³•"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">shortTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"æ‰§è¡ŒshortTaskå®Œæ¯•"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">"shortTaskæ‰§è¡Œè¿‡ç¨‹ä¸­è¢«æ‰“æ–­"</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">longTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"æ‰§è¡ŒlongTaskå®Œæ¯•"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">"longTaskæ‰§è¡Œè¿‡ç¨‹ä¸­è¢«æ‰“æ–­"</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨ç¨‹åºï¼Œæ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š</p><p><img src="img/QQæˆªå›¾20190702101041.png" alt="QQæˆªå›¾20190702101041.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶åœ¨ä»»åŠ¡éƒ½è¢«æäº¤åé©¬ä¸Šæ‰§è¡Œäº†<code>shutdown</code>æ–¹æ³•ï¼Œä½†æ˜¯å¹¶ä¸ä¼šé©¬ä¸Šå…³é—­çº¿ç¨‹æ± ï¼Œè€Œæ˜¯ç­‰å¾…æ‰€æœ‰è¢«æäº¤çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œäº†æ‰å…³é—­ã€‚</p><p><code>shutdownNow</code>ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    ThreadPoolExecutor threadPoolExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">            <span class="number">2</span>, <span class="number">4</span>, <span class="number">10</span>,</span><br><span class="line">            TimeUnit.SECONDS,</span><br><span class="line">            <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">2</span>), (ThreadFactory) Thread::<span class="keyword">new</span>,</span><br><span class="line">            <span class="keyword">new</span> ThreadPoolExecutor.AbortPolicy());</span><br><span class="line"></span><br><span class="line">    threadPoolExecutor.execute(<span class="keyword">new</span> shortTask());</span><br><span class="line">    threadPoolExecutor.execute(<span class="keyword">new</span> longTask());</span><br><span class="line">    threadPoolExecutor.execute(<span class="keyword">new</span> longTask());</span><br><span class="line">    threadPoolExecutor.execute(<span class="keyword">new</span> shortTask());</span><br><span class="line"></span><br><span class="line">    List&lt;Runnable&gt; runnables = threadPoolExecutor.shutdownNow(); <span class="comment">// é©¬ä¸Šå…³é—­ï¼Œå¹¶è¿”å›è¿˜æœªè¢«æ‰§è¡Œçš„ä»»åŠ¡</span></span><br><span class="line">    System.out.println(runnables);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">"å·²ç»æ‰§è¡Œäº†çº¿ç¨‹æ± shutdownNowæ–¹æ³•"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">shortTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"æ‰§è¡ŒshortTaskå®Œæ¯•"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">"shortTaskæ‰§è¡Œè¿‡ç¨‹ä¸­è¢«æ‰“æ–­"</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">longTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"æ‰§è¡ŒlongTaskå®Œæ¯•"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">"longTaskæ‰§è¡Œè¿‡ç¨‹ä¸­è¢«æ‰“æ–­"</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨ç¨‹åºï¼Œæ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š <img src="img/QQæˆªå›¾20190702101355.png" alt="QQæˆªå›¾20190702101355.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ‰§è¡Œ<code>shutdownNow</code>æ–¹æ³•åï¼Œçº¿ç¨‹æ± é©¬ä¸Šå°±è¢«å…³é—­äº†ï¼Œæ­£åœ¨æ‰§è¡Œä¸­çš„ä¸¤ä¸ªä»»åŠ¡è¢«æ‰“æ–­ï¼Œå¹¶ä¸”è¿”å›äº†çº¿ç¨‹é˜Ÿåˆ—ä¸­ç­‰å¾…è¢«æ‰§è¡Œçš„ä¸¤ä¸ªä»»åŠ¡ã€‚</p><p>é€šè¿‡ä¸Šé¢ä¸¤ä¸ªä¾‹å­æˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ°<code>shutdown</code>å’Œ<code>shutdownNow</code>æ–¹æ³•éƒ½ä¸æ˜¯é˜»å¡çš„ã€‚å¸¸ä¸<code>shutdown</code>æ­é…çš„æ–¹æ³•æœ‰<code>awaitTermination</code>ã€‚</p><p><code>awaitTermination</code>æ–¹æ³•æ¥æ”¶timeoutå’ŒTimeUnitä¸¤ä¸ªå‚æ•°ï¼Œç”¨äºè®¾å®šè¶…æ—¶æ—¶é—´åŠå•ä½ã€‚å½“ç­‰å¾…è¶…è¿‡è®¾å®šæ—¶é—´æ—¶ï¼Œä¼šç›‘æµ‹ExecutorServiceæ˜¯å¦å·²ç»å…³é—­ï¼Œè‹¥å…³é—­åˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚è¯¥æ–¹æ³•æ˜¯é˜»å¡çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    ThreadPoolExecutor threadPoolExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">            <span class="number">2</span>, <span class="number">4</span>, <span class="number">10</span>,</span><br><span class="line">            TimeUnit.SECONDS,</span><br><span class="line">            <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">2</span>), (ThreadFactory) Thread::<span class="keyword">new</span>,</span><br><span class="line">            <span class="keyword">new</span> ThreadPoolExecutor.AbortPolicy());</span><br><span class="line"></span><br><span class="line">    threadPoolExecutor.execute(<span class="keyword">new</span> shortTask());</span><br><span class="line">    threadPoolExecutor.execute(<span class="keyword">new</span> longTask());</span><br><span class="line">    threadPoolExecutor.execute(<span class="keyword">new</span> longTask());</span><br><span class="line">    threadPoolExecutor.execute(<span class="keyword">new</span> shortTask());</span><br><span class="line"></span><br><span class="line">    threadPoolExecutor.shutdown();</span><br><span class="line">    <span class="keyword">boolean</span> isShutdown = threadPoolExecutor.awaitTermination(<span class="number">3</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">if</span> (isShutdown) &#123;</span><br><span class="line">        System.out.println(<span class="string">"çº¿ç¨‹æ± åœ¨3ç§’å†…æˆåŠŸå…³é—­"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">"ç­‰äº†3ç§’è¿˜æ²¡å…³é—­ï¼Œä¸ç­‰äº†â•°ï¼ˆâ€µâ–¡â€²ï¼‰â•¯"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">"------------"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">shortTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"æ‰§è¡ŒshortTaskå®Œæ¯•"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">"shortTaskæ‰§è¡Œè¿‡ç¨‹ä¸­è¢«æ‰“æ–­"</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">longTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"æ‰§è¡ŒlongTaskå®Œæ¯•"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">"longTaskæ‰§è¡Œè¿‡ç¨‹ä¸­è¢«æ‰“æ–­"</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p><p><img src="img/QQæˆªå›¾20190702102156.png" alt="QQæˆªå›¾20190702102156.png"></p><h2 id="4å¤§æ‹’ç»ç­–ç•¥"><a href="#4å¤§æ‹’ç»ç­–ç•¥" class="headerlink" title="4å¤§æ‹’ç»ç­–ç•¥"></a>4å¤§æ‹’ç»ç­–ç•¥</h2><p>å½“çº¿ç¨‹æ± æ— æ³•å†æ¥æ”¶æ–°çš„ä»»åŠ¡çš„æ—¶å€™ï¼Œå¯é‡‡å–å¦‚ä¸‹å››ç§ç­–ç•¥ï¼š <img src="img/QQæˆªå›¾20190302111014.png" alt="QQæˆªå›¾20190302111014.png"></p><h3 id="CallerRunsPolicy"><a href="#CallerRunsPolicy" class="headerlink" title="CallerRunsPolicy"></a>CallerRunsPolicy</h3><p><code>CallerRunsPolicy</code>ç­–ç•¥ï¼šç”±è°ƒç”¨çº¿ç¨‹å¤„ç†è¯¥ä»»åŠ¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    ThreadPoolExecutor threadPoolExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">            <span class="number">2</span>, <span class="number">3</span>, <span class="number">10</span>,</span><br><span class="line">            TimeUnit.SECONDS,</span><br><span class="line">            <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">1</span>), (ThreadFactory) Thread::<span class="keyword">new</span>,</span><br><span class="line">            <span class="keyword">new</span> ThreadPoolExecutor.CallerRunsPolicy());</span><br><span class="line"></span><br><span class="line">    threadPoolExecutor.execute(<span class="keyword">new</span> shortTask(<span class="string">"ä»»åŠ¡1"</span>));</span><br><span class="line">    threadPoolExecutor.execute(<span class="keyword">new</span> longTask(<span class="string">"ä»»åŠ¡2"</span>));</span><br><span class="line">    threadPoolExecutor.execute(<span class="keyword">new</span> longTask(<span class="string">"ä»»åŠ¡3"</span>));</span><br><span class="line">    threadPoolExecutor.execute(<span class="keyword">new</span> shortTask(<span class="string">"ä»»åŠ¡4"</span>));</span><br><span class="line">    threadPoolExecutor.execute(<span class="keyword">new</span> shortTask(<span class="string">"ä»»åŠ¡5"</span>));</span><br><span class="line"></span><br><span class="line">    threadPoolExecutor.shutdown();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">shortTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">shortTask</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"æ‰§è¡ŒshortTask-name-"</span> + name + <span class="string">"å®Œæ¯•"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">"shortTaskæ‰§è¡Œè¿‡ç¨‹ä¸­è¢«æ‰“æ–­"</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">longTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">longTask</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"æ‰§è¡ŒlongTask-name-"</span> + name + <span class="string">"å®Œæ¯•"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">"longTaskæ‰§è¡Œè¿‡ç¨‹ä¸­è¢«æ‰“æ–­"</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢çš„çº¿ç¨‹æ± æœ€å¤šåªèƒ½ä¸€æ¬¡æ€§æäº¤4ä¸ªä»»åŠ¡ï¼Œç¬¬5ä¸ªä»»åŠ¡æäº¤åä¼šè¢«æ‹’ç»ç­–ç•¥å¤„ç†ã€‚å¯åŠ¨ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p><p><img src="img/QQæˆªå›¾20190702103818.png" alt="QQæˆªå›¾20190702103818.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œç¬¬5ä¸ªæäº¤çš„ä»»åŠ¡ç”±è°ƒç”¨çº¿ç¨‹ï¼ˆå³mainçº¿ç¨‹ï¼‰å¤„ç†è¯¥ä»»åŠ¡ã€‚</p><h3 id="AbortPolicy"><a href="#AbortPolicy" class="headerlink" title="AbortPolicy"></a>AbortPolicy</h3><p><code>AbortPolicy</code>ç­–ç•¥ï¼šä¸¢å¼ƒä»»åŠ¡ï¼Œå¹¶æŠ›å‡º<code>RejectedExecutionException</code>å¼‚å¸¸ã€‚å‰é¢çš„ä¾‹å­å°±æ˜¯ä½¿ç”¨è¯¥ç­–ç•¥ï¼Œæ‰€ä»¥ä¸å†æ¼”ç¤ºã€‚</p><h3 id="DiscardOldestPolicy"><a href="#DiscardOldestPolicy" class="headerlink" title="DiscardOldestPolicy"></a>DiscardOldestPolicy</h3><p><code>DiscardOldestPolicy</code>ç­–ç•¥ï¼šä¸¢å¼ƒæœ€æ—©è¢«æ”¾å…¥åˆ°çº¿ç¨‹é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œå°†æ–°æäº¤çš„ä»»åŠ¡æ”¾å…¥åˆ°çº¿ç¨‹é˜Ÿåˆ—æœ«ç«¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    ThreadPoolExecutor threadPoolExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">            <span class="number">2</span>, <span class="number">3</span>, <span class="number">10</span>,</span><br><span class="line">            TimeUnit.SECONDS,</span><br><span class="line">            <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">1</span>), (ThreadFactory) Thread::<span class="keyword">new</span>,</span><br><span class="line">            <span class="keyword">new</span> ThreadPoolExecutor.DiscardOldestPolicy());</span><br><span class="line"></span><br><span class="line">    threadPoolExecutor.execute(<span class="keyword">new</span> shortTask(<span class="string">"ä»»åŠ¡1"</span>));</span><br><span class="line">    threadPoolExecutor.execute(<span class="keyword">new</span> longTask(<span class="string">"ä»»åŠ¡2"</span>));</span><br><span class="line">    threadPoolExecutor.execute(<span class="keyword">new</span> longTask(<span class="string">"ä»»åŠ¡3"</span>));</span><br><span class="line">    threadPoolExecutor.execute(<span class="keyword">new</span> shortTask(<span class="string">"ä»»åŠ¡4"</span>));</span><br><span class="line">    threadPoolExecutor.execute(<span class="keyword">new</span> shortTask(<span class="string">"ä»»åŠ¡5"</span>));</span><br><span class="line"></span><br><span class="line">    threadPoolExecutor.shutdown();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">shortTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">shortTask</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"æ‰§è¡ŒshortTask-name-"</span> + name + <span class="string">"å®Œæ¯•"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">"shortTaskæ‰§è¡Œè¿‡ç¨‹ä¸­è¢«æ‰“æ–­"</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">longTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">longTask</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"æ‰§è¡ŒlongTask-name-"</span> + name + <span class="string">"å®Œæ¯•"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">"longTaskæ‰§è¡Œè¿‡ç¨‹ä¸­è¢«æ‰“æ–­"</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p><p><img src="img/QQæˆªå›¾20190702105646.png" alt="QQæˆªå›¾20190702105646.png"></p><p>å¯ä»¥çœ‹åˆ°æœ€åæäº¤çš„ä»»åŠ¡è¢«æ‰§è¡Œäº†ï¼Œè€Œç¬¬3ä¸ªä»»åŠ¡æ˜¯ç¬¬ä¸€ä¸ªè¢«æ”¾åˆ°çº¿ç¨‹é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œè¢«ä¸¢å¼ƒäº†ã€‚</p><h3 id="DiscardPolicy"><a href="#DiscardPolicy" class="headerlink" title="DiscardPolicy"></a>DiscardPolicy</h3><p><code>DiscardPolicy</code>ç­–ç•¥ï¼šç›´æ¥ä¸¢å¼ƒæ–°çš„ä»»åŠ¡ï¼Œä¸æŠ›å¼‚å¸¸ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    ThreadPoolExecutor threadPoolExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">            <span class="number">2</span>, <span class="number">3</span>, <span class="number">10</span>,</span><br><span class="line">            TimeUnit.SECONDS,</span><br><span class="line">            <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">1</span>), (ThreadFactory) Thread::<span class="keyword">new</span>,</span><br><span class="line">            <span class="keyword">new</span> ThreadPoolExecutor.DiscardPolicy());</span><br><span class="line"></span><br><span class="line">    threadPoolExecutor.execute(<span class="keyword">new</span> shortTask(<span class="string">"ä»»åŠ¡1"</span>));</span><br><span class="line">    threadPoolExecutor.execute(<span class="keyword">new</span> longTask(<span class="string">"ä»»åŠ¡2"</span>));</span><br><span class="line">    threadPoolExecutor.execute(<span class="keyword">new</span> longTask(<span class="string">"ä»»åŠ¡3"</span>));</span><br><span class="line">    threadPoolExecutor.execute(<span class="keyword">new</span> shortTask(<span class="string">"ä»»åŠ¡4"</span>));</span><br><span class="line">    threadPoolExecutor.execute(<span class="keyword">new</span> shortTask(<span class="string">"ä»»åŠ¡5"</span>));</span><br><span class="line"></span><br><span class="line">    threadPoolExecutor.shutdown();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">shortTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">shortTask</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"æ‰§è¡ŒshortTask-name-"</span> + name + <span class="string">"å®Œæ¯•"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">"shortTaskæ‰§è¡Œè¿‡ç¨‹ä¸­è¢«æ‰“æ–­"</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">longTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">longTask</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"æ‰§è¡ŒlongTask-name-"</span> + name + <span class="string">"å®Œæ¯•"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">"longTaskæ‰§è¡Œè¿‡ç¨‹ä¸­è¢«æ‰“æ–­"</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨ç¨‹åºï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š <img src="img/QQæˆªå›¾20190702110022.png" alt="QQæˆªå›¾20190702110022.png"></p><p>ç¬¬5ä¸ªä»»åŠ¡ç›´æ¥è¢«æ‹’ç»ä¸¢å¼ƒäº†ï¼Œè€Œæ²¡æœ‰æŠ›å‡ºä»»ä½•å¼‚å¸¸ã€‚</p><h2 id="çº¿ç¨‹æ± å·¥å‚æ–¹æ³•"><a href="#çº¿ç¨‹æ± å·¥å‚æ–¹æ³•" class="headerlink" title="çº¿ç¨‹æ± å·¥å‚æ–¹æ³•"></a>çº¿ç¨‹æ± å·¥å‚æ–¹æ³•</h2><p>é™¤äº†ä½¿ç”¨ThreadPoolExecutorçš„æ„é€ æ–¹æ³•åˆ›å»ºçº¿ç¨‹æ± å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨<code>Executors</code>æä¾›çš„å·¥å‚æ–¹æ³•æ¥åˆ›å»ºä¸åŒç±»å‹çš„çº¿ç¨‹æ± ï¼š</p><p><img src="img/QQæˆªå›¾20190702110350.png" alt="QQæˆªå›¾20190702110350.png"></p><h3 id="newFixedThreadPool"><a href="#newFixedThreadPool" class="headerlink" title="newFixedThreadPool"></a>newFixedThreadPool</h3><p>æŸ¥çœ‹<code>newFixedThreadPool</code>æ–¹æ³•æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newFixedThreadPool</span><span class="params">(<span class="keyword">int</span> nThreads)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(nThreads, nThreads,</span><br><span class="line">                                  <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                  <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡<code>newFixedThreadPool</code>åˆ›å»ºçš„æ˜¯ä¸€ä¸ªå›ºå®šå¤§å°çš„çº¿ç¨‹æ± ï¼Œå¤§å°ç”±<code>nThreads</code>å‚æ•°æŒ‡å®šï¼Œå®ƒå…·æœ‰å¦‚ä¸‹å‡ ä¸ªç‰¹ç‚¹:</p><ol><li><p>å› ä¸ºcorePoolSizeå’ŒmaximumPoolSizeçš„å€¼éƒ½ä¸ºnThreadsï¼Œæ‰€ä»¥çº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°é‡æ°¸è¿œç­‰äºnThreadsï¼Œä¸å¯èƒ½æ–°å»ºé™¤äº†æ ¸å¿ƒçº¿ç¨‹æ•°çš„çº¿ç¨‹æ¥å¤„ç†ä»»åŠ¡ï¼Œå³keepAliveTimeå®é™…ä¸Šåœ¨è¿™é‡Œæ˜¯æ— æ•ˆçš„ã€‚</p></li><li><p>LinkedBlockingQueueæ˜¯ä¸€ä¸ªæ— ç•Œé˜Ÿåˆ—ï¼ˆæœ€å¤§é•¿åº¦ä¸ºInteger.MAX_VALUEï¼‰ï¼Œæ‰€ä»¥è¿™ä¸ªçº¿ç¨‹æ± ç†è®ºæ˜¯å¯ä»¥æ— é™çš„æ¥æ”¶æ–°çš„ä»»åŠ¡ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸Šé¢æ²¡æœ‰æŒ‡å®šæ‹’ç»ç­–ç•¥çš„åŸå› ã€‚</p></li></ol><h3 id="newCachedThreadPool"><a href="#newCachedThreadPool" class="headerlink" title="newCachedThreadPool"></a>newCachedThreadPool</h3><p>æŸ¥çœ‹<code>newCachedThreadPool</code>æ–¹æ³•æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newCachedThreadPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">0</span>, Integer.MAX_VALUE,</span><br><span class="line">                                  <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">                                  <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¿™æ˜¯ä¸€ä¸ªç†è®ºä¸Šæ— é™å¤§å°çš„çº¿ç¨‹æ± ï¼š</p><ol><li><p>æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º0ï¼ŒSynchronousQueueé˜Ÿåˆ—æ˜¯æ²¡æœ‰é•¿åº¦çš„é˜Ÿåˆ—ï¼Œæ‰€ä»¥å½“æœ‰æ–°çš„ä»»åŠ¡æäº¤ï¼Œå¦‚æœæœ‰ç©ºé—²çš„è¿˜æœªè¶…æ—¶çš„ï¼ˆæœ€å¤§ç©ºé—²æ—¶é—´60ç§’ï¼‰çº¿ç¨‹åˆ™æ‰§è¡Œè¯¥ä»»åŠ¡ï¼Œå¦åˆ™æ–°å¢ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†è¯¥ä»»åŠ¡ã€‚</p></li><li><p>å› ä¸ºçº¿ç¨‹æ•°é‡æ²¡æœ‰é™åˆ¶ï¼Œç†è®ºä¸Šå¯ä»¥æ¥æ”¶æ— é™ä¸ªæ–°ä»»åŠ¡ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿæ²¡æœ‰æŒ‡å®šæ‹’ç»ç­–ç•¥ã€‚</p></li></ol><h3 id="newSingleThreadExecutor"><a href="#newSingleThreadExecutor" class="headerlink" title="newSingleThreadExecutor"></a>newSingleThreadExecutor</h3><p>æŸ¥çœ‹<code>newSingleThreadExecutor</code>æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newSingleThreadExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> FinalizableDelegatedExecutorService</span><br><span class="line">        (<span class="keyword">new</span> ThreadPoolExecutor(<span class="number">1</span>, <span class="number">1</span>,</span><br><span class="line">                                <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><ol><li><p>æ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°éƒ½ä¸º1ï¼Œæ¯æ¬¡åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¤„ç†ä»»åŠ¡ã€‚</p></li><li><p>LinkedBlockingQueueé˜Ÿåˆ—å¯ä»¥æ¥æ”¶æ— é™ä¸ªæ–°ä»»åŠ¡ã€‚</p></li></ol><h3 id="newScheduledThreadPool"><a href="#newScheduledThreadPool" class="headerlink" title="newScheduledThreadPool"></a>newScheduledThreadPool</h3><p>æŸ¥çœ‹<code>newScheduledThreadPool</code>æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ScheduledExecutorService <span class="title">newScheduledThreadPool</span><span class="params">(<span class="keyword">int</span> corePoolSize)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ScheduledThreadPoolExecutor(corePoolSize);</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ScheduledThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(corePoolSize, Integer.MAX_VALUE, <span class="number">0</span>, NANOSECONDS,</span><br><span class="line">          <span class="keyword">new</span> DelayedWorkQueue());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ‰€ä»¥<code>newScheduledThreadPool</code>ç†è®ºæ˜¯ä¹Ÿæ˜¯å¯ä»¥æ¥æ”¶æ— é™ä¸ªä»»åŠ¡ï¼ŒDelayedWorkQueueä¹Ÿæ˜¯ä¸€ä¸ªæ— ç•Œé˜Ÿåˆ—ã€‚</p><p>ä½¿ç”¨newScheduledThreadPoolåˆ›å»ºçš„çº¿ç¨‹æ± é™¤äº†å¯ä»¥å¤„ç†æ™®é€šçš„Runnableä»»åŠ¡å¤–ï¼Œå®ƒè¿˜å…·æœ‰è°ƒåº¦çš„åŠŸèƒ½ï¼š</p><p>1.å»¶è¿ŸæŒ‡å®šæ—¶é—´åæ‰§è¡Œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ScheduledExecutorService executorService = Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// å»¶è¿Ÿ5ç§’æ‰§è¡Œ</span></span><br><span class="line">executorService.schedule(() -&gt; System.out.println(<span class="string">"hello"</span>), <span class="number">5</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure><p></p><p>2.æŒ‰æŒ‡å®šçš„é€Ÿç‡æ‰§è¡Œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ScheduledExecutorService executorService = Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// å»¶è¿Ÿ1ç§’æ‰§è¡Œï¼Œç„¶åæ¯5ç§’æ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line">executorService.scheduleAtFixedRate(</span><br><span class="line">        () -&gt; System.out.println(LocalTime.now()), <span class="number">1</span>, <span class="number">5</span>, TimeUnit.SECONDS</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20190702152117.png" alt="QQæˆªå›¾20190702152117.png"></p><p>3.æŒ‰æŒ‡å®šçš„æ—¶å»¶æ‰§è¡Œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ScheduledExecutorService executorService = Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line">executorService.scheduleWithFixedDelay(</span><br><span class="line">        () -&gt; System.out.println(LocalTime.now()), <span class="number">1</span>, <span class="number">5</span>, TimeUnit.SECONDS</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20190702152440.png" alt="QQæˆªå›¾20190702152440.png"></p><p>ä¹ä¸€çœ‹ï¼ŒscheduleAtFixedRateå’ŒscheduleWithFixedDelayæ²¡å•¥åŒºåˆ«ï¼Œå®é™…å®ƒä»¬è¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼š</p><ul><li><p>scheduleAtFixedRateæŒ‰ç…§å›ºå®šé€Ÿç‡æ‰§è¡Œä»»åŠ¡ï¼Œæ¯”å¦‚æ¯5ç§’æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œå³ä½¿ä¸Šä¸€ä¸ªä»»åŠ¡æ²¡æœ‰ç»“æŸï¼Œ5ç§’åä¹Ÿä¼šå¼€å§‹å¤„ç†æ–°çš„ä»»åŠ¡ï¼›</p></li><li><p>scheduleWithFixedDelayæŒ‰ç…§å›ºå®šçš„æ—¶å»¶å¤„ç†ä»»åŠ¡ï¼Œæ¯”å¦‚æ¯å»¶è¿Ÿ5ç§’æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œæ— è®ºä¸Šä¸€ä¸ªä»»åŠ¡å¤„ç†äº†1ç§’ï¼Œ1åˆ†é’Ÿè¿˜æ˜¯1å°æ—¶ï¼Œä¸‹ä¸€ä¸ªä»»åŠ¡æ€»æ˜¯åœ¨ä¸Šä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•å5ç§’é’Ÿåå¼€å§‹æ‰§è¡Œã€‚</p></li></ul><p>å¯¹äºè¿™äº›çº¿ç¨‹æ± å·¥å‚æ–¹æ³•çš„ä½¿ç”¨ï¼Œé˜¿é‡Œå·´å·´ç¼–ç¨‹è§„ç¨‹æŒ‡å‡ºï¼š</p><p><img src="img/QQæˆªå›¾20190702153306.png" alt="QQæˆªå›¾20190702153306.png"></p><p>å› ä¸ºè¿™å‡ ä¸ªçº¿ç¨‹æ± ç†è®ºæ˜¯éƒ½å¯ä»¥æ¥æ”¶æ— é™ä¸ªä»»åŠ¡ï¼Œæ‰€ä»¥è¿™å°±æœ‰å†…å­˜æº¢å‡ºçš„é£é™©ã€‚å®é™…ä¸Šåªè¦æˆ‘ä»¬æŒæ¡äº†ThreadPoolExecutoræ„é€ å‡½æ•°7ä¸ªå‚æ•°çš„å«ä¹‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ ¹æ®ä¸åŒçš„ä¸šåŠ¡æ¥åˆ›å»ºå‡ºç¬¦åˆéœ€æ±‚çš„çº¿ç¨‹æ± ã€‚ä¸€èˆ¬çº¿ç¨‹æ± çš„åˆ›å»ºå¯ä»¥å‚è€ƒå¦‚ä¸‹è§„åˆ™ï¼š</p><ul><li><p>IOå¯†é›†å‹ä»»åŠ¡ï¼Œçº¿ç¨‹æ± çº¿ç¨‹æ•°é‡å¯ä»¥è®¾ç½®ä¸º2 X CPUæ ¸å¿ƒæ•°ï¼›</p></li><li><p>è®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼Œçº¿ç¨‹æ± çº¿ç¨‹æ•°é‡å¯ä»¥è®¾ç½®ä¸ºCPUæ ¸å¿ƒæ•° + 1ã€‚</p></li></ul><h2 id="ä¸€äº›APIçš„ç”¨æ³•"><a href="#ä¸€äº›APIçš„ç”¨æ³•" class="headerlink" title="ä¸€äº›APIçš„ç”¨æ³•"></a>ä¸€äº›APIçš„ç”¨æ³•</h2><p>ThreadPoolExecutoræä¾›äº†å‡ ä¸ªåˆ¤æ–­çº¿ç¨‹æ± çŠ¶æ€çš„æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    ThreadPoolExecutor threadPoolExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">            <span class="number">1</span>, <span class="number">2</span>, <span class="number">5</span>, TimeUnit.SECONDS,</span><br><span class="line">            <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">1</span>), (ThreadFactory) Thread::<span class="keyword">new</span>,</span><br><span class="line">            <span class="keyword">new</span> ThreadPoolExecutor.AbortPolicy()</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    threadPoolExecutor.execute(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    threadPoolExecutor.shutdown();</span><br><span class="line">    System.out.println(<span class="string">"çº¿ç¨‹æ± ä¸ºshutdownçŠ¶æ€ï¼š"</span> + threadPoolExecutor.isShutdown());</span><br><span class="line">    System.out.println(<span class="string">"çº¿ç¨‹æ± æ­£åœ¨å…³é—­ï¼š"</span> + threadPoolExecutor.isTerminating());</span><br><span class="line">    System.out.println(<span class="string">"çº¿ç¨‹æ± å·²ç»å…³é—­ï¼š"</span> + threadPoolExecutor.isTerminated());</span><br><span class="line">    threadPoolExecutor.awaitTermination(<span class="number">6</span>, TimeUnit.SECONDS);</span><br><span class="line">    System.out.println(<span class="string">"çº¿ç¨‹æ± å·²ç»å…³é—­"</span> + threadPoolExecutor.isTerminated());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p><p><img src="img/20190703205843.png" alt="20190703205843.png"></p><p>å‰é¢æˆ‘ä»¬æåˆ°ï¼Œçº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹å³ä½¿æ˜¯ç©ºé—²çŠ¶æ€ä¹Ÿä¸ä¼šè¢«é”€æ¯ï¼Œé™¤éä½¿ç”¨<code>allowCoreThreadTimeOut</code>è®¾ç½®äº†å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">       ThreadPoolExecutor threadPoolExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">               <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, TimeUnit.SECONDS,</span><br><span class="line">               <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">1</span>), (ThreadFactory) Thread::<span class="keyword">new</span>,</span><br><span class="line">               <span class="keyword">new</span> ThreadPoolExecutor.AbortPolicy()</span><br><span class="line">       );</span><br><span class="line">       threadPoolExecutor.allowCoreThreadTimeOut(<span class="keyword">true</span>);</span><br><span class="line">       threadPoolExecutor.execute(() -&gt; &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">               System.out.println(<span class="string">"ä»»åŠ¡æ‰§è¡Œå®Œæ¯•"</span>);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">               e.printStackTrace();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/asdfasdfaaaaa.gif" alt="asdfasdfaaaaa.gif"></p><p>5ç§’åä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œæ ¸å¿ƒçº¿ç¨‹å¤„äºç©ºé—²çš„çŠ¶æ€ã€‚å› ä¸ºé€šè¿‡<code>allowCoreThreadTimeOut</code>æ–¹æ³•è®¾ç½®äº†å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶ï¼Œæ‰€ä»¥3ç§’åï¼ˆkeepAliveTimeè®¾ç½®ä¸º3ç§’ï¼‰ï¼Œæ ¸å¿ƒçº¿ç¨‹è¢«é”€æ¯ã€‚æ ¸å¿ƒçº¿ç¨‹è¢«é”€æ¯åï¼Œçº¿ç¨‹æ± ä¹Ÿå°±æ²¡æœ‰ä½œç”¨äº†ï¼Œäºæ˜¯å°±è‡ªåŠ¨å…³é—­äº†ã€‚</p><div class="note danger"><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹æ± è°ƒç”¨äº†<code>allowCoreThreadTimeOut(true)</code>æ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒçš„<code>keepAliveTime</code>ä¸èƒ½ä¸º0ã€‚</p></div><p>ThreadPoolExecutoræä¾›äº†ä¸€<code>remove</code>æ–¹æ³•ï¼ŒæŸ¥çœ‹å…¶æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Runnable task)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> removed = workQueue.remove(task);</span><br><span class="line">    tryTerminate(); <span class="comment">// In case SHUTDOWN and now empty</span></span><br><span class="line">    <span class="keyword">return</span> removed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯çœ‹åˆ°ï¼Œå®ƒåˆ é™¤çš„æ˜¯çº¿ç¨‹é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œè€Œéæ­£åœ¨è¢«æ‰§è¡Œçš„ä»»åŠ¡ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    ThreadPoolExecutor threadPoolExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">            <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, TimeUnit.SECONDS,</span><br><span class="line">            <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">1</span>), (ThreadFactory) Thread::<span class="keyword">new</span>,</span><br><span class="line">            <span class="keyword">new</span> ThreadPoolExecutor.AbortPolicy()</span><br><span class="line">    );</span><br><span class="line">    threadPoolExecutor.execute(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">            System.out.println(<span class="string">"ä»»åŠ¡æ‰§è¡Œå®Œæ¯•"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    Runnable r = () -&gt; System.out.println(<span class="string">"çœ‹çœ‹æˆ‘æ˜¯å¦ä¼šè¢«åˆ é™¤"</span>);</span><br><span class="line">    threadPoolExecutor.execute(r);</span><br><span class="line">    threadPoolExecutor.remove(r);</span><br><span class="line"></span><br><span class="line">    threadPoolExecutor.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ‰§è¡Œç¨‹åºï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p><p><img src="img/QQæˆªå›¾20190703211746.png" alt="QQæˆªå›¾20190703211746.png"></p><p>å¯çœ‹åˆ°ä»»åŠ¡å¹¶æ²¡æœ‰è¢«æ‰§è¡Œï¼Œå·²ç»è¢«åˆ é™¤ï¼Œå› ä¸ºå”¯ä¸€ä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹å·²ç»åœ¨æ‰§è¡Œä»»åŠ¡äº†ï¼Œæ‰€ä»¥åæäº¤çš„è¿™ä¸ªä»»åŠ¡è¢«æ”¾åˆ°äº†çº¿ç¨‹é˜Ÿåˆ—é‡Œï¼Œç„¶åé€šè¿‡removeæ–¹æ³•åˆ é™¤ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰å½“å¾€çº¿ç¨‹æ± é‡Œæäº¤äº†ä»»åŠ¡åï¼Œçº¿ç¨‹æ± æ‰ä¼šå¯åŠ¨æ ¸å¿ƒçº¿ç¨‹å¤„ç†ä»»åŠ¡ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨<code>prestartCoreThread</code>æ–¹æ³•ï¼Œè®©æ ¸å¿ƒçº¿ç¨‹å³ä½¿æ²¡æœ‰ä»»åŠ¡æäº¤ï¼Œä¹Ÿå¤„äºç­‰å¾…æ‰§è¡Œä»»åŠ¡çš„æ´»è·ƒçŠ¶æ€ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    ThreadPoolExecutor threadPoolExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">            <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, TimeUnit.SECONDS,</span><br><span class="line">            <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">1</span>), (ThreadFactory) Thread::<span class="keyword">new</span>,</span><br><span class="line">            <span class="keyword">new</span> ThreadPoolExecutor.AbortPolicy()</span><br><span class="line">    );</span><br><span class="line">    System.out.println(<span class="string">"æ´»è·ƒçº¿ç¨‹æ•°: "</span> + threadPoolExecutor.getActiveCount());</span><br><span class="line">    threadPoolExecutor.prestartCoreThread();</span><br><span class="line">    System.out.println(<span class="string">"æ´»è·ƒçº¿ç¨‹æ•°: "</span> + threadPoolExecutor.getActiveCount());</span><br><span class="line">    threadPoolExecutor.prestartCoreThread();</span><br><span class="line">    System.out.println(<span class="string">"æ´»è·ƒçº¿ç¨‹æ•°: "</span> + threadPoolExecutor.getActiveCount());</span><br><span class="line">    threadPoolExecutor.prestartCoreThread();</span><br><span class="line">    System.out.println(<span class="string">"æ´»è·ƒçº¿ç¨‹æ•°: "</span> + threadPoolExecutor.getActiveCount());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20190703213145.png" alt="QQæˆªå›¾20190703213145.png"></p><p>è¯¥æ–¹æ³•è¿”å›booleanç±»å‹å€¼ï¼Œå¦‚æœæ‰€ä»¥æ ¸å¿ƒçº¿ç¨‹éƒ½å¯åŠ¨äº†ï¼Œè¿”å›falseï¼Œåä¹‹è¿”å›trueã€‚</p><p>è¿˜æœ‰ä¸€ä¸ªå’Œå®ƒç±»ä¼¼çš„<code>prestartAllCoreThreads</code>æ–¹æ³•ï¼Œå®ƒçš„ä½œç”¨æ˜¯ä¸€æ¬¡æ€§å¯åŠ¨æ‰€æœ‰æ ¸å¿ƒçº¿ç¨‹ï¼Œè®©å…¶å¤„äºæ´»è·ƒåœ°ç­‰å¾…æ‰§è¡Œä»»åŠ¡çš„çŠ¶æ€ã€‚</p><p>ThreadPoolExecutorçš„invokeAnyæ–¹æ³•ç”¨äºéšæœºæ‰§è¡Œä»»åŠ¡é›†åˆä¸­çš„æŸä¸ªä»»åŠ¡ï¼Œå¹¶è¿”å›æ‰§è¡Œç»“æœï¼Œè¯¥æ–¹æ³•æ˜¯åŒæ­¥æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, ExecutionException </span>&#123;</span><br><span class="line">    ThreadPoolExecutor threadPoolExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">            <span class="number">2</span>, <span class="number">5</span>, <span class="number">3</span>, TimeUnit.SECONDS,</span><br><span class="line">            <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">1</span>), (ThreadFactory) Thread::<span class="keyword">new</span>,</span><br><span class="line">            <span class="keyword">new</span> ThreadPoolExecutor.AbortPolicy()</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»»åŠ¡é›†åˆ</span></span><br><span class="line">    List&lt;Callable&lt;Integer&gt;&gt; tasks = IntStream.range(<span class="number">0</span>, <span class="number">4</span>).boxed().map(i -&gt; (Callable&lt;Integer&gt;) () -&gt; &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(ThreadLocalRandom.current().nextInt(<span class="number">5</span>));</span><br><span class="line">        <span class="keyword">return</span> i;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">// éšæœºæ‰§è¡Œç»“æœ</span></span><br><span class="line">    Integer result = threadPoolExecutor.invokeAny(tasks);</span><br><span class="line">    System.out.println(<span class="string">"-------------------"</span>);</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    threadPoolExecutor.shutdownNow();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨ç¨‹åºï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p><p><img src="img/QQæˆªå›¾20190704091530.png" alt="QQæˆªå›¾20190704091530.png"></p><p>ThreadPoolExecutorçš„invokeAllåˆ™æ˜¯æ‰§è¡Œä»»åŠ¡é›†åˆä¸­çš„æ‰€æœ‰ä»»åŠ¡ï¼Œè¿”å›Futureé›†åˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, ExecutionException </span>&#123;</span><br><span class="line">    ThreadPoolExecutor threadPoolExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">            <span class="number">2</span>, <span class="number">5</span>, <span class="number">3</span>, TimeUnit.SECONDS,</span><br><span class="line">            <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">1</span>), (ThreadFactory) Thread::<span class="keyword">new</span>,</span><br><span class="line">            <span class="keyword">new</span> ThreadPoolExecutor.AbortPolicy()</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    List&lt;Callable&lt;Integer&gt;&gt; tasks = IntStream.range(<span class="number">0</span>, <span class="number">4</span>).boxed().map(i -&gt; (Callable&lt;Integer&gt;) () -&gt; &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(ThreadLocalRandom.current().nextInt(<span class="number">5</span>));</span><br><span class="line">        <span class="keyword">return</span> i;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    List&lt;Future&lt;Integer&gt;&gt; futureList = threadPoolExecutor.invokeAll(tasks);</span><br><span class="line">    futureList.stream().map(f-&gt;&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> f.get();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">    threadPoolExecutor.shutdownNow();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºå¦‚ä¸‹ï¼š <img src="img/QQæˆªå›¾20190704091836.png" alt="QQæˆªå›¾20190704091836.png"></p><p>æ€»ç»“ä¸‹è¿™äº›æ–¹æ³•ï¼š</p><table><tr><th>æ–¹æ³•</th><th>æè¿°</th></tr><tr><td>allowCoreThreadTimeOut(boolean value)</td><td>æ˜¯å¦å…è®¸æ ¸å¿ƒçº¿ç¨‹ç©ºé—²åè¶…æ—¶ï¼Œæ˜¯çš„è¯è¶…æ—¶åæ ¸å¿ƒçº¿ç¨‹å°†é”€æ¯ï¼Œçº¿ç¨‹æ± è‡ªåŠ¨å…³é—­</td></tr><tr><td>awaitTermination(long timeout, TimeUnit unit)</td><td>é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç­‰å¾…çº¿ç¨‹æ± å…³é—­ï¼Œtimeoutç”¨äºæŒ‡å®šç­‰å¾…æ—¶é—´ã€‚</td></tr><tr><td>execute(Runnable command)</td><td>å‘çº¿ç¨‹æ± æäº¤ä»»åŠ¡ï¼Œæ²¡æœ‰è¿”å›å€¼</td></tr><tr><td>submit(Runnable task)</td><td>å‘çº¿ç¨‹æ± æäº¤ä»»åŠ¡ï¼Œè¿”å›Future</td></tr><tr><td>isShutdown()</td><td>åˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦ä¸ºshutdownçŠ¶æ€</td></tr><tr><td>isTerminating()</td><td>åˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦æ­£åœ¨å…³é—­</td></tr><tr><td>isTerminated()</td><td>åˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦å·²ç»å…³é—­</td></tr><tr><td>remove(Runnable task)</td><td>ç§»é™¤çº¿ç¨‹é˜Ÿåˆ—ä¸­çš„æŒ‡å®šä»»åŠ¡</td></tr><tr><td>prestartCoreThread()</td><td>æå‰è®©ä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹å¤„äºæ´»è·ƒçŠ¶æ€ï¼Œç­‰å¾…æ‰§è¡Œä»»åŠ¡</td></tr><tr><td>prestartAllCoreThreads()</td><td>æå‰è®©æ‰€æœ‰æ ¸å¿ƒçº¿ç¨‹å¤„äºæ´»è·ƒçŠ¶æ€ï¼Œç­‰å¾…æ‰§è¡Œä»»åŠ¡</td></tr><tr><td>getActiveCount()</td><td>è·å–çº¿ç¨‹æ± æ´»è·ƒçº¿ç¨‹æ•°</td></tr><tr><td>getCorePoolSize()</td><td>è·å–çº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹æ•°</td></tr><tr><td>threadPoolExecutor.getQueue()</td><td>è·å–çº¿ç¨‹æ± çº¿ç¨‹é˜Ÿåˆ—</td></tr><tr><td>getMaximumPoolSize()</td><td>è·å–çº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•°</td></tr><tr><td>shutdown()</td><td>è®©çº¿ç¨‹æ± å¤„äºshutdownçŠ¶æ€ï¼Œä¸å†æ¥æ”¶ä»»åŠ¡ï¼Œç­‰å¾…æ‰€æœ‰æ­£åœ¨è¿è¡Œä¸­çš„ä»»åŠ¡ç»“æŸåï¼Œå…³é—­çº¿ç¨‹æ± ã€‚</td></tr><tr><td>shutdownNow()</td><td>è®©çº¿ç¨‹æ± å¤„äºstopçŠ¶æ€ï¼Œä¸å†æ¥å—ä»»åŠ¡ï¼Œå°è¯•æ‰“æ–­æ­£åœ¨è¿è¡Œä¸­çš„ä»»åŠ¡ï¼Œå¹¶å…³é—­çº¿ç¨‹æ± ï¼Œè¿”å›çº¿ç¨‹é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚</td></tr></table><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;åœ¨å‰é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬éƒ½æ˜¯é€šè¿‡&lt;code&gt;new Thread&lt;/code&gt;æ¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œç”±äºçº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯éƒ½éœ€è¦æ¶ˆè€—ä¸€å®šçš„CPUèµ„æºï¼Œæ‰€ä»¥åœ¨é«˜å¹¶å‘ä¸‹è¿™ç§åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼å°†ä¸¥é‡å½±å“ä»£ç æ‰§è¡Œæ•ˆç‡ã€‚è€Œçº¿ç¨‹æ± çš„ä½œç”¨å°±æ˜¯è®©ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œç»“æŸåä¸é©¬ä¸Šé”€æ¯ï¼Œç»§ç»­æ‰§è¡Œæ–°çš„ä»»åŠ¡ï¼Œè¿™æ ·å°±èŠ‚çœäº†ä¸æ–­åˆ›å»ºçº¿ç¨‹å’Œé”€æ¯çº¿ç¨‹çš„å¼€é”€ã€‚
    
    </summary>
    
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Java Concurrency Lock</title>
    <link href="http://mrbird.cc/Java-Concurrency-Lock.html"/>
    <id>http://mrbird.cc/Java-Concurrency-Lock.html</id>
    <published>2019-03-16T01:37:15.000Z</published>
    <updated>2019-10-28T12:14:46.239Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --><p>Locké”æ˜¯ç”¨æ¥æ§åˆ¶å¤šä¸ªçº¿ç¨‹è®¿é—®å…±äº«èµ„æºçš„æ–¹å¼ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªé”èƒ½å¤Ÿé˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å…±äº«èµ„æºï¼ˆä½†æ˜¯æœ‰äº›é”å¯ä»¥å…è®¸å¤šä¸ªçº¿ç¨‹å¹¶å‘çš„è®¿é—®å…±äº«èµ„æºï¼Œæ¯”å¦‚è¯»å†™é”ï¼‰ã€‚åœ¨Lockæ¥å£å‡ºç°ä¹‹å‰ï¼ŒJavaç¨‹åºæ˜¯é synchronizedå…³é”®å­—å®ç°é”åŠŸèƒ½çš„ï¼Œè€ŒJava SE 5ä¹‹åï¼Œå¹¶å‘åŒ…ä¸­æ–°å¢äº†Lockæ¥å£ï¼ˆä»¥åŠç›¸å…³å®ç°ç±»ï¼‰ç”¨æ¥å®ç°é”åŠŸèƒ½ï¼Œå®ƒæä¾›äº†ä¸synchronizedå…³é”®å­—ç±»ä¼¼çš„åŒæ­¥åŠŸèƒ½ï¼Œåªæ˜¯åœ¨ä½¿ç”¨æ—¶éœ€è¦æ˜¾å¼åœ°è·å–å’Œé‡Šæ”¾é”ã€‚è™½ç„¶å®ƒç¼ºå°‘äº†ï¼ˆé€šè¿‡synchronizedå—æˆ–è€…æ–¹æ³•æ‰€æä¾›çš„ï¼‰éšå¼è·å–é‡Šæ”¾é”çš„ä¾¿æ·æ€§ï¼Œä½†æ˜¯å´æ‹¥æœ‰äº†é”è·å–ä¸é‡Šæ”¾çš„å¯æ“ä½œæ€§ã€å¯ä¸­æ–­çš„è·å–é”ä»¥åŠè¶…æ—¶è·å–é”ç­‰å¤šç§synchronizedå…³é”®å­—æ‰€ä¸å…·å¤‡çš„åŒæ­¥ç‰¹æ€§ã€‚</p><a id="more"></a><h2 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h2><p>ReentrantLockå­—é¢ä¸Šæ„æ€å°±æ˜¯å¯é‡å…¥é”ï¼Œè¡¨ç¤ºè¯¥é”èƒ½å¤Ÿæ”¯æŒä¸€ä¸ªçº¿ç¨‹å¯¹èµ„æºçš„é‡å¤åŠ é”ã€‚å®šä¹‰ä¸€ä¸ªReentrantLockï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br></pre></td></tr></table></figure><p></p><p>é»˜è®¤æ— å‚æ„é€ å‡½æ•°åˆ›å»ºçš„æ˜¯éå…¬å¹³é”ï¼Œæ„é€ å‡½æ•°é‡è½½æ–¹æ³•<code>ReentrantLock(boolean fair)</code>æ”¯æŒä¼ å…¥<code>true</code>åˆ›å»ºå…¬å¹³é”ã€‚å…¬å¹³é”çš„æ„æ€æ˜¯å¤šçº¿ç¨‹åœ¨è·å–é”çš„æ—¶å€™æ˜¯å…¬å¹³çš„ï¼Œä¹Ÿå°±æ˜¯ç­‰å¾…æ—¶é—´æœ€é•¿çš„çº¿ç¨‹æœ€ä¼˜å…ˆè·å–é”ï¼Œç±»ä¼¼FIFOã€‚</p><p>ä½¿ç”¨ReentrantLockå¯ä»¥å®ç°å’Œsynchronizedä¸€æ ·çš„åŠŸèƒ½ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReentrantLockTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        IntStream.range(<span class="number">0</span>, <span class="number">2</span>).forEach(i -&gt; <span class="keyword">new</span> Thread(ReentrantLockTest::needLock).start());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">needLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"å¼€å§‹å·¥ä½œ"</span>);</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><div class="note danger"><p>ç¡®ä¿åœ¨finallyé‡Œé‡Šæ”¾é”ï¼Œå¦åˆ™å®¹æ˜“é€ æˆæ­»é”ã€‚</p></div><p>ä¸Šé¢ä¾‹å­åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è·å¾—é”<code>lock</code>ï¼Œåˆ«çš„çº¿ç¨‹å¿…é¡»ç­‰å¾…é”è¢«é‡Šæ”¾ï¼ˆ<code>unlock</code>ï¼‰æ‰èƒ½å¼€å§‹ç«äº‰è·å–é”ã€‚ç¨‹åºè¿è¡Œç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/fasdfasdf.gif" alt="sdfsdaaa.gif"></p><p><code>needLock</code>æ–¹æ³•å’Œä¸‹é¢é€šè¿‡synchronizedå…³é”®å­—å®ç°é”æ–¹æ³•æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">needLockBySync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (ReentrantLockTest.class) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"å¼€å§‹å·¥ä½œ"</span>);</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>lock</code>æ–¹æ³•æ˜¯ä¸å¯è¢«æ‰“æ–­çš„ï¼Œå³è°ƒç”¨çº¿ç¨‹çš„<code>interrupt</code>æ–¹æ³•ä¸èµ·ä½œç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReentrantLockTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread thread1 = <span class="keyword">new</span> Thread(ReentrantLockTest::testLockUnInterruptibly);</span><br><span class="line">        thread1.start();</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Thread thread2 = <span class="keyword">new</span> Thread(ReentrantLockTest::testLockUnInterruptibly);</span><br><span class="line">        thread2.start();</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        thread2.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testLockUnInterruptibly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock(); <span class="comment">// ä¸å¯ä»¥è¢«æ‰“æ–­</span></span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"å¼€å§‹å·¥ä½œ"</span>);</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123; &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¿è¡Œç»“æœ:</p><p><img src="img/QQæˆªå›¾20190517140102.png" alt="QQæˆªå›¾20190517140102.png"></p><p><img src="img/QQæˆªå›¾20190517140138.png" alt="QQæˆªå›¾20190517140138.png"></p><p>thread2(Thread-1)ä¾æ—§åœ¨ç»§ç»­ç­‰å¾…è·å–é”ï¼Œæ²¡æœ‰è¢«æ‰“æ–­ã€‚</p><p>ReentrantLockæä¾›äº†å¯æ‰“æ–­è·å–é”çš„æ–¹æ³•<code>lockInterruptibly</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReentrantLockTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread thread1 = <span class="keyword">new</span> Thread(ReentrantLockTest::testLockInterruptibly);</span><br><span class="line">        thread1.start();</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Thread thread2 = <span class="keyword">new</span> Thread(ReentrantLockTest::testLockInterruptibly);</span><br><span class="line">        thread2.start();</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        thread2.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testLockInterruptibly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lockInterruptibly(); <span class="comment">// å¯ä»¥è¢«æ‰“æ–­</span></span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"å¼€å§‹å·¥ä½œ"</span>);</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123; &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><img src="img/sfasdfasfdasdfa.png" alt="QQæˆªå›¾20190517140645.png"></p><p>thread2åœ¨ç­‰å¾…è·å–é”æ—¶è¢«æ‰“æ–­ï¼ŒæŠ›å‡º<code>InterruptedException</code>å¼‚å¸¸ã€‚</p><p>ReentrantLockçš„<code>tryLock</code>æ–¹æ³•ç”¨äºå°è¯•è·å–é”ï¼Œè¿”å›booleanç±»å‹ï¼Œè¡¨ç¤ºè·å–é”æˆåŠŸä¸å¦ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReentrantLockTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread thread1 = <span class="keyword">new</span> Thread(ReentrantLockTest::testTryLock, <span class="string">"thread1"</span>);</span><br><span class="line">        thread1.start();</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Thread thread2 = <span class="keyword">new</span> Thread(ReentrantLockTest::testTryLock, <span class="string">"thread2"</span>);</span><br><span class="line">        thread2.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testTryLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (lock.tryLock()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">"å¼€å§‹å·¥ä½œ"</span>);</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123; &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"æ²¡æœ‰è·å–åˆ°é”"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20190517142035.png" alt="QQæˆªå›¾20190517142035.png"></p><p>thread1æŠ¢åˆ°é”åè¿›å…¥æ­»å¾ªç¯ï¼Œä¸€ç›´ä¸é‡Šæ”¾é”ã€‚thread2å°è¯•è·å–é”å¤±è´¥åç›´æ¥æ”¾å¼ƒã€‚</p><p><code>tryLock</code>çš„é‡è½½æ–¹æ³•<code>tryLock(long timeout, TimeUnit unit)</code>å¯ä»¥è®¾ç½®å°è¯•è·å–é”çš„æ—¶é—´èŒƒå›´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´æ²¡æœ‰è·å–åˆ°é”åˆ™è¿”å›falseã€‚</p><p>ReentrantLockä¸€äº›åˆ«çš„æ–¹æ³•ï¼š</p><table><tr><th>æ–¹æ³•</th><th>å«ä¹‰</th></tr><tr><td><code>getQueueLength()</code></td><td>ç­‰å¾…è·å–é”çº¿ç¨‹æ•°é‡</td></tr><tr><td><code>hasQueuedThreads()</code></td><td>æ˜¯å¦æœ‰åœ¨ç­‰å¾…è·å–é”çš„çº¿ç¨‹</td></tr><tr><td><code>hasQueuedThread(Thread thread)</code></td><td>ç­‰å¾…è·å–é”çš„çº¿ç¨‹é˜Ÿåˆ—é‡Œæ˜¯åŒ…å«æŒ‡å®šçš„çº¿ç¨‹</td></tr><tr><td><code>isLocked</code></td><td>å½“å‰é”æ˜¯å¦è¢«ä»»æ„ä¸€ä¸ªçº¿ç¨‹è·å–åˆ°äº†</td></tr></table><h2 id="ReadWriteLock"><a href="#ReadWriteLock" class="headerlink" title="ReadWriteLock"></a>ReadWriteLock</h2><p>ReadWriteLockä¸ºè¯»å†™é”ã€‚ReentrantLockä¸ºæ’ä»–é”ï¼ŒåŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œè®¿é—®ï¼Œè€Œè¯»å†™é”åœ¨åŒä¸€æ—¶åˆ»å¯ä»¥å…è®¸å¤šä¸ªè¯»çº¿ç¨‹è®¿é—®ï¼Œä½†æ˜¯åœ¨å†™çº¿ç¨‹è®¿é—®æ—¶ï¼Œæ‰€æœ‰çš„è¯»çº¿ç¨‹å’Œå…¶ä»–å†™çº¿ç¨‹å‡è¢«é˜»å¡ã€‚è¯»å†™é”ç»´æŠ¤äº†ä¸€å¯¹é”ï¼Œä¸€ä¸ªè¯»é”å’Œä¸€ä¸ªå†™é”ï¼Œé€šè¿‡åˆ†ç¦»è¯»é”å’Œå†™é”ï¼Œä½¿å¾—å¹¶å‘æ€§ç›¸æ¯”ä¸€èˆ¬çš„æ’ä»–é”æœ‰äº†å¾ˆå¤§æå‡ã€‚</p><p>ç®€è€Œè¨€ä¹‹ï¼ŒReadWriteLockåŒ…å«è¯»å†™é”ï¼Œéµå¾ªä»¥ä¸‹è§„åˆ™ï¼š</p><ul><li><p>å†™çš„æ—¶å€™ä¸èƒ½è¯»</p></li><li><p>å†™çš„æ—¶å€™ä¸èƒ½å†™</p></li><li><p>è¯»çš„æ—¶å€™ä¸èƒ½å†™</p></li><li><p>è¯»çš„æ—¶å€™å¯ä»¥è¯»</p></li></ul><p>ReadWriteLockä¸ºæ¥å£ï¼Œæˆ‘ä»¬ä½¿ç”¨å®ƒçš„å®ç°ç±»ReentrantReadWriteLockåˆ›å»ºè¯»å†™é”å®ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ReentrantReadWriteLock lock = <span class="keyword">new</span> ReentrantReadWriteLock(<span class="keyword">true</span>);</span><br><span class="line">ReentrantReadWriteLock.ReadLock readLock = lock.readLock();</span><br><span class="line">ReentrantReadWriteLock.WriteLock writeLock = lock.writeLock();</span><br></pre></td></tr></table></figure><p></p><p>ä½¿ç”¨è¯»å†™é”åˆ›å»ºä¸€ä¸ªè¯»å†™çš„ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadWriteLockTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ReentrantReadWriteLock lock = <span class="keyword">new</span> ReentrantReadWriteLock(<span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// è¯»é”</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ReentrantReadWriteLock.ReadLock readLock = lock.readLock();</span><br><span class="line">    <span class="comment">// å†™é”</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ReentrantReadWriteLock.WriteLock writeLock = lock.writeLock();</span><br><span class="line">    <span class="comment">// å­˜æ”¾æ•°æ®</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Long&gt; data = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                write();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"writer"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                read();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"reader"</span>).start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            writeLock.lock(); <span class="comment">// å†™é”</span></span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">long</span> value = System.currentTimeMillis();</span><br><span class="line">            data.add(value);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" å†™å…¥value: "</span> + value);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            writeLock.unlock(); <span class="comment">// é‡Šæ”¾å†™é”</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            readLock.lock(); <span class="comment">// è·å–è¯»é”</span></span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            String value = data.stream().map(String::valueOf).collect(Collectors.joining(<span class="string">","</span>));</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"è¯»å–data: "</span> + value);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            readLock.unlock(); <span class="comment">// é‡Šæ”¾è¯»é”</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><img src="img/xxxxxxxxx.gif" alt="xxxxxxxxx.gif"></p><p>ReentrantReadWriteLockè¿˜åŒ…å«äº†ä¸€äº›åˆ«çš„å®ç”¨æ–¹æ³•ï¼š</p><p><img src="img/QQæˆªå›¾20190517153100.png" alt="QQæˆªå›¾20190517153100.png"></p><p>åŠŸèƒ½å’Œä¸Šé¢ä»‹ç»çš„ReentrantLockå·®ä¸å¤šï¼Œæ–¹æ³•åè§åçŸ¥å…¶æ„ï¼Œä¸å†æ¼”ç¤ºäº†ã€‚</p><h2 id="Condition"><a href="#Condition" class="headerlink" title="Condition"></a>Condition</h2><p>Conditionæ¥å£æä¾›äº†ç±»ä¼¼Objectçš„<code>wait</code>ã€<code>notify</code>å’Œ<code>notifyAll</code>æ–¹æ³•ï¼Œä¸Locké…åˆå¯ä»¥å®ç°ç”Ÿäº§/æ¶ˆè´¹æ¨¡å¼ï¼Œä½†æ˜¯è¿™ä¸¤è€…åœ¨ä½¿ç”¨æ–¹å¼ä»¥åŠåŠŸèƒ½ç‰¹æ€§ä¸Šè¿˜æ˜¯æœ‰å·®åˆ«çš„ã€‚</p><p>ä½¿ç”¨Coditionå®ç°ä¸€ä¸ªç”Ÿäº§æ¶ˆè´¹çš„ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConditionTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Condition condition = lock.newCondition();</span><br><span class="line">    <span class="comment">// åˆå§‹æ•°æ®</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> data = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// æ˜¯å¦è¢«æ¶ˆè´¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> consumed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                produceData();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"producer"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                consumeData();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"consumer"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">produceData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock(); <span class="comment">// è·å–é”</span></span><br><span class="line">            <span class="keyword">while</span> (!consumed) &#123; <span class="comment">// åˆ¤æ–­æ•°æ®æ˜¯å¦è¢«æ¶ˆè´¹</span></span><br><span class="line">                condition.await(); <span class="comment">// å¦‚æœæ²¡æœ‰è¢«æ¶ˆè´¹åˆ™è¿›å…¥ç­‰å¾…</span></span><br><span class="line">            &#125;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            data++;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" produce data = "</span> + data);</span><br><span class="line">            consumed = <span class="keyword">false</span>; <span class="comment">// ç”Ÿäº§å®Œæ•°æ®å°†æ¶ˆè´¹æ ‡è¯†ç½®ä¸ºfalse</span></span><br><span class="line">            condition.signal(); <span class="comment">// è§£é™¤awaitï¼Œç”¨äºé€šçŸ¥æ¶ˆè´¹è€…å¯ä»¥å¼€å§‹æ¶ˆè´¹äº†</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock(); <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">consumeData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock(); <span class="comment">// è·å–é”</span></span><br><span class="line">            <span class="keyword">while</span> (consumed) &#123; <span class="comment">// åˆ¤æ–­æ•°æ®æ˜¯å¦è¢«æ¶ˆè´¹</span></span><br><span class="line">                condition.await(); <span class="comment">// å¦‚æœè¢«æ¶ˆè´¹äº†åˆ™è¿›å…¥ç­‰å¾…</span></span><br><span class="line">            &#125;</span><br><span class="line">            TimeUnit.MICROSECONDS.sleep(<span class="number">500</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" consume data = "</span> + data);</span><br><span class="line">            consumed = <span class="keyword">true</span>; <span class="comment">// æ¶ˆè´¹å®Œå°†æ¶ˆè´¹æ ‡è¯†ç½®ä¸ºtrue</span></span><br><span class="line">            condition.signal(); <span class="comment">// è§£é™¤awaitï¼Œå“Ÿé¢†åŸŸé€šçŸ¥ç”Ÿäº§è€…å¯ä»¥å¼€å§‹ç”Ÿäº§äº†</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock(); <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä¾‹å­ä¸­ï¼Œé€šè¿‡<code>consumed</code>åˆ¤æ–­æ•°æ®æ˜¯å¦è¢«æ¶ˆè´¹ã€‚<code>produceData</code>æ–¹æ³•åœ¨è·å–é”åï¼Œåˆ¤æ–­æ•°æ®æ˜¯å¦è¢«æ¶ˆè´¹ï¼Œå¦‚æœæ²¡æœ‰è¢«æ¶ˆè´¹ï¼Œåˆ™è°ƒç”¨Conditionçš„<code>await</code>æ–¹æ³•è¿›å…¥ç­‰å¾…ï¼Œç›´åˆ°Conditionå¯¹è±¡çš„<code>signal</code>æ–¹æ³•è¢«è°ƒç”¨ï¼›<code>consumeData</code>æ–¹æ³•é€»è¾‘å’Œ<code>produceData</code>ä¸€è‡´ã€‚</p><p>Conditionæ ¸å¿ƒç”¨æ³•å°±æ˜¯é€šè¿‡<code>await</code>æ–¹æ³•è®©çº¿ç¨‹è¿›å…¥é˜»å¡ç­‰å¾…çŠ¶æ€ï¼Œé€šè¿‡<code>signal</code>è§£é™¤é˜»å¡çŠ¶æ€ã€‚ä¸Šé¢çš„ä¾‹å­è¿è¡Œæ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/eososos.gif" alt="eososos.gif"></p><p>å¯¹åº”ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬å¯ä»¥æ€è€ƒä¸‹é¢ä¸‰ä¸ªé—®é¢˜ï¼š</p><ol><li><p>æ˜¯å¦å¯ä»¥åªä½¿ç”¨Lockè€Œä¸ä½¿ç”¨Conditionï¼Ÿ</p></li><li><p>ç”Ÿäº§è€…æŠ¢åˆ°äº†é”è¿›å…¥awaitï¼Œå¹¶æ²¡æœ‰é‡Šæ”¾é”ï¼Œä¸ºä»€ä¹ˆæ¶ˆè´¹è€…å¯ä»¥è·å¾—é”ï¼Ÿ</p></li><li><p>æ˜¯å¦å¯ä»¥åªä½¿ç”¨Conditionä¸ä½¿ç”¨Lockï¼Ÿ</p></li></ol><p>å¯¹äºç¬¬ä¸€ä¸ªé—®é¢˜ï¼š<strong>æ˜¯å¦å¯ä»¥åªä½¿ç”¨Lockè€Œä¸ä½¿ç”¨Conditionï¼Ÿ</strong></p><p>è™½ç„¶æˆ‘ä»¬å¯ä»¥å®šä¹‰å…¬å¹³çš„ReentrantLockï¼Œä½†æ˜¯å®é™…ä¸Šå¹¶ä¸èƒ½ç¡®ä¿100%å…¬å¹³ï¼Œåªæ˜¯å°½å¯èƒ½çš„å…¬å¹³ã€‚ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹å¿…é¡»ä¸ºç”Ÿäº§è€…ç”Ÿæˆå®Œäº†æ•°æ®é€šçŸ¥æ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹å®Œäº†é€šçŸ¥ç”Ÿäº§è€…ç”Ÿäº§ï¼Œè¿™æ˜¯ç¯ç¯ç›¸æ‰£çš„ï¼Œä¸å…è®¸å‡ºç°åˆ«çš„æƒ…å†µã€‚</p><p>å¯¹äºç¬¬äºŒä¸ªé—®é¢˜ï¼š<strong>ç”Ÿäº§è€…æŠ¢åˆ°äº†é”è¿›å…¥awaitï¼Œå¹¶æ²¡æœ‰é‡Šæ”¾é”ï¼Œä¸ºä»€ä¹ˆæ¶ˆè´¹è€…å¯ä»¥è·å¾—é”ï¼Ÿ</strong></p><p>å‡å¦‚ä¸€å¼€å§‹<code>produceData</code>æ–¹æ³•å…ˆé€šè¿‡<code>lock.lock()</code>è·å–åˆ°äº†é”ï¼Œconsumedåˆå§‹å€¼ä¸ºfalseï¼Œæ‰€ä»¥æ¥ç€æ–¹æ³•ä¼šè°ƒç”¨<code>condition.await()</code>è¿›å…¥é˜»å¡ç­‰å¾…ã€‚<code>await</code>æ–¹æ³•ä¼šä½¿å¾—å½“å‰çº¿ç¨‹<strong>é‡Šæ”¾é”å¯¹è±¡</strong>ï¼Œç„¶åè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°å‘ç”Ÿä¸‹é¢ä¸‰ç§æƒ…å†µä¹‹ä¸€æ‰ä¼šè¢«è§£é™¤ä¼‘çœ ï¼š</p><ol><li><p>Conditionçš„<code>signal</code>æ–¹æ³•è¢«è°ƒç”¨ï¼›</p></li><li><p>Conditionçš„<code>signalAll</code>æ–¹æ³•è¢«è°ƒç”¨ï¼›</p></li><li><p>å…¶ä»–çº¿ç¨‹è°ƒç”¨äº†å½“å‰çº¿ç¨‹çš„<code>interrupt</code>æ–¹æ³•ã€‚</p></li></ol><p>å¯¹äºç¬¬ä¸‰ä¸ªé—®é¢˜ï¼š<strong>æ˜¯å¦å¯ä»¥åªä½¿ç”¨Conditionä¸ä½¿ç”¨Lockï¼Ÿ</strong></p><p>æ—¢ç„¶<code>await</code>ä¼šä½¿å¾—çº¿ç¨‹è¿›å…¥é˜»å¡ç­‰å¾…çŠ¶æ€ï¼Œé‚£ä¹ˆæ˜¯å¦å¯ä»¥ç›´æ¥ä½¿ç”¨<code>await</code>ï¼Œè€Œä¸ä½¿ç”¨Lockå‘¢ï¼Ÿæˆ‘ä»¬æ”¹é€ ä¸Šé¢çš„ä¾‹å­ï¼Œå»æ‰è·å–å’Œé‡Šæ”¾é”çš„ç›¸å…³ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConditionTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å…¬å¹³é”</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Condition condition = lock.newCondition();</span><br><span class="line">    <span class="comment">// åˆå§‹æ•°æ®</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> data = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// æ˜¯å¦è¢«æ¶ˆè´¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> consumed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                produceData();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                consumeData();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">produceData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (!consumed) &#123;</span><br><span class="line">                condition.await();</span><br><span class="line">            &#125;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            data++;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" produce data = "</span> + data);</span><br><span class="line">            consumed = <span class="keyword">false</span>;</span><br><span class="line">            condition.signal();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">consumeData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (consumed) &#123;</span><br><span class="line">                condition.await();</span><br><span class="line">            &#125;</span><br><span class="line">            TimeUnit.MICROSECONDS.sleep(<span class="number">500</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" consume data = "</span> + data);</span><br><span class="line">            consumed = <span class="keyword">true</span>;</span><br><span class="line">            condition.signal();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20190517152744.png" alt="QQæˆªå›¾20190517152744.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œç¨‹åºæŠ›å‡º<code>IllegalMonitorStateException</code>å¼‚å¸¸ï¼Œæ‰€ä»¥Conditionå¿…é¡»é…åˆLockä½¿ç”¨ã€‚</p><p>æ­£å¦‚å‰é¢è¯´çš„ï¼ŒConditionçš„åŠŸèƒ½ç±»ä¼¼äºObjectå¯¹è±¡çš„<code>wait</code>å’Œ<code>notify</code>æ–¹æ³•ï¼Œä¸‹é¢æˆ‘ä»¬ä½¿ç”¨Objectå¯¹è±¡çš„<code>wait</code>å’Œ<code>notify</code>æ–¹æ³•å®ç°ä¸€ä¸ªç±»ä¼¼ä¸Šé¢ç”Ÿäº§æ¶ˆè´¹çš„åŠŸèƒ½ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WaitNotifyExample</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> data = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> used = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Object MONITOR = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                produceData();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"thread1"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                consumeData();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"thread2"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">produceData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (MONITOR) &#123;</span><br><span class="line">            <span class="keyword">while</span> (!used) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    MONITOR.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            data++;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" ç”Ÿäº§data = "</span> + data);</span><br><span class="line">            used = <span class="keyword">false</span>;</span><br><span class="line">            MONITOR.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">consumeData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (MONITOR) &#123;</span><br><span class="line">            <span class="keyword">while</span> (used) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    MONITOR.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" æ¶ˆè´¹data = "</span> + data);</span><br><span class="line">            used = <span class="keyword">true</span>;</span><br><span class="line">            MONITOR.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/baoningn.gif" alt="baoningn.gif"></p><h2 id="JDK8-StampedLock"><a href="#JDK8-StampedLock" class="headerlink" title="JDK8 StampedLock"></a>JDK8 StampedLock</h2><p>JDK8 æ–°å¢äº†ä¸€ä¸ªé”StampedLockï¼Œå®ƒæ˜¯å¯¹ReadWriteLockçš„æ”¹è¿›ã€‚</p><p>ä½¿ç”¨ReadWriteLockçš„æ—¶å€™ï¼Œå½“è¯»çº¿ç¨‹æ•°é‡è¿œå¤§äºå†™çº¿ç¨‹æ•°é‡çš„æ—¶å€™å°±ä¼šå‡ºç°â€œå†™é¥¥é¥¿â€ç°è±¡ã€‚å› ä¸ºé”å¤§æ¦‚ç‡éƒ½è¢«è¯»çº¿ç¨‹æŠ¢èµ°äº†ï¼Œå†™çº¿ç¨‹å¾ˆéš¾æŠ¢åˆ°é”ï¼Œè¿™å°†ä½¿å¾—è¯»å†™æ•ˆç‡éå¸¸ä½ä¸‹ã€‚</p><p>JDK8çš„StampedLockå°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜è€Œè®¾è®¡çš„ï¼ŒStampedLockåŒ…å«<strong>ä¹è§‚é”</strong>å’Œ<strong>æ‚²è§‚é”</strong>ï¼š</p><ul><li><p>ä¹è§‚é”ï¼šæ¯æ¬¡å»æ‹¿æ•°æ®çš„æ—¶å€™ï¼Œå¹¶ä¸è·å–é”å¯¹è±¡ï¼Œè€Œæ˜¯åˆ¤æ–­æ ‡è®°ä½ï¼ˆstampï¼‰æ˜¯å¦æœ‰è¢«ä¿®æ”¹ï¼Œå¦‚æœæœ‰ä¿®æ”¹å°±å†å»è¯»ä¸€æ¬¡ã€‚</p></li><li><p>æ‚²è§‚é”ï¼šæ¯æ¬¡æ‹¿æ•°æ®çš„æ—¶å€™éƒ½å»è·å–é”ã€‚</p></li></ul><p>é€šè¿‡ä¹è§‚é”ï¼Œå½“å†™çº¿ç¨‹æ²¡æœ‰å†™æ•°æ®çš„æ—¶å€™ï¼Œæ ‡å¿—ä½stampå¹¶æ²¡æœ‰æ”¹å˜ï¼Œæ‰€ä»¥å³ä½¿æœ‰å†å¤šçš„è¯»çº¿ç¨‹åœ¨è¯»å–æ•°æ®ï¼Œå®ƒä»¬éƒ½å¯ä»¥ç›´æ¥å»è¯»æ•°æ®ï¼Œè€Œæ— éœ€è·å–é”ï¼Œè¿™å°±ä¸ä¼šä½¿å¾—å†™çº¿ç¨‹æŠ¢ä¸åˆ°é”äº†ã€‚</p><div class="note info"><p>stampç±»ä¼¼ä¸€ä¸ªæ—¶é—´æˆ³çš„ä½œç”¨ï¼Œæ¯æ¬¡å†™çš„æ—¶å€™å¯¹å…¶+1æ¥æ”¹å˜è¢«æ“ä½œå¯¹è±¡çš„stampå€¼ã€‚</p></div><p>ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥æ¨¡æ‹Ÿå†™é¥¥é¥¿çš„æƒ…å†µï¼šåˆ›å»º20ä¸ªçº¿ç¨‹ï¼Œå…¶ä¸­19ä¸ªçº¿ç¨‹ç”¨äºè¯»æ•°æ®ï¼Œ1ä¸ªçº¿ç¨‹ç”¨äºå†™æ•°æ®ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StampedLockTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> StampedLock lock = <span class="keyword">new</span> StampedLock();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Long&gt; data = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">        Runnable read = StampedLockTest::read;</span><br><span class="line">        Runnable write = StampedLockTest::write;</span><br><span class="line"></span><br><span class="line">        IntStream.range(<span class="number">0</span>, <span class="number">19</span>).forEach(i -&gt; executorService.submit(read));</span><br><span class="line">        executorService.submit(write);</span><br><span class="line"></span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> stamped = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stamped = lock.readLock(); <span class="comment">// è·å–æ‚²è§‚é”ï¼Œé˜»å¡å†™çº¿ç¨‹</span></span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            String collect = data.stream().map(String::valueOf).collect(Collectors.joining(<span class="string">","</span>));</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" read value: "</span> + collect);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlockRead(stamped);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> stamped = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stamped = lock.writeLock();</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">long</span> value = System.currentTimeMillis();</span><br><span class="line">            data.add(value);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" write value: "</span> + value);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlockWrite(stamped);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä¾‹å­é€šè¿‡StampedLockè°ƒç”¨<code>writeLock</code>ã€<code>unlockWrite</code>ã€<code>readLock</code>å’Œ<code>unlockRead</code>çš„æ—¶å€™éƒ½ä¼šå¯¼è‡´StampedLockçš„stampå€¼çš„å˜åŒ–ï¼Œå³æ¯æ¬¡+1ï¼Œç›´åˆ°åŠ åˆ°æœ€å¤§å€¼ï¼Œç„¶åä»0é‡æ–°å¼€å§‹ã€‚</p><p>ä¸Šé¢ç¨‹åºè¿è¡Œç»“æœå¦‚ä¸‹ï¼š <img src="img/QQæˆªå›¾20190517155259.png" alt="QQæˆªå›¾20190517155259.png"></p><p>å¯ä»¥çœ‹åˆ°å†™çº¿ç¨‹æœ€åæ‰æŠ¢åˆ°é”å¹¶å†™å…¥æ•°æ®ã€‚</p><p>æˆ‘ä»¬é€šè¿‡ä¹è§‚é”æ¥æ”¹å–„è¿™ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StampedLockTest2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> StampedLock lock = <span class="keyword">new</span> StampedLock();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Long&gt; data = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">        Runnable read = StampedLockTest2::read;</span><br><span class="line">        Runnable write = StampedLockTest2::write;</span><br><span class="line"></span><br><span class="line">        IntStream.range(<span class="number">0</span>, <span class="number">19</span>).forEach(i -&gt; executorService.submit(read));</span><br><span class="line">        executorService.submit(write);</span><br><span class="line"></span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> stamped = lock.tryOptimisticRead(); <span class="comment">// è·å–ä¹è§‚é”</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ç›´æ¥è¯»å–å€¼</span></span><br><span class="line">        String collect = data.stream().map(String::valueOf).collect(Collectors.joining(<span class="string">","</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœæˆ³è¢«æ”¹å˜ï¼Œæ–¹æ³•è¿”å›falseï¼Œè¯´æ˜stampedè¢«ä¿®æ”¹è¿‡äº†ï¼ˆè¢«writeæ–¹æ³•ä¿®æ”¹è¿‡äº†ï¼Œæœ‰æ–°çš„æ•°æ®å†™å…¥ï¼‰ï¼Œ</span></span><br><span class="line">        <span class="comment">// é‚£ä¹ˆé‡æ–°è·å–é”å¹¶å»è¯»å–å€¼ï¼Œå¦åˆ™ç›´æ¥ä½¿ç”¨ä¸Šé¢è¯»å–çš„å€¼ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (!lock.validate(stamped)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                stamped = lock.readLock();</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                collect = data.stream().map(String::valueOf).collect(Collectors.joining(<span class="string">","</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlockRead(stamped);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" read value: "</span> + collect);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> stamped = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stamped = lock.writeLock();</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">long</span> value = System.currentTimeMillis();</span><br><span class="line">            data.add(value);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" write value: "</span> + value);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlockWrite(stamped);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æˆ‘ä»¬é‡ç‚¹å…³æ³¨<code>read</code>æ–¹æ³•ã€‚<code>read</code>æ–¹æ³•ä¸€å¼€å§‹é€šè¿‡è°ƒç”¨StampedLockçš„<code>tryOptimisticRead</code>æ–¹æ³•æ¥è·å–æ ‡å¿—ä½stampï¼Œè·å–ä¹è§‚é”å¹¶ä¸ä¼šçœŸæ­£çš„å»è·å–é”ï¼ˆæ‰€ä»¥ä¸ä¼šé˜»å¡å†™æ“ä½œï¼‰ï¼Œç„¶åç›´æ¥å»è¯»æ•°æ®ã€‚æ¥ç€é€šè¿‡StampedLockçš„<code>validate</code>æ–¹æ³•åˆ¤æ–­æ ‡å¿—ä½stampæ˜¯å¦è¢«ä¿®æ”¹äº†ï¼ˆ<code>write</code>æ–¹æ³•é‡Œä¼šä¿®æ”¹æ ‡å¿—ä½çš„å€¼ï¼‰ï¼Œå¦‚æœæ–¹æ³•è¿”å›trueï¼Œåˆ™è¯´æ˜æ•°æ®æ²¡æœ‰è¢«ä¿®æ”¹è¿‡ï¼Œç›´æ¥ä½¿ç”¨å‰é¢è¯»å–çš„æ•°æ®å³å¯ï¼›å¦åˆ™éœ€è¦å»è·å–é”é‡æ–°å»è¯»æ•°æ®ï¼Œé˜»æ­¢å†™æ“ä½œã€‚</p><p>ä¸Šé¢ä¾‹å­è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><p><img src="img/QQæˆªå›¾20190517160314.png" alt="QQæˆªå›¾20190517160314.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œå†™æ“ä½œä¸€å¼€å§‹å°±æŠ¢åˆ°äº†é”ï¼Œå¹¶å†™å…¥äº†æ•°æ®ã€‚</p><p><strong>ç®€è€Œè¨€ä¹‹ï¼ŒStampedLockè§£å†³äº†åœ¨æ²¡æœ‰æ–°æ•°æ®å†™å…¥æ—¶ï¼Œç”±äºè¿‡å¤šè¯»æ“ä½œæŠ¢å¤ºé”è€Œä½¿å¾—å†™æ“ä½œä¸€ç›´è·å–ä¸åˆ°é”æ— æ³•å†™å…¥æ–°æ•°æ®çš„é—®é¢˜ã€‚</strong></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;Locké”æ˜¯ç”¨æ¥æ§åˆ¶å¤šä¸ªçº¿ç¨‹è®¿é—®å…±äº«èµ„æºçš„æ–¹å¼ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªé”èƒ½å¤Ÿé˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å…±äº«èµ„æºï¼ˆä½†æ˜¯æœ‰äº›é”å¯ä»¥å…è®¸å¤šä¸ªçº¿ç¨‹å¹¶å‘çš„è®¿é—®å…±äº«èµ„æºï¼Œæ¯”å¦‚è¯»å†™é”ï¼‰ã€‚åœ¨Lockæ¥å£å‡ºç°ä¹‹å‰ï¼ŒJavaç¨‹åºæ˜¯é synchronizedå…³é”®å­—å®ç°é”åŠŸèƒ½çš„ï¼Œè€ŒJava SE 5ä¹‹åï¼Œå¹¶å‘åŒ…ä¸­æ–°å¢äº†Lockæ¥å£ï¼ˆä»¥åŠç›¸å…³å®ç°ç±»ï¼‰ç”¨æ¥å®ç°é”åŠŸèƒ½ï¼Œå®ƒæä¾›äº†ä¸synchronizedå…³é”®å­—ç±»ä¼¼çš„åŒæ­¥åŠŸèƒ½ï¼Œåªæ˜¯åœ¨ä½¿ç”¨æ—¶éœ€è¦æ˜¾å¼åœ°è·å–å’Œé‡Šæ”¾é”ã€‚è™½ç„¶å®ƒç¼ºå°‘äº†ï¼ˆé€šè¿‡synchronizedå—æˆ–è€…æ–¹æ³•æ‰€æä¾›çš„ï¼‰éšå¼è·å–é‡Šæ”¾é”çš„ä¾¿æ·æ€§ï¼Œä½†æ˜¯å´æ‹¥æœ‰äº†é”è·å–ä¸é‡Šæ”¾çš„å¯æ“ä½œæ€§ã€å¯ä¸­æ–­çš„è·å–é”ä»¥åŠè¶…æ—¶è·å–é”ç­‰å¤šç§synchronizedå…³é”®å­—æ‰€ä¸å…·å¤‡çš„åŒæ­¥ç‰¹æ€§ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>ThreadLocalä½¿ç”¨å­¦ä¹ </title>
    <link href="http://mrbird.cc/ThreadLocal.html"/>
    <id>http://mrbird.cc/ThreadLocal.html</id>
    <published>2019-03-15T08:21:35.000Z</published>
    <updated>2019-10-28T12:14:46.291Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sat Nov 23 2019 18:20:05 GMT+0800 (GMT+08:00) --><p>ThreadLocalå­—é¢ä¸Šçš„æ„æ€æ˜¯å±€éƒ¨çº¿ç¨‹å˜é‡ï¼Œæ¯ä¸ªçº¿ç¨‹é€šè¿‡ThreadLocalçš„<code>get</code>å’Œ<code>set</code>æ–¹æ³•æ¥è®¿é—®å’Œä¿®æ”¹çº¿ç¨‹è‡ªå·±ç‹¬æœ‰çš„å˜é‡ã€‚ç®€å•åœ°è¯´ï¼ŒThreadLocalçš„ä½œç”¨å°±æ˜¯ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹æä¾›äº†ä¸€ä¸ªç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½å¯ä»¥ç‹¬ç«‹åœ°æ”¹å˜è‡ªå·±çš„å‰¯æœ¬ï¼Œè€Œä¸ä¼šå½±å“å…¶å®ƒçº¿ç¨‹æ‰€å¯¹åº”çš„å‰¯æœ¬ã€‚<a id="more"></a></p><h2 id="ThreadLocalçš„åŸºæœ¬ä½¿ç”¨"><a href="#ThreadLocalçš„åŸºæœ¬ä½¿ç”¨" class="headerlink" title="ThreadLocalçš„åŸºæœ¬ä½¿ç”¨"></a>ThreadLocalçš„åŸºæœ¬ä½¿ç”¨</h2><p>ThreadLocalæ˜¯ä¸€ä¸ªæ³›å‹ç±»ï¼Œåœ¨åˆ›å»ºçš„æ—¶å€™éœ€è¦æŒ‡å®šå˜é‡çš„ç±»å‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;String&gt; threadLocal = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br></pre></td></tr></table></figure><p></p><p>ThreadLocalæä¾›äº†<code>set</code>æ–¹æ³•æ¥è®¾ç½®å˜é‡çš„å€¼ï¼Œ<code>get</code>æ–¹æ³•è·å–å˜é‡çš„å€¼ï¼Œ<code>remove</code>æ–¹æ³•ç§»é™¤å˜é‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;String&gt; threadLocal = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        threadLocal.set(<span class="string">"mrbird"</span>);</span><br><span class="line">        System.out.println(threadLocal.get());</span><br><span class="line">        threadLocal.remove();</span><br><span class="line">        System.out.println(threadLocal.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š <img src="img/QQæˆªå›¾20190515100033.png" alt="QQæˆªå›¾20190515100033.png"></p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥ç»™ThreadLocalè®¾ç½®åˆå§‹å€¼ï¼Œè®¾ç½®åˆå§‹å€¼æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ol><li>é‡å†™<code>initialValue</code>æ–¹æ³•ï¼š</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;String&gt; threadLocal = <span class="keyword">new</span> ThreadLocal&lt;String&gt;()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> String <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"åˆå§‹å€¼"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        System.out.println(threadLocal.get()); <span class="comment">// åˆå§‹å€¼</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>ä½¿ç”¨ThreadLocalçš„<code>withInitial</code>æ–¹æ³•ï¼š</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;String&gt; threadLocal = ThreadLocal.withInitial(() -&gt; <span class="string">"åˆå§‹å€¼"</span>);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        System.out.println(threadLocal.get()); <span class="comment">// åˆå§‹å€¼</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å€¼å¾—æ³¨æ„çš„æ˜¯<code>remove</code>æ— æ³•ç§»é™¤åˆå§‹å€¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;String&gt; threadLocal = ThreadLocal.withInitial(() -&gt; <span class="string">"åˆå§‹å€¼"</span>);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        threadLocal.remove();</span><br><span class="line">        System.out.println(threadLocal.get()); <span class="comment">// åˆå§‹å€¼</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="æ¼”ç¤ºå¤šçº¿ç¨‹é—´ç‹¬ç«‹"><a href="#æ¼”ç¤ºå¤šçº¿ç¨‹é—´ç‹¬ç«‹" class="headerlink" title="æ¼”ç¤ºå¤šçº¿ç¨‹é—´ç‹¬ç«‹"></a>æ¼”ç¤ºå¤šçº¿ç¨‹é—´ç‹¬ç«‹</h2><p>åœ¨å¤šä¸ªçº¿ç¨‹ä¸­ä½¿ç”¨ThreadLocalï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalTest2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;String&gt; threadLocal = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Random random = <span class="keyword">new</span> Random(System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread thread1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            threadLocal.set(<span class="string">"thread t1"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MICROSECONDS.sleep(random.nextInt(<span class="number">1000</span>));</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" "</span> + threadLocal.get());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"thread1"</span>);</span><br><span class="line"></span><br><span class="line">        Thread thread2 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            threadLocal.set(<span class="string">"thread t2"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MICROSECONDS.sleep(random.nextInt(<span class="number">1000</span>));</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" "</span> + threadLocal.get());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"thread2"</span>);</span><br><span class="line"></span><br><span class="line">        thread1.start();</span><br><span class="line">        thread2.start();</span><br><span class="line">        thread1.join();</span><br><span class="line">        thread2.join();</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" "</span> + threadLocal.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p><p><img src="img/QQæˆªå›¾20190515100702.png" alt="QQæˆªå›¾20190515100702.png"></p><p>ç»“æœè¯æ˜äº†ThreadLocalåœ¨æ¯ä¸ªçº¿ç¨‹é—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼ŒthreadLocalåœ¨thread1ã€thread2å’Œmainçº¿ç¨‹é—´éƒ½æœ‰ä¸€ä»½ç‹¬ç«‹æ‹·è´ã€‚</p><h2 id="ThreadLocalåŸºæœ¬åŸç†"><a href="#ThreadLocalåŸºæœ¬åŸç†" class="headerlink" title="ThreadLocalåŸºæœ¬åŸç†"></a>ThreadLocalåŸºæœ¬åŸç†</h2><p>åœ¨ThreadLocalç±»ä¸­æœ‰ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ThreadLocalMap(æ¦‚å¿µä¸Šç±»ä¼¼äºMap)ï¼Œç”¨é”®å€¼å¯¹çš„å½¢å¼å­˜å‚¨æ¯ä¸€ä¸ªçº¿ç¨‹çš„å˜é‡å‰¯æœ¬ï¼ŒThreadLocalMapä¸­å…ƒç´ çš„keyä¸ºå½“å‰ThreadLocalå¯¹è±¡ï¼Œè€Œvalueå¯¹åº”çº¿ç¨‹çš„å˜é‡å‰¯æœ¬ã€‚</p><p>æˆ‘ä»¬ä½¿ç”¨Mapæ¥ä»£æ›¿ThreadLocalMapï¼Œåˆ›å»ºä¸€ä¸ªç®€æ˜“çš„ç±»ThreadLocalå®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThreadLocal</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Thread, T&gt; threadLocalMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            Thread key = Thread.currentThread();</span><br><span class="line">            threadLocalMap.put(key, t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            Thread key = Thread.currentThread();</span><br><span class="line">            T t = threadLocalMap.get(key);</span><br><span class="line">            <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> initalValue();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">initalValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä½¿ç”¨æ–¹å¼å’Œä¹‹å‰çš„ä¾‹å­ä¸€è‡´ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalTest3</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> MyThreadLocal&lt;String&gt; threadLocal = <span class="keyword">new</span> MyThreadLocal&lt;String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">initalValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"initalValue"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Random random = <span class="keyword">new</span> Random(System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread thread1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            threadLocal.set(<span class="string">"thread t1"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MICROSECONDS.sleep(random.nextInt(<span class="number">1000</span>));</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" "</span> + threadLocal.get());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"thread1"</span>);</span><br><span class="line"></span><br><span class="line">        Thread thread2 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            threadLocal.set(<span class="string">"thread t2"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MICROSECONDS.sleep(random.nextInt(<span class="number">1000</span>));</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" "</span> + threadLocal.get());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"thread2"</span>);</span><br><span class="line"></span><br><span class="line">        thread1.start();</span><br><span class="line">        thread2.start();</span><br><span class="line">        thread1.join();</span><br><span class="line">        thread2.join();</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" "</span> + threadLocal.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p><p><img src="img/QQæˆªå›¾20190515101510.png" alt="QQæˆªå›¾20190515101510.png"></p><h2 id="ä½¿ç”¨å»ºè®®"><a href="#ä½¿ç”¨å»ºè®®" class="headerlink" title="ä½¿ç”¨å»ºè®®"></a>ä½¿ç”¨å»ºè®®</h2><ol><li><p>å°†ThreadLocalå˜é‡æŒ‡å®šä¸º<code>private static</code>ï¼›</p></li><li><p>ä½¿ç”¨å®Œæ¯•åæ˜¾å¼åœ°è°ƒç”¨<code>remove</code>æ–¹æ³•ç§»é™¤ã€‚</p></li></ol><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sat Nov 23 2019 18:20:05 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;ThreadLocalå­—é¢ä¸Šçš„æ„æ€æ˜¯å±€éƒ¨çº¿ç¨‹å˜é‡ï¼Œæ¯ä¸ªçº¿ç¨‹é€šè¿‡ThreadLocalçš„&lt;code&gt;get&lt;/code&gt;å’Œ&lt;code&gt;set&lt;/code&gt;æ–¹æ³•æ¥è®¿é—®å’Œä¿®æ”¹çº¿ç¨‹è‡ªå·±ç‹¬æœ‰çš„å˜é‡ã€‚ç®€å•åœ°è¯´ï¼ŒThreadLocalçš„ä½œç”¨å°±æ˜¯ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹æä¾›äº†ä¸€ä¸ªç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½å¯ä»¥ç‹¬ç«‹åœ°æ”¹å˜è‡ªå·±çš„å‰¯æœ¬ï¼Œè€Œä¸ä¼šå½±å“å…¶å®ƒçº¿ç¨‹æ‰€å¯¹åº”çš„å‰¯æœ¬ã€‚
    
    </summary>
    
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>JUCä¹‹Semaphore</title>
    <link href="http://mrbird.cc/JUC-Semaphore.html"/>
    <id>http://mrbird.cc/JUC-Semaphore.html</id>
    <published>2019-03-11T08:24:16.000Z</published>
    <updated>2019-10-28T12:14:46.238Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --><p>JUCçš„Semaphoreä¿—ç§°ä¿¡å·é‡ï¼Œå¯ç”¨æ¥æ§åˆ¶åŒæ—¶è®¿é—®ç‰¹å®šèµ„æºçš„çº¿ç¨‹æ•°é‡ã€‚é€šè¿‡å®ƒçš„æ„é€ å‡½æ•°æˆ‘ä»¬å¯ä»¥æŒ‡å®šä¿¡å·é‡ï¼ˆç§°ä¸ºè®¸å¯è¯permitså¯èƒ½æ›´ä¸ºæ˜ç¡®ï¼‰çš„æ•°é‡ï¼Œçº¿ç¨‹å¯ä»¥è°ƒç”¨Semaphoreå¯¹è±¡çš„<code>acquire</code>æ–¹æ³•è·å–ä¸€ä¸ªè®¸å¯è¯ï¼Œè°ƒç”¨<code>release</code>æ¥å½’è¿˜ä¸€ä¸ªè®¸å¯è¯ã€‚</p><p>ä¸‹é¢ä¸¾ä¸ªSemaphoreçš„åŸºæœ¬ä½¿ç”¨ç¤ºä¾‹ã€‚<a id="more"></a></p><h2 id="Semaphoreç¤ºä¾‹"><a href="#Semaphoreç¤ºä¾‹" class="headerlink" title="Semaphoreç¤ºä¾‹"></a>Semaphoreç¤ºä¾‹</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SemaphoreTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// å®šä¹‰è®¸å¯è¯æ•°é‡</span></span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        IntStream.range(<span class="number">0</span>, <span class="number">4</span>).forEach(i -&gt; &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">"å¼€å§‹"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire(); <span class="comment">// ä¸€æ¬¡æ‹¿ä¸€ä¸ªè®¸å¯è¯</span></span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">"è·å–è®¸å¯è¯"</span>);</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">"é‡Šæ”¾è®¸å¯è¯"</span>);</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">"ç»“æŸ"</span>);</span><br><span class="line">            &#125;, <span class="string">"thread"</span> + (i + <span class="number">1</span>)).start();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰è®¸å¯è¯çš„æ•°é‡ä¸º2ä¸ªï¼Œç„¶å4ä¸ªçº¿ç¨‹é€šè¿‡<code>acquire</code>æ–¹æ³•å»è·å–è®¸å¯è¯ï¼Œç»“æŸè¡Œé€šè¿‡<code>release</code>æ–¹æ³•é‡Šæ”¾è®¸å¯è¯ã€‚<code>acquire</code>æ–¹æ³•é»˜è®¤ä¸€æ¬¡åªæ‹¿ä¸€ä¸ªè®¸å¯è¯ï¼Œæ‰€ä»¥ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒåŒä¸€æ—¶åˆ»æœ€å¤šåªæœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œã€‚</p><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š <img src="img/asfasdfa.gif" alt="asfasdfa.gif"></p><p><code>acquire</code>çš„é‡è½½æ–¹æ³•<code>acquire(int permits)</code>å…è®¸çº¿ç¨‹ä¸€æ¬¡æ€§è·å–Nä¸ªè®¸å¯è¯ï¼›åŒæ ·çš„<code>release</code>çš„é‡è½½æ–¹æ³•<code>release(int permits)</code>å…è®¸çº¿ç¨‹ä¸€æ¬¡æ€§é‡Šæ”¾Nä¸ªè®¸å¯è¯ã€‚</p><p>Semaphoreè¿˜æœ‰ä¸€ä¸ª<code>tryAcquire</code>ï¼Œå®ƒå…è®¸çº¿ç¨‹å°è¯•å»è·å–1ä¸ªè®¸å¯è¯ï¼Œå¦‚æœè®¸å¯è¯ä¸è¶³æ²¡æœ‰è·å–åˆ°çš„è¯ï¼Œçº¿ç¨‹ä¹Ÿä¼šç»§ç»­æ‰§è¡Œï¼Œè€Œéé˜»å¡ç­‰å¾…ã€‚<code>tryAcquire</code>æ–¹æ³•çš„é‡è½½æ–¹æ³•<code>tryAcquire(long timeout, TimeUnit unit)</code>å¯ä»¥æŒ‡å®šå°è¯•è·å–è®¸å¯è¯çš„è¶…æ—¶æ—¶é—´ã€‚</p><h2 id="acquireUninterruptibly"><a href="#acquireUninterruptibly" class="headerlink" title="acquireUninterruptibly"></a>acquireUninterruptibly</h2><p>ä»ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬ä¼šå‘ç°<code>acquire</code>æ–¹æ³•ä¼šæŠ›å‡º<code>InterruptedException</code>å¼‚å¸¸ï¼Œè¯´æ˜è¿™ä¸ªæ–¹æ³•æ˜¯å¯ä»¥è¢«æ‰“æ–­çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SemaphoreTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(<span class="number">1</span>);</span><br><span class="line">        Thread thread1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                semaphore.acquire(<span class="number">2</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                System.err.println(<span class="string">"semaphore InterruptedException"</span>);</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        thread1.start();</span><br><span class="line">        TimeUnit.MICROSECONDS.sleep(<span class="number">500</span>);</span><br><span class="line">        thread1.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä¾‹å­thread1çº¿ç¨‹è·å–2ä¸ªè®¸å¯è¯ï¼Œä½†è®¸å¯è¯æ€»æ•°åªæœ‰1ä¸ªï¼Œæ‰€ä»¥ä¼šé˜»å¡ç­‰å¾…ã€‚mainçº¿ç¨‹é€šè¿‡è°ƒç”¨thread1çš„<code>interrupt</code>æ–¹æ³•å»æ‰“æ–­thread1çº¿ç¨‹ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><p><img src="img/QQæˆªå›¾20190515164441.png" alt="QQæˆªå›¾20190515164441.png"></p><p>è€Œé€šè¿‡<code>acquireUninterruptibly</code>æ–¹æ³•å»è·å–è®¸å¯è¯æ˜¯ä¸å¯è¢«æ‰“æ–­çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SemaphoreTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(<span class="number">1</span>);</span><br><span class="line">        Thread thread1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            semaphore.acquireUninterruptibly(<span class="number">2</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        thread1.start();</span><br><span class="line">        TimeUnit.MICROSECONDS.sleep(<span class="number">500</span>);</span><br><span class="line">        thread1.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ç¨‹åºå¹¶ä¸ä¼šæŠ›å‡º<code>InterruptedException</code>ï¼Œthread1ä¼šä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ã€‚</p><h2 id="drainPermits"><a href="#drainPermits" class="headerlink" title="drainPermits"></a>drainPermits</h2><p><code>drainPermits</code>æ–¹æ³•ä¸€æ¬¡æ€§è·å–æ‰€æœ‰è®¸å¯è¯ï¼ˆdrainæŠ½å¹²æ¦¨å¹²ğŸ˜®ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SemaphoreTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"availablePermits: "</span> + semaphore.availablePermits());</span><br><span class="line">            semaphore.drainPermits(); <span class="comment">// è·å–æ‰€æœ‰è®¸å¯è¯ï¼ŒæŠ½å¹²</span></span><br><span class="line">            System.out.println(<span class="string">"availablePermits: "</span> + semaphore.availablePermits());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">4</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            semaphore.release(<span class="number">5</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"ç»“æŸ"</span>);</span><br><span class="line">        &#125;, <span class="string">"thread1"</span>).start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>availablePermits</code>æ–¹æ³•ç”¨äºè·å–å½“å‰å¯ç”¨è®¸å¯è¯æ•°é‡çš„é¢„ä¼°å€¼ã€‚ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p><p><img src="img/QQæˆªå›¾20190515164951.png" alt="QQæˆªå›¾20190515164951.png"></p><h2 id="åˆ«çš„API"><a href="#åˆ«çš„API" class="headerlink" title="åˆ«çš„API"></a>åˆ«çš„API</h2><p><code>hasQueuedThreads</code>æ–¹æ³•ç”¨äºåˆ¤æ–­æ˜¯å¦æœ‰å¤„äºç­‰å¾…è·å–è®¸å¯è¯çŠ¶æ€çš„çº¿ç¨‹ï¼›<code>getQueueLength</code>ç”¨äºè·å–å¤„äºç­‰å¾…è·å–è®¸å¯è¯çŠ¶æ€çš„çº¿ç¨‹çš„æ•°é‡ï¼›<code>getQueuedThreads</code>ç”¨äºè·å–å¤„äºç­‰å¾…è·å–è®¸å¯è¯çŠ¶æ€çš„çº¿ç¨‹é›†åˆã€‚</p><p><code>getQueuedThreads</code>æ˜¯<code>protected</code>çš„ï¼Œæ‰€ä»¥è¦ä½¿ç”¨å®ƒï¼Œæˆ‘ä»¬å¾—è‡ªå®šä¹‰ä¸€ä¸ªSemaphoreçš„å­ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SemaphoreTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// å®šä¹‰è®¸å¯è¯æ•°é‡</span></span><br><span class="line">        <span class="keyword">final</span> MySemaphore semaphore = <span class="keyword">new</span> MySemaphore(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        IntStream.range(<span class="number">0</span>, <span class="number">4</span>).forEach(i -&gt; &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">"å¼€å§‹"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">"è·å–è®¸å¯è¯"</span>);</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">"é‡Šæ”¾è®¸å¯è¯"</span>);</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">"ç»“æŸ"</span>);</span><br><span class="line">            &#125;, <span class="string">"thread"</span> + (i + <span class="number">1</span>)).start();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (semaphore.hasQueuedThreads()) &#123;</span><br><span class="line">                System.out.println(<span class="string">"ç­‰å¾…çº¿ç¨‹æ•°é‡ï¼š"</span> + semaphore.getQueueLength());</span><br><span class="line">                Collection&lt;Thread&gt; queuedThreads = semaphore.getQueuedThreads();</span><br><span class="line">                System.out.println(<span class="string">"ç­‰å¾…çº¿ç¨‹ï¼š"</span> + queuedThreads.stream().map(Thread::getName).collect(Collectors.joining(<span class="string">","</span>)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MySemaphore</span> <span class="keyword">extends</span> <span class="title">Semaphore</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">2595494765642942297L</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MySemaphore</span><span class="params">(<span class="keyword">int</span> permits)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(permits);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MySemaphore</span><span class="params">(<span class="keyword">int</span> permits, <span class="keyword">boolean</span> fair)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(permits, fair);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Collection&lt;Thread&gt; <span class="title">getQueuedThreads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.getQueuedThreads();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼ˆæˆªå–ä¸€éƒ¨åˆ†ï¼‰ï¼š <img src="img/QQæˆªå›¾20190515165623.png" alt="QQæˆªå›¾20190515165623.png"></p><h2 id="Apiæ€»ç»“"><a href="#Apiæ€»ç»“" class="headerlink" title="Apiæ€»ç»“"></a>Apiæ€»ç»“</h2><p>æ€»ç»“ä¸‹Semaphoreå¸¸ç”¨çš„æ–¹æ³•ï¼š</p><table><tr><th>æ–¹æ³•</th><th>æè¿°</th></tr><tr><td><code>acquire()</code></td><td>è·å–ä¸€ä¸ªè®¸å¯è¯ï¼Œå¯ä»¥è¢«æ‰“æ–­ï¼Œæ²¡æœ‰è¶³å¤Ÿçš„è®¸å¯è¯æ—¶é˜»å¡ç­‰å¾…</td></tr><tr><td><code>acquire(int permits)</code></td><td>è·å–æŒ‡å®šæ•°é‡çš„è®¸å¯è¯ï¼Œå¯ä»¥è¢«æ‰“æ–­ï¼Œæ²¡æœ‰è¶³å¤Ÿçš„è®¸å¯è¯æ—¶é˜»å¡ç­‰å¾…</td></tr><tr><td><code>acquireUninterruptibly()</code></td><td>è·å–ä¸€ä¸ªè®¸å¯è¯ï¼Œä¸å¯è¢«æ‰“æ–­ï¼Œæ²¡æœ‰è¶³å¤Ÿçš„è®¸å¯è¯æ—¶é˜»å¡ç­‰å¾…</td></tr><tr><td><code>acquireUninterruptibly(int permits)</code></td><td>è·å–æŒ‡å®šæ•°é‡çš„è®¸å¯è¯ï¼Œä¸å¯è¢«æ‰“æ–­ï¼Œæ²¡æœ‰è¶³å¤Ÿçš„è®¸å¯è¯æ—¶é˜»å¡ç­‰å¾…</td></tr><tr><td><code>tryAcquire()</code></td><td>å°è¯•è·å–ä¸€ä¸ªè®¸å¯è¯ï¼Œæ²¡æœ‰è¶³å¤Ÿçš„è®¸å¯è¯æ—¶ç¨‹åºç»§ç»­æ‰§è¡Œï¼Œä¸ä¼šè¢«é˜»å¡</td></tr><tr><td><code>tryAcquire(int permits)</code></td><td>å°è¯•è·å–æŒ‡å®šæ•°é‡çš„è®¸å¯è¯ï¼Œæ²¡æœ‰è¶³å¤Ÿçš„è®¸å¯è¯æ—¶ç¨‹åºç»§ç»­æ‰§è¡Œï¼Œä¸ä¼šè¢«é˜»å¡</td></tr><tr><td><code>tryAcquire(long timeout, TimeUnit unit)</code></td><td>åœ¨æŒ‡å®šçš„æ—¶é—´èŒƒå›´å†…å°è¯•è·å–1ä¸ªè®¸å¯è¯ï¼Œæ²¡æœ‰è¶³å¤Ÿçš„è®¸å¯è¯æ—¶ç¨‹åºç»§ç»­æ‰§è¡Œï¼Œ<br>ä¸ä¼šè¢«é˜»å¡ï¼Œåœ¨è¯¥æ—¶é—´æ–¹ä½å†…å¯ä»¥è¢«æ‰“æ–­</td></tr><tr><td><code>tryAcquire(int permits, long timeout, TimeUnit unit)</code></td><td>åœ¨æŒ‡å®šçš„æ—¶é—´èŒƒå›´å†…å°è¯•è·å–æŒ‡å®šæ•°é‡çš„è®¸å¯è¯ï¼Œæ²¡æœ‰è¶³å¤Ÿçš„è®¸å¯è¯æ—¶ç¨‹åº<br>ç»§ç»­æ‰§è¡Œï¼Œä¸ä¼šè¢«é˜»å¡ï¼Œåœ¨è¯¥æ—¶é—´æ–¹ä½å†…å¯ä»¥è¢«æ‰“æ–­</td></tr><tr><td><code>release()</code></td><td>é‡Šæ”¾ä¸€ä¸ªè®¸å¯è¯</td></tr><tr><td><code>drainPermits()</code></td><td>ä¸€æ¬¡æ€§è·å–æ‰€æœ‰å¯ç”¨çš„è®¸å¯è¯</td></tr><tr><td><code>availablePermits()</code></td><td>è·å–å½“å‰å¯ç”¨è®¸å¯è¯æ•°é‡çš„é¢„ä¼°å€¼</td></tr><tr><td><code>hasQueuedThreads()</code></td><td>åˆ¤æ–­æ˜¯å¦æœ‰å¤„äºç­‰å¾…è·å–è®¸å¯è¯çŠ¶æ€çš„çº¿ç¨‹</td></tr><tr><td><code>getQueueLength()</code></td><td>è·å–å¤„äºç­‰å¾…è·å–è®¸å¯è¯çŠ¶æ€çš„çº¿ç¨‹çš„æ•°é‡çš„é¢„ä¼°å€¼</td></tr><tr><td><code>getQueuedThreads()</code></td><td>è·å–å¤„äºç­‰å¾…è·å–è®¸å¯è¯çŠ¶æ€çš„çº¿ç¨‹é›†åˆ</td></tr></table><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;JUCçš„Semaphoreä¿—ç§°ä¿¡å·é‡ï¼Œå¯ç”¨æ¥æ§åˆ¶åŒæ—¶è®¿é—®ç‰¹å®šèµ„æºçš„çº¿ç¨‹æ•°é‡ã€‚é€šè¿‡å®ƒçš„æ„é€ å‡½æ•°æˆ‘ä»¬å¯ä»¥æŒ‡å®šä¿¡å·é‡ï¼ˆç§°ä¸ºè®¸å¯è¯permitså¯èƒ½æ›´ä¸ºæ˜ç¡®ï¼‰çš„æ•°é‡ï¼Œçº¿ç¨‹å¯ä»¥è°ƒç”¨Semaphoreå¯¹è±¡çš„&lt;code&gt;acquire&lt;/code&gt;æ–¹æ³•è·å–ä¸€ä¸ªè®¸å¯è¯ï¼Œè°ƒç”¨&lt;code&gt;release&lt;/code&gt;æ¥å½’è¿˜ä¸€ä¸ªè®¸å¯è¯ã€‚&lt;/p&gt;&lt;p&gt;ä¸‹é¢ä¸¾ä¸ªSemaphoreçš„åŸºæœ¬ä½¿ç”¨ç¤ºä¾‹ã€‚
    
    </summary>
    
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥ç†è§£volatileå…³é”®å­—</title>
    <link href="http://mrbird.cc/volatile.html"/>
    <id>http://mrbird.cc/volatile.html</id>
    <published>2019-03-10T08:20:41.000Z</published>
    <updated>2019-10-28T12:14:46.307Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sat Nov 23 2019 18:20:05 GMT+0800 (GMT+08:00) --><p>volatileå…³é”®å­—ä¿®é¥°çš„æˆå‘˜å˜é‡å…·æœ‰ä¸¤å¤§ç‰¹æ€§ï¼šä¿è¯äº†è¯¥æˆå‘˜å˜é‡åœ¨ä¸åŒçº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§ï¼›ç¦æ­¢å¯¹è¯¥æˆå‘˜å˜é‡è¿›è¡Œé‡æ’åºï¼Œä¹Ÿå°±ä¿è¯äº†å…¶æœ‰åºæ€§ã€‚ä½†æ˜¯volatileä¿®é¥°çš„æˆå‘˜å˜é‡å¹¶ä¸å…·æœ‰åŸå­æ€§ï¼Œåœ¨å¹¶å‘ä¸‹å¯¹å®ƒçš„ä¿®æ”¹æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚ä¸‹é¢åˆ†åˆ«ä¸¾ä¾‹æ¥æ¼”ç¤ºè¿™ä¸¤ä¸ªç‰¹æ€§ï¼Œå¹¶ä¸”åˆ†æä¸ºä»€ä¹ˆvolatileä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p><a id="more"></a><h2 id="å¯è§æ€§"><a href="#å¯è§æ€§" class="headerlink" title="å¯è§æ€§"></a>å¯è§æ€§</h2><p>é€šè¿‡å¯¹<a href="/Java-Memory-model.html">JMM</a>çš„å­¦ä¹ ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“çº¿ç¨‹å¯¹ä¸»å†…å­˜ä¸­å…±äº«å˜é‡çš„ä¿®æ”¹é¦–å…ˆä¼šä»ä¸»å†…å­˜è·å–å€¼çš„æ‹·è´ï¼Œç„¶åä¿å­˜åˆ°çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ã€‚æ¥ç€åœ¨å·¥ä½œå†…å­˜ä¸­å¯¹å€¼è¿›è¡Œä¿®æ”¹ï¼Œæœ€ç»ˆåˆ·å›ä¸»å†…å­˜ã€‚ç”±äºä¸åŒçº¿ç¨‹æ‹¥æœ‰å„è‡ªçš„å·¥ä½œå†…å­˜ï¼Œæ‰€ä»¥å®ƒä»¬å¯¹æŸä¸ªå…±äº«å˜é‡å€¼çš„ä¿®æ”¹åœ¨æ²¡æœ‰åˆ·å›ä¸»å†…å­˜çš„æ—¶å€™åªå¯¹è‡ªå·±å¯è§ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡å¦‚æœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œå…¶ä¸­ä¸€ä¸ªçº¿ç¨‹ç”¨äºä¿®æ”¹å…±äº«å˜é‡valueï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ç”¨äºè·å–ä¿®æ”¹åçš„valueï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VolatileTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> INIT_VALUE = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> LIMIT = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">int</span> value = INIT_VALUE;</span><br><span class="line">            <span class="keyword">while</span> (value &lt; LIMIT) &#123;</span><br><span class="line">                <span class="keyword">if</span> (value != INIT_VALUE) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"è·å–æ›´æ–°åçš„å€¼ï¼š"</span> + INIT_VALUE);</span><br><span class="line">                    value = INIT_VALUE;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"reader"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">int</span> value = INIT_VALUE;</span><br><span class="line">            <span class="keyword">while</span> (INIT_VALUE &lt; LIMIT) &#123;</span><br><span class="line">                System.out.println(<span class="string">"å°†å€¼æ›´æ–°ä¸ºï¼š"</span> + ++value);</span><br><span class="line">                INIT_VALUE = value;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.MICROSECONDS.sleep(<span class="number">500</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"writer"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>writerçº¿ç¨‹æ¯éš”0.5ç§’å°†INIT_VALUEå€¼é€’å¢ï¼Œç›´åˆ°INIT_VALUEå¤§äºç­‰äº5ã€‚è€Œreaderçº¿ç¨‹åˆ™æ˜¯ä¸åœçš„å»è·å–INIT_VALUEçš„å€¼ï¼Œç›´åˆ°INIT_VALUEçš„å€¼å¤§äºç­‰äº5ã€‚ç¨‹åºæ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p><p><img src="img/QQæˆªå›¾20190514143804.png" alt="QQæˆªå›¾20190514143804.png"></p><p><img src="img/QQæˆªå›¾20190514150227.png" alt="QQæˆªå›¾20190514150227.png"></p><p>å¤šæ‰§è¡Œå‡ æ¬¡å¯èƒ½æ¯æ¬¡ç»“æœéƒ½ä¸ä¸€æ ·ï¼Œä½†æ˜¯å¯ä»¥ç¡®å®šçš„æ˜¯ï¼Œwriterå¯¹å€¼çš„ä¿®æ”¹readerå¹¶ä¸èƒ½é©¬ä¸Šæ„ŸçŸ¥åˆ°ï¼ˆå¦‚æœèƒ½æ„ŸçŸ¥åˆ°çš„è¯ï¼Œreaderçº¿ç¨‹å°±ä¸ä¼šåœä¸ä¸‹æ¥äº†ï¼‰ã€‚</p><p>ä¸ºä»€ä¹ˆä¼šå‡ºç°ä¸Šé¢çš„ç»“æœå‘¢ï¼Ÿå› ä¸ºwriterçº¿ç¨‹åœ¨å·¥ä½œå†…å­˜ä¸­ä¿®æ”¹äº†INIT_VALUEçš„å€¼ï¼Œå³ä½¿å®ƒåˆ·å›ä¸»å†…å­˜äº†ï¼Œä½†æ˜¯readerçº¿ç¨‹åœ¨æ­¤ä¹‹å‰å·²ç»ä»ä¸»å†…å­˜è·å–äº†INIT_VALUEçš„å€¼ï¼ˆå› ä¸ºçº¿ç¨‹è·å–CPUæ—¶é—´ç‰‡ä¸ç¡®å®šæ€§ï¼Œè¿™ä¸ªå€¼å¯èƒ½æ˜¯0ï¼Œä¹Ÿå¯èƒ½æ˜¯è¢«writerä¿®æ”¹åçš„å€¼ï¼Œä½†writerçº¿ç¨‹æ˜¯æ¯éš”0.5ç§’æ‰ä¼šå»ä¿®æ”¹å€¼ï¼Œæ‰€ä»¥readerè·å–åˆ°çš„INIT_VALUEçš„å€¼ä¸€èˆ¬ä¸ä¼šæ˜¯writerä¿®æ”¹çš„æœ€ç»ˆå€¼5ï¼‰ï¼Œå¹¶ä¿å­˜åˆ°äº†readerçº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ã€‚readerçº¿ç¨‹é€šè¿‡whileä¸æ–­çš„è½®è¯¢åˆ¤æ–­valueå’ŒINIT_VALUEçš„å€¼æ˜¯å¦ç›¸ç­‰ï¼Œä½†æ˜¯ç”±äºreaderçº¿ç¨‹å·¥ä½œå†…å­˜ä¸­å·²ç»æœ‰INIT_VALUEçš„å€¼çš„æ‹·è´äº†ï¼Œæ‰€ä»¥readerå¹¶ä¸ä¼šé‡æ–°ä»ä¸»å†…å­˜ä¸­è·å–è¢«writerä¿®æ”¹åçš„INIT_VALUEçš„å€¼ï¼Œreaderçº¿ç¨‹é‡Œwhileæ¡ä»¶ä¸€ç›´æˆç«‹ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆreaderçº¿ç¨‹ä¸ä¼šæ­£å¸¸åœæ­¢å¹¶ä¸”æ²¡æœ‰è¾“å‡ºä¿®æ”¹åçš„å€¼çš„åŸå› ã€‚</p><p>ä¿®æ”¹ä¸Šé¢çš„ä¾‹å­ï¼Œå°†INIT_VALUEæˆå‘˜å˜é‡ä½¿ç”¨volatileå…³é”®å­—ä¿®é¥°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VolatileTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> <span class="keyword">int</span> INIT_VALUE = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> LIMIT = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">int</span> value = INIT_VALUE;</span><br><span class="line">            <span class="keyword">while</span> (value &lt; LIMIT) &#123;</span><br><span class="line">                <span class="keyword">if</span> (value != INIT_VALUE) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"è·å–æ›´æ–°åçš„å€¼ï¼š"</span> + INIT_VALUE);</span><br><span class="line">                    value = INIT_VALUE;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"reader"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">int</span> value = INIT_VALUE;</span><br><span class="line">            <span class="keyword">while</span> (INIT_VALUE &lt; LIMIT) &#123;</span><br><span class="line">                System.out.println(<span class="string">"å°†å€¼æ›´æ–°ä¸ºï¼š"</span> + ++value);</span><br><span class="line">                INIT_VALUE = value;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.MICROSECONDS.sleep(<span class="number">500</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"writer"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20190514145045.png" alt="QQæˆªå›¾20190514145045.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œreaderçº¿ç¨‹å·²ç»å¯ä»¥æ­£å¸¸åœæ­¢äº†ï¼Œå› ä¸ºæœ€ç»ˆINIT_VALUEçš„å€¼è‚¯å®šæ˜¯5ï¼Œå¹¶ä¸”readerå¯ä»¥æ„ŸçŸ¥åˆ°è¿™ä¸ªå€¼è¢«ä¿®æ”¹ä¸º5äº†ã€‚</p><p>ä¸ºä»€ä¹ˆvolatileä¿®é¥°çš„æˆå‘˜å˜é‡åœ¨çº¿ç¨‹é—´å…·æœ‰å¯è§æ€§å‘¢ï¼Ÿå› ä¸ºé€šè¿‡volatileä¿®é¥°ï¼Œå¯¹æ­¤å˜é‡è¿›è¡Œå†™æ“ä½œæ—¶ï¼Œæ±‡ç¼–æŒ‡ä»¤ä¸­ä¼šæœ‰ä¸€ä¸ªLOCKå‰ç¼€æŒ‡ä»¤ï¼ŒåŠ äº†è¿™ä¸ªæŒ‡ä»¤åï¼Œä¼šå¼•å‘ä¸¤ä»¶äº‹æƒ…ï¼š</p><ol><li><p>å°†å½“å‰å¤„ç†å™¨ç¼“å­˜è¡Œçš„å†…å®¹å†™å›åˆ°ç³»ç»Ÿå†…å­˜ï¼Œä¹Ÿå°±æ˜¯å¼ºåˆ¶å°†å·¥ä½œå†…å­˜ä¸­çš„å€¼åˆ·å›ä¸»å†…å­˜ï¼›</p></li><li><p>è¿™ä¸ªå†™å›åˆ°å†…å­˜çš„æ“ä½œä¼šä½¿å¾—åœ¨å…¶ä»–CPUé‡Œç¼“å­˜äº†è¯¥å†…å­˜åœ°å€çš„æ•°æ®å¤±æ•ˆã€‚å…¶ä»–CPUç¼“å­˜æ•°æ®å¤±æ•ˆï¼Œåˆ™ä¼šé‡æ–°å»å†…å­˜ä¸­è¯»å–å€¼ï¼Œä¹Ÿå°±æ˜¯è¢«ä¿®æ”¹çš„æ•°æ®ã€‚</p></li></ol><p>é€šè¿‡ä¸Šé¢è¿™ä¸¤ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®å®šçš„æ˜¯ï¼Œwriterå¯¹å€¼è¿›è¡Œä¿®æ”¹å¹¶åˆ·å›ä¸»å†…å­˜åï¼Œreaderé‡ŒINIT_VALUEå€¼çš„æ‹·è´å°±å¤±æ•ˆäº†ï¼Œæ‰€ä»¥readerçº¿ç¨‹ä¼šå†æ¬¡ä»ä¸»å†…å­˜ä¸­è·å–INIT_VALUEçš„å€¼ï¼Œè¿™æ—¶å€™è¿™ä¸ªå€¼å·²ç»æ˜¯è¢«writerçº¿ç¨‹ä¿®æ”¹åˆ·æ–°åçš„å€¼äº†ã€‚</p><h2 id="æœ‰åºæ€§"><a href="#æœ‰åºæ€§" class="headerlink" title="æœ‰åºæ€§"></a>æœ‰åºæ€§</h2><p>æ¥çœ‹ä¸€ä¸ªçº¿ç¨‹ä¸å®‰å…¨çš„å•ä¾‹å®ç°ï¼ˆåŒé‡åŒæ­¥é”å•ä¾‹æ¨¡å¼ï¼Œæ›´å¤šå…³äºå•ä¾‹çš„ä»‹ç»å¯ä»¥å‚è€ƒ<a href="/singleton.html">å•ä¾‹çš„å‡ ç§å†™æ³•å’Œå¯¹æ¯”</a>ï¼‰:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ç§æœ‰åŒ–æ„é€ å‡½æ•°ï¼Œè®©å¤–éƒ¨æ²¡åŠæ³•ç›´æ¥é€šè¿‡newæ¥åˆ›å»º</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingletonTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å•ä¾‹å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SingletonTest instance = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// é™æ€å·¥å‚æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingletonTest <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123; <span class="comment">// åŒé‡æ£€æµ‹</span></span><br><span class="line">            <span class="keyword">synchronized</span> (SingletonTest.class) &#123; <span class="comment">// åŒæ­¥é”</span></span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> SingletonTest();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢çš„ä¾‹å­è™½ç„¶åŠ äº†åŒæ­¥é”ï¼Œä½†æ˜¯åœ¨å¤šçº¿ç¨‹ä¸‹å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ç¬¬12è¡Œ<code>instance = new SingletonTest()</code>åœ¨å®é™…æ‰§è¡Œçš„æ—¶å€™ä¼šè¢«æ‹†åˆ†ä¸ºä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤:</p><ol><li><p>åˆ†é…å­˜å‚¨SingletonTestå¯¹è±¡çš„å†…å­˜ç©ºé—´ï¼›</p></li><li><p>åˆå§‹åŒ–SingletonTestå¯¹è±¡ï¼›</p></li><li><p>å°†instanceæŒ‡å‘åˆšåˆšåˆ†é…çš„å†…å­˜ç©ºé—´ã€‚</p></li></ol><p>é€šè¿‡JMMçš„å­¦ä¹ æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œåœ¨æ‰§è¡Œç¨‹åºæ—¶ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¸¸å¸¸ä¼šå¯¹æŒ‡ä»¤åšé‡æ’åºï¼Œå› ä¸ºç¬¬2æ­¥å’Œç¬¬3æ­¥å¹¶æ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œæ‰€ä»¥å¯èƒ½å‘ç”Ÿé‡æ’åºï¼Œæ’åºåçš„æ­¥éª¤ä¸ºï¼š</p><ol><li><p>åˆ†é…å­˜å‚¨SingletonTestå¯¹è±¡çš„å†…å­˜ç©ºé—´ï¼›</p></li><li><p>å°†instanceæŒ‡å‘åˆšåˆšåˆ†é…çš„å†…å­˜ç©ºé—´ï¼›</p></li><li><p>åˆå§‹åŒ–SingletonTestå¯¹è±¡ã€‚</p></li></ol><p>ç»è¿‡é‡æ’åºåï¼Œä¸Šé¢çš„ä¾‹å­åœ¨å¤šçº¿ç¨‹ä¸‹å°±ä¼šå‡ºç°é—®é¢˜ã€‚å‡å¦‚ç°åœ¨æœ‰ä¸¤ä¸ªçº¿ç¨‹Aå’ŒBåŒæ—¶è°ƒç”¨SingletonTest#getInstanceï¼Œçº¿ç¨‹Aæ‰§è¡Œåˆ°äº†ä»£ç çš„ç¬¬12è¡Œ<code>instance = new SingletonTest()</code>ï¼Œå·²ç»å®Œæˆäº†å¯¹è±¡å†…å­˜ç©ºé—´çš„åˆ†é…å¹¶å°†instanceæŒ‡å‘äº†è¯¥å†…å­˜ç©ºé—´ï¼Œçº¿ç¨‹Bæ‰§è¡Œåˆ°äº†ç¬¬9è¡Œï¼Œå‘ç°instanceå¹¶ä¸æ˜¯nullï¼ˆå› ä¸ºå·²ç»æŒ‡å‘äº†å†…å­˜ç©ºé—´ï¼‰ï¼Œæ‰€ä»¥å°±ç›´æ¥è¿”å›instanceäº†ã€‚ä½†æ˜¯çº¿ç¨‹Aå¹¶è¿˜æ²¡æœ‰æ‰§è¡Œåˆå§‹åŒ–SingletonTestæ“ä½œï¼Œæ‰€ä»¥å®é™…çº¿ç¨‹Bæ‹¿åˆ°çš„SingletonTestå®ä¾‹æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆçº¿ç¨‹Båç»­å¯¹SingletonTestæ“æ§å°†æŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚</p><p>è¦è®©ä¸Šé¢çš„ä¾‹å­æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œåªéœ€è¦ç”¨volatileä¿®é¥°å•ä¾‹å¯¹è±¡å³å¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ç§æœ‰åŒ–æ„é€ å‡½æ•°ï¼Œè®©å¤–éƒ¨æ²¡åŠæ³•ç›´æ¥é€šè¿‡newæ¥åˆ›å»º</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingletonTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å•ä¾‹å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> SingletonTest instance = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// é™æ€å·¥å‚æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingletonTest <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123; <span class="comment">// åŒé‡æ£€æµ‹</span></span><br><span class="line">            <span class="keyword">synchronized</span> (SingletonTest.class) &#123; <span class="comment">// åŒæ­¥é”</span></span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> SingletonTest();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å› ä¸ºé€šè¿‡volatileä¿®é¥°çš„æˆå‘˜å˜é‡ä¼šæ·»åŠ å†…å­˜å±éšœæ¥é˜»æ­¢JVMè¿›è¡ŒæŒ‡ä»¤é‡æ’ä¼˜åŒ–ã€‚</p><h2 id="çº¿ç¨‹ä¸å®‰å…¨"><a href="#çº¿ç¨‹ä¸å®‰å…¨" class="headerlink" title="çº¿ç¨‹ä¸å®‰å…¨"></a>çº¿ç¨‹ä¸å®‰å…¨</h2><p>ä¸¾ä¸ªé€’å¢çš„ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VolatileTest2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> <span class="keyword">int</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread thread1 = <span class="keyword">new</span> Thread(() -&gt; IntStream.range(<span class="number">0</span>, <span class="number">500</span>).forEach(i -&gt; value += <span class="number">1</span>));</span><br><span class="line">        Thread thread2 = <span class="keyword">new</span> Thread(() -&gt; IntStream.range(<span class="number">0</span>, <span class="number">500</span>).forEach(i -&gt; value += <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        thread1.start();</span><br><span class="line">        thread2.start();</span><br><span class="line">        thread1.join();</span><br><span class="line">        thread2.join();</span><br><span class="line">        System.out.println(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¤šæ¬¡è¿è¡Œä¸Šé¢çš„ä¾‹å­ï¼š</p><p><img src="img/asdfjwqefj.gif" alt="asdfjwqefj.gif"></p><p>å¯ä»¥çœ‹åˆ°æœ€ç»ˆçš„å€¼æœ‰å¯èƒ½å°äº1000ã€‚</p><p>volatileå¯ä»¥ä¿è¯ä¿®æ”¹çš„å€¼èƒ½å¤Ÿé©¬ä¸Šæ›´æ–°åˆ°ä¸»å†…å­˜ï¼Œå…¶ä»–çº¿ç¨‹ä¹Ÿä¼šæ•æ‰åˆ°è¢«ä¿®æ”¹åçš„å€¼ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä¸èƒ½ä¿è¯åŸå­æ€§å‘¢ï¼Ÿ</p><p>å› ä¸ºåœ¨Javaä¸­ï¼Œåªæœ‰å¯¹åŸºæœ¬ç±»å‹çš„èµ‹å€¼å’Œä¿®æ”¹æ‰æ˜¯åŸå­æ€§çš„ï¼Œè€Œå¯¹å…±äº«å˜é‡çš„ä¿®æ”¹å¹¶ä¸æ˜¯åŸå­æ€§çš„ã€‚é€šè¿‡<a href="/Java-Memory-model.html">JMM</a>å†…å­˜äº¤äº’åè®®æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹å…±äº«å˜é‡çš„å€¼éœ€è¦ç»è¿‡ä¸‹é¢è¿™äº›æ­¥éª¤ï¼š</p><ol><li><p>çº¿ç¨‹ä»ä¸»å†…å­˜ä¸­è¯»å–ï¼ˆreadï¼‰å…±äº«å˜é‡çš„å€¼ï¼Œç„¶åè½½å…¥ï¼ˆloadï¼‰åˆ°çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­çš„å˜é‡ï¼›</p></li><li><p>ä½¿ç”¨ï¼ˆuseï¼‰å·¥ä½œå†…å­˜å˜é‡çš„å€¼ï¼Œæ‰§è¡ŒåŠ å‡æ“ä½œï¼Œç„¶åå°†ä¿®æ”¹åçš„å€¼èµ‹å€¼ï¼ˆassignï¼‰ç»™å·¥ä½œå†…å­˜ä¸­çš„å˜é‡ï¼›</p></li><li><p>å°†å·¥ä½œå†…å­˜ä¸­ä¿®æ”¹åçš„å˜é‡çš„å€¼å­˜å‚¨ï¼ˆstoreï¼‰åˆ°ä¸»å†…å­˜ä¸­ï¼Œå¹¶æ‰§è¡Œå†™å…¥ï¼ˆwriteï¼‰æ“ä½œã€‚</p></li></ol><p>æ‰€ä»¥ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå¯èƒ½å‡ºç°ä¸‹é¢è¿™ç§æƒ…å†µï¼š</p><p>thread1å’Œthread2åŒæ—¶è·å–äº†valueçš„å€¼ï¼Œæ¯”å¦‚ä¸º100ã€‚thread1æ‰§è¡Œäº†+1æ“ä½œï¼Œç„¶åå†™å›ä¸»å†…å­˜ï¼Œè¿™ä¸ªæ—¶å€™thread2åˆšå¥½æ‰§è¡Œå®Œuseæ“ä½œï¼ˆ+1ï¼‰ï¼Œå‡†å¤‡æ‰§è¡Œassignï¼ˆå°†+1åçš„å€¼å†™å›å·¥ä½œå†…å­˜å¯¹åº”çš„å˜é‡ä¸­ï¼‰æ“ä½œã€‚è™½ç„¶è¿™æ—¶å€™thread2å·¥ä½œå†…å­˜ä¸­valueå€¼çš„æ‹·è´æ— æ•ˆäº†ï¼ˆå› ä¸ºvolatileçš„ç‰¹æ€§ï¼‰ï¼Œä½†æ˜¯thread2å·²ç»æ‰§è¡Œå®Œ+1æ“ä½œäº†ï¼Œå®ƒå¹¶ä¸éœ€è¦å†ä»ä¸»å†…å­˜ä¸­è·å–valueçš„å€¼ï¼Œæ‰€ä»¥thread2å¯ä»¥é¡ºåˆ©åœ°å°†+1åçš„å€¼èµ‹å€¼ç»™å·¥ä½œå†…å­˜ä¸­çš„å˜é‡ï¼Œç„¶ååˆ·å›ä¸»å­˜ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸Šé¢çš„ç´¯åŠ ç»“æœå¯èƒ½ä¼šå°äº1000çš„åŸå› ã€‚</p><p>è¦è®©ä¸Šé¢çš„ä¾‹å­æ˜¯çº¿ç¨‹å®‰å…¨çš„è¯å¯ä»¥åŠ åŒæ­¥é”ï¼Œæˆ–è€…ä½¿ç”¨atomicç±»ï¼Œåç»­ä¼šä»‹ç»åˆ°ã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sat Nov 23 2019 18:20:05 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;volatileå…³é”®å­—ä¿®é¥°çš„æˆå‘˜å˜é‡å…·æœ‰ä¸¤å¤§ç‰¹æ€§ï¼šä¿è¯äº†è¯¥æˆå‘˜å˜é‡åœ¨ä¸åŒçº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§ï¼›ç¦æ­¢å¯¹è¯¥æˆå‘˜å˜é‡è¿›è¡Œé‡æ’åºï¼Œä¹Ÿå°±ä¿è¯äº†å…¶æœ‰åºæ€§ã€‚ä½†æ˜¯volatileä¿®é¥°çš„æˆå‘˜å˜é‡å¹¶ä¸å…·æœ‰åŸå­æ€§ï¼Œåœ¨å¹¶å‘ä¸‹å¯¹å®ƒçš„ä¿®æ”¹æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚ä¸‹é¢åˆ†åˆ«ä¸¾ä¾‹æ¥æ¼”ç¤ºè¿™ä¸¤ä¸ªç‰¹æ€§ï¼Œå¹¶ä¸”åˆ†æä¸ºä»€ä¹ˆvolatileä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>JUCä¹‹Exchanger</title>
    <link href="http://mrbird.cc/JUC-Exchanger.html"/>
    <id>http://mrbird.cc/JUC-Exchanger.html</id>
    <published>2019-03-06T08:24:53.000Z</published>
    <updated>2019-10-28T12:14:46.237Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --><p>JUCä¸­çš„Exchangerå…è®¸<strong>æˆå¯¹çš„</strong>çº¿ç¨‹åœ¨æŒ‡å®šçš„åŒæ­¥ç‚¹ä¸Šé€šè¿‡<code>exchange</code>æ–¹æ³•æ¥äº¤æ¢æ•°æ®ã€‚å¦‚æœç¬¬ä¸€ä¸ªçº¿ç¨‹å…ˆæ‰§è¡Œ<code>exchange</code>æ–¹æ³•ï¼Œå®ƒä¼šä¸€ç›´ç­‰å¾…ç¬¬äºŒä¸ªçº¿ç¨‹ä¹Ÿ æ‰§è¡Œ<code>exchange</code>æ–¹æ³•ï¼Œå½“ä¸¤ä¸ªçº¿ç¨‹éƒ½åˆ°è¾¾åŒæ­¥ç‚¹æ—¶ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹å°±å¯ä»¥äº¤æ¢æ•°æ®ï¼Œå°†å½“å‰çº¿ç¨‹ç”Ÿäº§ å‡ºæ¥çš„æ•°æ®ä¼ é€’ç»™å¯¹æ–¹ã€‚<a id="more"></a></p><h2 id="Exchangerç¤ºä¾‹"><a href="#Exchangerç¤ºä¾‹" class="headerlink" title="Exchangerç¤ºä¾‹"></a>Exchangerç¤ºä¾‹</h2><p>ä¸¤ä¸ªçº¿ç¨‹é€šè¿‡Exchangeräº¤æ¢æ•°æ®çš„ç®€å•ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExchangerTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Exchanger&lt;String&gt; exchanger = <span class="keyword">new</span> Exchanger&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"thread1å¼€å§‹"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String exchange = exchanger.exchange(<span class="string">"æ¥è‡ªthread1çš„æ•°æ®"</span>);</span><br><span class="line">                System.out.println(<span class="string">"æ¥æ”¶thread2å‘é€çš„æ•°æ®ï¼š"</span> + exchange);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"thread1ç»“æŸ"</span>);</span><br><span class="line">        &#125;, <span class="string">"thread1"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"thread2å¼€å§‹"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String exchange = exchanger.exchange(<span class="string">"æ¥è‡ªthread2çš„æ•°æ®"</span>);</span><br><span class="line">                System.out.println(<span class="string">"æ¥æ”¶thread1å‘é€çš„æ•°æ®ï¼š"</span> + exchange);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"thread2ç»“æŸ"</span>);</span><br><span class="line">        &#125;, <span class="string">"thread2"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åœ¨å®šä¹‰Exchangerçš„æ—¶å€™éœ€è¦æŒ‡å®šäº¤æ¢çš„æ•°æ®ç±»å‹ï¼Œè¿™é‡Œä¸ºStringç±»å‹ã€‚<code>exchange</code>æ–¹æ³•ç”¨äºå‘å¦ä¸€ä¸ªçº¿ç¨‹å‘é€æ•°æ®ï¼Œæ–¹æ³•çš„è¿”å›å€¼ä¸ºå¦ä¸€ä¸ªçº¿ç¨‹å‘é€è¿‡æ¥çš„æ•°æ®ã€‚ä¸Šé¢ä¾‹å­è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">thread1å¼€å§‹</span><br><span class="line">thread2å¼€å§‹</span><br><span class="line">æ¥æ”¶thread2å‘é€çš„æ•°æ®ï¼šæ¥è‡ªthread2çš„æ•°æ®</span><br><span class="line">thread1ç»“æŸ</span><br><span class="line">æ¥æ”¶thread1å‘é€çš„æ•°æ®ï¼šæ¥è‡ªthread1çš„æ•°æ®</span><br><span class="line">thread2ç»“æŸ</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢è¯´è¿‡ï¼Œåªæœ‰å½“æˆå¯¹çš„çº¿ç¨‹éƒ½åˆ°è¾¾åŒæ­¥ç‚¹çš„æ—¶å€™ï¼Œæ‰ä¼šæ‰§è¡Œæ•°æ®äº¤æ¢æ“ä½œã€‚ç°åœ¨æˆ‘ä»¬è®©thread2ä¼‘çœ ä¸€ä¼šå„¿ï¼Œçœ‹çœ‹thread1æ˜¯å¦ä¼šè¿›å…¥ç­‰å¾…ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExchangerTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Exchanger&lt;String&gt; exchanger = <span class="keyword">new</span> Exchanger&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"thread1å¼€å§‹"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String exchange = exchanger.exchange(<span class="string">"æ¥è‡ªthread1çš„æ•°æ®"</span>);</span><br><span class="line">                System.out.println(<span class="string">"æ¥æ”¶thread2å‘é€çš„æ•°æ®ï¼š"</span> + exchange);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"thread1ç»“æŸ"</span>);</span><br><span class="line">        &#125;, <span class="string">"thread1"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"thread2å¼€å§‹"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">3</span>); <span class="comment">// thread1ä¹Ÿä¼šè¿›å…¥ç­‰å¾…ï¼Œç›´åˆ°åŒæ–¹éƒ½å‡†å¤‡å¥½äº¤æ¢æ•°æ®ã€‚</span></span><br><span class="line">                String exchange = exchanger.exchange(<span class="string">"æ¥è‡ªthread2çš„æ•°æ®"</span>);</span><br><span class="line">                System.out.println(<span class="string">"æ¥æ”¶thread1å‘é€çš„æ•°æ®ï¼š"</span> + exchange);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"thread2ç»“æŸ"</span>);</span><br><span class="line">        &#125;, <span class="string">"thread2"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/exchanger1.gif" alt="exchanger1.gif"></p><p>é‚£ä¹ˆå¦‚æœçº¿ç¨‹ä¸æˆå¯¹ä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿæˆ‘ä»¬æ·»åŠ thread3çº¿ç¨‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExchangerTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Exchanger&lt;String&gt; exchanger = <span class="keyword">new</span> Exchanger&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"thread1å¼€å§‹"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String exchange = exchanger.exchange(<span class="string">"å‘é€æ•°æ®-thread1"</span>);</span><br><span class="line">                System.out.println(<span class="string">"æ¥æ”¶æ•°æ®ï¼š"</span> + exchange);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"thread1ç»“æŸ"</span>);</span><br><span class="line">        &#125;, <span class="string">"thread1"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"thread2å¼€å§‹"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String exchange = exchanger.exchange(<span class="string">"å‘é€æ•°æ®-thread2"</span>);</span><br><span class="line">                System.out.println(<span class="string">"æ¥æ”¶æ•°æ®ï¼š"</span> + exchange);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"thread2ç»“æŸ"</span>);</span><br><span class="line">        &#125;, <span class="string">"thread2"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"thread3å¼€å§‹"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String exchange = exchanger.exchange(<span class="string">"å‘é€æ•°æ®-thread3"</span>);</span><br><span class="line">                System.out.println(<span class="string">"æ¥æ”¶æ•°æ®ï¼š"</span> + exchange);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"thread3ç»“æŸ"</span>);</span><br><span class="line">        &#125;, <span class="string">"thread3"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">thread1å¼€å§‹</span><br><span class="line">thread3å¼€å§‹</span><br><span class="line">æ¥æ”¶æ•°æ®ï¼šå‘é€æ•°æ®-thread1</span><br><span class="line">thread3ç»“æŸ</span><br><span class="line">thread2å¼€å§‹</span><br><span class="line">æ¥æ”¶æ•°æ®ï¼šå‘é€æ•°æ®-thread3</span><br><span class="line">thread1ç»“æŸ</span><br></pre></td></tr></table></figure><p></p><p>å¯çœ‹åˆ°thread1å’Œthread3äº¤æ¢äº†æ•°æ®ç„¶åæ­£å¸¸åœæ­¢äº†ï¼Œè€Œthread2ç”±äºæ²¡æœ‰çº¿ç¨‹å’Œå®ƒäº¤æ¢æ•°æ®è€Œè‹¦è‹¦ç­‰å¾…ï¼Œçº¿ç¨‹æ°¸è¿œä¸ä¼šåœæ­¢ã€‚æŸ¥çœ‹çº¿ç¨‹å¿«ç…§å¯ä»¥è¯æ˜è¿™ç‚¹ï¼š</p><p><img src="img/QQæˆªå›¾20190514092846.png" alt="QQæˆªå›¾20190514092846.png"></p><p>çº¿ç¨‹åŒ¹é…æ˜¯éšæœºçš„ï¼Œæ‰€ä»¥ä¹Ÿæœ‰å¯èƒ½thread1å’Œthread2åŒ¹é…ï¼Œthread3è¿›å…¥æ— ä¼‘æ­¢çš„ç­‰å¾…ï¼Œè¿™å°±ç±»ä¼¼äºâ€¦</p><p><img src="img/QQæˆªå›¾20190514093233.png" alt="QQæˆªå›¾20190514093233.png"></p><p>å¦ä¸€ä¸ªå€¼å¾—ä¸€æçš„ç‚¹å°±æ˜¯é€šè¿‡Exchangeräº¤æ¢çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œè€Œä¸æ˜¯å¯¹è±¡çš„æ‹·è´ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExchangerTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Exchanger&lt;Object&gt; exchanger = <span class="keyword">new</span> Exchanger&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"thread1å¼€å§‹"</span>);</span><br><span class="line">            Object object = <span class="keyword">new</span> Object();</span><br><span class="line">            System.out.println(<span class="string">"thread1å‘é€æ•°æ®ï¼š"</span> + object);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Object exchange = exchanger.exchange(object);</span><br><span class="line">                System.out.println(<span class="string">"æ¥æ”¶thread2å‘é€çš„æ•°æ®ï¼š"</span> + exchange);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"thread1ç»“æŸ"</span>);</span><br><span class="line">        &#125;, <span class="string">"thread1"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"thread2å¼€å§‹"</span>);</span><br><span class="line">            Object object = <span class="keyword">new</span> Object();</span><br><span class="line">            System.out.println(<span class="string">"thread2å‘é€æ•°æ®ï¼š"</span> + object);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Object exchange = exchanger.exchange(object);</span><br><span class="line">                System.out.println(<span class="string">"æ¥æ”¶thread1å‘é€çš„æ•°æ®ï¼š"</span> + exchange);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"thread2ç»“æŸ"</span>);</span><br><span class="line">        &#125;, <span class="string">"thread2"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">thread1å¼€å§‹</span><br><span class="line">thread2å¼€å§‹</span><br><span class="line">thread2å‘é€æ•°æ®ï¼šjava.lang.Object@6d559005</span><br><span class="line">thread1å‘é€æ•°æ®ï¼šjava.lang.Object@7702c19</span><br><span class="line">æ¥æ”¶thread2å‘é€çš„æ•°æ®ï¼šjava.lang.Object@6d559005</span><br><span class="line">æ¥æ”¶thread1å‘é€çš„æ•°æ®ï¼šjava.lang.Object@7702c19</span><br><span class="line">thread2ç»“æŸ</span><br><span class="line">thread1ç»“æŸ</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°thread1å‘é€çš„å¯¹è±¡å’Œthread2æ¥æ”¶çš„å¯¹è±¡å¥æŸ„æ˜¯ä¸€è‡´çš„ã€‚</p><h2 id="è®¾ç½®è¶…æ—¶æ—¶é—´"><a href="#è®¾ç½®è¶…æ—¶æ—¶é—´" class="headerlink" title="è®¾ç½®è¶…æ—¶æ—¶é—´"></a>è®¾ç½®è¶…æ—¶æ—¶é—´</h2><p>å¦‚æœä¸æƒ³çº¿ç¨‹åœ¨äº¤æ¢æ•°æ®çš„æ—¶å€™ç­‰å¾…è¿‡é•¿çš„æ—¶é—´ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>exchanger</code>çš„é‡è½½æ–¹æ³•<code>exchange(V x, long timeout, TimeUnit unit)</code>æ¥æŒ‡å®šè¶…æ—¶æ—¶é—´ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExchangerTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Exchanger&lt;String&gt; exchanger = <span class="keyword">new</span> Exchanger&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"thread1å¼€å§‹"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String exchange = exchanger.exchange(<span class="string">"æ¥è‡ªthread1çš„æ•°æ®"</span>, <span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">                System.out.println(<span class="string">"æ¥æ”¶thread2å‘é€çš„æ•°æ®ï¼š"</span> + exchange);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | TimeoutException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"thread1ç»“æŸ"</span>);</span><br><span class="line">        &#125;, <span class="string">"thread1"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"thread2å¼€å§‹"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">                String exchange = exchanger.exchange(<span class="string">"æ¥è‡ªthread2çš„æ•°æ®"</span>);</span><br><span class="line">                System.out.println(<span class="string">"æ¥æ”¶thread1å‘é€çš„æ•°æ®ï¼š"</span> + exchange);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"thread2ç»“æŸ"</span>);</span><br><span class="line">        &#125;, <span class="string">"thread2"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä¾‹å­ä¸­ï¼Œthread2ä¼‘çœ 10ç§’åæ‰å¼€å§‹äº¤æ¢æ•°æ®ï¼Œè€Œthread1åœ¨ç­‰å¾…5ç§’åæ²¡èƒ½æˆåŠŸäº¤æ¢æ•°æ®å°±æŠ›å‡º<code>TimeoutException</code>å¼‚å¸¸äº†ã€‚10ç§’åç”±äºæ²¡æœ‰çº¿ç¨‹å†å’Œthread2äº¤æ¢æ•°æ®ï¼Œæ‰€ä»¥thread2ä¼šä¸€ç›´ç­‰å¾…ï¼š</p><p><img src="img/QQæˆªå›¾20190514093752.png" alt="QQæˆªå›¾20190514093752.png"></p><p><img src="img/QQæˆªå›¾20190514093839.png" alt="QQæˆªå›¾20190514093839.png"></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Sat Nov 23 2019 18:20:04 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;JUCä¸­çš„Exchangerå…è®¸&lt;strong&gt;æˆå¯¹çš„&lt;/strong&gt;çº¿ç¨‹åœ¨æŒ‡å®šçš„åŒæ­¥ç‚¹ä¸Šé€šè¿‡&lt;code&gt;exchange&lt;/code&gt;æ–¹æ³•æ¥äº¤æ¢æ•°æ®ã€‚å¦‚æœç¬¬ä¸€ä¸ªçº¿ç¨‹å…ˆæ‰§è¡Œ&lt;code&gt;exchange&lt;/code&gt;æ–¹æ³•ï¼Œå®ƒä¼šä¸€ç›´ç­‰å¾…ç¬¬äºŒä¸ªçº¿ç¨‹ä¹Ÿ æ‰§è¡Œ&lt;code&gt;exchange&lt;/code&gt;æ–¹æ³•ï¼Œå½“ä¸¤ä¸ªçº¿ç¨‹éƒ½åˆ°è¾¾åŒæ­¥ç‚¹æ—¶ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹å°±å¯ä»¥äº¤æ¢æ•°æ®ï¼Œå°†å½“å‰çº¿ç¨‹ç”Ÿäº§ å‡ºæ¥çš„æ•°æ®ä¼ é€’ç»™å¯¹æ–¹ã€‚
    
    </summary>
    
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
  </entry>
  
</feed>
